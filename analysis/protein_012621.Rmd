---
title: "Protein/Carbohydrate Containing Drinks"
date: "`r format(Sys.time(), '%d %B, %Y (%H:%M)')`"
output:
  html_document:
    font: Source Sans Pro
    theme: cosmo
    anchor_sections: TRUE 
    toc_depth: 3
    toc_float: 
      smooth_scroll: true
      collapsed: false
    linkcolor: blue
bibliography: protein.bib
csl: jama.csl
link-citations: yes
workflowr:
  suppress_report: TRUE
nocite: '@*'
---

#### 

```{=html}
<style type="text/css">
  body{
  font-size: 9.5pt;
  font-family: Source Sans Pro;
}

.list-group-item.active, .list-group-item.active:hover, .list-group-item.active:focus {
  color: #090909;
  background-color: #0909093d;
}

.lightable-classic.lightable-hover tbody tr:hover {
    background-color: #c5d4e4;
}
.btn-xs, .btn-group-xs>.btn { 
display: none; 
}

.btn-default {
display: none !important; 
}
</style>
```
```{r setupData, include = FALSE}
## (updated 2021/01/06 11:34) preliminaries -------------------------------
# functions
now <- function() {str_replace_all(format(Sys.time(), "%m %d %y_%H-%M"), " ", "_")}
# replace_mg <- function(a, b) {if_else(is.na(a) & !is.na(b), b, a)}
tab_inc <- function() {
  table_n <- table_n + 1
  table_n}
fig_inc <- function() {
  figure_n <- figure_n + 1
  figure_n}
table_n <- 1
figure_n <- 1

## get current files; select protein refids; directory must have unique ####
source("code/readFiles_120220_wfr.R")

# add study protein indicator "tx"
study_char.dat <- left_join(study_char.dat, protein_refids, by = "refid") 
study_arm.dat  <- left_join(study_arm.dat, protein_refids, by = "refid") 

# study char protein refs 
study_char_prot.dat <- study_char.dat %>% 
  filter(tx == "protein") 

# study arm protein refs 
study_arm_prot.dat <- study_arm.dat %>% 
  filter(tx == "protein")

## dichot factor treatment arm outcome type for ordering (updated 2020/12/12 12:04) ####
# save dichot.dat 
dichot_all.dat <- dichot.dat
dichot.dat <- dichot.dat %>% 
  filter(refid %in% protein_refids$refid) %>% 
  # factor arm_tx levels for protein studies
  mutate(tx = factor(arm_tx,
  levels = c(
    "fasting",
    "water",
    "other_clear",
    "other",
    "cho",
    "milk",
    "protein"))) %>%
  mutate(tx = fct_recode(tx,
    Fasting = "fasting",
    Water = "water",
    Clear = "other_clear",
    Other = "other",
    CHO = "cho",
    Milk = "milk",
    "Prot/CHO" = "protein"),
    arm_tx = tx) %>%
  select(-tx)

## contin factor treatment arm outcome type for ordering (updated 2020/12/12 12:04) ####
# save contin.dat
contin_all.dat <- contin.dat
contin.dat <- contin.dat %>% 
  filter(refid %in% protein_refids$refid) %>% 
  mutate(tx = factor(arm_tx,
  levels = c(
    "fasting",
    "water",
    "other_clear",
    "other",
    "cho",
    "milk",
    "protein"))) %>%
  mutate(tx = fct_recode(tx,
    Fasting = "fasting",
    Water = "water",
    Clear = "other_clear",
    Other = "other",
    CHO = "cho",
    Milk = "milk",
    "Prot/CHO" = "protein"),
    arm_tx = tx) %>%
  select(-tx)

## likert factor treatment arm outcome type for ordering (updated 2020/12/12 12:04) ####
# save likert
likert_all.dat <- likert.dat
# likert.dat <- likert_all.dat
likert.dat <- likert.dat %>% 
  filter(refid %in% protein_refids$refid) %>% 
  # factor arm_tx levels for protein studies
  mutate(tx = factor(arm_tx,
  levels = c(
    "fasting",
    "water",
    "placebo",
    "other",     
    "other_clear",
    "cho", 
    "milk",
    "protein")), 
  tx = fct_recode(tx,
    Fasting = "fasting",
    Water = "water",
    Placebo = "placebo",
    Other = "other",     
    Clear = "other_clear",
    CHO = "cho",
    Milk = "milk",
    "Prot/CHO" = "protein"),
    arm_tx = tx) %>%
  select(-tx)
```

# Included Studies

<br>

<font size = 4> Table `r table_n`. Number of included studies according to age, surgery, and design. </font>

```{r}
## (updated 2021/01/25 21:33) number included -----------------------------
study_char_prot.dat %>%
  select(age, design, surg_nosurg) %>% 
  tabyl(design, surg_nosurg, age) %>% 
  adorn_totals("row") %>% 
  data.frame() %>% 
  as_tibble() %>% 
  select(c(1:3,5,6)) %>% 
  `colnames<-`(c("design", "nonsurg_adult", "surg_adult",  "nonsurg_peds", "surg_peds")) %>% 
  select(design, surg_adult, nonsurg_adult, surg_peds, nonsurg_peds) %>% 
  filter(!design %in% c("case_series", "cluster", "prospect_coh", "casecontrol", "case_series", "other")) %>% 
  mutate(
    design = case_when(
      design == "rct" ~ "RCT",
      design == "crossover" ~ "Crossover",
      design == "cluster" ~ "Cluster",
      design == "nrsi" ~ "Nonrandomized",
      design == "prospect_coh" ~ "Prospective Cohort",
      design == "retrospect_coh" ~ "Retrospective Cohort",
      design == "Total" ~ "Total")) %>% 
  kbl(
    booktabs = T, align = c("lcccc"), col.names = c("Design", "Surgical^a^", "Non-surgical", "Surgical", "Non-surgical")) %>%
  add_header_above(c(" " = 1, "Adult" = 2, "Pediatric" = 2), line = TRUE) %>% 
  kable_styling(bootstrap_options = opt_boot, position = "left") %>% 
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "12em") %>%  
  column_spec(c(2:5), width = "8em") %>% 
  row_spec(5, bold = TRUE) %>% 
  footnote(general = "RCT: randomized controlled trial",
           alphabet = c("Includes 1 endoscopy study."),
           general_title = "", 
           footnote_as_chunk = FALSE)
table_n <- tab_inc()
```

<br>

<font size = 4> Table `r table_n`. Included studies according to design, age, centers, country, type of surgery or procedure, and design (see [References](#references) for citations). </font>

```{r studiesIncluded, echo = FALSE, include = TRUE}
## (updated 2020/12/13 09:53) studiesIncluded -----------------------------
# list of studies, age, surgical/non surgical, design
study_char_prot.dat %>%
  mutate(
    surg = case_when(
      str_detect(surg_type, "[Gg]yn") ~ "Gyn",
      str_detect(surg_type, "ariety") ~ "Various",
      str_detect(surg_type, "various") ~ "Various",
      str_detect(surg_type, "total hip or total knee replacement") ~ "TKA/THA",
      str_detect(surg_type, "cholecystectomy") ~ "Cholecystectomy",
      str_detect(surg_type, "[Gg]ast|Bowel") ~ "Other GI",
      str_detect(surg_type, "not appli") ~ "None (healthy)",
      str_detect(surg_type, "oral") ~ "Oral",
      str_detect(surg_type, "minor") ~ "Misc minor",
      str_detect(surg_type, "None") ~ "None (healthy)",
      str_detect(surg_type, "abdomin") ~ "Other GI",
      str_detect(surg_type, "Endso") ~ "Endoscopy"),
    country = ifelse(grepl("USA", country), "USA", country),
    country = ifelse(grepl("UK", country), "UK", country),
    country = ifelse(!is.na(non_vh_hdi), str_c(country, "^a^"), country),
    n_analyze = ifelse(refid == 2009, 9, n_analyze),
    study = ifelse(grepl("Marquini", study), str_c(study, "^b^"), study),
    surg = ifelse(surg_nosurg == "nonsurgical", "None", surg)) %>%
  arrange(age, desc(surg_nosurg), design, year, study) %>%
  select(refid, study, n_analyze, centers, country, surg) %>%
  kbl(
    booktabs = T, align = c("llccll"), # format = "latex",
    col.names = c("\\ \\ \\ \\ \\ \\ \\ \\ ID", "Study", "Analyzed (N)", "Centers", "Country^a^", "Surgery")) %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "6em") %>%  
  column_spec(2, width = "10em") %>%  
  column_spec(3, width = "6em") %>%  
  column_spec(4, width = "6em") %>%  
  column_spec(5, width = "10em") %>%  
  column_spec(6, width = "12em") %>%  
  pack_top(., "Adult, Surgical", 1, 19) %>%
  pack_sub(., "RCT", 1, 19) %>%
  pack_sub(., "Nonrandomized Studies of Interventions", 20, 21) %>%
  pack_sub(., "Retrospective Cohort", 22, 22) %>%
  pack_top(., "Adult, Nonsurgical", 23, 23) %>%
  pack_sub(., "RCT", 23, 23) %>%
  pack_sub(., "Crossover", 24, 29) %>%
  pack_top(., "Pediatric, Nonsurgical", 30, 30) %>%
  pack_sub(., "RCT", 30, 30) %>%
  footnote(
    alphabet = c(
      "Non very high [Human Development Index](https://en.wikipedia.org/wiki/List_of_countries_by_Human_Development_Index) country."),
      "Multiple publications of the same study.",
    general_title = "",
    footnote_as_chunk = FALSE)

table_n <- tab_inc()
```

```{r studiesOutcomes, echo = FALSE, include = FALSE}
## (updated 2020/12/13 09:54) studiesOutcomes -----------------------------
# <font size = 4> Table `r table_n`. Outcomes reported in included studies. </font>
# list of studies, age, surgical/non surgical, design
study_char_prot.dat %>%
  mutate(across(out_emptying:out_bp, ~ ifelse(!is.na(.), "\U2022", NA))) %>% 
  arrange(age, desc(surg_nosurg), design, year, study) %>%
  select(study, out_emptying:out_bp) %>%
  kbl(
    booktabs = T, align = c("lccccccccccc"), # format = "latex",
    col.names = c("\\ \\ \\ \\ \\ \\ \\ \\ Study", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ")) %>%
  kable_classic(full_width = TRUE, html_font = opt_font, position = "left", "hover") %>%
  kable_styling(bootstrap_options = opt_boot) %>%
  pack_top(., "Adult, Surgical", 1, 19) %>%
  pack_sub(., "RCT", 1, 19) %>%
  pack_sub(., "Nonrandomized Studies of Interventions", 20, 21) %>%
  pack_sub(., "Retrospective Cohort", 22, 22) %>%
  pack_top(., "Adult, Nonsurgical", 23, 23) %>%
  pack_sub(., "RCT", 23, 23) %>%
  pack_sub(., "Crossover", 24, 29) %>%
  pack_top(., "Pediatric, Nonsurgical", 30, 30) %>%
  pack_sub(., "RCT", 30, 30) %>%
  footnote(
    alphabet = c("Multiple publications of the same study."),
    general_title = "",
    footnote_as_chunk = FALSE)

#  table_n <- tab_inc()
```

<br><br>

<hr style="height:2px;border-width:0;color:gray;background-color:gray">

# Patient Reported Outcomes

<br>

## Surgical/Endoscopy Studies

<br>

### \*Hunger

<br>

<!-- occurrence -->

<font size = 4> Table `r table_n`. Occurrence of hunger according to fasting, liquid and volume. </font>

```{r dichotProtData, include = FALSE}
## (updated 2020/12/13 09:55) dichotProtData ------------------------------
# dichot_prot_studies <- dichot.dat %>% group_by(refid) %>% slice(1) 
# timeingest1 = ifelse(timeingest1 == 99, 12, timeingest1), timeingest2 = ifelse(timeingest2 == 99, 12, timeingest2),
dichot_prot.dat <- dichot.dat %>%
  mutate(
    # surgical studies (note none have times 0 or negative)
    # hr_2 is ≤ 2; hr_26 is (2, 6] >2 to 6; hr_gt6 is >6
    hr_2 = 0, hr_26 = 0, hr_gt6 = 0,
    hr_2 =   if_else(timeingest1 <= 2 & timeingest1 > 0, amtingest1, hr_2, missing = 0),
    hr_26 =  if_else(timeingest1 > 2 & timeingest1 < 6, amtingest1, hr_26, missing = 0),
    hr_gt6 = if_else(timeingest1 >= 6, amtingest1, hr_gt6, missing = 0),
    hr_2 =   if_else(hr_2 == 0 & timeingest2 <= 2 & timeingest2 > 0, amtingest2, hr_2, missing = 0),
    hr_26 =  if_else(hr_26 == 0 & timeingest2 > 2 & timeingest2 < 6, amtingest2, hr_26, missing = 0),
    hr_gt6 = if_else(hr_gt6 == 0 & timeingest2 >= 6, amtingest2, hr_gt6, missing = 0),
    hr_gt6 = if_else(grepl("also received 300", type_ingest_1), 500, hr_gt6)) %>%  # Oyama PM
    # for nonsurgical
    # hr_0 = 0, hr_minus2 = 0,
    # hr_0 =      if_else(surg_nosurg != "surgical" & timeingest1 ==  0, amtingest1, hr_0, missing = 0),
    # hr_minus2 = if_else(surg_nosurg != "surgical" & timeingest1 == -2, amtingest1, hr_minus2, missing = 0),
    # hr_0 =      if_else(surg_nosurg != "surgical" & timeingest2 ==  0, amtingest1, hr_0, missing = 0),
    # hr_minus2 = if_else(surg_nosurg != "surgical" & timeingest2 == -2, amtingest1, hr_minus2, missing = 0)) %>% 
  replace_with_na_at(.vars = c("hr_gt6", "hr_26", "hr_2"), condition = ~ .x == 0) %>%
  filter(surg_nosurg == "surgical") %>% 
  # select(refid, study, hr_2, hr_26, hr_gt6, timeingest1, amtingest1, timeingest2, amtingest2, age, design)
  mutate(
    hunger_np = n_percent(hunger_n, hunger_per),
    thirst_np = n_percent(thirst_n, thirst_per),
    nausea_np = n_percent(nausea_n, nausea_per),
    vomit_np = n_percent(vomit_n, vomit_per),
    comfort_np = n_percent(arm_n - comfort_n, 100 - comfort_per),
    satisfac_np = n_percent(satisfac_n, satisfac_per),
    complicate_np = n_percent(complicate_n, complicate_per),
    hypotension_np = n_percent(hypotension_n, hypotension_per),
    regurg_np = n_percent(regurg_n, regurg_per),
    rgv_gt25_np = n_percent(rgv_gt25_n, rgv_gt25_per),
    ph_lt25_np = n_percent(ph_lt25_n, ph_lt25_per),
    aspirate_np = n_percent(aspirate_n, aspirate_per),
    vomit_np = ifelse(refid == 6446 & arm_n == 40, "4 (10)", vomit_np)) %>%
  arrange(age, desc(surg_nosurg), design, year, study, arm_tx, arm) %>%
  select(refid, study, year, age, design, surg_nosurg, arm, arm_n, arm_tx, hr_gt6, hr_26, hr_2, time_outcome, hunger_np:aspirate_np, compl_descript, out_dichot_notes, ends_with("_n"), timeingest1, amtingest1, timeingest2, amtingest2, ends_with("per")) %>%
  filter_at(vars(hunger_np:aspirate_np), any_vars(!is.na(.)))

## dichot_prot_htnvr all not used except for debugging ---------------------
dichot_prot_htnvr <- dichot_prot.dat %>%
  select(refid:time_outcome, hunger_np, thirst_np, nausea_np, vomit_np, regurg_np, satisfac_np) %>%
  filter_at(vars(hunger_np, thirst_np, nausea_np, vomit_np, regurg_np, satisfac_np), any_vars(!is.na(.))) %>%
  select(!c(year, age, surg_nosurg), study, arm_n:vomit_np) %>%
  mutate(
    arm_tx = as.character(arm_tx),
    arm_tx = ifelse(grepl("Marquini", study) & arm_tx != "Prot/CHO", "Water^c^", arm_tx)) %>%
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    time_outcome = ifelse(row_number() == 1, time_outcome, NA)) %>%
  ungroup()
```

```{r hungerTableOr, include = TRUE}
## (updated 2021/01/12 09:42) hungerTableOr -------------------------------
dichot_format <- function(x) (x/100)

# odds ratios
# exclude single arm studies
# select refid, study, arm_tx, arm_n, outcome_n
dichot_hunger_or <- dichot_prot.dat %>% 
  filter(!is.na(hunger_np)) %>%
  select(refid, study, arm_tx, arm_n, hunger_n) %>% 
  group_by(refid) %>% 
  filter(n() > 1)

or_hunger <- with(or_join(dichot_hunger_or, "hunger"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2))
```

```{r hungerTable, include = TRUE}
## (updated 2021/01/12 18:04) hungerTable ---------------------------------
dichot_hunger <- dichot_prot.dat %>% 
  filter(!is.na(hunger_np)) %>%
  arrange(age, desc(surg_nosurg), design, year, study) %>% 
  select(refid:time_outcome, hunger_np, hunger_per, hunger_n)

dichot_hunger <- left_join(dichot_hunger, or_hunger, by = "refid") %>% 
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    or_ci = ifelse(row_number() == 1, or_ci, NA),
    time_outcome = ifelse(row_number() == 1, time_outcome, NA)) %>%
  ungroup() %>% 
  mutate(hunger_per = round(hunger_per, 0)) %>% 
  select(refid, arm, design, age, study, arm_n, arm_tx, starts_with("hr"), time_outcome, hunger_np, hunger_per, or_ci)

prot_row <- dichot_hunger %>%
  mutate(line = row_number()) %>%
  filter(grepl("Prot", arm_tx)) %>%
  pull(line)

dichot_hunger$hunger_bar <- 0
dichot_hunger$hunger_bar <- ifelse(grepl("Prot", dichot_hunger$arm_tx),
  color_bar("darksalmon", fun = dichot_format)(dichot_hunger$hunger_per),
  color_bar("lightgray", fun = dichot_format)(dichot_hunger$hunger_per))

dichot_hunger  <- dichot_hunger %>% 
  add_foot(study, "Koeppe 2013", "b") %>% 
mutate(hunger_bar = str_replace(hunger_bar, ">[0-9][0-9]", ">&nbsp;"))
  
dichot_hunger %>% 
  select(!c(refid, arm, design, age, hunger_per)) %>% 
  select(study:hunger_np, hunger_bar, or_ci) %>% 
  kbl(booktabs = T, align =  c("lclccccrlc"), escape = FALSE,
    col.names = c("\\ \\ \\ \\ \\ \\ \\ Study", "\\ \\ \\ N", "Liquid", "> 6", "6→2", "≤ 2", "(hr)", "N (%)", " ", "CHO vs. Fasting")) %>% 
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Time^a^" = 1, "Hunger" = 2, "OR (95% CI)"), line = TRUE) %>% 
  kable_styling(bootstrap_options = opt_boot, position = "left") %>% 
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>% 
  column_spec(1, width = "9em") %>%  
  column_spec(2, width = "3em") %>% 
  column_spec(3, width = "4em") %>% 
  column_spec(c(4:6), width = "3em") %>% 
  column_spec(7, width = "3em") %>% 
  column_spec(8, width = "5em") %>% 
  column_spec(9, width = "5em") %>% 
  column_spec(10, width = "8em") %>% 
  row_spec(prot_row, color = "brown") %>% 
  pack_top(., "Adult, Surgical", 1, 2) %>% 
  pack_sub(., "RCT", 1, 2) %>%
  footnote(general = "RCT: randomized controlled trial; OR: odds ratio; CHO: carbohydrate; Prot: protein.",
           alphabet = c("At time of endocoscopy = 0",
           "'Did you feel hunger during the fasting period?'"),
           general_title = "",  
           footnote_as_chunk = FALSE)

table_n <- tab_inc()

```

<br>

<!-- likert -->

<font size = 4> Table `r table_n`. Comparative hunger ratings in included studies (surgical and nonsurgical) according to fasting, liquid and volume. </font>

```{r hungerLikert, include = TRUE}
# no subgroup data
likert_prot_hung.dat <- likert.dat %>%
  filter(refid %in% protein_refids$refid) %>%
  filter(hunger_l == "hunger_l") %>%
  # filter_at(vars(hunger_m:hunger_pval), any_vars(!is.na(.))) # same
  select(refid:age, arm_n, arm_tx, likert_time_outcome, contains("ingest"), starts_with("hunger")) %>%
  mutate(arm_tx = droplevels(arm_tx)) %>%
  arrange(age, desc(surg_nosurg), design, year, study, arm_tx)

likert_prot_hung_kbl.dat <- likert_prot_hung.dat %>%
  rename(time_outcome = likert_time_outcome) %>%
  mutate(
    # surgical studies (note none have times 0 or negative)
    # hr_2 is ≤ 2; hr_26 is (2, 6] >2 to 6; hr_gt6 is >6
    hr_2 = 0, hr_26 = 0, hr_gt6 = 0,
    hr_2 =   if_else(timeingest1 <= 2 & timeingest1 > 0, amtingest1, hr_2, missing = 0),
    # FOR Du Rct add new header in table after RCT
    hr_2 =   if_else(timeingest1 == 0, amtingest1, hr_2, missing = 0),
    hr_26 =  if_else(timeingest1 > 2 & timeingest1 < 6, amtingest1, hr_26, missing = 0),
    hr_gt6 = if_else(timeingest1 >= 6, amtingest1, hr_gt6, missing = 0),
    hr_2 =   if_else(hr_2 == 0 & timeingest2 <= 2 & timeingest2 > 0, amtingest2, hr_2, missing = 0),
    hr_26 =  if_else(hr_26 == 0 & timeingest2 > 2 & timeingest2 < 6, amtingest2, hr_26, missing = 0),
    hr_gt6 = if_else(hr_gt6 == 0 & timeingest2 >= 6, amtingest2, hr_gt6, missing = 0),
    hr_gt6 = if_else(grepl("also received 300", type_ingest_1), 500, hr_gt6),  # Oyama PM
    arm_tx = as.character(arm_tx),
    arm_tx = ifelse(study == "Du 2017" & arm_tx == "Clear", "Juice^e^", arm_tx),
    arm_tx = ifelse(study == "Marquini 2020c" & arm_tx == "Clear", "Water^c^", arm_tx)) %>%
    # for nonsurgical
    # hr_0 = 0, hr_minus2 = 0,
    # hr_0 =      if_else(surg_nosurg != "surgical" & timeingest1 ==  0, amtingest1, hr_0, missing = 0),
    # hr_minus2 = if_else(surg_nosurg != "surgical" & timeingest1 == -2, amtingest1, hr_minus2, missing = 0),
    # hr_0 =      if_else(surg_nosurg != "surgical" & timeingest2 ==  0, amtingest1, hr_0, missing = 0),
    # hr_minus2 = if_else(surg_nosurg != "surgical" & timeingest2 == -2, amtingest1, hr_minus2, missing = 0)) %>%
  replace_with_na_at(.vars = c("hr_gt6", "hr_26", "hr_2"), condition = ~ .x == 0) %>%
  # Footnote: distilled water, 4 drops red dye, 2 drops sucrose
  select(refid:arm_tx, hr_gt6, hr_26, hr_2, time_outcome, hunger_scale, hunger_m:hunger_iqru) %>%
  #mutate(0
  #  time_outcome = ifelse(time_outcome == 0 & refid != 1315, "Preop", time_outcome),
  #  time_outcome = ifelse(suppressWarnings(!is.na(as.numeric(time_outcome))) & refid != 1315,
  #    str_c("Postop ", time_outcome, " hrs"), time_outcome),
  #  time_outcome = ifelse(refid == 1315, str_c("At ", time_outcome, " hrs"), time_outcome)) %>%
  mutate(
    hunger_med = paste0(hunger_med, " (", hunger_iqrl, "-", hunger_iqru, ")"),
    hunger_med = ifelse(hunger_med == "NA (NA-NA)", NA, hunger_med),
    hunger_med = gsub(" \\(NA-NA\\)", "", hunger_med),
    ranges = str_c("(", hunger_rl, "-", hunger_ru, ")"),
    mn_95_ci = str_c(round_1(hunger_m), " (", round_1(hunger95l), "-", round_1(hunger95u), ")"),
    mn_95_ci = ifelse(mn_95_ci == "NA (NA-NA)", NA, mn_95_ci),
    # NOTE: footnote e: Hunger Satiety Scale
    hunger_scale = ifelse(hunger_scale == "VAS: 0 to 100", "0→100", hunger_scale),
    hunger_scale = ifelse(hunger_scale == "VAS, 0 to 100", "0→100", hunger_scale),
    hunger_scale = ifelse(hunger_scale == "VAS, 0 to 10", "0→10", hunger_scale),
    hunger_scale = ifelse(refid == 3588, "1→5 NRS", hunger_scale),
    hunger_scale = ifelse(refid == 1315, "5→1 HSS^f^", hunger_scale),
    hunger_med = ifelse(grepl("(AM)", study) & arm_tx == "Fasting", str_c(hunger_med, "^d^"), hunger_med),
    hunger_med = ifelse(grepl("(PM)", study) & arm_tx == "Fasting", str_c(hunger_med, "^d^"), hunger_med)) %>%
  # remove second line study identifier
  arrange(age, desc(surg_nosurg), design, year, study) %>%
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    hunger_scale = ifelse(row_number() == 1, hunger_scale, NA),
    time_outcome = ifelse(row_number() == 1, time_outcome, NA)) %>%
  ungroup()
```

```{r hungerAdultSurgKable, echo = FALSE}
## (updated 2020/12/13 13:48) hungerAdultSurgKable ------------------------
protein_row <- likert_prot_hung_kbl.dat %>%
  mutate(line = row_number()) %>%
  filter(arm_tx == "Prot/CHO") %>%
  pull(line)

likert_prot_hung_kbl.dat %>%
  select(study, arm_tx, arm_n, hr_gt6, hr_26, hr_2, time_outcome, hunger_scale, mn_95_ci, hunger_med, ranges) %>%
  add_row(study = NA, arm_tx = NA, arm_n = NA, hr_gt6 = NA, hr_26 = NA, hr_2 = NA, time_outcome = NA, hunger_scale = NA, mn_95_ci = NA, hunger_med = NA, ranges = NA) %>% 
  kbl(booktabs = T, align = c("llccccclll"), escape = FALSE,
      col.names = c(
        "\\ \\ \\ \\ \\ \\ \\ Study", "Liquid", "N",  "> 6", "6→2", "≤ 2", "Time (hr)^a^", "Scale^b^", "M (95% CI)",
        "Med (IQR)", "Range")) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Hunger Rating\n *(Between-group Comparison)*" = 5), line = TRUE) %>%
  # NOTE: footnote a: includes at 2.5 hours
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = TRUE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "8em") %>%
  column_spec(2, width = "4em") %>%
  column_spec(3, width = "2em") %>%
  column_spec(c(4:6), width = "2em") %>%
  column_spec(7, width = "5em") %>%
  column_spec(8, width = "4em") %>%
  column_spec(9, width = "5em") %>%
  column_spec(10, width = "5em") %>%
  column_spec(11, width = "4em") %>% 
  row_spec(protein_row, color = "brown") %>%
  pack_top(., "Adult, Surgical", 1, 6) %>%
  pack_sub(., "RCT", 1, 6) %>%
  pack_rows("P = 0.001; MD^g^\\ ≈ -31.1 (95% CI, -36.9 to -25.3)", 3, 3, label_row_css = "padding-left:70%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>% 
  pack_rows("MD^g^\\ ≈ -11.2 (95% CI, -21.9 to -0.4)", 5, 5, label_row_css = "padding-left:70%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>%
  pack_rows("2-hr post-op MD 2.8 (95% CI, -8.1 to 13.7)", 5, 5, label_row_css = "padding-left:70%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>%
  pack_rows("P = 0.4; MD^h^ -1.8 (95% CI, -2.0, -1.5)", 7, 7, label_row_css = "padding-left:70%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>%
  pack_rows("MD^g^\\ ≈ 0.5 (95% CI, -1.1 to 2.1)", 9, 9, label_row_css = "padding-left:70%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>% 
  pack_rows("MD^g^\\ ≈ 1.0 (95% CI, -0.4 to 2.4)", 11, 11, label_row_css = "padding-left:70%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>%
  pack_rows("CHO vs. apple juice or milk, p=0.78", 14, 14, label_row_css = "padding-left:70%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>%
  pack_sub(., "Nonrandomized Studies of Interventions", 7, 10) %>%
  pack_top(., "Pediatric, Nonsurgical (age 8-14 years)", 11, 13) %>%
  pack_rows("0 hr", 11, 13, label_row_css = "padding-left:45%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE) %>%
  footnote(
    general = "RCT: randomized controlled trial; M: mean; Med: median; IQR: interquartile range; NRS: numeric rting scale; MD: mean difference.",
    alphabet = c(
      "When outcome assessed relative to surgery where 0 is prior to induction and other values hours postop or rlative to liquids in nonsurgical studies.",
      "Arrow (→) indicates best to worst hunger (all visual analogue except Du 2017 and Oyama 2011).",
      "Distilled water, 4 drops red dye, 2 drops sucrose.",
      "Range as reported but apparent error being <1 or >5.",
      "Apple juice.",
      "Hunger Satiety Scale.",
      "Estimated using reported medians, IQRs, and ranges.",
      "Calculated from means and confidence intervals."),
    general_title = "",
    footnote_as_chunk = FALSE)

table_n <- tab_inc()
```

<br>

### \*Thirst

<br>

<!-- occurrence -->

<font size = 4> Table `r table_n`. Occurrence of thirst according to fasting, liquid and volume. </font>

```{r thirstTableOr, include = TRUE}
## (updated 2021/01/12 09:42) hungerTableOr -------------------------------
dichot_format <- function(x) (x/100)

# odds ratios
# exclude single arm studies
# select refid, study, arm_tx, arm_n, outcome_n
dichot_thirst_or <- dichot_prot.dat %>% 
  filter(!is.na(thirst_np)) %>%
  select(refid, study, arm_tx, arm_n, thirst_n) %>% 
  group_by(refid) %>% 
  filter(n() > 1)

or_thirst <- with(or_join(dichot_thirst_or, "thirst"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2))
```

```{r thirstTable, include = TRUE}
## (updated 2021/01/12 18:04) thirstTable ---------------------------------
dichot_thirst <- dichot_prot.dat %>% 
  filter(!is.na(thirst_np)) %>%
  arrange(age, desc(surg_nosurg), design, year, study) %>% 
  select(refid:time_outcome, thirst_np, thirst_per, thirst_n)

dichot_thirst <- left_join(dichot_thirst, or_thirst, by = "refid") %>% 
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    or_ci = ifelse(row_number() == 1, or_ci, NA),
    time_outcome = ifelse(row_number() == 1, time_outcome, NA)) %>%
  ungroup() %>% 
  mutate(thirst_per = round(thirst_per, 0)) %>% 
  select(refid, arm, design, age, study, arm_n, arm_tx, starts_with("hr"), time_outcome, thirst_np, thirst_per, or_ci)

prot_row <- dichot_thirst %>%
  mutate(line = row_number()) %>%
  filter(grepl("Prot", arm_tx)) %>%
  pull(line)

dichot_thirst$thirst_bar <- 0
dichot_thirst$thirst_bar <- ifelse(grepl("Prot", dichot_thirst$arm_tx),
  color_bar("darksalmon", fun = dichot_format)(dichot_thirst$thirst_per),
  color_bar("lightgray", fun = dichot_format)(dichot_thirst$thirst_per))

dichot_thirst  <- dichot_thirst %>% 
  add_foot(study, "Koeppe 2013", "b") %>% 
mutate(thirst_bar = str_replace(thirst_bar, ">[0-9][0-9]", ">&nbsp;"))
  
dichot_thirst %>% 
  select(!c(refid, arm, design, age, thirst_per)) %>% 
  select(study:thirst_np, thirst_bar, or_ci) %>% 
  kbl(booktabs = T, align =  c("lclccccrlc"), escape = FALSE,
    col.names = c("\\ \\ \\ \\ \\ \\ \\ Study", "\\ \\ \\ N", "Liquid", "> 6", "6→2", "≤ 2", "(hr)", "N (%)", " ", "CHO vs. Fasting")) %>% 
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Time^a^" = 1, "Thirst" = 2, "OR (95% CI)"), line = TRUE) %>% 
  kable_styling(bootstrap_options = opt_boot, position = "left") %>% 
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>% 
  column_spec(1, width = "9em") %>%  
  column_spec(2, width = "3em") %>% 
  column_spec(3, width = "4em") %>% 
  column_spec(c(4:6), width = "3em") %>% 
  column_spec(7, width = "3em") %>% 
  column_spec(8, width = "5em") %>% 
  column_spec(9, width = "5em") %>% 
  column_spec(10, width = "8em") %>% 
  row_spec(prot_row, color = "brown") %>% 
  pack_top(., "Adult, Surgical", 1, 2) %>% 
  pack_sub(., "RCT", 1, 2) %>%
  footnote(general = "RCT: randomized controlled trial; OR: odds ratio; CHO: carbohydrate; Prot: protein.",
           alphabet = c("At time of endocoscopy = 0",
           "Report of thirst.'"),
           general_title = "",  
           footnote_as_chunk = FALSE)

table_n <- tab_inc()

```

<!-- Likert -->

<br>

<font size = 4> Table `r table_n`. Comparative thirst ratings according to fasting, liquid and volume. </font>

```{r thirstAdultSurg, echo = FALSE}
## (updated 2020/12/14 05:50) thirstLikData -------------------------------
# no subgroup data, all surgical
likert_prot_thirst.dat <- likert.dat %>%
  rename(time_outcome = likert_time_outcome) %>%
  filter(refid %in% protein_refids$refid) %>%
  filter(thirst_l == "thirst_l") %>%
  # filter_at(vars(thirst_m:thirst_pval), any_vars(!is.na(.))) # same
  select(refid:age, arm_n, arm_tx, time_outcome, contains("ingest"), starts_with("thirst")) %>% 
  mutate(arm_tx = droplevels(arm_tx)) %>% 
  arrange(study, arm_tx) %>% 
  group_by(study) %>% mutate(arm = row_number()) %>% ungroup() %>% 
  arrange(age, desc(surg_nosurg), design, year, study)

## (updated 2020/12/14 09:51) thirstAdultSurg -----------------------------
likert_prot_thirst_kbl.dat <- likert_prot_thirst.dat %>%
  mutate(
    # surgical studies (note none have times 0 or negative)
    # hr_2 is ≤ 2; hr_26 is (2, 6] >2 to 6; hr_gt6 is >6
    hr_2 = 0, hr_26 = 0, hr_gt6 = 0,
    hr_2 =   if_else(timeingest1 <= 2 & timeingest1 > 0, amtingest1, hr_2, missing = 0),
    # FOR Du Rct add new header in table after RCT
    # hr_2 =   if_else(timeingest1 == 0, amtingest1, hr_2, missing = 0),
    hr_26 =  if_else(timeingest1 > 2 & timeingest1 < 6, amtingest1, hr_26, missing = 0),
    hr_gt6 = if_else(timeingest1 >= 6, amtingest1, hr_gt6, missing = 0),
    hr_2 =   if_else(hr_2 == 0 & timeingest2 <= 2 & timeingest2 > 0, amtingest2, hr_2, missing = 0),
    hr_26 =  if_else(hr_26 == 0 & timeingest2 > 2 & timeingest2 < 6, amtingest2, hr_26, missing = 0),
    hr_gt6 = if_else(hr_gt6 == 0 & timeingest2 >= 6, amtingest2, hr_gt6, missing = 0),
    hr_gt6 = if_else(grepl("also received 300", type_ingest_1), 500, hr_gt6)) %>%  # Oyama PM
  replace_with_na_at(.vars = c("hr_gt6", "hr_26", "hr_2"), condition = ~ .x == 0) %>%
  mutate(
    arm_tx = as.character(arm_tx),
    arm_tx = ifelse(refid == 247 & arm_n == 42, str_c(arm_tx, "^d^"), arm_tx),
    arm_tx = ifelse(study == "Marquini 2020c" & arm_tx == "Clear", "Water^c^", arm_tx),
    # NOTE: footnote c: distilled water, 4 drops red dye, 2 drops sucrose
    iqrs = str_c("(", round_1(thirst_iqrl), "-", round_1(thirst_iqru), ")"),
    thirst_med = paste(round_1(thirst_med), iqrs),
    ranges = str_c("(", thirst_rl, "-", thirst_ru, ")"),
    mn_95_ci = str_c(round_1(thirst_m), " (", round_1(thirst95l), "-", round_1(thirst95u), ")"),
    mn_95_ci = ifelse(mn_95_ci == "NA (NA-NA)", NA, mn_95_ci),
    iqrs = ifelse(iqrs == "NA (NA-NA)", NA, iqrs),
    thirst_med = gsub(" \\(NA-NA\\)", "", thirst_med),
    thirst_scale = ifelse(refid == 1315, "5→1^g^", thirst_scale),
    # thirst_scale = ifelse(refid == 1315, str_c(thirst_scale, "HSS^e^ 1 to 5"), thirst_scale),
    # NOTE: footnote e: thirst Satiety Scale
    thirst_scale = ifelse(thirst_scale == "VAS (0-10)", "0→10", thirst_scale),
    thirst_scale = ifelse(thirst_scale == "VAS: 0 to 100", "0→100", thirst_scale),
    thirst_scale = ifelse(thirst_scale == "VAS, 0 to 100", "0→100", thirst_scale),
    thirst_scale = ifelse(thirst_scale == "VAS, 0 to 10", "0→10", thirst_scale),
    thirst_scale = ifelse(thirst_scale == "NRS, 1 to 5", "1→5 NRS", thirst_scale),
    thirst_med = ifelse(refid == 3588 & arm_n %in% c(33, 26), str_c(thirst_med, "^d^"), thirst_med)) %>%
  select(refid:arm_tx, hr_gt6, hr_26, hr_2, time_outcome, thirst_scale, mn_95_ci, thirst_med, ranges) %>%
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    thirst_scale = ifelse(row_number() == 1, thirst_scale, NA),
    time_outcome = ifelse(row_number() == 1, time_outcome, NA)) %>%
  ungroup()

```

```{r thirstAdultSurgKable, echo = FALSE}
## (updated 2020/12/14 09:51) thirstAdultSurgKable ------------------------
protein_row <- likert_prot_thirst_kbl.dat %>%
  mutate(line = row_number()) %>%
  filter(arm_tx == "Prot/CHO") %>%
  pull(line)

likert_prot_thirst_kbl.dat %>%
  # select(!c(refid, arm:age)) %>%
  select(study, arm_tx, arm_n, hr_gt6, hr_26, hr_2, time_outcome, thirst_scale, mn_95_ci, thirst_med, ranges) %>%
  add_row(study = NA, arm_tx = NA, arm_n = NA, hr_gt6 = NA, hr_26 = NA, hr_2 = NA, time_outcome = NA, thirst_scale = NA, mn_95_ci = NA, thirst_med = NA, ranges = NA) %>% 
  kbl(booktabs = T, align = c("llccccclll"), escape = FALSE,
      col.names = c(
        "\\ \\ \\ \\ \\ \\ \\ Study", "Liquid", "N",  "> 6", "6→2", "≤ 2", "Time (hr)^a^", "Scale^b^", "M (95% CI)",
        "Med (IQR)", "Range")) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Thirst Rating\n *(Between-group Comparison)*" = 5), line = TRUE) %>%
  # NOTE: footnote a: includes at 2.5 hours
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = TRUE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "8em") %>%
  column_spec(2, width = "4em") %>%
  column_spec(3, width = "2em") %>%
  column_spec(c(4:6), width = "2em") %>%
  column_spec(7, width = "5em") %>%
  column_spec(8, width = "4em") %>%
  column_spec(9, width = "5em") %>%
  column_spec(10, width = "5em") %>%
  column_spec(11, width = "4em") %>% 
  row_spec(protein_row, color = "brown") %>%
  pack_top(., "Adult, Surgical", 1, 13) %>%
  pack_sub(., "RCT", 1, 9) %>%
  pack_rows("Differences between groups not detected", 4, 4, label_row_css = "padding-left:70%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>%  
  pack_rows("P = 0.01; MD^e^≈\\ -13.3 (95% CI, -16.4 to -10.2)", 6, 6, label_row_css = "padding-left:70%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>% 
  pack_rows("MD^e^≈\\ -10.6 (95% CI, -24.6 to 3.4)", 8, 8, label_row_css = "padding-left:70%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>% 
  pack_rows("2-hr post-op MD -3.1 (95% CI, -15.8 to 9.5)", 8, 8, label_row_css = "padding-left:70%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>% 
  pack_rows("P = 0.01, MD^f^≈\\ -2.8 (95% CI, -3.0 to -2.6)", 10, 10, label_row_css = "padding-left:70%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>% 
  pack_sub(., "Nonrandomized Studies of Interventions", 10, 13) %>%
  pack_rows("dMD^e^≈\\ -0.5 (95% CI, -2.1 to 1.1)", 12, 12, label_row_css = "padding-left:70%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>% 
  pack_rows("≈MD^e^\ -1.0 (95% CI, -2.2 to 0.2)", 14, 14, label_row_css = "padding-left:70%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>% 
  footnote(general = "RCT: randomized controlled trial; M: mean; Med: median; IQR: interquartile range; NRS: numeric rating scale; MD: mean difference.",
    alphabet = c("Relative to surgery where 0 is prior to induction and other values hours postop.",
      "Arrow (→) indicates least to worst VAS unless otherwise noted.",
      "Distilled water, 4 drops red dye, 2 drops sucrose.",
      "Range as reported but apparent error being <1.",
      "Estimated using reported medians, IQRs, and ranges.",
      "Calculated from means and confidence intervals."),
    general_title = "",
    footnote_as_chunk = FALSE)

# TODO; note likert thirst outcomes not pooled due to timing of outcome assessment
rm(protein_row)
table_n <- tab_inc()
```

### \*Nausea

<br>

<font size = 4> Table `r table_n`. Occurrence of nausea according to fasting, liquid and volume. </font>

<br>

```{r nauseaTableOr, include = TRUE}
## (updated 2021/01/12 09:42) nauseaTableOr -------------------------------
dichot_format <- function(x) (x/100)

# odds ratios
# exclude single arm studies
# select refid, study, arm_tx, arm_n, outcome_n
dichot_nausea_or <- dichot_prot.dat %>% 
  filter(!is.na(nausea_np)) %>%
  select(refid, study, arm_tx, arm_n, nausea_n) %>% 
  group_by(refid) %>% 
  filter(n() > 1)

or_nausea <- with(or_join(dichot_nausea_or, "nausea"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2))
```

```{r nauseaTable, include = TRUE}
## (updated 2021/01/12 18:04) nauseaTable ---------------------------------
dichot_nausea <- dichot_prot.dat %>% 
  filter(!is.na(nausea_np)) %>%
  arrange(age, desc(surg_nosurg), design, year, study) %>% 
  select(refid:time_outcome, nausea_np, nausea_per, nausea_n)

dichot_nausea <- left_join(dichot_nausea, or_nausea, by = "refid") %>% 
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    or_ci = ifelse(row_number() == 1, or_ci, NA),
    time_outcome = ifelse(row_number() == 1, time_outcome, NA)) %>%
  ungroup() %>% 
  mutate(nausea_per = round(nausea_per, 0),
         or_ci = ifelse(or_ci == "NA (NA, NA)", NA, or_ci)) %>% 
  select(refid, arm, design, age, study, arm_n, arm_tx, starts_with("hr"), time_outcome, nausea_np, nausea_per, or_ci)

prot_row <- dichot_nausea %>%
  mutate(line = row_number()) %>%
  filter(grepl("Prot", arm_tx)) %>%
  pull(line)

dichot_nausea$nausea_bar <- 0
dichot_nausea$nausea_bar <- ifelse(grepl("Prot", dichot_nausea$arm_tx),
  color_bar("darksalmon", fun = dichot_format)(dichot_nausea$nausea_per),
  color_bar("lightgray", fun = dichot_format)(dichot_nausea$nausea_per))

dichot_nausea  <- dichot_nausea %>% 
  # add_foot(study, "Koeppe 2013", "b") %>% 
mutate(nausea_bar = str_replace(nausea_bar, ">\\d+", ">&nbsp;"))
  
dichot_nausea %>% 
  select(!c(refid, arm, design, age, nausea_per)) %>% 
  select(study:nausea_np, nausea_bar, or_ci) %>% 
  kbl(booktabs = T, align =  c("lclccccrlc"), escape = FALSE,
    col.names = c("\\ \\ \\ \\ \\ \\ \\ Study", "\\ \\ \\ N", "Liquid", "> 6", "6→2", "≤ 2", "(hr)", "N (%)", " ", "CHO vs. Fasting")) %>% 
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Time^a^" = 1, "Nausea" = 2, "OR (95% CI)"), line = TRUE) %>% 
  kable_styling(bootstrap_options = opt_boot, position = "left") %>% 
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>% 
  column_spec(1, width = "10em") %>%  
  column_spec(2, width = "3em") %>% 
  column_spec(3, width = "4em") %>% 
  column_spec(c(4:6), width = "3em") %>% 
  column_spec(7, width = "3em") %>% 
  column_spec(8, width = "4em") %>% 
  column_spec(9, width = "7em") %>% 
  column_spec(10, width = "8em") %>% 
  row_spec(prot_row, color = "brown") %>% 
  pack_top(., "Adult, Surgical", 1, 2) %>% 
  pack_sub(., "RCT", 1, 15) %>%
  pack_sub(., "Retrospective Cohort", 16, 17) %>%
  footnote(general = "RCT: randomized controlled trial; OR: odds ratio; CHO: carbohydrate; Prot: protein.",
           alphabet = c("Relative to induction or start of endocoscopy."),
           general_title = "",  
           footnote_as_chunk = FALSE)

table_n <- tab_inc()

```

<br>

### &nbsp; Pooled (adult RCTs)

<br>

<font size = 4> Figure `r figure_n`. Pooled incidence of nausea --- randomized trials comparing protein-containing drinks with fasting in adult surgical patients. </font>

```{r nauseaMeta, echo = FALSE, fig.width = 10, fig.height = 4.5, fig.align = "center"}
## (updated 2020/12/13 09:57) nauseaMeta ----------------------------------
# data
nvra_meta.dat <- dichot_prot.dat %>% 
    mutate(
    time_outcome = ifelse(time_outcome == 0, "Preop", time_outcome),
    time_outcome = ifelse(suppressWarnings(!is.na(as.numeric(time_outcome))), str_c("Postop ", time_outcome, " hrs"), time_outcome)) %>% 
  select(refid, study, year, arm_tx, nausea_n, arm_n, design, time_outcome) %>% 
  filter(design == "rct", !is.na(nausea_n), arm_tx != "CHO") %>% 
  mutate(arm_tx = as.character(arm_tx)) %>% 
  select(!design) %>% 
  arrange(year)

nvra_meta.dat <- left_join(nvra_meta.dat[c(1, 3, 5, 7, 9, 11, 13), ],
  nvra_meta.dat[c(2, 4, 6, 8, 10, 12, 14), ],
  by = c("refid", "study", "year")) %>%
  filter(arm_tx.x == "Fasting") %>% 
  mutate(post_op = ifelse(time_outcome.y == "Preop", "Preop", "Postop")) %>% 
  select(-contains("time"))

nvra_meta <- metabin(nausea_n.y, arm_n.y, nausea_n.x, arm_n.x,
  studlab = study,
  data = nvra_meta.dat,
  sm = "OR",
  method = "Inverse",
  prediction = TRUE,
  hakn = TRUE,
  method.tau = "PM",
  byvar = post_op,
  digits = 2)

forest(nvra_meta,
  comb.fixed = FALSE,
  lab.e = "Prot/CHO",
  lab.c = "Fasting",
  digits = 2,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = FALSE,
  fs.xlab = 11,
  print.subgroup.labels = TRUE,
  print.byvar = FALSE,
  test.subgroup = FALSE,
  subgroup = FALSE,
  pooled.events = TRUE,
  xlab = "Favors Protein              Favors Fasting")
  
figure_n <- fig_inc()
```

<br>

<br>

### \*Pain

<br>

<font size = 4> Table `r table_n`. Pain ratings according to fasting, liquid and volume. </font>

```{r comfortData, include = FALSE}
## (updated 2020/12/14` 14:32) comfortData ---------------------------------
# comfort studies
likert_prot_comfort.dat <- likert.dat %>%
  rename(time_outcome = likert_time_outcome) %>%
  filter(refid %in% protein_refids$refid, !is.na(comfort_l) | !is.na(pain_l)) %>%
  # filter_at(vars(thirst_m:thirst_pval), any_vars(!is.na(.))) # same
  select(refid:age, arm_n, arm_tx, time_outcome, contains("ingest"), starts_with(c("comfort", "pain")), out_l_notes) %>%
    mutate(
    # surgical studies (note none have times 0 or negative)
    # hr_2 is ≤ 2; hr_26 is (2, 6] >2 to 6; hr_gt6 is >6
    hr_2 = 0, hr_26 = 0, hr_gt6 = 0,
    hr_2 = if_else(timeingest1 <= 2 & timeingest1 > 0, amtingest1, hr_2, missing = 0),
    # FOR Du Rct add new header in table after RCT
    # hr_2 =   if_else(timeingest1 == 0, amtingest1, hr_2, missing = 0),
    hr_26 =  if_else(timeingest1 > 2 & timeingest1 < 6, amtingest1, hr_26, missing = 0),
    hr_gt6 = if_else(timeingest1 >= 6, amtingest1, hr_gt6, missing = 0),
    hr_2 =   if_else(hr_2 == 0 & timeingest2 <= 2 & timeingest2 > 0, amtingest2, hr_2, missing = 0),
    hr_26 =  if_else(hr_26 == 0 & timeingest2 > 2 & timeingest2 < 6, amtingest2, hr_26, missing = 0),
    hr_gt6 = if_else(hr_gt6 == 0 & timeingest2 >= 6, amtingest2, hr_gt6, missing = 0),
    hr_gt6 = if_else(grepl("also received 300", type_ingest_1), 500, hr_gt6),  # Oyama PM
    arm_tx = droplevels(arm_tx)) %>%
  replace_with_na_at(.vars = c("hr_gt6", "hr_26", "hr_2"), condition = ~ .x == 0) %>%
  mutate( # columns for table
    comfort95l = ifelse(is.na(comfort95l), conf_tl(comfort_m, comfort_sd, arm_n), comfort95l),
    comfort95u = ifelse(is.na(comfort95u), conf_tu(comfort_m, comfort_sd, arm_n), comfort95u),
    m_ci = ifelse(comfort_m >= 1,
      str_c(round_1(comfort_m), " (", round_1(comfort95l), "-", round_1(comfort95u), ")"),
      str_c(round_2(comfort_m), " (", round_2(comfort95l), "-", round_2(comfort95u), ")")),
    m_ci = gsub(" \\(NA-NA\\)", "", m_ci),
    med_iqr = str_c(comfort_med, " (", comfort_iqrl, "-", comfort_iqru, ")"),
    med_range = str_c("(", comfort_rl, "-", comfort_ru, ")")) %>% 
  arrange(year, study, arm_tx)
  
```

```{r comfortKable, echo = FALSE}
## (updated 2020/12/14 14:31) comfortKable --------------------------------
protein_row <- likert_prot_comfort.dat %>% 
  mutate(line = row_number()) %>% 
  filter(arm_tx == "Prot/CHO") %>% 
  pull(line)

likert_prot_comfort.dat %>%
  rename(scale_com = comfort_pain_scale) %>%
  select(study, arm_tx, arm_n, hr_gt6, hr_26, hr_2, time_outcome, scale_com, m_ci, med_iqr) %>%
  add_row(study = NA, arm_tx = NA, arm_n = NA, hr_gt6 = NA, hr_26 = NA, hr_2 = NA, time_outcome = NA, scale_com = NA, m_ci = NA, med_iqr = NA) %>%
  mutate(
    scale_com = ifelse(grepl("QoR-40 (pain)", scale_com), "QoR-40 pain^c^", scale_com),
    # scale_com = ifelse(grepl("comfort", scale_com), "QoR-40^c^  12→60 ", scale_com),
    scale_com = ifelse(grepl("unspecified", scale_com), "VAS^d^  ?→? ", scale_com),
    scale_com = ifelse(grepl("abdominal", scale_com), "VAS^e^ 0→100 ", scale_com),
    scale_com = ifelse(grepl("0 to 100 \\(pain\\)", scale_com), "VAS 0→100", scale_com),
    scale_com = ifelse(grepl("Pain VAS, 0 to 10", scale_com), "VAS 0→10", scale_com),
    time_outcome = ifelse(study == "Helminen 2019", 2, time_outcome)) %>%
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    scale_com = ifelse(row_number() == 1, scale_com, NA)) %>%
  ungroup() %>%
  mutate(scale_com = ifelse(arm_tx == "CHO" & arm_n == 43, "35→5", scale_com)) %>% 
  kbl(booktabs = T, align = c("llccccclll"), escape = FALSE,
    col.names = c(
      "\\ \\ \\ \\ \\ \\ \\ Study", "Liquid", "N",  "> 6", "6→2", "≤ 2", "Time (hr)^a^", "Scale^b^", "M (95% CI)",
      "Med (IQR)")) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Pain\n *(Between-group Comparison)*" = 4), line = TRUE) %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  column_spec(1, width = "10em") %>%
  column_spec(2, width = "4em") %>%
  column_spec(3, width = "1em") %>%
  column_spec(c(4:6), width = "2em") %>%
  column_spec(7, width = "7em") %>%
  column_spec(8, width = "8em") %>%
  column_spec(9, width = "8em") %>%
  column_spec(10, width = "8em") %>%
  row_spec(protein_row, color = "brown") %>%
  pack_top(., "Adult, Surgical", 1, 12) %>%
  pack_sub(., "RCT", 1, 12) %>%
  pack_rows("Between-group difference not detected, P = 0.49", 4, 4, label_row_css = "padding-left:60%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>% 
  pack_rows("MD 0.08 (95% CI, -0.70 to 0.86)", 6, 6, label_row_css = "padding-left:60%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>% 
    pack_rows("Between-group difference not detected, P = 0.16", 9, 9, label_row_css = "padding-left:60%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>% 
  pack_rows("MD 0.03 (-0.10 to 0.17)", 11, 11, label_row_css = "padding-left:60%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>% 
  pack_rows("MD -1.92 (95% CI, -2.15 to -1.69)", 13, 13, label_row_css = "padding-left:60%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>% 
  #pack_rows("Comfort", 1, 3, label_row_css = "padding-left:76.5%", bold = TRUE) %>%
  #pack_rows("Pain", 4, 12, label_row_css = "padding-left:77.5%", bold = TRUE) %>%
  footnote(
    general = "RCT: randomized controlled trial; Med: median; IQR: interquartile range; NRS: numeric rating scale; MD: mean difference",
    alphabet = c("Following surgery.",
      "Arrow (→) indicates best to worst.",
      "Quality of Recovery Score physical comfort domain.",
      "Did not state the range or direction of the visual analogue scale.",
      "Abdominal pain in women undergoing laparoscopic gastric bypass."),
    general_title = "",
    footnote_as_chunk = FALSE)

table_n <- tab_inc()
```

<br>


### \*Patient Satisfaction

<br>

<font size = 4> Table `r table_n`. Patient satisfaction ratings according to fasting, liquid and volume. </font>

```{r satisLikert, include = TRUE}
## (updated 2021/01/29 08:30) satisLikert ---------------------------------
# no subgroup data
likert_prot_satis.dat <-  likert.dat %>%
  filter(refid %in% protein_refids$refid) %>%
  # delete Asakura as abstracted QoR emotional
  filter(pt_satis_l == "pt_satis_l", refid != 2234) %>%
  # filter_at(vars(satis_m:satis_pval), any_vars(!is.na(.))) # same
  select(refid:age, arm_n, arm_tx, likert_time_outcome, contains("ingest"), contains("satis")) %>%
  mutate(arm_tx = droplevels(arm_tx)) %>%
  arrange(age, desc(surg_nosurg), design, year, study, arm_tx)

likert_prot_satis_kbl.dat <- likert_prot_satis.dat %>%
  rename(time_outcome = likert_time_outcome) %>%
  mutate(
    # surgical studies (note none have times 0 or negative)
    # hr_2 is ≤ 2; hr_26 is (2, 6] >2 to 6; hr_gt6 is >6
    hr_2 = 0, hr_26 = 0, hr_gt6 = 0,
    hr_2 =   if_else(timeingest1 <= 2 & timeingest1 > 0, amtingest1, hr_2, missing = 0),
    hr_26 =  if_else(timeingest1 > 2 & timeingest1 < 6, amtingest1, hr_26, missing = 0),
    hr_gt6 = if_else(timeingest1 >= 6, amtingest1, hr_gt6, missing = 0),
    hr_2 =   if_else(hr_2 == 0 & timeingest2 <= 2 & timeingest2 > 0, amtingest2, hr_2, missing = 0),
    hr_26 =  if_else(hr_26 == 0 & timeingest2 > 2 & timeingest2 < 6, amtingest2, hr_26, missing = 0),
    hr_gt6 = if_else(hr_gt6 == 0 & timeingest2 >= 6, amtingest2, hr_gt6, missing = 0),
    hr_gt6 = if_else(grepl("also received 300", type_ingest_1), 500, hr_gt6),  # Oyama PM
    arm_tx = as.character(arm_tx),
    arm_tx = ifelse(study == "Du 2017" & arm_tx == "Clear", "Juice^e^", arm_tx),
    arm_tx = ifelse(study == "Marquini 2020c" & arm_tx == "Clear", "Water^c^", arm_tx)) %>%
  replace_with_na_at(.vars = c("hr_gt6", "hr_26", "hr_2"), condition = ~ .x == 0) %>%
  # Footnote: distilled water, 4 drops red dye, 2 drops sucrose
  select(refid:arm_tx, hr_gt6, hr_26, hr_2, time_outcome, satisfaction_scale, satis_m:satis_iqru) %>%
  mutate(
    satis_med = paste0(satis_med, " (", satis_iqrl, "-", satis_iqru, ")"),
    satis_med = ifelse(satis_med == "NA (NA-NA)", NA, satis_med),
    satis_med = gsub(" \\(NA-NA\\)", "", satis_med),
    ranges = str_c("(", satis_rl, "-", satis_ru, ")"),
    mn_95_ci = str_c(round_1(satis_m), " (", round_1(satis95l), "-", round_1(satis95u), ")"),
    mn_95_ci = ifelse(mn_95_ci == "NA (NA-NA)", NA, mn_95_ci),
    # NOTE: footnote e: satis Satiety Scale
    satisfaction_scale = ifelse(satisfaction_scale == "VAS, 0 to 10", "0→10", satisfaction_scale)) %>% 
  # remove second line study identifier
  arrange(age, desc(surg_nosurg), design, year, study) %>%
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    satisfaction_scale = ifelse(row_number() == 1, satisfaction_scale, NA),
    time_outcome = ifelse(row_number() == 1, time_outcome, NA)) %>%
  ungroup()
```

```{r satisAdultSurgKable, echo = FALSE}
## (updated 2021/01/29 08:30) satisAdultSurgKable -------------------------
protein_row <- likert_prot_satis_kbl.dat %>%
  mutate(line = row_number()) %>%
  filter(arm_tx == "Prot/CHO") %>%
  pull(line)

likert_prot_satis_kbl.dat %>%
  select(study, arm_tx, arm_n, hr_gt6, hr_26, hr_2, time_outcome, satisfaction_scale, mn_95_ci, satis_med, ranges) %>%
  add_row(study = NA, arm_tx = NA, arm_n = NA, hr_gt6 = NA, hr_26 = NA, hr_2 = NA, time_outcome = NA, satisfaction_scale = NA, mn_95_ci = NA, satis_med = NA, ranges = NA) %>% 
  kbl(booktabs = T, align = c("llcccccccc"), escape = FALSE,
      col.names = c(
        "\\ \\ \\ \\ \\ \\ \\ Study", "Liquid", "N",  "> 6", "6→2", "≤ 2", "Time (hr)^a^", "Scale^b^", "M (95% C)",
        "Med", "Range")) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Satisfaction Rating\n *(Between-group Comparison)*" = 5), line = TRUE) %>%
  # NOTE: footnote a: includes at 2.5 hours
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "8em") %>%
  column_spec(2, width = "4em") %>%
  column_spec(3, width = "2em") %>%
  column_spec(c(4:6), width = "2em") %>%
  column_spec(7, width = "5em") %>%
  column_spec(8, width = "5em") %>%
  column_spec(9, width = "6em") %>%
  column_spec(10, width = "6em") %>%
  column_spec(11, width = "6em") %>% 
  row_spec(protein_row, color = "brown") %>%
  pack_top(., "Adult, Surgical", 1, 2) %>%
  pack_sub(., "RCT", 1, 2) %>%
  pack_rows("P = 0.01; MD^d^\\ 1.76 (95% CI, 1.59 to 1.93)", 3, 3, label_row_css = "padding-left:62%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>% 
  #pack_rows("MD^g^\\ ≈ -11.2 (95% CI, -21.9 to -0.4)", 5, 5, label_row_css = "padding-left:70%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>%
  #pack_rows("2-hr post-op MD 2.8 (95% CI, -8.1 to 13.7)", 5, 5, label_row_css = "padding-left:70%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>%
  #pack_rows("P = 0.4; MD^h^ -1.8 (95% CI, -2.0, -1.5)", 7, 7, label_row_css = "padding-left:70%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>%
  #pack_rows("MD^g^\\ ≈ 0.5 (95% CI, -1.1 to 2.1)", 9, 9, label_row_css = "padding-left:70%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>% 
  #pack_rows("MD^g^\\ ≈ 1.0 (95% CI, -0.4 to 2.4)", 11, 11, label_row_css = "padding-left:70%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>%
  #pack_rows("CHO vs. apple juice or milk, p=0.78", 14, 14, label_row_css = "padding-left:70%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>%
  #pack_sub(., "Nonrandomized Studies of Interventions", 7, 10) %>%
  #pack_top(., "Pediatric, Nonsurgical (age 8-14 years)", 11, 13) %>%
  #pack_rows("0 hr", 11, 13, label_row_css = "padding-left:45%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE) %>%
  footnote(
    general = "RCT: randomized controlled trial; M: mean; Med: median; MD: mean difference.",
    alphabet = c(
      "When outcome assessed relative to surgery where 0 is prior to induction.",
      "Visual analogue scale with arrow (→) indicating low to high patient satisfaction.",
      "Distilled water, 4 drops red dye, 2 drops sucrose.",
      "Calculated from means and confidence intervals."),
    general_title = "",
    footnote_as_chunk = FALSE)

table_n <- tab_inc()
```

<br>

## Healthy Volunteer Studies

<br>

### \*Nausea

<br>

<font size = 4> Table `r table_n`. Occurrence of nausea in crossover studies of adult healthy volunteers. </font>

```{r dichotNonsurg}
## (updated 2020/12/13 09:55) dichotProtData ------------------------------
# dichot_prot_studies <- dichot.dat %>% group_by(refid) %>% slice(1) 
# timeingest1 = ifelse(timeingest1 == 99, 12, timeingest1), timeingest2 = ifelse(timeingest2 == 99, 12, timeingest2),
dichot_prot_nonsurg.dat <- dichot.dat %>%
  mutate(
    # surgical studies (note none have times 0 or negative)
    # hr_2 is ≤ 2; hr_26 is (2, 6] >2 to 6; hr_gt6 is >6
    hr_2 = 0, hr_26 = 0, hr_gt6 = 0,
    hr_2 =   if_else(timeingest1 <= 2 & timeingest1 > 0, amtingest1, hr_2, missing = 0),
    hr_26 =  if_else(timeingest1 > 2 & timeingest1 < 6, amtingest1, hr_26, missing = 0),
    hr_gt6 = if_else(timeingest1 >= 6, amtingest1, hr_gt6, missing = 0),
    hr_2 =   if_else(hr_2 == 0 & timeingest2 <= 2 & timeingest2 > 0, amtingest2, hr_2, missing = 0),
    hr_26 =  if_else(hr_26 == 0 & timeingest2 > 2 & timeingest2 < 6, amtingest2, hr_26, missing = 0),
    hr_gt6 = if_else(hr_gt6 == 0 & timeingest2 >= 6, amtingest2, hr_gt6, missing = 0),
    hr_gt6 = if_else(grepl("also received 300", type_ingest_1), 500, hr_gt6),  # Oyama PM
    # for nonsurgical
    hr_0 = 0, hr_minus2 = 0,
    hr_0 =      if_else(surg_nosurg != "surgical" & timeingest1 ==  0, amtingest1, hr_0, missing = 0),
    hr_minus2 = if_else(surg_nosurg != "surgical" & timeingest1 == -2, amtingest1, hr_minus2, missing = 0),
    hr_0 =      if_else(surg_nosurg != "surgical" & timeingest2 ==  0, amtingest1, hr_0, missing = 0),
    hr_minus2 = if_else(surg_nosurg != "surgical" & timeingest2 == -2, amtingest1, hr_minus2, missing = 0)) %>% 
  replace_with_na_at(.vars = c("hr_gt6", "hr_26", "hr_2", "hr_0", "hr_minus2"), condition = ~ .x == 0) %>%
  filter(surg_nosurg == "non-surgical") %>% 
  # select(refid, study, hr_2, hr_26, hr_gt6, timeingest1, amtingest1, timeingest2, amtingest2, age, design)
  mutate(
    hunger_np = n_percent(hunger_n, hunger_per),
    thirst_np = n_percent(thirst_n, thirst_per),
    nausea_np = n_percent(nausea_n, nausea_per),
    vomit_np = n_percent(vomit_n, vomit_per),
    comfort_np = n_percent(arm_n - comfort_n, 100 - comfort_per),
    satisfac_np = n_percent(satisfac_n, satisfac_per),
    complicate_np = n_percent(complicate_n, complicate_per),
    hypotension_np = n_percent(hypotension_n, hypotension_per),
    regurg_np = n_percent(regurg_n, regurg_per),
    rgv_gt25_np = n_percent(rgv_gt25_n, rgv_gt25_per),
    ph_lt25_np = n_percent(ph_lt25_n, ph_lt25_per),
    aspirate_np = n_percent(aspirate_n, aspirate_per),
    vomit_np = ifelse(refid == 6446 & arm_n == 40, "4 (10)", vomit_np)) %>%
  arrange(age, desc(surg_nosurg), design, year, study, arm_tx, arm) %>%
  select(refid, study, year, age, design, surg_nosurg, arm, arm_n, arm_tx, hr_gt6, hr_26, hr_2, time_outcome, hunger_np:aspirate_np, compl_descript, out_dichot_notes, ends_with("_n"), timeingest1, amtingest1, timeingest2, amtingest2, ends_with("per")) %>%
  filter_at(vars(hunger_np:aspirate_np), any_vars(!is.na(.)))
```

```{r dichotProtCrossKbl, include = TRUE}
## (updated 2020/12/13 09:57) dichotProtCrossKbl --------------------------
dichot_prot_cross <- dichot_prot_nonsurg.dat %>% 
  filter(design == "crossover") %>% 
  select(refid:arm_tx, timeingest1, amtingest1, time_outcome, nausea_np) %>% 
  rename(hr = amtingest1) %>% 
  select(!c(refid, year, age, design, surg_nosurg, arm, timeingest1)) %>% 
  group_by(study) %>%
  mutate(study = ifelse(row_number() == 1, study, NA),
         time_outcome = ifelse(row_number() == 1, time_outcome, NA)) %>%
  ungroup() 

protein_row <- dichot_prot_cross %>% 
  mutate(line = row_number()) %>% 
  filter(arm_tx == "Prot/CHO") %>% 
  pull(line)

dichot_prot_cross %>% 
  select(study, arm_tx, arm_n, hr, time_outcome, nausea_np) %>% 
  kbl(booktabs = T, align =  c("lllclc"), escape = FALSE,
    col.names = c("\\ \\ \\ \\ \\ \\ \\ Study", "Liquid", "N","Ingested (mL)", "Time Assessed", "N (%)")) %>% 
  kable_styling(bootstrap_options = opt_boot, full_width = FALSE, position = "left") %>% 
  kable_classic(position = "left", full_width = FALSE, html_font = opt_font, "hover") %>% 
  column_spec(1, width = "10em") %>%  
  column_spec(2, width = "5em") %>% 
  column_spec(3, width = "2em") %>% 
  column_spec(4, width = "6em") %>% 
  column_spec(5, width = "9em") %>% 
  column_spec(6, width = "4em") %>% 
  row_spec(protein_row, color = "brown") %>% 
  pack_top(., "Adult, Nonsurgical", 1, 5) %>% 
  pack_sub(., "Crossover", 1, 5) %>% 
    footnote(
    general = "CHO: carbohydrate; Prot: protein",
    general_title = "",
    footnote_as_chunk = FALSE)

  table_n <- tab_inc()
```

<br><br>

# Clinical Outcomes

```{r dataDichot, echo = FALSE}
## (updated 2021/02/02 15:30) dataDichot ----------------------------------
dichot_prot.dat <- dichot.dat %>%
  mutate(
    # surgical studies (note none have times 0 or negative)
    # hr_2 is ≤ 2; hr_26 is (2, 6] >2 to 6; hr_gt6 is >6
    hr_2 = 0, hr_26 = 0, hr_gt6 = 0,
    hr_2 =   if_else(timeingest1 <= 2 & timeingest1 > 0, amtingest1, hr_2, missing = 0),
    hr_26 =  if_else(timeingest1 > 2 & timeingest1 < 6, amtingest1, hr_26, missing = 0),
    hr_gt6 = if_else(timeingest1 >= 6, amtingest1, hr_gt6, missing = 0),
    hr_2 =   if_else(hr_2 == 0 & timeingest2 <= 2 & timeingest2 > 0, amtingest2, hr_2, missing = 0),
    hr_26 =  if_else(hr_26 == 0 & timeingest2 > 2 & timeingest2 < 6, amtingest2, hr_26, missing = 0),
    hr_gt6 = if_else(hr_gt6 == 0 & timeingest2 >= 6, amtingest2, hr_gt6, missing = 0),
    hr_gt6 = if_else(grepl("also received 300", type_ingest_1), 500, hr_gt6), # %>%  # Oyama PM
    # for nonsurgical
    hr_0 = 0, hr_minus2 = 0,
    hr_0 =      if_else(surg_nosurg != "surgical" & timeingest1 ==  0, amtingest1, hr_0, missing = 0),
    hr_minus2 = if_else(surg_nosurg != "surgical" & timeingest1 == -2, amtingest1, hr_minus2, missing = 0),
    hr_0 =      if_else(surg_nosurg != "surgical" & timeingest2 ==  0, amtingest1, hr_0, missing = 0),
    hr_minus2 = if_else(surg_nosurg != "surgical" & timeingest2 == -2, amtingest1, hr_minus2, missing = 0)) %>% 
  replace_with_na_at(.vars = c("hr_gt6", "hr_26", "hr_2"), condition = ~ .x == 0) %>%
  # filter(surg_nosurg == "surgical") %>% 
  # select(refid, study, hr_2, hr_26, hr_gt6, timeingest1, amtingest1, timeingest2, amtingest2, age, design)
  mutate(
    hunger_np = n_percent(hunger_n, hunger_per),
    thirst_np = n_percent(thirst_n, thirst_per),
    nausea_np = n_percent(nausea_n, nausea_per),
    vomit_np = n_percent(vomit_n, vomit_per),
    comfort_np = n_percent(arm_n - comfort_n, 100 - comfort_per),
    satisfac_np = n_percent(satisfac_n, satisfac_per),
    complicate_np = n_percent(complicate_n, complicate_per),
    hypotension_np = n_percent(hypotension_n, hypotension_per),
    regurg_np = n_percent(regurg_n, regurg_per),
    rgv_gt25_np = n_percent(rgv_gt25_n, rgv_gt25_per),
    ph_lt25_np = n_percent(ph_lt25_n, ph_lt25_per),
    aspirate_np = n_percent(aspirate_n, aspirate_per),
    vomit_np = ifelse(refid == 6446 & arm_n == 40, "4 (10)", vomit_np)) %>%
  arrange(age, desc(surg_nosurg), design, year, study, arm_tx, arm) %>%
  select(refid, study, year, age, design, surg_nosurg, arm, arm_n, arm_tx, hr_gt6, hr_26, hr_2, time_outcome, hunger_np:aspirate_np, compl_descript, out_dichot_notes, ends_with("_n"), timeingest1, amtingest1, timeingest2, amtingest2, ends_with("per")) 
```

<br>

## *Aspiration

<br>

<font size = 4> Table `r table_n`. Studies reporting no occurrence of aspiration and participants according to liquid received. </font>

```{r aspirateTableReport, include = TRUE}
## (updated 2021/01/12 18:04) aspirateTableReport -------------------------
dichot_prot.dat %>% 
  filter(!is.na(aspirate_np)) %>%
  filter(surg_nosurg == "surgical") %>% 
  arrange(age, desc(surg_nosurg), design, year, study) %>% 
  select(refid, design, age, study, arm_n, arm_tx) %>% 
  pivot_wider(id_cols = c(refid, study, age, design), names_from = arm_tx, values_from = arm_n) %>% 
  filter(!refid %in% c(6446, 247)) %>% 
  mutate(study = ifelse(refid == 165, "Marquini 2020", study)) %>% 
  select(study, Fasting:Clear) %>% 
  select(study, Fasting, Water, Clear, CHO, "Prot/CHO") %>% 
  janitor::adorn_totals(c("col", "row"), fill = "-", na.rm = TRUE) %>% 
  kbl(booktabs = T, align =  c("lcccccr"), escape = FALSE,
    col.names = c("\\ \\ \\ \\ \\ \\ \\ Study", "Fasting", "Water", "Clear", "CHO", "Prot/CHO", "Total")) %>% 
  add_header_above(c(" " = 1, "Liquid" = 5, " " = 1), line = TRUE) %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>% 
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>% 
  column_spec(1, width = "10em") %>%  
  column_spec(2:6, width = "5em") %>% 
  column_spec(7, width = "5em") %>% 
  row_spec(13, bold = TRUE) %>% 
  #pack_top(., "Adult, Surgical", 1, 2) %>% 
  #pack_sub(., "RCT", 1, 15) %>%
  #pack_sub(., "Retrospective Cohort", 16, 17) %>%
  footnote(general = "CHO: carbohydrate; Prot: protein.",
           general_title = "",  
           footnote_as_chunk = FALSE)
table_n <- tab_inc()
```

<font size = 4> Table `r table_n`. Studies not reporting whether or aspiration occurred. </font>

```{r aspirateTableNoReport, include = TRUE}
## (updated 2021/01/12 18:04) aspirateTableReport -------------------------

dichot_prot.dat %>% 
  filter(is.na(aspirate_np)) %>%
  filter(surg_nosurg == "surgical") %>% 
  arrange(age, desc(surg_nosurg), design, year, study) %>% 
  select(refid, design, age, study, arm_n, arm_tx) %>% 
  pivot_wider(id_cols = c(refid, study, age, design), names_from = arm_tx, values_from = arm_n) %>% 
  select(study, Fasting, Water, CHO, "Prot/CHO") %>% 
  janitor::adorn_totals(c("col", "row"), fill = "-", na.rm = TRUE) %>% 
    kbl(booktabs = T, align =  c("lccccr"), escape = FALSE,
    col.names = c("\\ \\ \\ \\ \\ \\ \\ Study", "Fasting", "Water", "CHO", "Prot/CHO", "\\ \\ Total")) %>% 
  add_header_above(c(" " = 1, "Liquid" = 4, " " = 1), line = TRUE) %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>% 
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>% 
  column_spec(1, width = "10em") %>%  
  column_spec(2:5, width = "5em") %>% 
  column_spec(6, width = "5em") %>% 
  row_spec(10, bold = TRUE) %>% 
  #pack_top(., "Adult, Surgical", 1, 2) %>% 
  #pack_sub(., "RCT", 1, 15) %>%
  #pack_sub(., "Retrospective Cohort", 16, 17) %>%
  footnote(general = "CHO: carbohydrate; Prot: protein.",
           general_title = "",  
           footnote_as_chunk = FALSE)

table_n <- tab_inc()

```

## Regurgitation

<br>

## Vomiting 

<br>

## Complications

<br>

## Residual Gastric Volume

<br>

### Surgical Studies

<br>
{#rgv_surg_result}

<font size = 4> Table `r table_n`. Residual gastric volumes at induction in randomized controlled trials of adult surgical patients according to fasting, liquid and volume. </font>

```{r rgvTable, include = FALSE}
## (updated 2020/12/15 07:54) rgvTable ------------------------------------
# no specified subgroup data (2020/12/15 06:24)
rgv_surg.dat <- contin.dat %>%
  filter(refid %in% protein_refids$refid) %>%
  select(refid:age, arm_n, arm_tx, timeingest1, amtingest1, timeingest2, amtingest2, type_ingest_1, starts_with("rgv"), notes_continuous) %>%
  filter(!is.na(rgv_us) | !is.na(rgv_imag) | !is.na(rgv_asp)) %>%
  # filter_at(vars(rgv_time_1:rgv_pval_2), any_vars(!is.na(.))) # same
  mutate(
    # surgical studies (note none have times 0 or negative)
    # hr_2 is ≤ 2; hr_26 is (2, 6] >2 to 6; hr_gt6 is >6
    hr_2 = 0, hr_26 = 0, hr_gt6 = 0,
    hr_2 =   if_else(timeingest1 <= 2 & timeingest1 > 0, amtingest1, hr_2, missing = 0),
    hr_26 =  if_else(timeingest1 > 2 & timeingest1 < 6, amtingest1, hr_26, missing = 0),
    hr_gt6 = if_else(timeingest1 >= 6, amtingest1, hr_gt6, missing = 0),
    hr_2 =   if_else(hr_2 == 0 & timeingest2 <= 2 & timeingest2 > 0, amtingest2, hr_2, missing = 0),
    hr_26 =  if_else(hr_26 == 0 & timeingest2 > 2 & timeingest2 < 6, amtingest2, hr_26, missing = 0),
    hr_gt6 = if_else(hr_gt6 == 0 & timeingest2 >= 6, amtingest2, hr_gt6, missing = 0),
    hr_gt6 = if_else(grepl("also received 300", type_ingest_1), 500, hr_gt6), # Oyama 2011
    arm_tx = droplevels(arm_tx)) %>%
    replace_with_na_at(.vars = c("hr_gt6", "hr_26", "hr_2"), condition = ~ .x == 0) %>%
  filter(surg_nosurg == "surgical") %>% 
  mutate(
    study = ifelse(study == "Oyama 2011" & grepl("AM", notes_continuous), "Oyama 2011 (AM)^a^", study),
    study = ifelse(study == "Oyama 2011" & grepl("PM", notes_continuous), "Oyama 2011 (PM)^a^", study),
    rgv_type_meas = case_when(
      rgv_type_meas == "aspiration" ~ "Asp",
      rgv_type_meas == "ultrasound" ~ "US",
      rgv_type_meas == "imaging" ~ "MRI"),
    rgv_iqr_low_1 = ifelse(rgv_iqr_low_1 >= 10, round_0(rgv_iqr_low_1), round_1(rgv_iqr_low_1)),
    rgv_iqr_up_1 = ifelse(rgv_iqr_up_1 >= 10, round_0(rgv_iqr_up_1), round_1(rgv_iqr_up_1)),
    rgv_iqr = str_c("(", rgv_iqr_low_1, "-", rgv_iqr_up_1, ")"),
    rgv_range = str_c("(", round_0(rgv_range_low_1), "-", round_0(rgv_range_up_1), ")"),
    rgv_range = na_if(rgv_range, "(NA-NA)"),
    rgv_mean_1 = ifelse(study == "Du 2017", round_2(rgv_mean_1), round_1(rgv_mean_1)),
    rgv_mean_1 = suppressWarnings(ifelse(study == "Gomes 2017", round_1(as.numeric(rgv_mean_1)), rgv_mean_1)),
    rgv_sd_1 = ifelse(study == "Gomes 2017", round_1(rgv_sd_1), rgv_sd_1),
    rgv_mean = ifelse(!is.na(rgv_sd_1) & !is.na(rgv_mean_1), str_c(rgv_mean_1, " (", rgv_sd_1, ")"), rgv_mean_1),
    rgv_mean = na_if(rgv_mean, "NA"),
    rgv_med = str_c(round(rgv_median_1, 0), rgv_iqr, sep = " ")) %>%
  arrange(age, desc(surg_nosurg), design, year, study, arm_tx) %>%
  group_by(study) %>%
  mutate(
    id = row_number(),
    study = ifelse(id > 1, NA, study),
    rgv_type_meas = ifelse(id > 1, NA, rgv_type_meas)) %>%
  ungroup() %>%
  filter(surg_nosurg == "surgical") %>% 
  select(refid, age, design, surg_nosurg, study, arm_tx, arm_n, hr_gt6, hr_26, hr_2, rgv_type_meas, rgv_time_1, rgv_mean, rgv_med, rgv_range)
```

```{r rgvKable, echo = FALSE}
## (updated 2020/12/15 08:32) rgvKable ------------------------------------
protein_row <- rgv_surg.dat %>% 
  mutate(line = row_number()) %>% 
  filter(arm_tx == "Prot/CHO") %>% 
  pull(line)

rgv_surg.dat %>%
  select(!c(refid:surg_nosurg, rgv_time_1)) %>% 
  kbl(booktabs = T, align = c("llcccccccc"), escape = FALSE,
    col.names = c("\\ \\ \\ \\ \\ \\ \\ Author", "Liquid", "N", "> 6", "6→2", "≤ 2", "Measure", "M (SD)", 
      "Med (IQR)", "Range")) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "RGV" = 1, "RGV (mL)" = 3), line = TRUE) %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  row_spec(protein_row, color = "brown") %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  column_spec(1, width = "12em") %>%
  column_spec(2, width = "6em") %>%
  column_spec(3, width = "4em") %>%
  column_spec(c(4:6), width = "3em") %>%
  column_spec(7, width = "3em") %>%
  column_spec(8, width = "6em") %>%
  column_spec(9, width = "7em") %>%
  column_spec(10, width = "6em") %>%
  pack_top(., "Adult, Surgical", 1, 15) %>%
  pack_sub(., "RCT", 1, 9) %>%
  pack_sub(., "Nonrandomized Studies of Interventions", 10, 15) %>%
  footnote(general = "RGV: residual gastric volumne; Med: median; IQR: interquartile range; CHO: carbohydrate; RCT: randomized controlled trial; Asp: aspiration.",
    general_title = "",
    footnote_as_chunk = FALSE)

  table_n <- tab_inc()
```

<br>

### &nbsp; Pooled Results

<font size = 4> Figure `r figure_n`. Forest plot for pooled mean difference estimate of residual gastric volume in randomized and non-randomized trials of adult surgical patients -- fasted and those given protein-containing drinks. </font>

```{r metaForestSurg, echo = FALSE, fig.width = 10, fig.height = 5, fig.align = "top"}
## (updated 2020/12/15 11:05) metaForestSurg ------------------------------
rgv_meta.dat <- contin.dat %>%
  arrange(design, year, study) %>% 
  filter(refid %in% protein_refids$refid, surg_nosurg == "surgical") %>%
  filter(arm_tx == "Fasting" | arm_tx == "Prot/CHO") %>%
  filter(!is.na(rgv_us) | !is.na(rgv_imag) | !is.na(rgv_asp)) %>%
  mutate(design = ifelse(design == "nrsi", "Non-randomized", "RCT")) %>%
  select(refid, study, year, design, arm_n, arm_tx, rgv_mean_1, rgv_sd_1, rgv_median_1:rgv_iqr_up_1) 

rgv_meta.dat <- left_join(rgv_meta.dat[c(1,3,5,7,9,11), ], rgv_meta.dat[c(2,4,6,8,10,12), ], 
                          by = c("refid", "study", "year"))
  
rgv_meta <- metacont(n.e = arm_n.x, n.c = arm_n.y, 
         median.e = rgv_median_1.x, 
         mean.e = rgv_mean_1.x,
         sd.e = rgv_sd_1.x,
         q1.e = rgv_iqr_low_1.x, 
         q3.e = rgv_iqr_up_1.x,
         min.e = rgv_range_low_1.x,
         max.e = rgv_range_up_1.x,
         mean.c = rgv_mean_1.y,
         sd.c = rgv_sd_1.y,
         median.c = rgv_median_1.y, 
         q1.c = rgv_iqr_low_1.y, 
         q3.c = rgv_iqr_up_1.y,
         min.c = rgv_range_low_1.y,
         max.c = rgv_range_up_1.y,
         data = rgv_meta.dat,
         byvar = design.x,
         studlab = study)

forest(rgv_meta, 
       comb.random = TRUE,
       lab.e = "Prot/CHO     ",
       lab.c = "Fasting     ",
       digits = 2,
       digits.sd = 2,
       digits.tau2 = 1,
       overall.hetstat = FALSE,
       print.I2.ci = TRUE,
       print.byvar = FALSE,
       overall = FALSE,
       fs.xlab = 11,
       xlab = "RGV (mL)\n Favors Prot/CHO              Favors Fasting")

figure_n <- fig_inc()
```

Mean differences estimated from from reported medians, interquartile and overall ranges.

<br>

### Nonsurgical Studies 

<br>

<font size = 4> Table `r table_n`. Residual gastric volumes in randomized controlled trials of nonsurgical healthy volunteers according to fasting, liquid and volume. </font>

```{r rgvNonsurgTable, echo = FALSE}
## (updated 2020/12/15 10:23) rgvNonsurgTable -----------------------------
rgv_nonsurg.dat <- contin.dat %>%
  filter(refid %in% protein_refids$refid) %>%
  select(refid:age, arm_n, arm_tx, timeingest1, amtingest1, timeingest2, amtingest2, type_ingest_1, starts_with("rgv"), notes_continuous) %>%
  filter(!is.na(rgv_us) | !is.na(rgv_imag) | !is.na(rgv_asp)) %>%
  filter(surg_nosurg == "non-surgical") %>% 
  mutate(
    hr_2 = 0, hr_0 = 0, 
    hr_2 = if_else(abs(timeingest1) == 2, amtingest1, hr_2, missing = 0), # crossover abs
    hr_0 = if_else(timeingest1 == 0, amtingest1, hr_0, missing = 0), # crossover
    hr_2 = if_else(hr_2 == 0 & abs(timeingest2) == 2, amtingest2, hr_2, missing = 0), # crossover abs
    hr_0 = if_else(hr_0 == 0 & timeingest2 == 0, amtingest2, hr_0, missing = 0), # crossover
    arm_tx = droplevels(arm_tx)) %>%
  replace_with_na_at(.vars = c("hr_2", "hr_0"), condition = ~ .x == 0) %>%
  mutate(rgv_type_meas = case_when(
      rgv_type_meas == "aspiration" ~ "Asp",
      rgv_type_meas == "ultrasound" ~ "US",
      rgv_type_meas == "imaging" ~ "MRI"))

## (updated 2020/12/15 10:24) rgv_no_table --------------------------------
rgv_no_table <- rgv_nonsurg.dat %>%
  select(
    refid, arm, study, year, age, arm_n, arm_tx, design, surg_nosurg, arm_tx, timeingest1, amtingest1,
    timeingest2, amtingest2, everything()) %>%
  arrange(age, desc(surg_nosurg), design, year, study, arm_tx) %>% 
  select(!type_ingest_1) %>%
  rename(time_1_rgv = rgv_time_1, time_2_rgv = rgv_time_2) %>%
  pivot_wider(names_from = time_1_rgv, values_from = rgv_mean_1:rgv_iqr_up_1) %>%
  pivot_wider(names_from = time_2_rgv, values_from = rgv_mean_2:rgv_iqr_up_2) %>%
  select(!ends_with("NA")) %>%
  rename_with(~ gsub("_95_", "_ci_", .x, fixed = TRUE)) %>%
  rename_with(~ gsub("rgv_", "", .x, fixed = TRUE)) %>%
  # reorder to facilitate select final digit is hour of measurement variable_1/2_hr
  select(refid:surg_nosurg, type_meas, hr_2, hr_0, ends_with("_1"), ends_with("_2"), ends_with("_3")) %>%
  # select(!median_1_2) %>%
  mutate(
    mean_1_2 = coalesce(mean_1_2, mean_2_2),
    sd_1_2 = coalesce(sd_1_2, sd_2_2),
    ci_low_1_2 = coalesce(ci_low_1_2, ci_low_2_2),
    ci_up_1_2 = coalesce(ci_up_1_2, ci_up_2_2),
    iqr_low_1_2 = coalesce(iqr_low_1_2, iqr_low_2_2),
    iqr_up_1_2 = coalesce(iqr_up_1_2, iqr_up_2_2),
    range_low_1_2 = coalesce(range_low_1_2, range_low_2_2),
    range_up_1_2 = coalesce(range_up_1_2, range_up_2_2),
    median_1_2 = coalesce(median_1_2, median_2_2)) %>%
  # rename(median_1_2 = median_2_2) %>% # no median_1_2 values
  # removed coalesced columns
  select(!ends_with("_2_2")) %>% 
  # select(!ends_with("_2_3")) %>% 
  # select(!(mean_2_2:ci_up_2_2)) %>%
  # select(!(range_low_2_2:iqr_up_2_2)) %>%
  janitor::remove_empty(which = "cols") %>%
  # rename to remove data point 1, 2, 3
  rename_with(~ gsub("_1_", "_", .x, fixed = TRUE)) %>%
  rename_with(~ gsub("_2_", "_", .x, fixed = TRUE)) %>%
  # rename_with(~ gsub("_3_", "_", .x, fixed = TRUE)) %>%
  rename_with(~ gsub("mean_", "m_", .x, fixed = TRUE)) %>%
  rename_with(~ gsub("median_", "med_", .x, fixed = TRUE)) %>%
  # calculate sd if missing and ci reported
  mutate(
    sd_1 = ifelse(is.na(sd_1) & !is.na(ci_low_1), sd_confint(ci_low_1, ci_up_1), sd_1),
    sd_2 = ifelse(is.na(sd_2) & !is.na(ci_low_2), sd_confint(ci_low_2, ci_up_2), sd_2)) %>%
  # keep range and iqr but display only iqr
  select(refid, arm, study, year, age, design, arm_tx, arm_n, type_meas, hr_2, hr_0, m_1, sd_1, m_2, sd_2, m_3, sd_3, med_1, iqr_low_1, iqr_up_1, range_low_1, range_up_1, med_2, iqr_low_2, iqr_up_2, range_low_2, range_up_2)
```

```{r rgvNonsurgKable, echo = FALSE}
## (updated 2020/12/15 10:24) rgvNonsurgKable -----------------------------
protein_row <- rgv_no_table %>% 
  mutate(line = row_number()) %>% 
  filter(arm_tx == "Prot/CHO") %>% 
  pull(line)

rgv_no_table %>% 
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    type_meas = ifelse(row_number() == 1, type_meas, NA)) %>%
  ungroup() %>%
  mutate(
    arm_tx = as.character(arm_tx), 
    arm_tx = ifelse(refid == 1315 & arm_tx == "Clear", "Apple juice", arm_tx),
    msd1 = str_c(round_1(m_1), " (", round_1(sd_1), ")"),
    msd2 = str_c(round_1(m_2), " (", round_1(sd_2), ")"),
    msd1 = ifelse(refid == 1315, str_c(round_2(m_1), " (", round_2(sd_1), ")"), msd1),
    msd2 = ifelse(refid == 1315, str_c(round_2(m_2), " (", round_2(sd_2), ")"), msd2),
    msd3 = str_c(round_1(m_3), " (", round_1(sd_3), ")"),
    med1 = str_c(round(med_1, 0), " (", round(iqr_low_1, 0), "-", round(iqr_up_1, 0), ")"),
    # Nakamura med and add range for hr 2
    msd1 = ifelse(refid == 2703, paste0(round_0(med_1), " (", round_0(iqr_low_1), ", ", round_0(iqr_up_1), ")"), msd1),
    msd2 = ifelse(refid == 2703, paste0(round_0(med_2), " [", range_low_2, ", ", range_up_2, "]"), msd2),
    msd2 = ifelse(refid == 6280, paste0(round_0(med_2), " (", round_0(iqr_low_2), ", ", round_0(iqr_up_2), ")" ), msd2),
    msd1 = na_if(msd1, "NA (NA)"),
    msd2 = na_if(msd2, "NA (NA)"),
    msd3 = na_if(msd3, "NA (NA)")) %>%
  mutate(
    add_foot(., study, "Du 2017", "a"),
    msd1 = replace_na(msd1, ""),
    msd1 = cell_spec(msd1, underline = (ifelse(refid == 2703, TRUE, FALSE))),
    msd2 = cell_spec(msd2, underline = (ifelse(refid == 2703, TRUE, FALSE)))) %>%
  select(study, arm_tx, arm_n, hr_2, hr_0, type_meas, msd1:msd3, -age, -design) %>%
    add_row() %>% 
  kbl(
    booktabs = T, align = c("lllcccccc"), escape = FALSE,
    col.names = c("\\ \\ \\ \\ \\ \\ \\ Study", "Liquid", "N", "2 hr", "0 hr", "Measure", "1 hr", "2 hr", "3 hr")) %>%
  add_header_above(c(" " = 3, "Liquid Volume (mL)" = 2, "RGV" = 1, "Mean RGV (SD) (mL)" = 3), line = TRUE) %>%
  add_header_above(c(" " = 6, "Median RGV (IQR) [Range] (mL)" = 3), underline = TRUE, line = TRUE) %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  column_spec(1, width = "11em") %>%
  column_spec(2, width = "6em") %>%
  column_spec(3, width = "4em") %>%
  column_spec(c(4:5), width = "5em") %>%
  column_spec(6, width = "6em") %>%
  column_spec(7, width = "7em") %>%
  column_spec(8, width = "8em") %>%
  column_spec(9, width = "7em") %>%
  pack_top(., "Adult, Nonsurgical", 1, 2) %>%
  pack_sub(., "RCT", 1, 2) %>%
  pack_sub(., "Crossover", 3, 13) %>%
  pack_top(., "Pedatric, Nonsurgical", 14, 16) %>%
  pack_rows("Proportion of Baseline Gastric Antral CSA", 14, 16, label_row_css = "padding-left:63%", bold = FALSE) %>%
  pack_sub(., "RCT", 14, 16) %>%
  pack_rows("Prot/CHO vs Juice, MD 0.07 (95% CI, 0.04 to 0.11)", 17, 17, label_row_css = "padding-left:64%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>% 
  row_spec(protein_row, color = "brown") %>%
  footnote(
    general = "RGV: residual gastric volumne; IQR: interquartile range; M: mean; SD: standard deviation; CHO: carbohydrate; MRI: magnetic resonance imaging; US: ultrasound; CSA: cross-sectional area.",
    general_title = "",
    alphabet = c("Authors reported similar clearances of all 3 liquids in terminal emptying phase (eg, 120 to 180 minutes)."),
    footnote_as_chunk = FALSE) 

 table_n <- tab_inc()
```

<br>

### &nbsp; Pooled Results

<br>

<font size = 4> Figure `r figure_n`. Forest plot for pooled mean difference in residual gastric volume in crossover trials of adult nonsurgical patients at 2 hours --- protein and carbohydrate versus carbohydrate drinks. </font>
  
```{r metaNonsurg, echo = FALSE, fig.width = 10, fig.height = 3.5, fig.align = "center"} 
# 1 hour
rgv_no_2hr <- rgv_no_table %>% 
  filter(age == "Adult", design == "crossover") %>% 
  filter(arm != 3) %>% 
  select(refid, study, year, age, design, arm_tx, arm_n, m_2, sd_2, med_2, iqr_low_2, iqr_up_2, range_low_2, range_up_2) %>% 
  mutate(study = ifelse(study == "Nakamura 2014", "Nakamura 2014ᵇ", study),
         study = ifelse(study == "Lobo 2009", "Lobo 2009ª", study))

rgv_meta.dat <- left_join(rgv_no_2hr[c(2,4,6,8,10), ], rgv_no_2hr[c(1,3,5,7,9), ], by = c("refid", "study", "year"))

rgv_meta <- metacont(n.e = arm_n.x, n.c = arm_n.y, 
         median.e = med_2.x, 
         mean.e = m_2.x,
         sd.e = sd_2.x,
         q1.e = iqr_low_2.x, 
         q3.e = iqr_up_2.x,
         min.e = range_low_2.x,
         max.e = range_up_2.x,
         mean.c = m_2.y,
         sd.c = sd_2.y,
         median.c = med_2.y, 
         q1.c = iqr_low_2.y, 
         q3.c = iqr_up_2.y,
         min.c = range_low_2.y,
         max.c = range_up_2.y,
         data = rgv_meta.dat,
         # byvar = Hour,
         sm = "MD",
         method.tau = "REML",
         pooledvar = FALSE,
         studlab = study)

temp.dat <- data.frame(rgv_meta[c("n.e", "mean.e", "sd.e", "n.c", "mean.c", "sd.c", "studlab")]) %>% 
  tibble() %>% 
  mutate(r_est = 0.5)

temp.dat <- metafor::escalc(
  m1i = mean.e,
  sd1i = sd.e,
  n1i = n.e,
  m2i = mean.c,
  sd2i = sd.c,
  n2i = n.c,
  ri = r_est,
  measure = "MD",
  slab = studlab,
  data = temp.dat) %>% 
  mutate(sd = sqrt(vi))

# rgv_meta$TE <- temp.dat$yi
# rgv_meta$seTE <- temp.dat$sd

rgv_metagen <- metagen(yi, sd,
  studlab = studlab,
  data = temp.dat)

forest(rgv_metagen, 
       comb.random = TRUE,
       comb.fixed = FALSE,
       lab.e = "Prot/CHO      ",
       lab.c = "Carbohydrate     ",
       digits = 0,
       digits.sd = 1,
       print.I2 = TRUE,
       print.tau2 = FALSE,
       digits.tau2 = 0,
       print.I2.ci = FALSE,
       print.pval.Q = FALSE,
       overall = TRUE,
       xlim = c(-100, 350),
       at = c(-100, 0, 100, 200, 300),
       print.byvar = FALSE,
       col.diamond.fixed = "red",
       fs.xlab = 11,
       leftcols = c("studlab"),
       smlab = "Mean Difference (at 2 hours)",
       xlab = "RGV (mL)\n Favors Prot/CHO                  Favors Carbohydrate")

# Nakamura raw from digitized to check
# tibble(prot = c(107.71, 155.16, 168.99, 186.79, 224.36, 236.21, 254.00, 257.96, 354.81, 422.03),
#      cho = c(2.05, 2.05, 3.32, 3.32, 11.00, 12.28, 13.55, 16.11, 31.3, 35.29)) %>% 
# summarise(mn_p = mean(prot), mn_cho = mean(cho), sd_p = sd(prot), sd_cho = sd(cho))

#forest(rgv_meta, 
#       comb.random = TRUE,
#       comb.fixed = FALSE,
#       lab.e = "Prot/CHO      ",
#       lab.c = "Carbohydrate     ",
#       digits = 1,
#       digits.sd = 1,
#       print.I2 = TRUE,
#       print.tau2 = TRUE,
#       digits.tau2 = 0,
#       print.I2.ci = TRUE,
#       print.pval.Q = TRUE,
#       overall = TRUE,
#       xlim = c(-50, 350),
#       at = c(-50, 0, 100, 200, 300),
#       print.byvar = FALSE,
#       col.diamond.fixed = "red",
#       fs.xlab = 11,
#       xlab = "RGV (mL)\n Favors Protein          Favors Carbohydrate")

figure_n <- figure_n + 1
# TODO:  Compared with a carbohydrate drink, at 2 hours the residual gastric volume in non-surgical healthy adults appeared higher (MD 41.6, 95% CI: 36.7--46.5, I^2 = 99%, 4 crossover studies, 61 patients) but accompanied by large heterogeneity. 
```

^a^ Lobo 2009 included the protein comparison arm with the highest residual gastric volume. 

^b^ Nakamura 2014 did not report exact 2-hour volumes --- median, range were estimated from figures. Residual gastric volumes were exceedingly low following the carbohydrate drink. 

<br>

## pH

<br>

<font size = 4> Table `r table_n`. Gastric pH at induction. </font>

```{r phTable, include = TRUE}
## (updated 2020/12/15 13:36) phTable -------------------------------------
ph.dat <- contin.dat %>%
  filter(refid %in% protein_refids$refid) %>%
  select(refid:age, arm_n, arm_tx, timeingest1, amtingest1, timeingest2, amtingest2, type_ingest_1, starts_with("ph_"), notes_continuous) %>%
  filter_at(vars(ph_time_1:ph_pval_2), any_vars(!is.na(.))) %>%  # same
    mutate(
    # surgical studies (note none have times 0 or negative)
    # hr_2 is ≤ 2; hr_26 is (2, 6] >2 to 6; hr_gt6 is >6
    hr_2 = 0, hr_26 = 0, hr_gt6 = 0,
    hr_2 =   if_else(timeingest1 <= 2 & timeingest1 > 0, amtingest1, hr_2, missing = 0),
    hr_26 =  if_else(timeingest1 > 2 & timeingest1 < 6, amtingest1, hr_26, missing = 0),
    hr_gt6 = if_else(timeingest1 >= 6, amtingest1, hr_gt6, missing = 0),
    hr_2 =   if_else(hr_2 == 0 & timeingest2 <= 2 & timeingest2 > 0, amtingest2, hr_2, missing = 0),
    hr_26 =  if_else(hr_26 == 0 & timeingest2 > 2 & timeingest2 < 6, amtingest2, hr_26, missing = 0),
    hr_gt6 = if_else(hr_gt6 == 0 & timeingest2 >= 6, amtingest2, hr_gt6, missing = 0)) %>% 
  janitor::remove_empty(which = "cols") %>% 
  mutate(
    ph_mean_1 = ifelse(study == "Du 2017", round_2(ph_mean_1), round_1(ph_mean_1)),
    ph_mean_1 = suppressWarnings(ifelse(study == "Gomes 2017", round_1(as.numeric(ph_mean_1)), ph_mean_1)),
    ph_sd_1 = ifelse(study == "Gomes 2017", round_1(ph_sd_1), ph_sd_1),
    ph_mean = ifelse(!is.na(ph_sd_1) & !is.na(ph_mean_1), str_c(ph_mean_1, " (", ph_sd_1, ")"), ph_mean_1)) %>%
  group_by(study) %>%
  mutate(
    id = row_number(),
    study = ifelse(id > 1, NA, study)) %>%
  ungroup() %>%
  select(refid, age, design, surg_nosurg, study, arm_tx, arm_n, hr_gt6, hr_26, hr_2,  ph_mean) %>% 
  add_row()

ph.dat %>% 
  mutate(arm_tx = str_c(arm_tx, "^a^")) %>% 
  select(!c(refid, age, design, surg_nosurg)) %>% 
  kbl(booktabs = T, align = c("llccccc"), escape = FALSE,
    col.names = c("\\ \\ \\ \\ \\ \\ \\ Author", "Liquid", "N", "> 6", "6→2", "≤ 2", "Mean (SD)")) %>%    
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "pH" = 1), line = TRUE) %>% 
  kable_styling(bootstrap_options = opt_boot, full_width = FALSE, position = "left") %>% 
  kable_classic(position = "left", full_width = FALSE, html_font = opt_font, "hover") %>% 
  row_spec(2, color = "brown") %>% 
  column_spec(1, width = "15em") %>% 
  column_spec(2, width = "4em") %>% 
  column_spec(c(3:6), width = "2em") %>%
  column_spec(7, width = "6em") %>%
  pack_top(., "Adult, Surgical", 1, 2) %>% 
  pack_sub(., "Nonrandomized Studies of Interventions", 1, 2) %>% 
  pack_rows("MD 1.30 (95% CI, 0.17 to 2.43)", 3, 3, label_row_css = "padding-left:70%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>% 
  footnote(general = "MD: mean difference; hr: hour; Prot: protein; CHO: carbohydrate.",
  alphabet = c("Arms not receiving famotidine."),
  general_title = " ", 
  footnote_as_chunk = FALSE)

table_n <- tab_inc()
```

<br>

## RGV \< 25 mL & pH \> 2.5

<br>

<br>

<font size = 4> Table `r table_n`. Increased residual gastric volumes and pH \< 2.5. </font>

```{r dichotProtNonSurg, include = TRUE}
## (updated 2020/12/14 17:54) dichotProtSurgNonSurg -----------------------
dichot_prot.dat <- dichot.dat %>%
  mutate(
    # surgical studies (note none have times 0 or negative)
    # hr_2 is ≤ 2; hr_26 is (2, 6] >2 to 6; hr_gt6 is >6
    hr_2 = 0, hr_26 = 0, hr_gt6 = 0,
    hr_2 =   if_else(timeingest1 <= 2 & timeingest1 > 0, amtingest1, hr_2, missing = 0),
    hr_26 =  if_else(timeingest1 > 2 & timeingest1 < 6, amtingest1, hr_26, missing = 0),
    hr_gt6 = if_else(timeingest1 >= 6, amtingest1, hr_gt6, missing = 0),
    hr_2 =   if_else(hr_2 == 0 & timeingest2 <= 2 & timeingest2 > 0, amtingest2, hr_2, missing = 0),
    hr_26 =  if_else(hr_26 == 0 & timeingest2 > 2 & timeingest2 < 6, amtingest2, hr_26, missing = 0),
    hr_gt6 = if_else(hr_gt6 == 0 & timeingest2 >= 6, amtingest2, hr_gt6, missing = 0),
    hr_gt6 = if_else(grepl("also received 300", type_ingest_1), 500, hr_gt6), # %>%  # Oyama PM
    # for nonsurgical
    hr_0 = 0, hr_minus2 = 0,
    hr_0 =      if_else(surg_nosurg != "surgical" & timeingest1 ==  0, amtingest1, hr_0, missing = 0),
    hr_minus2 = if_else(surg_nosurg != "surgical" & timeingest1 == -2, amtingest1, hr_minus2, missing = 0),
    hr_0 =      if_else(surg_nosurg != "surgical" & timeingest2 ==  0, amtingest1, hr_0, missing = 0),
    hr_minus2 = if_else(surg_nosurg != "surgical" & timeingest2 == -2, amtingest1, hr_minus2, missing = 0)) %>% 
  replace_with_na_at(.vars = c("hr_gt6", "hr_26", "hr_2"), condition = ~ .x == 0) %>%
  # filter(surg_nosurg == "surgical") %>% 
  # select(refid, study, hr_2, hr_26, hr_gt6, timeingest1, amtingest1, timeingest2, amtingest2, age, design)
  mutate(
    hunger_np = n_percent(hunger_n, hunger_per),
    thirst_np = n_percent(thirst_n, thirst_per),
    nausea_np = n_percent(nausea_n, nausea_per),
    vomit_np = n_percent(vomit_n, vomit_per),
    comfort_np = n_percent(arm_n - comfort_n, 100 - comfort_per),
    satisfac_np = n_percent(satisfac_n, satisfac_per),
    complicate_np = n_percent(complicate_n, complicate_per),
    hypotension_np = n_percent(hypotension_n, hypotension_per),
    regurg_np = n_percent(regurg_n, regurg_per),
    rgv_gt25_np = n_percent(rgv_gt25_n, rgv_gt25_per),
    ph_lt25_np = n_percent(ph_lt25_n, ph_lt25_per),
    aspirate_np = n_percent(aspirate_n, aspirate_per),
    vomit_np = ifelse(refid == 6446 & arm_n == 40, "4 (10)", vomit_np)) %>%
  arrange(age, desc(surg_nosurg), design, year, study, arm_tx, arm) %>%
  select(refid, study, year, age, design, surg_nosurg, arm, arm_n, arm_tx, hr_gt6, hr_26, hr_2, time_outcome, hunger_np:aspirate_np, compl_descript, out_dichot_notes, ends_with("_n"), timeingest1, amtingest1, timeingest2, amtingest2, ends_with("per")) 

dichot_prot_rgv_ph <- dichot_prot.dat %>%
  filter_at(vars(hunger_np:aspirate_np), any_vars(!is.na(.))) %>% 
  select(refid:time_outcome, timeingest1, amtingest1, rgv_gt25_np, ph_lt25_np) %>%
  filter_at(vars(rgv_gt25_np, ph_lt25_np), any_vars(!is.na(.))) %>%
  mutate(rgv_gt25_np = ifelse(refid == 233, str_c(rgv_gt25_np, "^c^"), rgv_gt25_np),
    rgv_gt25_np = ifelse(refid == 7283, str_c(rgv_gt25_np, "^b^"), rgv_gt25_np),
    hr_0 = ifelse(timeingest1 == 0, amtingest1, NA)) %>%
  select(!c(hr_gt6, hr_26, timeingest1, amtingest1)) %>%
  select(refid:arm_tx, hr_2, hr_0, everything()) %>%
  arrange(desc(surg_nosurg), design, study, arm_tx) %>%
  select(!c(refid, arm, design, age, year, surg_nosurg)) %>%
  select(study, arm_tx, arm_n, everything()) %>%
  group_by(study) %>%
  mutate(study = ifelse(row_number() != 1, NA, study)) %>%
  ungroup()

dichot_prot_rgv_ph %>%
  add_row() %>% 
  kbl(booktabs = T, align = c("llcccccc"), escape = FALSE,
    col.names = c("\\ \\ \\ \\ \\ \\ \\ Study", "Liquid", "\\ \\ \\ N", "2", "0", 
      "\\ \\ \\ Time (hr)^a^", "N (%)", "N (%)")) %>%
  add_header_above(c(" " = 3, "Volume (mL) at hour" = 2, " " = 1, "Increased RGV" = 1, "pH < 2.5" = 1), line = TRUE) %>%
  kable_classic(position = "left", full_width = FALSE, html_font = opt_font, "hover") %>% 
  kable_styling(bootstrap_options = opt_boot, full_width = FALSE, position = "left") %>% 
  column_spec(1, width = "10em") %>%
  column_spec(2, width = "5em") %>%
  column_spec(3, width = "2em") %>%
  column_spec(c(4:5), width = "1em") %>%
  column_spec(6, width = "6em") %>%
  column_spec(7, width = "10em") %>%
  column_spec(8, width = "10em") %>%
  row_spec(c(2, 4), color = "brown") %>%
  pack_top(., "Adult, Surgical", 1, 2) %>%
  pack_sub(., "RCT", 1, 2) %>%
  pack_rows("OR 0.04 (95% CI, 0.00-0.33)", 3, 3, label_row_css = "padding-left:80%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>% 
  pack_top(., "Adult, Nonsurgical", 3, 4) %>%
  pack_sub(., "RCT", 3, 4) %>%
  pack_rows("OR 12.00 (95% CI, 1.1-136)", 5, 5, label_row_css = "padding-left:60%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>% 
  footnote(
    general = "RCT: randomized controlled trial; RGV: residual gastric volume.",
    alphabet = c("When outcome assessed relative to surgery where 0 is prior to induction for surgical studies, and hours after liquid ingestion for nonsurgical studies.",
      "RGV > 25 ml", 
      "RGV > 1.5 ml/g"),
    general_title = "",
    footnote_as_chunk = FALSE)

table_n <- tab_inc()
```

<br>

## Blood Pressure

<br>

## Length of Stay

<br>



# \*Study/Participant Detail

## Study Characteristics

<font size = 4> Table `r table_n`. Characteristics of included studies examining protein-containing drinks. </font>

```{r createStudyCharTable, include = FALSE}
study_char_table <- study_char_prot.dat %>%
  mutate(
    dates = str_c(date_start, "-", date_end),
    country = countrycode::countryname(country, destination = "iso3c"),
    low_r = noquote(if_else(non_vh_hdi == "yes", "\U2022", "", "")),
    n = n_enrolled,
    n_anal = n_analyze,
    pilot = noquote(if_else(pilot == "yes", "\U2022", "", "")),
    study = ifelse(grepl("Marquini", study), str_c(study, "^a^"), study),
    setting = case_when(
      !is.na(hospital) ~ "Hosp",
      !is.na(ambulatory) ~ "Amb",
      !is.na(oth_setting) ~"Other"),
    gen = noquote(if_else(!is.na(general), "\U2022", "", "")),
    reg = noquote(if_else(!is.na(regional), "\U2022", "", "")),
    sed = noquote(if_else(!is.na(sedation), "\U2022", "", "")),
    registered = noquote(if_else(registered == "yes", "\U2022", "", "")),
    surg = case_when(
      str_detect(surg_type, "[Gg]yn") ~ "Gyn",
      str_detect(surg_type, "ariety") ~ "Various",
      str_detect(surg_type, "various") ~ "Various",
      str_detect(surg_type, "total hip or total knee replacement") ~ "TKA/THA",
      str_detect(surg_type, "cholecystectomy") ~ "Cholecystectomy",
      str_detect(surg_type, "[Gg]ast|Bowel") ~ "Other GI",
      str_detect(surg_type, "not appli") ~ "None (healthy)",
      str_detect(surg_type, "oral") ~ "Oral",
      str_detect(surg_type, "minor") ~ "Misc minor",
      str_detect(surg_type, "None") ~ "None (healthy)",
      str_detect(surg_type, "abdomin") ~ "Other GI",
      str_detect(surg_type, "Endso") ~ "Endoscopy")) %>%
  # filter(!study %in% c("Marquini 2020b", "Marquini 2020c")) %>% 
  arrange(age, desc(surg_nosurg), design, year, study) %>%
  select(study, dates, country, n, pilot, setting, gen, reg, sed, surg, registered)

# study design numbers
# temp <- study_char_prot.dat %>% 
#   select(refid, study, year, design) %>% 
#   group_by(design) %>% 
#   summarise(n = n())
# 
# n_rct <-    pull(temp %>% filter(design == "RCT") %>% select(n))
# n_cross <-  pull(temp %>% filter(design == "Crossover") %>% select(n))
# n_nrsi <-   pull(temp %>% filter(design == "NRSI") %>% select(n))
# n_retCoh <- pull(temp %>% filter(design == "Retrospective Cohort") %>% select(n))
# 
# rm(temp)

```

```{r studyCharKable, echo = FALSE}
study_char_table %>%
  kbl(booktabs = T, align = c("lcccccccclc"), 
      # format = "latex",
      col.names = c("\\ \\ \\ \\ \\ \\ \\ Study", "Dates", "Country", " (N\\) ", "Pilot", 
                    "Setting", "Gen", "Reg", "Sed", "Type of Surgery", "Registered")) %>%
  add_header_above(c(" " = 3, "Enrolled" = 1, " " = 2, "Anesthetic" = 3, " " = 2)) %>% 
  kable_classic(full_width = TRUE, html_font = opt_font, position = "left", "hover") %>% 
  kable_styling(bootstrap_options = opt_boot) %>% 
  column_spec(1, width = "15em") %>% 
  # column_spec(2, width = "2em") %>% 
  column_spec(3, width = "7em") %>%
  pack_top(., "Adult, Surgical", 1, 19) %>% 
  pack_sub(., "RCT", 1, 19) %>% 
  pack_sub(., "Nonrandomized Studies of Interventions", 20, 21) %>% 
  pack_sub(., "Retrospective Cohort", 22, 22) %>% 
  pack_top(., "Adult, Nonsurgical", 23, 23) %>% 
  pack_sub(., "RCT", 23, 23) %>%
  pack_sub(., "Crossover", 24, 29) %>%
  pack_top(., "Pediatric, Nonsurgical", 30, 30) %>% 
  pack_sub(., "RCT", 30, 30) %>% 
  footnote(general_title = "",
    general = "Gen: general; Reg: regional; Sed: sedation; Hosp: hospital; Amb: ambulatory; TKA: total knee arthroplasty; THA: total hip arthroplasty.",
    alphabet = c("Multiple publications from the same study."),
    footnote_as_chunk = FALSE) # %>% 

table_n <- tab_inc()
```

<br><br>

## Sample Characteristics

<font size = 4> Table `r table_n`. Characteristics of patients in included studies. </font>

```{r createPtCharTable, include = FALSE}
pt_char_table <- study_arm_prot.dat %>%
  group_by(refid) %>%
  summarize(
    N = sum(arm_n),
    wgt = arm_n / N,
    asai_all = round(sum(asai * wgt, na.rm = TRUE)),
    asaii_all = round(sum(asaii * wgt, na.rm = TRUE)),
    asaiii_all = round(sum(asaiii * wgt, na.rm = TRUE)),
    asai_ii_all = round(sum(asai_ii * wgt, na.rm = TRUE)),
    age_mn_all = round(sum(age_mean * wgt, na.rm = TRUE)),
    age_md_all = round(sum(age_med * wgt, na.rm = TRUE)),
    sex_all = round(sum(female * wgt, na.rm = TRUE)),
    white_all = round(sum(white * wgt, na.rm = TRUE)),
    black_all = round(sum(black * wgt, na.rm = TRUE)),
    asian_all = round(sum(asian * wgt, na.rm = TRUE)),
    bmi_mn_all = round(sum(bmi_mean * wgt, na.rm = TRUE)),
    bmi_md_all = round(sum(bmi_med * wgt, na.rm = TRUE)),
    dm_mn_all = round(sum(dm * wgt, na.rm = TRUE)),
    neuro_all = round(sum(neuro * wgt, na.rm = TRUE))) %>%
  filter(row_number() == 1) %>%
  ungroup()

# add study age, surg_nosurg, design
temp <- left_join(study_names, study_char.dat[, c("refid", "age", "surg_nosurg", "design")], by = "refid")
  
pt_char_table <- left_join(pt_char_table, temp, by = "refid") %>% 
  arrange(age, desc(surg_nosurg), design, year, study) %>% 
  mutate(study = ifelse(grepl("Marquini", study), str_c(study, "^a^"), study)) %>% 
  select(design, study, year, everything())

rm(temp)

pt_char_table <- pt_char_table %>% 
  # filter(!study %in% c("Marquini 2020b", "Marquini 2020c")) %>% 
  select(study, N, asai_all, asaii_all, asai_ii_all, asaiii_all, sex_all, age_mn_all, 
  age_md_all, white_all, black_all, asian_all, bmi_mn_all, bmi_md_all, dm_mn_all)

```

```{r ptCharKable, echo = FALSE}
pt_char_table %>% 
  mutate_at(vars(asai_all:dm_mn_all), na_if, 0) %>% 
  kbl(
    booktabs = T, align = c("lrrrrcccccccccc"),
    col.names = c("\\ \\ \\ \\ \\ \\ \\ Study", "Analyzed", "I", "II", "I-II", "III", "(%)",
      "Mean", "Med", "White", "Black", "Asian", "Mean", "Med", "DM (%)")) %>%
  add_header_above(c(" " = 1, "N" = 1, "\\ \\ \\ ASA Classs (%)" = 4, "Female" = 1, "Age" = 2,
    "Race (%)" = 3, "BMI (kg/m^2^)" = 2, " " = 1), line = TRUE) %>%
  kable_classic(full_width = TRUE, html_font = opt_font, position = "left", "hover") %>% 
  kable_styling(bootstrap_options = opt_boot) %>% 
  column_spec(1, width = "15em") %>%
  # column_spec(2, width = "4em") %>%
  column_spec(3, width = "3em") %>%
  pack_top(., "Adult, Surgical", 1, 19) %>% 
  pack_sub(., "RCT", 1, 19) %>% 
  pack_sub(., "Nonrandomized Studies of Interventions", 20, 21) %>% 
  pack_sub(., "Retrospective Cohort", 22, 22) %>% 
  pack_top(., "Adult, Nonsurgical", 23, 23) %>% 
  pack_sub(., "RCT", 23, 23) %>%
  pack_sub(., "Crossover", 24, 29) %>%
  pack_top(., "Pediatric, Nonsurgical", 30, 30) %>% 
  pack_sub(., "RCT", 30, 30) %>% 
  footnote(alphabet = c("Multiple publications from he same study."),
    general = "Med: median",
    general_title = "",
    footnote_as_chunk = T
  )
table_n <- tab_inc()
```

<br><br>

## Fasting, Liquid Timing and Amounts

<font size = 4> Table `r table_n`. Liquid consumption prior to surgery or outcome measurement and amounts according to study arm. </font>

```{r createFastingTable, include = FALSE}
fasting_table <- study_arm.dat %>% 
  filter(refid %in% protein_refids$refid) %>% 
  mutate(tx = factor(arm_tx,
  levels = c(
    "fasting",
    "water",
    "other_clear",
    "other",
    "cho",
    "milk",
    "protein"))) %>%
  mutate(tx = fct_recode(tx,
    Fasting = "fasting",
    Water = "water",
    Clear = "other_clear",
    Other = "other",
    CHO = "cho",
    Milk = "milk",
    "Prot/CHO" = "protein"),
    arm_tx = tx) %>%
  mutate(arm = ifelse(refid == 3588 & arm_n == 35, 3, arm),
         arm = ifelse(refid == 3588 & arm_n == 27, 2, arm)) %>% 
  select(refid, year, study, tx, arm_n, fastsolid, fastliquid, type_of_liquid, timeingest1, amtingest1, timeingest2, amtingest2, age, surg_nosurg, age, design, arm) %>% 
  arrange(age, desc(surg_nosurg), design, year, study, tx) %>% 
  select(study, tx, year, design, arm_n, fastsolid, fastliquid, timeingest1:amtingest2) 

fasting_table <- fasting_table %>%
  mutate(timeingest1 = ifelse(timeingest1 == 99, 12, timeingest1)) %>% 
  mutate(amtingest1  = na_if(amtingest1, 0)) %>% 
  mutate(timeingest1 = round(timeingest1, 0)) %>% 
  mutate(timeingest2 = round(timeingest2, 0)) %>% 
  group_by(study) %>% 
  # mutate(design = if_else(row_number() == 1, design, "")) %>% 
  mutate(year = ifelse(row_number() == 1, as.numeric(year), "" )) %>% 
  mutate(study = ifelse(study == "Marquini 2020a", "Marquini 2020a,b,c", study)) %>% 
  filter(!study %in% c("Marquini 2020b", "Marquini 2020c")) %>% 
  mutate(study = if_else(row_number() == 1, study, "")) %>% 
  ungroup()

# study arms
study_arm.dat %>% 
  filter(refid %in% protein_refids$refid) %>% 
  group_by(refid) %>% 
  count(refid)

```

```{r fastingKable, echo = FALSE}
prot_row <- fasting_table %>%
  mutate(line = row_number()) %>%
  filter(grepl("Prot", tx)) %>%
  pull(line)

fasting_table %>%
  select(-year, -design) %>% 
  kbl(booktabs = T, align = c("llccccccc"),
      col.names = c("\\ \\ \\ \\ \\ \\ \\ Author", "\\ \\ Liquid", "N", "Solids", "Liquids",  "Time^a^ (hr)", "Amount (mL)", 
      "Time^a^ (hr)", "Amount (mL)")) %>%
  add_header_above(c(" " = 3, "Prescribed Fasting  (hr)" = 2, "Treat Liquid 1" = 2, "Treat Liquid 2" = 2), line = TRUE) %>% 
  kable_classic(full_width = TRUE, html_font = opt_font, position = "left", "hover") %>% 
  kable_styling(bootstrap_options = opt_boot) %>% 
  row_spec(prot_row, color = "brown") %>%
  column_spec(1, width = "15em") %>% 
  # column_spec(2, width = "5em") %>% 
  # column_spec(3, width = "9em") %>%
  pack_top(., "Adult, Surgical", 1, 44) %>% 
  pack_sub(., "RCT", 1, 44) %>% 
  pack_sub(., "Nonrandomized Studies of Interventions", 45, 50) %>% 
  pack_sub(., "Retrospective Cohort", 51, 52) %>% 
  pack_top(., "Adult, Nonsurgical", 53, 68) %>% 
  pack_sub(., "RCT", 53, 54) %>%
  pack_sub(., "Crossover", 55, 68) %>%
  pack_top(., "Pediatric, Nonsurgical", 69, 71) %>% 
  pack_sub(., "RCT", 69, 71) %>%   
  footnote(general = "hr: hours",
          alphabet = c("Hours prior to surgery"),
          alphabet_title = " ",
          general_title = "",
          footnote_as_chunk = T)

table_n <- tab_inc()
```

<br><br>

## Protein-containing Drinks

<font size = 4> Table `r table_n`. Composition of protein-containing liquids and brands. </font>

```{r createProteinDrinkTable, include = FALSE}
# protein drinks used
prot_drink.dat <- readxl::read_xlsx("data/protein_detail_102320.xlsx", range = "A28:O59") %>% 
  janitor::clean_names()

# calculate total protein
volume <- study_arm.dat %>% 
  filter(arm_tx == "protein") %>% 
  mutate(amtingest2 = replace_na(amtingest2, 0),
    tot_vol = amtingest2 + amtingest1) %>% 
  select(refid, study, year, arm_tx, arm, tot_vol, amtingest1, amtingest2, age, surg_nosurg, design)

prot_drink.dat[, 5:10] <- map(prot_drink.dat[, 5:10], function(x) noquote(if_else(x == "X", "\U2022", "", "")))

prot_drink.dat <- left_join(volume[, c("refid", "tot_vol", "study", "age", "surg_nosurg", "design", "year")],
  prot_drink.dat,
  by = "refid") %>%
  mutate(prot_g_all = round(protein_g * tot_vol / 100, 0)) %>%
  group_by(study, brand) %>%
  slice(1)
         
prot_drink_table <- prot_drink.dat %>% 
  mutate(kcal = round(as.numeric(kcal), 0)) %>% 
  group_by(refid) %>% 
  arrange(age, desc(surg_nosurg), design, year, study) %>% 
  mutate(study = ifelse(row_number() == 2 & study == "Lobo 2009", " ", study),
         study = ifelse(study == "Marquini 2020a", "Marquini 2020 (all)", study)) %>% 
  ungroup() %>% 
  filter(!study %in% c("Marquini 2020b", "Marquini 2020c")) %>% 
  select(study, whey, glutamine, arginine, pea, soy, not_specified, protein_g, cho_g, kcal, osmolarity, prot_g_all, brand, tx_detail)
```

```{r proteinDrinksKable, echo = FALSE}
prot_drink_table %>% 
  select(-tx_detail) %>% 
  kbl(booktabs = T, align = c("lccccccccccc"),
      col.names = linebreak(c("\\ \\ \\ \\ \\ \\ \\ Author", "Whey", "Glut", "Arg", "Pea", "Soy", "NS", 
      "Protein, g", "CHO, g", "Kcal", "Osm", "Ingested, g", "Brand"))) %>%
  add_header_above(c(" " = 7, "Per 100 g" = 4, "Protein" = 1, " " = 1), line = TRUE) %>%  
  kable_classic(full_width = TRUE, html_font = opt_font, position = "left", "hover") %>% 
  kable_styling(bootstrap_options = opt_boot) %>% 
  column_spec(1, width = "15em") %>% 
  column_spec(c(2,3,4,5,6,7), width = "3em") %>% 
  # column_spec(3, width = "9em") %>%
  pack_top(., "Adult, Surgical", 1, 17) %>% 
  pack_sub(., "RCT", 1, 17) %>% 
  pack_sub(., "Nonrandomized Studies of Interventions", 18, 20) %>% 
  pack_sub(., "Retrospective Cohort", 21, 21) %>% 
  pack_top(., "Adult, Nonsurgical", 22, 29) %>% 
  pack_sub(., "RCT", 22, 22) %>%
  pack_sub(., "Crossover", 23, 29) %>%
  pack_top(., "Pediatric, Nonsurgical", 30, 30) %>% 
  pack_sub(., "RCT", 30, 30) %>%  
  footnote(general = "CHO: carbohydrate; g: grams; Osm: osomolality; Glut: glutamine; Arg: arginine; NS: not specified",
          #alphabet = c("per 100/mL if not otherwise specified"),
          # alphabet_title = " ",
          general_title = "",
          footnote_as_chunk = T)  

table_n <- tab_inc()
```

<br>

```{r proteinDrinksDetailKable, echo = FALSE, include = FALSE}
# Table `r table_n`. 
## Protein-containing Drinks (note) 
prot_drink_table %>% 
  select(study, tx_detail) %>% 
  filter(!is.na(tx_detail)) %>% 
   kbl(booktabs = T, align = c("ll"),
      col.names = c("\\ \\ \\ \\ \\ \\ \\ Author", "Detail")) %>%
  kable_classic(full_width = TRUE, html_font = "Cambria", position = "left", "striped") %>% 
  column_spec(1, width = "15em") %>% 
  # column_spec(2, width = "5em") %>% 
  # column_spec(3, width = "9em") %>%
  # add_header_above(c(" " = 3, "Prescribed Fasting  (hr)" = 2, "Treat Liquid 1" = 2, "Treat Liquid 2" = 2)) %>% 
  pack_rows("RCT", 1, 19) %>%
  pack_rows("Crossover", 20, 26) %>% 
  pack_rows("Non-randomized study (intervention)", 27, 28) %>% 
  pack_rows("Retrospective Cohort", 29, 29) %>% 
  footnote(general = "g: grams; Osm: osmolality",
          # alphabet = c("Hours prior to surgery"),
          # alphabet_title = " ",
          general_title = "",
          footnote_as_chunk = T)  
```

<br>

## Comparator Detail

<font size = 4> Table `r table_n`. Comparator details.</font>

```{r createComparatorDetailTable, echo = FALSE}
comparator_detail_table <- study_arm.dat %>%
  filter(refid %in% protein_refids$refid) %>% 
  mutate(tx = factor(arm_tx,
  levels = c(
    "fasting",
    "water",
    "other_clear",
    "other",
    "cho",
    "milk",
    "protein"))) %>%
  mutate(tx = fct_recode(tx,
    Fasting = "fasting",
    Water = "water",
    Clear = "other_clear",
    Other = "other",
    CHO = "cho",
    Milk = "milk",
    "Prot/CHO" = "protein"),
    arm_tx = tx,
    arm = ifelse(refid == 3588 & arm_n == 35, 3, arm),
    arm = ifelse(refid == 3588 & arm_n == 27, 2, arm)) %>%
  select(refid, arm_n, tx, type_of_liquid, tx_detail, arm)

temp <- left_join(study_names, study_char.dat[, c("refid", "age", "surg_nosurg", "design")], by = "refid")
comparator_detail_table <- left_join(comparator_detail_table, temp, by = "refid") %>% 
  arrange(age, desc(surg_nosurg), design, year, study, arm)
rm(temp)

comparator_detail_table <- comparator_detail_table %>%
  arrange(age, desc(surg_nosurg), design, year, study, tx) %>% 
  group_by(study) %>% 
  # mutate(design = if_else(row_number() == 1, design, "")) %>% 
  mutate(year = ifelse(row_number() == 1, as.numeric(year), "" )) %>% 
  filter(!study %in% c("Marquini 2020b", "Marquini 2020c")) %>% 
  mutate(study = if_else(row_number() == 1, study, ""),
         study = ifelse(study == "Marquini 2020a", "Marquini 2020 (all)", study),
         tx_detail = firstup(tx_detail)) %>% 
  ungroup() %>% 
  select(study, arm_n, tx, tx_detail)

```

```{r createComparatorDetailKable, echo = FALSE}
prot_row <- fasting_table %>%
  mutate(line = row_number()) %>%
  filter(grepl("Prot", tx)) %>%
  pull(line)

comparator_detail_table %>% 
   kbl(booktabs = T, align = c("ll"),
      col.names = c("\\ \\ \\ \\ \\ \\ \\ Author", "N", "Liquid", "Detail")) %>%
  kable_classic(full_width = TRUE, html_font = opt_font, position = "left", "hover") %>% 
  kable_styling(bootstrap_options = opt_boot) %>% 
    row_spec(prot_row, color = "brown") %>%
  column_spec(1, width = "15em") %>% 
  column_spec(2, width = "5em") %>% 
  column_spec(3, width = "8em") %>%
  # add_header_above(c(" " = 3, "Prescribed Fasting  (hr)" = 2, "Treat Liquid 1" = 2, "Treat Liquid 2" = 2)) %>% 
  pack_top(., "Adult, Surgical", 1, 44) %>% 
  pack_sub(., "RCT", 1, 44) %>% 
  pack_sub(., "Nonrandomized Studies of Interventions", 45, 50) %>% 
  pack_sub(., "Retrospective Cohort", 51, 52) %>% 
  pack_top(., "Adult, Nonsurgical", 53, 68) %>% 
  pack_sub(., "RCT", 53, 54) %>%
  pack_sub(., "Crossover", 55, 68) %>%
  pack_top(., "Pediatric, Nonsurgical", 69, 71) %>% 
  pack_sub(., "RCT", 69, 71) %>% 
  footnote(general = "CHO: carbohydrate; g: grams; Osm: osmolality",
          # alphabet = c("Hours prior to surgery"),
          # alphabet_title = " ",
          general_title = "",
          footnote_as_chunk = T)  

table_n <- tab_inc()
```

<br>

## Funding

<font size = 4> Table `r table_n`. Reported funding sources. </font>

```{r createFundingTable, include = FALSE}
study_fund_table <- study_char_prot.dat %>%
  mutate(
    # sponsor_desc = str_to_title(sponsor_desc),
    registered = noquote(if_else(registered == "yes", "\U2022", "", "")),
    public = noquote(if_else(funding == "public" | funding == "pub_indus", "\U2022", "", "")),
    industry = noquote(if_else(funding == "pub_indus", "\U2022", "", "")),
    none = noquote(if_else(funding == "none", "\U2022", "", "")),
    not_reported = noquote(if_else(funding == "NR", "\U2022", "", "")),
    study = ifelse(study == "Marquini 2020a", "Marquini 2020 (all)", study)) %>%
  filter(!study %in% c("Marquini 2020b", "Marquini 2020c")) %>% 
  arrange(age, desc(surg_nosurg), design, year, study) %>%
  select(study, design, registered, public, industry, none, not_reported, sponsor_desc)

temp <- prot_drink_table %>% 
  mutate(brand = ifelse(str_detect(brand, "Arm"), NA, brand)) %>% 
  select(study, brand) %>% 
  distinct()

study_fund_table <- left_join(study_fund_table, temp, by = "study") 

```

```{r fundingKable, echo = FALSE}
study_fund_table %>% 
  select(-design, -registered) %>% 
  kbl(booktabs = T, align = c("lcccclll"),
      col.names = c("\\ \\ \\ \\ \\ \\ \\ Author", "Public", "Industry", "None", 
                    "Not Reported", "Funding description", "Brand")) %>%
  kable_classic(full_width = TRUE, html_font = opt_font, position = "left", "hover") %>% 
  kable_styling(bootstrap_options = opt_boot) %>% 
  column_spec(1, width = "16em") %>% 
  column_spec(c(2,3,4,5), width = "4em") %>% 
  column_spec(6, width = "23em") %>%
  add_header_above(c(" " = 1, "Reported Funding Source(s)" = 4, " " = 2), line = TRUE) %>% 
  # add_header_above(c(" " = 3, "Prescribed Fasting  (hr)" = 2, "Treat Liquid 1" = 2, "Treat Liquid 2" = 2)) %>% 
  # add_header_above(c(" " = 3, "Prescribed Fasting  (hr)" = 2, "Treat Liquid 1" = 2, "Treat Liquid 2" = 2)) %>% 
  pack_top(., "Adult, Surgical", 1, 17) %>% 
  pack_sub(., "RCT", 1, 17) %>% 
  pack_sub(., "Nonrandomized Studies of Interventions", 18, 19) %>% 
  pack_sub(., "Retrospective Cohort", 20, 20) %>% 
  pack_top(., "Adult, Nonsurgical", 21, 21) %>% 
  pack_sub(., "RCT", 21, 21) %>%
  pack_sub(., "Crossover", 22, 27) %>%
  pack_top(., "Pediatric, Nonsurgical", 28, 28) %>% 
  pack_sub(., "RCT", 28, 28)
  #footnote(general = "g: grams; Osm: osmolality",
          # alphabet = c("Hours prior to surgery"),
          # alphabet_title = " ",
          # general_title = "",
          # footnote_as_chunk = T)

table_n <- tab_inc()
```

<br>

<br>

# Risk of Bias

### \*Patient Reported Outcomes

<br>

<font size = 4> Figure `r figure_n`. Individual study risk of bias appraisal for randomized controlled trials including patient reported outcomes --- nausea, hunger, thirst, and pain. </font>

<img src="assets/hunger_dichot_rob_traffic.svg" style="width:600px;" align="left"/>

<br clear="all" />

```{r}
figure_n <- fig_inc()
```

<br>

### Clinical Outcomes

<br>

<font size = 4> Figure `r figure_n`. Individual study risk of bias appraisal for randomized controlled trials for clinical outcomes. </font>

```{r}
figure_n <- fig_inc()
```

<br>

# References {#references}
