---
title: "Carbohydrate Drinks"
date: "`r format(Sys.time(), '%d %B, %Y (%H:%M)')`"
output:
  html_document:
    font: Source Sans Pro
    theme: cosmo
    anchor_sections: TRUE
    toc_float: 
      collapsed: true
      smooth_scroll: TRUE
    toc_depth: 3
    linkcolor: blue
  latex_engine: xelatex
  pdf_document:
    toc: yes
    toc_depth: '3'
bibliography: "bib/cho.bib"
csl: jama.csl
link-citations: yes
workflowr:
  suppress_report: false
nocite: '@*'
---

#### 

```{=html}
<style type="text/css">
  body{
  font-size: 9.5pt;
  font-family: Source Sans Pro;
}

.list-group-item.active, .list-group-item.active:hover, .list-group-item.active:focus {
  color: #090909;
  background-color: #0909093d;
}

.lightable-classic.lightable-hover tbody tr:hover {
    background-color: #c5d4e4;
}
.btn-xs, .btn-group-xs>.btn { 
display: none; 
}

.btn-default {
display: none !important; 
}
</style>
```

```{r setupData, include = FALSE}
## * (updated 2021/01/06 11:34) preliminaries -------------------------------
library(multinma)
# functions
now <- function() {str_replace_all(format(Sys.time(), "%m %d %y_%H-%M"), " ", "_")}
m_table <- function(data, x){
  group_by(data, arm_tx) %>%
    summarise(tx_count = n())
}
# replace_mg <- function(a, b) {if_else(is.na(a) & !is.na(b), b, a)}
tab_inc <- function() {
  table_n <- table_n + 1
  table_n}
fig_inc <- function() {
  figure_n <- figure_n + 1
  figure_n}
table_n <- 1
figure_n <- 1

## * get current files; select cho refids; directory must have unique ####
source("code/readFiles_120220_wfr.R")

# study char cho refs 
study_char_cho.dat <- study_char.dat %>% 
  filter(refid %in% cho_refids)

# study arm protein refs 
study_arm_cho.dat <- study_arm.dat %>%
  filter(refid %in% cho_refids) %>%
  # remove Awad other, no "other" category
  filter(arm_tx != "other") %>%
  # remove duplicate arms tewari 2019 (refid 716)
  filter(!(refid == 716 & arm_n == 8)) %>%
  mutate(
    study = ifelse(refid == 2564 & grepl("colorectal", notes_arm), paste(study, "(CR)"), study),
    study = ifelse(refid == 2564 & grepl("cholecystectomy", notes_arm), paste(study, "(CH)"), study),
    study = ifelse(refid == 1926 & grepl("general", notes_arm), paste(study, "(gen)"), study),
    study = ifelse(refid == 1926 & grepl("epidural", notes_arm), paste(study, "(epi)"), study)
  ) %>%
  mutate(tx = factor(arm_tx,
    levels = c(
      "fasting",
      "water",
      "placebo",
      "other_clear",
      "milk",
      "prot",
      "prot_simp",
      "prot_comp",
      "cho_simp",
      "cho_comp"
    )
  )) %>%
  mutate(
    tx = fct_recode(tx,
      Fasting = "fasting",
      Water = "water",
      Placebo = "placebo",
      Clear = "other_clear",
      Milk = "milk",
      "Prot" = "prot",
      "CHO/Comp/Prot" = "prot_comp",
      "CHO/Simp/Prot" = "prot_simp",
      "CHO/Simp" = "cho_simp",
      "CHO/Comp" = "cho_comp",
    ),
    arm_tx = tx
  ) %>%
  select(-tx) 

# tewari 2019
study_arm_cho_tewari.dat <- study_arm.dat %>% 
  filter(refid == 716)

## * dichot factor treatment arm outcome type for ordering (updated 2020/12/12 12:04) ####
# save dichot.dat 
dichot_cho.dat <- dichot.dat %>% 
  filter(refid %in% cho_refids) %>% 
  # remove Awad other, no "other" category
  filter(arm_tx != "other") %>% 
  # factor arm_tx levels for cho studies
  mutate(tx = factor(arm_tx,
  levels = c(
    "fasting",
    "water",
    "placebo",
    "other_clear",
    "milk",
    "prot",
    "prot_simp",
    "prot_comp",
    "cho_simp",
    "cho_comp"))) %>%
  mutate(tx = fct_recode(tx,
    Fasting = "fasting",
    Water = "water",
    Placebo = "placebo",
    Clear = "other_clear",
    Milk = "milk",
    "Prot" = "prot",
    "CHO/Simp/Prot" = "prot_simp",
    "CHO/Comp/Prot" = "prot_comp",
    "CHO/Simp" = "cho_simp",
    "CHO/Comp" = "cho_comp",),
    arm_tx = tx) %>%
  select(-tx)

dichot_cho.dat %>% tabyl(arm_tx)

## * contin factor treatment arm outcome type for ordering (updated 2020/12/12 12:04) ####
contin_cho.dat <- contin.dat %>% 
  filter(refid %in% cho_refids) %>% 
  # remove Awad other, no "other" category
  filter(arm_tx != "other") %>%
  # factor arm_tx levels for cho studies
  mutate(tx = factor(arm_tx,
  levels = c(
    "fasting",
    "water",
    "placebo",
    "other_clear",
    "milk",
    "prot",
    "prot_simp",
    "prot_comp",
    "cho_simp",
    "cho_comp"))) %>%
  mutate(tx = fct_recode(tx,
    Fasting = "fasting",
    Water = "water",
    Placebo = "placebo",
    Clear = "other_clear",
    Milk = "milk",
    "Prot" = "prot",
    "CHO/Simp/Prot" = "prot_simp",
    "CHO/Comp/Prot" = "prot_comp",
    "CHO/Simp" = "cho_simp",
    "CHO/Comp" = "cho_comp",),
    arm_tx = tx) %>%
  select(-tx)

contin_cho.dat %>% tabyl(arm_tx)

## * likert factor treatment arm outcome type for ordering (updated 2020/12/12 12:04) ####
likert_cho.dat <- likert.dat %>% 
  filter(refid %in% cho_refids) %>% 
  # remove Awad other, no "other" category
  filter(arm_tx != "other") %>%
  # factor arm_tx levels for cho studies
  mutate(tx = factor(arm_tx,
  levels = c(
    "fasting",
    "water",
    "placebo",
    "other_clear",
    "milk",
    "prot",
    "prot_simp",
    "prot_comp",
    "cho_simp",
    "cho_comp"))) %>%
  mutate(tx = fct_recode(tx,
    Fasting = "fasting",
    Water = "water",
    Placebo = "placebo",
    Clear = "other_clear",
    Milk = "milk",
    "Prot" = "prot",
    "CHO/Simp/Prot" = "prot_simp",
    "CHO/Comp/Prot" = "prot_comp",
    "CHO/Simp" = "cho_simp",
    "CHO/Comp" = "cho_comp",),
    arm_tx = tx) %>%
  select(-tx)

likert_cho.dat %>% tabyl(arm_tx)

## * divide Sada 2014 and Celiksular 2016 into 2 studies ------------------
likert_cho.dat <- likert_cho.dat %>%
  mutate(
    study = ifelse(study == "Sada 2014" & grepl("cholecystectomy", out_l_notes), "Sada 2014 (CH)", study),
    study = ifelse(study == "Sada 2014" & !grepl("cholecystectomy", out_l_notes), "Sada 2014 (CR)", study),
    study = ifelse(study == "Celiksular 2016" & grepl("general", out_l_notes), "Celiksular 2016 (G)", study),
    study = ifelse(study == "Celiksular 2016" & grepl("epidural", out_l_notes), "Celiksular 2016 (E)", study)
  )

contin_cho.dat <- contin_cho.dat %>%
  mutate(
    study = ifelse(study == "Sada 2014" & grepl("cholecystectomy", notes_continuous), "Sada 2014 (CH)", study),
    study = ifelse(study == "Sada 2014" & !grepl("cholecystectomy", notes_continuous), "Sada 2014 (CR)", study),
    study = ifelse(study == "Celiksular 2016" & grepl("general", notes_continuous), "Celiksular 2016 (G)", study),
    study = ifelse(study == "Celiksular 2016" & grepl("epidural", notes_continuous), "Celiksular 2016 (E)", study)
  )

dichot_cho.dat <- dichot_cho.dat %>%
  mutate(
    study = ifelse(study == "Sada 2014" & grepl("cholecystectomy", out_dichot_notes), "Sada 2014 (CH)", study),
    study = ifelse(study == "Sada 2014" & !grepl("cholecystectomy", out_dichot_notes), "Sada 2014 (CR)", study),
    study = ifelse(study == "Celiksular 2016" & grepl("general", out_dichot_notes), "Celiksular 2016 (G)", study),
    study = ifelse(study == "Celiksular 2016" & grepl("epidural", out_dichot_notes), "Celiksular 2016 (E)", study)
  )


```

# **Included Studies** 

<br/>

<font size = 4> Table `r table_n`. Number of included studies according to age, surgery, and design. </font>

```{r tablesIncluded, include = TRUE, echo = FALSE} 
## (updated 2021/01/05 09:15) Included Studies ----------------------------
# list of studies, age, surgical/non surgical, design 
study_char_cho.dat %>%
  filter(!study %in% c("Marquini 2020b", "Marquini 2020c")) %>% 
  group_by(age, surg_nosurg, design, .groups = "drop") %>%
  summarise(total = n()) %>%
  ungroup() %>%
  arrange(age, desc(surg_nosurg), design) %>%
  group_by(age, surg_nosurg, .groups = "drop") %>%
  mutate(row = row_number()) %>%
  ungroup() %>%
  janitor::adorn_totals("row") %>%
  mutate(
    age = ifelse(row != 1, NA, age),
    surg_nosurg = ifelse(row != 1, NA, surg_nosurg),
    surg_nosurg = firstup(surg_nosurg),
    design = case_when(
      design == "rct" ~ "RCT",
      design == "crossover" ~ "Crossover",
      design == "cluster" ~ "Cluster",
      design == "nrsi" ~ "Nonrandomized",
      design == "prospect_coh" ~ "Prospective Cohort",
      design == "retrospect_coh" ~ "Retrospective Cohort",
      design == "casecontrol" ~ "Case-Control",
      design == "other" ~ "Before-After"),
      age = ifelse(row_number() == n(), "Total", age)
  ) %>%
  select(age, surg_nosurg, design, total) %>%
  kbl(
    booktabs = T, align = c("lllr"),
    col.names = c("Age", "Patients", "Design", "N")
  ) %>%
  row_spec(c(0, 15), bold = TRUE) %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "8em") %>%
  column_spec(2, width = "8em") %>%
  column_spec(3, width = "10em") %>%
  column_spec(4, width = "3em") %>% 
  footnote(
    general = "RCT: randomized controlled trial.",
    # alphabet = c("Footnote a", "Footnote b", ...),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

## *Adult Surgical*

<br/>

<font size = 4> Table `r table_n`. Studies of adults undergoing surgery (see [References](#references) for citations). </font>

```{r studiesIncludedList, echo = FALSE, include = TRUE}
## * (updated 2021/03/01 09:25) included_studies ----------------------------
included_studies <- study_char_cho.dat %>%
  select(refid, study, year, age, surg_nosurg, design, n_analyze, country, centers, non_vh_hdi, surg_type) %>%
  mutate(
    surg = case_when(
      str_detect(surg_type, "[Gg]yn|[Hh]ysterectomy") ~ "Gyn",
      str_detect(surg_type, "craniotomy") ~ "Neurosurgical",
      str_detect(surg_type, "maxillofacial") ~ "Maxillofacial",
      str_detect(surg_type, "[Hh]ernia|herniorrhaphy") ~ "Herniorrhaphy",
      str_detect(surg_type, "prostatectomy") ~ "Prostatectomy",
      str_detect(surg_type, "ariety") ~ "Various",
      str_detect(surg_type, "various|Hirschsprung's") ~ "Various",
      str_detect(surg_type, "CABG|[Cc]oronary artery bypass surgery") ~ "CABG",
      str_detect(surg_type, "Cardiac surgery") ~ "Cardiac",
      str_detect(surg_type, "[Cc]olorectal|[Bb]owel|colon resection") ~ "Colorectal",
      str_detect(surg_type, "[Tt]hyroid|hip joint") ~ "Thyroid",
      str_detect(surg_type, "[Oo]rthopedic|discectomy") ~ "Orthopedic",
      str_detect(surg_type, "total hip or total knee replacement|[Tt]otal hip|[Tt]otal knee|Hip joint|hip replacement") ~ "TKA/THA",
      str_detect(surg_type, "cholecystectomy") ~ "Cholecystectomy",
      str_detect(surg_type, "pancreaticoduodenectomy") ~ "Whipple",
      str_detect(surg_type, "[Gg]ast|Bowel") ~ "Other GI",
      str_detect(surg_type, "not appli") ~ "None (healthy)",
      str_detect(surg_type, "oral") ~ "Oral",
      str_detect(surg_type, "minor") ~ "Misc minor",
      str_detect(surg_type, "None") ~ "None (healthy)",
      str_detect(surg_type, "abdomin") ~ "Other GI",
      str_detect(surg_type, "[Cc]esarean") ~ "Cesarean delivery",
      str_detect(surg_type, "[Cc]aesarian") ~ "Cesarean delivery",
      str_detect(surg_type, "[Ll]abor") ~ "Labor",
      str_detect(surg_type, "thoracotomy") ~ "Thoracic",
      str_detect(surg_type, "healthy") ~ "None (healthy)",
      str_detect(surg_type, "Elective") ~ "Elective",
      str_detect(surg_type, "adenotonsillectomy") ~ "Adenotonsillectomy",
      str_detect(surg_type, "[Bb]reast") ~ "Breast",
      str_detect(surg_type, "Endso|endoscopic|colonoscopy") ~ "Endoscopic"
    ),
    surg_nosurg = ifelse(surg_nosurg == "non-surgical", "None", surg_nosurg),
    study = ifelse(grepl("Marquini", study), str_c(study, "^b^"), study),
    country = ifelse(grepl("USA", country), "USA", country),
    country = ifelse(grepl("UK", country), "UK", country),
    country = ifelse(!is.na(non_vh_hdi), str_c(country, "^a^"), country),
    n_analyze = ifelse(refid == 2009, 9, n_analyze)
  ) 

## (updated 2021/03/01 09:24) adult surgical ------------------------------
included_studies %>% 
  arrange(age, design, surg, country, year, study) %>%
  filter(age == "Adult", surg_nosurg == "surgical") %>% 
  select(refid, study, n_analyze, centers, country, surg) %>%
  kbl(
    booktabs = T, align = c("llccll"), # format = "latex",
    col.names = c("        ID", "Study", "Analyzed (N)", "Centers", "Country^a^", "Surgery")
  ) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "6em") %>%
  column_spec(2, width = "10em") %>%
  column_spec(3, width = "6em") %>%
  column_spec(4, width = "6em") %>%
  column_spec(5, width = "10em") %>%
  column_spec(6, width = "12em") %>%
  pack_top(., "RCT", 1, 84) %>%
  pack_top(., "Nonrandomized Studies of Interventions", 85, 92) %>%
  pack_top(., "Prospective Cohort", 93, 95) %>%
  pack_top(., "Retrospective Cohort", 96, 97) %>%
  pack_top(., "Case-Control", 98, 98) %>%
  pack_top(., "Before-After", 99, 99) %>%
  footnote(
    general = "RCT: randomized controlled trial.",
    alphabet = c(
      "Non very high [Human Development Index](https://en.wikipedia.org/wiki/List_of_countries_by_Human_Development_Index) country.",
    "Multiple publications of the same study."),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

## *Adult Nonsurgical*

<br/>

<font size = 4> Table `r table_n`. Studies of healthy adults not undergoing surgery (see [References](#references) for citations). </font>

```{r studiesAdultNonsurg, echo = FALSE, include = TRUE}
## (updated 2021/03/01 09:24) adult nonsurgical ---------------------------
included_studies %>% 
  arrange(age, design, country, year, study) %>%
  filter(age == "Adult", surg_nosurg == "None") %>% 
  select(refid, study, n_analyze, centers, country, surg) %>%
  kbl(
    booktabs = T, align = c("llccll"), 
    col.names = c("        ID", "Study", "Analyzed (N)", "Centers", "Country^a^", "Surgery")
  ) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "6em") %>%
  column_spec(2, width = "10em") %>%
  column_spec(3, width = "6em") %>%
  column_spec(4, width = "6em") %>%
  column_spec(5, width = "10em") %>%
  column_spec(6, width = "12em") %>%
  pack_top(., "RCT", 1, 1) %>%
  pack_top(., "Crossover", 2, 10) %>%
  pack_top(., "Nonrandomized Studies of Interventions", 11, 12) %>% 
  footnote(
    alphabet = c(
      general = "RCT: randomized controlled trial.",
      "Non very high [Human Development Index](https://en.wikipedia.org/wiki/List_of_countries_by_Human_Development_Index) country."
    ),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

## *Pediatric Surgical*

<br>

<font size = 4> Table `r table_n`. Studies of pediatric surgical patients (see [References](#references) for citations). </font>

```{r studiesPedsSurg, echo = FALSE, include = TRUE}
## (updated 2021/03/01 09:24) pediatric surgical --------------------------
included_studies %>% 
  filter(age == "Pediatric", surg_nosurg == "surgical") %>% 
  arrange(surg, country, year, study) %>%
  select(refid, study, n_analyze, centers, country, surg) %>%
  kbl(
    booktabs = T, align = c("llccll"), # format = "latex",
    col.names = c("        ID", "Study", "Analyzed (N)", "Centers", "Country^a^", "Surgery")
  ) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "6em") %>%
  column_spec(2, width = "10em") %>%
  column_spec(3, width = "6em") %>%
  column_spec(4, width = "6em") %>%
  column_spec(5, width = "10em") %>%
  column_spec(6, width = "12em") %>%
  pack_top(., "RCT", 1, 7) %>%
  pack_top(., "Nonrandomized Studies of Interventions", 8, 8) %>%
  pack_top(., "Prospective Cohort", 9, 9) %>%
  footnote(
    general = "RCT: randomized controlled trial.",
    alphabet = c(
      "Non very high [Human Development Index](https://en.wikipedia.org/wiki/List_of_countries_by_Human_Development_Index) country."),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br>

## *Pediatric Nonsurgical*

<br/>

<font size = 4> Table `r table_n`. Studies of healthy pediatric individuals not undergoing surgery (see [References](#references) for citations). </font>

```{r studiesPedsNonsurg, echo = FALSE, include = TRUE}
## (updated 2021/03/01 09:24) pediatric surgical --------------------------
included_studies %>% 
  filter(age == "Pediatric", surg_nosurg == "None") %>% 
  select(refid, study, n_analyze, centers, country, surg) %>%
  kbl(
    booktabs = T, align = c("llccll"), # format = "latex",
    col.names = c("        ID", "Study", "Analyzed (N)", "Centers", "Country^a^", "Surgery")
  ) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "6em") %>%
  column_spec(2, width = "10em") %>%
  column_spec(3, width = "6em") %>%
  column_spec(4, width = "6em") %>%
  column_spec(5, width = "10em") %>%
  column_spec(6, width = "12em") %>%
  pack_top(., "RCT", 1, 1) %>%
  pack_top(., "Crossover", 2, 2) %>%
  pack_top(., "Prospective Cohort", 3, 3) %>%
  footnote(
    general = "RCT: randomized controlled trial",
    alphabet = c(
      "Non very high [Human Development Index](https://en.wikipedia.org/wiki/List_of_countries_by_Human_Development_Index) country."
    ),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

<hr style="height:2px;border-width:0;color:gray;background-color:gray">

# **Patient Reported Outcomes** 

```{r dichotChoDataSurgical, include = FALSE}
## * (updated 2021/01/12 09:26; in temp_to_run) dichotChoDataNonSurgical ----------------------
dichot_nonsurg_cho.dat <- dichot_cho.dat %>%
  # only Jian 2017, non-surgical, reported any pro (hunger thirst) and was not included
  filter(surg_nosurg == "non-surgical") %>%
  mutate(
    hunger_np = n_percent(hunger_n, hunger_per),
    thirst_np = n_percent(thirst_n, thirst_per),
    nausea_np = n_percent(nausea_n, nausea_per),
    vomit_np = n_percent(vomit_n, vomit_per),
    comfort_np = n_percent(arm_n - comfort_n, 100 - comfort_per),
    satisfac_np = n_percent(satisfac_n, satisfac_per),
    complicate_np = n_percent(complicate_n, complicate_per),
    hypotension_np = n_percent(hypotension_n, hypotension_per),
    regurg_np = n_percent(regurg_n, regurg_per),
    rgv_gt25_np = n_percent(rgv_gt25_n, rgv_gt25_per),
    ph_lt25_np = n_percent(ph_lt25_n, ph_lt25_per),
    aspirate_np = n_percent(aspirate_n, aspirate_per),
    vomit_np = ifelse(refid == 6446 & arm_n == 40, "4 (10)", vomit_np)) %>%
  arrange(age, desc(surg_nosurg), design, year, study, arm_tx, arm) %>%
  select(refid, study, year, age, design, surg_nosurg, arm, arm_n, arm_tx, hr_gt6, hr_26, hr_2, time_outcome, hunger_np:aspirate_np, compl_descript, out_dichot_notes, ends_with("_n"), timeingest1, amtingest1, timeingest2, amtingest2, ends_with("per")) %>%
  filter_at(vars(hunger_np:aspirate_np), any_vars(!is.na(.)))

## * (updated 2021/01/12 09:26; in temp_to_run) dichotChoDataSurgical ----------------------
dichot_cho.dat <- dichot_cho.dat %>%
  # only Jian 2017, non-surgical, reported any pro (hunger thirst) and was not included
  filter(surg_nosurg == "surgical") %>%
  mutate(
    hunger_np = n_percent(hunger_n, hunger_per),
    thirst_np = n_percent(thirst_n, thirst_per),
    nausea_np = n_percent(nausea_n, nausea_per),
    vomit_np = n_percent(vomit_n, vomit_per),
    comfort_np = n_percent(arm_n - comfort_n, 100 - comfort_per),
    satisfac_np = n_percent(satisfac_n, satisfac_per),
    complicate_np = n_percent(complicate_n, complicate_per),
    hypotension_np = n_percent(hypotension_n, hypotension_per),
    regurg_np = n_percent(regurg_n, regurg_per),
    rgv_gt25_np = n_percent(rgv_gt25_n, rgv_gt25_per),
    ph_lt25_np = n_percent(ph_lt25_n, ph_lt25_per),
    aspirate_np = n_percent(aspirate_n, aspirate_per),
    vomit_np = ifelse(refid == 6446 & arm_n == 40, "4 (10)", vomit_np)) %>%
  arrange(age, desc(surg_nosurg), design, year, study, arm_tx, arm) %>%
  select(refid, study, year, age, design, surg_nosurg, arm, arm_n, arm_tx, hr_gt6, hr_26, hr_2, time_outcome, hunger_np:aspirate_np, compl_descript, out_dichot_notes, ends_with("_n"), timeingest1, amtingest1, timeingest2, amtingest2, ends_with("per")) %>%
  filter_at(vars(hunger_np:aspirate_np), any_vars(!is.na(.)))

## * (updated 2021/03/10 13:29; in temp_to_run) cho_amts adult rct ----------------------------
cho_amts <- study_arm_cho.dat %>%
  filter(design == "rct", age == "Adult", surg_nosurg == "surgical") %>%
  filter(arm_tx %in% c("CHO/Comp/Prot", "CHO/Simp/Prot", "CHO/Comp", "CHO/Simp")) %>%
  filter(refid %in% cho_refids) %>%
  mutate(
    amtingest2 = replace_na(amtingest2, 0),
    amtingest1 = replace_na(amtingest1, 0),
    tot_vol = amtingest2 + amtingest1,
    prot_gm_all = prot_conc * tot_vol / 100,
    cho_gm_all = cho_conc * tot_vol / 100,
    cho_gm_1 = cho_conc * amtingest1 / 100,
    cho_gm_2 = cho_conc * amtingest2 / 100,
    cho_gm_all = ifelse(is.na(cho_gm_all), cho_gm, cho_gm_all),
    prot_gm_all = ifelse(is.na(prot_gm_all), protein_gm, prot_gm_all)) %>%
  select(refid, study, arm_tx, arm, cho_gm, protein_gm, prot_gm_all, cho_gm_all, cho_gm_1, cho_gm_2, amtingest1, amtingest2, prot_conc, cho_conc)

```

<br/>

## *Preoperative Hunger* 

<a id="choTab6"></a>

### Rates (surgical) 

<br/>

<font size = 4> Table `r table_n`. Rates of preoperative hunger according to fasting, liquid and volume. </font>

```{r hungerTableOr, include = TRUE}
## (updated 2021/01/12 09:42) hungerTableOr -------------------------------
dichot_format <- function(x) (x/100)

dichot_hunger_or <- dichot_cho.dat %>% 
  filter(!is.na(hunger_np)) %>%
  select(refid, study, arm_tx, arm_n, hunger_n) %>% 
  group_by(refid) %>% 
  filter(n() > 1)

or_hunger <- with(or_join(dichot_hunger_or, "hunger"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2))

```

```{r hungerTableDichot, include = TRUE}
## (updated 2021/01/12 18:04) hungerTable ---------------------------------
dichot_hunger <- dichot_cho.dat %>% 
  filter(!is.na(hunger_np)) %>%
  arrange(age, desc(surg_nosurg), design, year, study) %>% 
  select(refid:time_outcome, hunger_np, hunger_per, hunger_n, out_dichot_notes) %>% 
  rename(notes = out_dichot_notes)

dichot_hunger <- left_join(dichot_hunger, or_hunger, by = "refid") %>%
  mutate(pre_post_op = ifelse(time_outcome > 0, "Postop", "Preop")) %>%
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    or_ci = ifelse(row_number() == 1, or_ci, NA),
  ) %>%
  ungroup() %>%
  mutate(hunger_per = round(hunger_per, 0)) %>%
  select(refid, arm, design, age, study, arm_n, arm_tx, starts_with("hr"), pre_post_op, time_outcome, hunger_np, hunger_per, or_ci, notes) 

cho_row <- dichot_hunger %>%
  mutate(line = row_number()) %>%
  filter(grepl("CHO", arm_tx)) %>%
  pull(line)

dichot_hunger$hunger_bar <- 0
dichot_hunger$hunger_bar <- ifelse(grepl("CHO", dichot_hunger$arm_tx),
  color_bar("darksalmon", fun = dichot_format)(dichot_hunger$hunger_per),
  color_bar("lightgray", fun = dichot_format)(dichot_hunger$hunger_per))

dichot_hunger <- dichot_hunger %>%
  add_foot(study, "Koeppe 2013", "a") %>%
  add_foot(study, "Panebianco 2020", "b") %>%
  add_foot(study, "Taniguchi 2011", "c") %>%
  # add_foot(study, "TDrobjewski 2018", "d") %>%
  add_foot(or_ci, "2.38 (1.29-4.39)", "e") %>%
  add_foot(or_ci, "1.72 (0.96-3.07)", "e") %>%
  add_foot(or_ci, "0.75 (0.43-1.30)", "e") %>%
  mutate(
    hunger_bar = str_replace(hunger_bar, ">\\d+", ">&nbsp;"),
    hunger_bar = ifelse(hunger_per == 0, "", hunger_bar),
    # pre_post_op = ifelse(study == "Taniguchi 2011^d^", cell_spec(pre_post_op, color = "black"), pre_post_op),
    study = ifelse(study == "Taniguchi 2011^c^", cell_spec(study, color = "black"), study)
  )

## (updated 2021/01/12 18:04) hungerKable ---------------------------------
dichot_hunger %>%
  filter(pre_post_op != "Postop") %>%
  # verify 2-hour timing
  # temp <- dichot_hunger %>%
  # filter(pre_post_op != "Postop") %>% 
  # pull(refid)
  # two_hours(temp)
  # verified no notes indicated hunger recorded preop
  select(!c(refid, arm, design, age, hunger_per, time_outcome, pre_post_op)) %>%
  select(study, arm_tx, arm_n:hunger_np, hunger_bar, or_ci) %>%
  kbl(
    booktabs = T, align = c("llccccrlc"), escape = FALSE,
    col.names = c("       Study", "Liquid", "N", "> 6", "6→2", "2", "N (%)", " ", "CHO vs. Comparator")
  ) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Hunger" = 2, "OR (95% CI)"), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4, 6), width = "3em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(7, width = "5em") %>%
  column_spec(8, width = "5em") %>%
  column_spec(9, width = "11em") %>%
  row_spec(cho_row, color = "brown") %>%
  pack_top(., "Adult, Surgical", 1, 9) %>%
  pack_sub(., "RCT", 1, 8) %>%
  pack_sub(., "Prospective Cohort", 9, 9) %>%
  pack_top(., "Pediatric, Surgical", 10, 11) %>%
  pack_sub(., "RCT", 10, 11) %>%
  # pack_top(., "Adult, Surgical", 1, 14) %>%
  # pack_sub(., "RCT", 1, 13) %>%
  # pack_sub(., "Prospective Cohort", 14, 14) %>%
  # pack_top(., "Pediatric, Surgical", 15, 16) %>%
  # pack_sub(., "RCT", 15, 16) %>%
  footnote(
    general = "RCT: randomized controlled trial; OR: odds ratio; CHO: carbohydrate; Simp: simple; Comp: complex; Prot: protein.",
    alphabet = c(
      "'Did you feel hunger during the fasting period?'",
      "Reported no hunger.",
      "Oral rehydration consumed between 5 and 2 hours prior to surgery. 'Did you feel hungry before surgery?' "
      # "Hunger present or absent."
      # "OR vs. combined CHO/Simp arms."
    ),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

<a id="choTab7"></a>

### Patient-rated (surgical) 

<br/>

<font size = 4> Table `r table_n`. Patient-rated preoperative hunger according to fasting, liquid and volume. </font>

```{r hungerTableLikert, include = TRUE}
## (updated 2021/01/13 05:51) hungerLikert --------------------------------
likert_cho_hung.dat <- likert_cho.dat %>%
  filter(refid %in% cho_refids) %>%
  filter(hunger_l == "hunger_l") %>%
  rename(notes = out_l_notes) %>%
  # filter_at(vars(hunger_m:hunger_pval), any_vars(!is.na(.))) # 1290 not incpuded as RR in notes field
  select(refid:age, arm_n, arm_tx, likert_time_outcome, contains("ingest"), starts_with("hunger"), starts_with("hr"), notes) %>%
  mutate(arm_tx = droplevels(arm_tx)) %>%
  # fill in any misssing time outcomes
  group_by(refid) %>%
  fill(likert_time_outcome) %>%
  ungroup() %>%
  mutate(
    pre_post_op = ifelse(likert_time_outcome > 0, "Postop", "Preop"),
    # Wendling 2020 is preop
    pre_post_op = ifelse(refid %in% c(262), "Preop", pre_post_op),
    pre_post_op = ifelse(surg_nosurg == "non-surgical", likert_time_outcome, pre_post_op)
  ) %>%
  arrange(age, desc(surg_nosurg), design, desc(pre_post_op), year, study, arm_tx)

likert_cho_hung_kbl.dat <- likert_cho_hung.dat %>%
  # note includes pre and postop, filtered before table
  rename(time_outcome = likert_time_outcome) %>%
  select(refid:arm_tx, hr_gt6, hr_26, hr_2, hr_minus2, hr_0, time_outcome, pre_post_op, hunger_scale, hunger_m:hunger_iqru, notes) %>%
  mutate(
    # fix Naguib Savluk Rizvanovic assume SEM
    hunger_sd = ifelse(refid %in% c(1274, 602, 431), hunger_sd * sqrt(arm_n), hunger_sd),
    # save hunger_med value
    hung_md = hunger_med,
    hunger_med = paste0(hunger_med, " (", round_0(hunger_iqrl), "-", round_0(hunger_iqru), ")"),
    hunger_med = ifelse(refid %in% c(2674, 3588), paste0(hung_md, " (", round_1(hunger_iqrl), "-", round_1(hunger_iqru), ")"), hunger_med),
    hunger_med = ifelse(hunger_med == "NA (NA-NA)", NA, hunger_med),
    hunger_med = gsub(" \\(NA-NA\\)", "", hunger_med),
    # Melis use only median because is change score with IQR as just lower
    # NOTE: footnote c: Mellis "Within group change from baseline."
    hunger_med = ifelse(refid == 4952, paste0(hung_md, " (", round_0(hunger_iqrl), ")^b^"), hunger_med),
    ranges = str_c("(", round_0(hunger_rl), "-", round_0(hunger_ru), ")"),
    hunger_sd = ifelse(is.na(hunger_sd) & !is.na(hunger95u), sd_confint(hunger95l, hunger95u), hunger_sd),
    mn_95_ci = str_c(round_1(hunger_m), " (", round_1(hunger95l), "-", round_1(hunger95u), ")"),
    mn_95_ci = ifelse(!is.na(hunger_m) & !is.na(hunger_sd), str_c(round_1(hunger_m), " (", round_1(hunger_m - (1.96 * hunger_sd)), "-", round_1(hunger_m + (1.96 * hunger_sd)), ")"), mn_95_ci),
    mn_95_ci = ifelse(mn_95_ci == "NA (NA-NA)", NA, mn_95_ci),
    mn_95_ci = str_replace(mn_95_ci, "\\(NA-NA\\)", ""),
    # mn_sd = NA,
    mn_sd = ifelse(!is.na(hunger_sd) & !is.na(hunger_m), paste0(round_1(hunger_m), " (", round_1(hunger_sd), ")"), round_2(hunger_m)),
    mn_sd = ifelse(refid == 262, paste0(mn_sd, "^c^"), mn_sd),
    mn_sd = na_if(mn_sd, " NA"),
    hunger_med = str_replace(hunger_med, "\\(NA-NA\\)", ""),
    ranges = str_replace(ranges, "\\(NA-NA\\)", ""),
    # NOTE: footnote e: Hunger Satiety Scale
    hunger_scale = ifelse(hunger_scale == "VAS: 0 to 100", "0→100", hunger_scale),
    hunger_scale = ifelse(hunger_scale == "VAS, 0-100", "0→100", hunger_scale),
    hunger_scale = ifelse(hunger_scale == "VAS, 0 to 100", "0→100", hunger_scale),
    hunger_scale = ifelse(hunger_scale == "VAS, 0 to 10", "0→10", hunger_scale),
    hunger_scale = ifelse(hunger_scale == "VAS, 1 to 10", "0→10", hunger_scale),
    hunger_scale = ifelse(hunger_scale == "VAS, 0-10", "0→10", hunger_scale),
    hunger_scale = ifelse(hunger_scale == "NRS, 0 to 10", "0→10^NRS^", hunger_scale),
    hunger_scale = ifelse(hunger_scale == "NRS, 0 to 2", "0→2^NRS^", hunger_scale),
    hunger_scale = ifelse(hunger_scale == "NRS, 0 to 3", "0→3^NRS^", hunger_scale),
    hunger_scale = ifelse(hunger_scale == "Likert, 0 to 3", "0→3^NRS^", hunger_scale),
    hunger_scale = ifelse(refid == 3588, "1→5^NRS^", hunger_scale),
    hunger_scale = ifelse(refid == 1315, "5→1^HSS^", hunger_scale),
    hunger_med = ifelse(grepl("(AM)", study) & arm_tx == "Fasting", str_c(hunger_med, "^d^"), hunger_med),
    hunger_med = ifelse(grepl("(PM)", study) & arm_tx == "Fasting", str_c(hunger_med, "^d^"), hunger_med),
    # Naugib footnote
    # mn_sd = ifelse(refid == 5803 & arm_tx == "Clear", paste0(mn_sd, "^b^"), mn_sd),
    # time_outcome = ifelse(study == "Wendling 2020", paste0(time_outcome, "^f^"), time_outcome),
    # TODO: z "Change from ingestion to 1 hour later."
  ) %>%
  arrange(age, desc(surg_nosurg), design, desc(pre_post_op), year, study) %>%
  group_by(study) %>%
  mutate(
    # for non-surgical use hr_26 as amount
    hr_26 = ifelse(surg_nosurg == "non-surgical", hr_0, hr_26),
  ) %>%
  ungroup() %>%
  select(-c(hr_minus2, hr_0))
```

```{r hungerAdultSurgKable, echo = FALSE}
## (updated 2020/12/13 13:48) hungerAdultSurgKable ------------------------
cho_row <- likert_cho_hung_kbl.dat %>%
  filter(pre_post_op %in% c("Preop")) %>% 
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    hunger_scale = ifelse(row_number() == 1, hunger_scale, NA),
  ) %>%
  ungroup() %>% 
  mutate(line = row_number()) %>%
  filter(grepl("CHO", arm_tx)) %>%
  pull(line)

likert_cho_hung_kbl.dat %>%
  # "Preop" are only surgical studies, verified no notes indicate post-op measures
  filter(pre_post_op %in% c("Preop")) %>% 
  # verify 2-hour timing verified 2021/06/21 11:42
  # temp <- likert_cho_hung_kbl.dat %>%
  # filter(pre_post_op %in% c("Preop")) %>% 
  # pull(refid)
  # two_hours(temp)
  # filter(pre_post_op %in% c("2")) %>% 
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    hunger_scale = ifelse(row_number() == 1, hunger_scale, NA),
  ) %>%
  ungroup() %>% 
  mutate(
    arm_tx = ifelse(refid == 1315 & arm_tx == "Clear", "Apple juice", as.character(arm_tx))
  ) %>%
  select(study, arm_tx, arm_n, hr_gt6, hr_26, hr_2, hunger_scale, mn_sd, hunger_med, ranges) %>%
  add_row() %>%
  kbl(
    booktabs = T, align = c("llcccclll"), escape = FALSE,
    col.names = c(
      "       Study", "Liquid", "N", "> 6", "6→2", "2", "Scale^a^", "M (SD)",
      "Med (IQR)", "Range"
    )
  ) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Hunger Rating" = 4), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  # NOTE: footnote a: includes at 2.5 hours
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4,6), width = "3em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(7, width = "4em") %>%
  column_spec(8, width = "6em") %>%
  column_spec(9, width = "7em") %>%
  column_spec(10, width = "4em") %>%
  row_spec(cho_row, color = "brown") %>%
  pack_top(., "Adult, Surgical", 1, 47) %>%
  pack_sub(., "RCT", 1, 41) %>%
  pack_sub(., "Nonrandomized Studies of Interventions", 42, 47) %>%
  result_pack("No detected difference", 46, padding = 70) %>%
  result_pack("Difference  p < .0001", 48, padding = 70) %>%
  # pack_top(., "Adult, Surgical", 1, 52) %>%
  # pack_sub(., "RCT", 1, 46) %>%
  # pack_sub(., "Nonrandomized Studies of Interventions", 47, 52) %>%
  # result_pack("No detected difference", 51, padding = 70) %>%
  # result_pack("Difference  p < .0001", 53, padding = 70) %>%
  footnote(
    general = "RCT: randomized controlled trial; M: mean; SD: standard deviation; Med: median; IQR: interquartile range; NRS: numeric rating scale.",
    alphabet = c(
      "Arrow (→) indicates best to worst hunger (visual analogue if not noted NRS).",
      # "Detected a difference vs. fasting and water, p < .05.",
      "Within group change from baseline; reported IQR as a single value.",
      "Difference from before beverage consumption to 1 hr post-consumption.",
      "IQR bound outside range of scale used."
      # "Range as reported but apparent error being <1 or >5.",
    ),
    general_title = "",
    footnote_as_chunk = FALSE
  )

  table_n <- tab_inc()
```

<br/>

<a id="choTab8"></a>

### Patient-rated (nonsurgical) 

<br/>

<font size = 4> Table `r table_n`. Patient-rated hunger 2 hours following liquids in nonsurgical studies according to fasting, liquid and volume. </font>

```{r hungerNonSurgKable, echo = FALSE}
## (updated 2020/12/13 13:48) hungerAdultSurgKable ------------------------
cho_row <- likert_cho_hung_kbl.dat %>%
  # filter(pre_post_op %in% c("Preop")) %>% 
  filter(pre_post_op %in% c("2")) %>%
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    hunger_scale = ifelse(row_number() == 1, hunger_scale, NA),
    time_outcome = ifelse(row_number() == 1, time_outcome, NA)
    # for non-surgical use hr_26 as amount
  ) %>%
  ungroup() %>% 
  mutate(line = row_number()) %>%
  filter(grepl("CHO", arm_tx)) %>%
  pull(line)

# verify 2-hour timing, not applicable healthy volunteers

likert_cho_hung_kbl.dat %>%
  # filter(pre_post_op %in% c("Preop")) %>% 
  filter(pre_post_op %in% c("2")) %>%
  mutate(
    hunger_med = ifelse(hunger_med == "18.98", "19.0", hunger_med)
  ) %>% 
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    hunger_scale = ifelse(row_number() == 1, hunger_scale, NA),
    time_outcome = ifelse(row_number() == 1, time_outcome, NA),
    # pre_post_op = ifelse(row_number() == 1, pre_post_op, NA),
    # for non-surgical use hr_26 as amount
  ) %>%
  ungroup() %>% 
    mutate(
    study = ifelse(study == "Jian 2017", cell_spec(study, color = "black"), study),
  ) %>%
  select(study, arm_tx, arm_n, hr_26, hunger_scale, mn_sd, hunger_med, ranges) %>%
  add_row() %>%
  kbl(
    booktabs = T, align = c("llccclll"), escape = FALSE,
    col.names = c(
      "        Study", "Liquid", "N", "2 hr", "Scale^a^", "M (SD)", "Med (IQR)", "Range"
    )
  ) %>%
  add_header_above(c(" " = 3, "Volume (mL)" = 1, "Hunger Rating" = 4), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  # NOTE: footnote a: includes at 2.5 hours
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(4, width = "7em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(6, width = "6em") %>%
  column_spec(7, width = "7em") %>%
  column_spec(8, width = "4em") %>%
  row_spec(cho_row, color = "brown") %>%
  pack_top(., "Adult, Non-surgical", 1, 2) %>%
  pack_sub("Crossover", 1, 2) %>%
  result_pack("Did not compare groups", 3, padding = 70) %>%
  pack_top(., "Pediatric, Non-surgical", 3, 8) %>%
  result_pack("No detected differences", 6, padding = 70) %>%
  result_pack("No detected difference", 8, padding = 70) %>%
  footnote(
    general = " hr: hours; M: mean; SD: standard deviation; Med: median; IQR: interquartile range; HSS: Hunger Satiety Scale.",
    alphabet = c(
      "Arrow (→) indicates best to worst hunger (visual analogue or HSS)."
      # "Range as reported but apparent error being <1 or >5."
    ),
    general_title = "",
    footnote_as_chunk = FALSE
  )

  table_n <- tab_inc()
```

<br/>

<a id="choFig1"></a> 

### Pooled (adult RCTs, rates) 

<br/>

<font size = 4> Figure `r figure_n`. Pooled preoperative hunger from randomized trials comparing carbohydrate drinks with fasting in adult surgical patients. </font>

```{r hungerMetaDichotDat, fig.align = "left", include = TRUE,  fig.width = 10, fig.height = 3.2}
## (updated 2021/01/13 09:48) --------------------------------------------
hunger_meta.dat <- dichot_hunger %>% 
  filter(age == "Adult", design == "rct") %>% 
  filter(str_detect(arm_tx, "CHO|Fast")) %>% 
  mutate(arm_tx = as.character(arm_tx),
    simp_comp = ifelse(grepl("Simp", arm_tx), "Simple", "Complex"),
    arm_tx = ifelse(grepl("CHO", arm_tx), "CHO", arm_tx),
    n = as.numeric(str_extract(hunger_np, "^\\d{1,2}"))) %>% 
  select(refid, study, simp_comp, arm_tx, n, arm_n) %>% 
  group_by(refid) %>% 
  fill(study) %>% 
  ungroup() %>% 
  pivot_wider(id_cols = c("refid", "study"), names_from = "arm_tx", values_from = c("n", "arm_n"), values_fn = sum) %>% 
  rename(fast_e = n_Fasting, fast_n = arm_n_Fasting, cho_e = n_CHO, cho_n = arm_n_CHO) %>% 
  select(refid, study, fast_e, fast_n, cho_e, cho_n) %>% 
  mutate(study = str_replace(study, "\\^[a-z]\\^", ""))

simp_comp.dat <- dichot_hunger %>% 
  filter(age == "Adult", design == "rct") %>% 
  filter(str_detect(arm_tx, "CHO|Fast")) %>% 
  mutate(arm_tx = as.character(arm_tx),
    simp_comp = ifelse(grepl("Simp", arm_tx), "Simple", "Complex")) %>% 
  select(refid, arm_tx, simp_comp) %>% 
  filter(arm_tx != "Fasting") %>% 
  distinct(refid, simp_comp)

hunger_meta.dat <- left_join(hunger_meta.dat, simp_comp.dat, by = "refid") 

## (updated 2021/06/07 15:04) meta ----------------------------------------
hunger_meta <- metabin(cho_e, cho_n, fast_e, fast_n,
  data = hunger_meta.dat,
  studlab = study,
  sm = "OR",
  method = "MH",
  method.tau = "PM",
  hakn = FALSE,
  prediction = FALSE,
  # byvar = simp_comp,
  digits = 2)

forest(hunger_meta,
  comb.fixed = FALSE,
  lab.e = "CHO     ",
  lab.c = "Fasting    ",
  rightcols = c("effect", "ci"),
  rightlabs = c("OR", "95% CI    "),
  digits = 2,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = FALSE,
  prediction = FALSE,
  fs.xlab = 11,
  pooled.events = TRUE,
  subgroup = TRUE,
  print.byvar = FALSE,
  xlim = c(0.01, 2),
  at = c(.01, .1, .25, 1, 2),
  xlab = "Favors CHO           Favors Fasting")

figure_n <- fig_inc()
```

```{r hungerSensBias, include = FALSE, echo = FALSE, fig.width = 10, fig.height = 3.5, fig.align = "center"}
# metabias(hunger_meta, plotit = TRUE, k.min = 5)
# funnel(hunger_meta)
```
Too few studies to examine small-study effects. 

<br>

<a id="choFig2"></a> 

### Pooled (adult RCTs, patient-rated) 

<br>

<font size = 4> Figure `r figure_n`. Pooled preoperative hunger ratings (standardized mean differences in VAS or NRS) from randomized trials comparing carbohydrate drinks with fasting in adult surgical patients. </font>

```{r hungerAdultLikertMeta, echo = FALSE, fig.width = 10, fig.height = 5.5, fig.align = "left"}
## (updated 2021/02/16 11:15) hungerAdultLikertMeta ----------------------------
hung_lik_meta.dat <- likert_cho_hung_kbl.dat %>%
  # only preop studies
  filter(age == "Adult", design == "rct", pre_post_op == "Preop") %>%
  select(refid, study, pre_post_op, arm_tx, arm_n, hunger_m, hunger_sd, hung_md, hunger_iqrl, hunger_iqru, hunger_rl, hunger_ru) %>%
  # remove Naguib 5803, Melis 4952 lacking data to pool
  filter(!refid %in% c(5803, 4952)) %>%
  # estimates from p-values
  mutate(
    arm_n =       ifelse(study == "Savluk 2017" & arm_tx == "CHO", 113, arm_n),
    hunger_m =    ifelse(study == "Savluk 2017" & arm_tx == "CHO", 2.675, hunger_m),
    hunger_sd =   ifelse(study == "Savluk 2017" & arm_tx == "CHO", 1.227, hunger_sd),
    hunger_iqrl = ifelse(study == "Canbay 2014", NA, hunger_iqrl), # to allow est m, sd
    hunger_iqru = ifelse(study == "Canbay 2014", NA, hunger_iqru),
    hunger_m =    ifelse(study == "Zhang 2019" & arm_tx == "CHO/Comp", 10, hunger_m),
    hunger_sd =   ifelse(study == "Zhang 2019" & arm_tx == "CHO/Comp", 36.84, hunger_sd),
    hunger_m =    ifelse(study == "Zhang 2019" & arm_tx == "Fasting", 43.6, hunger_m),
    hunger_sd =   ifelse(study == "Zhang 2019" & arm_tx == "Fasting", 36.84, hunger_sd),
    hunger_m =    ifelse(study == "Yagmurdur 2011" & arm_tx == "CHO/Comp", 22, hunger_m),
    hunger_sd =   ifelse(study == "Yagmurdur 2011" & arm_tx == "CHO/Comp", 44.062, hunger_sd),
    hunger_m =    ifelse(study == "Yagmurdur 2011" & arm_tx == "Fasting", 69, hunger_m),
    hunger_sd =   ifelse(study == "Yagmurdur 2011" & arm_tx == "Fasting", 44.062, hunger_sd),
  )

# fasting
fast_meta.dat <- hung_lik_meta.dat %>%
  filter(grepl("Fasting|CHO", arm_tx)) %>%
  mutate(
    arm_tx = ifelse(grepl("CHO", arm_tx), "CHO", "Fasting"),
    # combine Wendling arms
    arm_n = ifelse(study == "Wendling 2020" & arm_tx == "CHO", 45, arm_n),
    hunger_m = ifelse(study == "Wendling 2020" & arm_tx == "CHO", -8.89, hunger_m),
    hunger_sd = ifelse(study == "Wendling 2020" & arm_tx == "CHO", 7.64, hunger_sd),
    hunger_sd = ifelse(study == "Wendling 2020" & arm_tx == "Fasting", 3.403, hunger_sd)
  ) %>%
  group_by(refid) %>%
  filter(n() > 1) %>%
  filter(row_number() < 3) %>%
  fill(pre_post_op) %>% 
  ungroup() %>%
  # select(-refid) %>%
  pivot_wider(names_from = "arm_tx", values_from = arm_n:hunger_ru)

temp <- metacont(
  n.e = arm_n_CHO, n.c = arm_n_Fasting,
  comb.fixed = TRUE,
  mean.e = hunger_m_CHO,
  sd.e = hunger_sd_CHO,
  median.e = hung_md_CHO,
  q1.e = hunger_iqrl_CHO,
  q3.e = hunger_iqru_CHO,
  min.e = hunger_rl_CHO,
  max.e = hunger_ru_CHO,
  mean.c = hunger_m_Fasting,
  sd.c = hunger_sd_Fasting,
  median.c = hung_md_Fasting,
  q1.c = hunger_iqrl_Fasting,
  q3.c = hunger_iqru_Fasting,
  min.c = hunger_rl_Fasting,
  max.c = hunger_ru_Fasting,
  data = fast_meta.dat[fast_meta.dat$pre_post_op == "Preop",],
  # byvar = simp_comp,
  # subset = study != "Wendling 2020",
  sm = "SMD",
  method.tau = "REML",
  hakn = TRUE,
  prediction = FALSE,
  studlab = study
)

forest(temp,
  weight.study = "random",
  comb.fixed = FALSE,
  lab.e = "CHO     ",
  lab.c = "Fasting     ",
  digits = 2,
  digits.sd = 1,
  digits.mean = 1,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  print.byvar = FALSE,
  bylab = FALSE,
  # overall = FALSE,
  fs.xlab = 11,
  # sortvar = -TE,
  xlim = c(-3, 1),
  rightcols = c("effect", "ci"),
  rightlabs = c("SMD", "95% CI     "),
  xlab = "Favors CHO              Favors Fasting"
)

figure_n <- fig_inc()

## (updated 2021/04/21 15:04) sensitivity ---------------------------------
# account for missings using metansue
# temp_w_missings <- as_tibble(temp[c("studlab", "n.e", "n.c", "zval")]) %>%
#   add_row(studlab = "Melis 2016", n.e = 20, n.c =  9, zval = NA) %>%
#   mutate(t_val = limma::zscoreT(zval, n.e + n.c - 1))
# 
# temp_w_missings <- with(temp_w_missings, metansue::smd_from_t(t = t_val, n1 = n.e, n2 = n.c))
# (temp_meta <- metansue::meta(temp_w_missings))
# metansue::forest(temp_meta)
# 
# rm(temp_w_missings, temp_meta)
# 
# temp_out <- dmetar::find.outliers(temp)
# update(temp,
#   subset = !study %in% c("Wendling 2020", "Onalan 2019")
# )
# metabias(temp, method = "Pustejovsky", plotit = TRUE)
# radial(temp, level = 0.95)
# funnel(temp)
# trimfill(temp)
# funnel(trimfill(temp))
```
Yagmurdur 2011 and Zhang 2019 standard deviations were estimated using P-values. 
Melis 2006 reported only non-signficant results and could not be included. A sensitivity analysis using multiple imputation to include the the result yielded SMD = -0.59 (95% CI, -0.83, -0.34; *I*^2^ = 74%). 
Excluding Wendling 2020, SMD = -0.61 (95% CI, -0.87 to -0.34), *I*^2^ = 74% (53%, 84%).
There were some indications of small-study effects in funnel plot, but not supported by Pustejovsky's test of asymmetry, P = .16.

<a id="choFig3"></a>

<br/><br/>

<font size = 4> Figure `r figure_n`. Pooled hunger ratings (standardized mean differences in VAS or NRS) from randomized trials comparing carbohydrate drinks with clear liquids or water in adult surgical patients. </font>

```{r hungerAdultLikertMetaClear, echo = FALSE}
## (updated 2021/04/09 14:25) hungerAdultLikertMetaClear ------------------
clear_meta.dat <- likert_cho_hung_kbl.dat %>%
  filter(age == "Adult", design == "rct", pre_post_op == "Preop") %>%
  filter(grepl("Clear|Water|CHO|Placebo", arm_tx)) %>%
  group_by(refid) %>%
  filter(n() > 1) %>%
  ungroup() %>%
  # delete Melis 4952, Wendling 262 no clear arms
  # leave out Naguib 5803 only NS result, add in sensitivity
  filter(!refid %in% c(4952, 262, 5803)) %>% 
  select(refid, study, pre_post_op, arm_tx, arm_n, hunger_m, hunger_sd, hung_md, hunger_iqrl, hunger_iqru, hunger_rl, hunger_ru) %>%
  mutate(arm_tx = ifelse(grepl("CHO", arm_tx), "CHO", "Clear"),
         # Tsutsumi sd from p-value, means from median and range) 
         hunger_m = ifelse(study == "Tsutsumi 2016" & arm_tx == "Water", 43.6, hunger_m),
         hunger_m = ifelse(study == "Tsutsumi 2016" & grepl("CHO", arm_tx), 12.4, hunger_m),
         hunger_sd = ifelse(study == "Tsutsumi 2016", 20.153, hunger_sd)) %>% 
  select(-refid) %>%
  pivot_wider(names_from = "arm_tx", values_from = arm_n:hunger_ru)

```

```{r hungerAdultLikertMetaClearForest, fig.width = 10, fig.height = 3.5, fig.align = "left"}
## (updated 2021/04/09 14:26) hungerAdultLikertMetaClearForest ------------
temp <- metacont(
  n.e = arm_n_CHO, n.c = arm_n_Clear,
  comb.fixed = TRUE,
  mean.e = hunger_m_CHO,
  sd.e = hunger_sd_CHO,
  median.e = hung_md_CHO,
  q1.e = hunger_iqrl_CHO,
  q3.e = hunger_iqru_CHO,
  min.e = hunger_rl_CHO,
  max.e = hunger_ru_CHO,
  mean.c = hunger_m_Clear,
  sd.c = hunger_sd_Clear,
  median.c = hung_md_Clear,
  q1.c = hunger_iqrl_Clear,
  q3.c = hunger_iqru_Clear,
  min.c = hunger_rl_Clear,
  max.c = hunger_ru_Clear,
  data = clear_meta.dat,
  sm = "SMD",
  hakn = TRUE,
  method.tau = "REML",
  prediction = FALSE,
  studlab = study
)

forest(temp,
  comb.fixed = FALSE,
  lab.e = "CHO     ",
  lab.c = "Clear/Water   ",
  digits = 2,
  digits.sd = 1,
  digits.mean = 1,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  print.byvar = FALSE,
  # overall = FALSE,
  fs.xlab = 11,
  # sortvar = -TE,
  # xlim = c(-4, 1),
  rightcols = c("effect", "ci"),
  rightlabs = c("SMD", "95% CI     "),
  xlab = "Favors CHO                  Favors Clear/Water"
)

# dmetar::find.outliers(temp)
figure_n <- fig_inc()
```

```{r hungerAdultLikertFunnel, fig.width = 6, fig.height = 4, fig.align = "center", include = FALSE, eval = FALSE}
## (updated 2021/04/09 14:27) hungerAdultLikertFunnel ---------------------
# <font size = 4> Figure `r figure_n`. Funnel plot with 90%, 95%, and 99% contours --- consistent with small-study effects (noting limitations with respect to Zwetsloot2017). </font>
par(bty = "n", xaxt = "l", yaxt = "l")
funnel(temp, contour = c(0.9, 0.95, 0.99))
figure_n <- fig_inc()

temp_1 <- update(temp, byvar = NULL)

metabias(temp_1, plotit = TRUE, k.min = 5, method = "Pustejovsky")

# sensitivity add Naguib NS 
# account for missings using metansue
temp_w_missings <- as_tibble(temp[c("studlab", "n.e", "n.c", "zval")]) %>%
  add_row(studlab = "Naguib", n.e = 150, n.c =  75, zval = NA) %>%
  mutate(t_val = limma::zscoreT(zval, n.e + n.c - 1))
temp_w_missings <- with(temp_w_missings, metansue::smd_from_t(t = t_val, n1 = n.e, n2 = n.c))
(temp_meta <- metansue::meta(temp_w_missings))
metansue::forest(temp_meta)

# rm(temp_w_missings, temp_meta)

```

Tsutsumi 2016 mean estimated from median and range, standard deviation, and P-value (.001). 
Too few studies to examine small-study effects.

<br/>
  
## *Preoperative Thirst* 

<a id="choTab9"></a>

### Rates (surgical) 

<br/>

<font size = 4> Table `r table_n`. Rates of preoperative thirst according to fasting, liquid and volume. </font>

```{r thirstTableOr, include = TRUE}
## (updated 2021/01/13 08:52) thirstTableOr -------------------------------
dichot_format <- function(x) (x/100)

dichot_thirst_or <- dichot_cho.dat %>% 
  filter(!is.na(thirst_np)) %>%
  select(refid, study, arm_tx, arm_n, thirst_n) %>% 
  group_by(refid) %>% 
  filter(n() > 1)

or_thirst <- with(or_join(dichot_thirst_or, "thirst"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2))

```

```{r thirstTable, include = TRUE}
## (updated 2021/01/12 18:04) thirstTable ---------------------------------
dichot_thirst <- dichot_cho.dat %>% 
  filter(!is.na(thirst_np)) %>%
  select(refid:time_outcome, thirst_np, thirst_per, thirst_n, out_dichot_notes) %>% 
  rename(notes = out_dichot_notes)

dichot_thirst <- left_join(dichot_thirst, or_thirst, by = "refid") %>%
  # correct Figuri 2012 to preop assessment (differed from nausea)
  mutate(time_outcome = ifelse(refid == 3518, 0, time_outcome),
         pre_post_op = ifelse(time_outcome > 0, "Postop", "Preop")) %>%
  # only preop (all were); verified check of notes
  filter(pre_post_op == "Preop") %>% 
  arrange(age, desc(surg_nosurg), design, desc(pre_post_op), year, study) %>% 
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    or_ci = ifelse(row_number() == 1, or_ci, NA),
  ) %>%
  ungroup() %>%
  mutate(thirst_per = round(thirst_per, 0)) %>%
  select(refid, arm, design, age, study, arm_n, arm_tx, starts_with("hr"), pre_post_op, time_outcome, thirst_np, thirst_per, or_ci, thirst_n, notes)

cho_row <- dichot_thirst %>%
  mutate(line = row_number()) %>%
  filter(grepl("CHO", arm_tx)) %>%
  pull(line)

dichot_thirst$thirst_bar <- NA
dichot_thirst$thirst_bar <- ifelse(grepl("CHO", dichot_thirst$arm_tx),
  color_bar("darksalmon", fun = dichot_format)(dichot_thirst$thirst_per),
  color_bar("lightgray", fun = dichot_format)(dichot_thirst$thirst_per))

# dichot_thirst$thirst_bar <- str_replace(dichot_thirst$thirst_bar, ">[0-9]{2}<", ">&nbsp;<")

dichot_thirst <- dichot_thirst %>%
  # add_foot(study, "Koeppe 2013", "c") %>% # 'Did you feel thirst during the fasting period?
  mutate(
    thirst_bar = str_replace(thirst_bar, ">[0-9]{1,2}", ">&nbsp;"),
    thirst_bar = ifelse(thirst_n == 0, NA, thirst_bar)
  )

dichot_thirst <- dichot_thirst %>% 
  add_foot(study, "Feguri 2012", "a") %>% #           'Reported thirst'.
  add_foot(study, "Koeppe 2013", "b") %>% #           'Did you feel thirst during the fasting period?
  add_foot(study, "Yildiz 2013", "c") %>% #           'Based on VAS scores.'
  add_foot(study, "Panebianco 2020", "d") %>% #       'None vs. a little or alot.'
  add_foot(study, "Labuschagne 2017", "e") %>% #      'Yes vs. no.'
  add_foot(study, "Taniguchi 2011", "f") %>% #        'Did you have a dry mouth before surgery?'
  add_foot(study, "TDrobjewski 2018", "g") %>% #      'Present or absent.'
  add_foot(study, "Huang 2020", "h") %>% #            'Present or absent.'
  # add_foot(or_ci, "2.24 (1.25-4.01)", "i") %>% 
  # add_foot(or_ci, "3.34 (1.80-6.20)", "i") %>% 
  # add_foot(or_ci, "0.87 (0.50-1.53)", "i") %>% 
mutate(pre_post_op = ifelse(study == "Taniguchi 2011^f^", cell_spec(pre_post_op, color = "black"), pre_post_op),
       study = ifelse(study == "Taniguchi 2011^f^", cell_spec(study, color = "black"), study),
       pre_post_op = ifelse(study == "Huang 2020^h^", cell_spec(pre_post_op, color = "black"), pre_post_op),
       or_ci = ifelse(or_ci == "0.52 (0.32-0.84)", cell_spec(or_ci, color = "black"), or_ci),
       study = ifelse(study == "Huang 2020^h^", cell_spec(study, color = "black"), study))
       # or_ci = ifelse(refid == 5803 & or_ci == "1.05 (0.56, 2.00)", cell_spec(or_ci, color = "black"), or_ci))

## (updated 2021/05/01 09:37) thirstKable ---------------------------------
dichot_thirst %>%
  mutate(
    arm_tx = as.character(arm_tx),
    arm_tx = ifelse(grepl("Huang", study), paste0(arm_tx, "^i^"), arm_tx),
    arm_tx = ifelse(arm_n == 170, paste0(arm_tx, "^j^"), arm_tx)
  ) %>%
  select(study, arm_tx, arm_n, hr_gt6:hr_2, thirst_np, thirst_bar, or_ci) %>%
  kbl(
    booktabs = T, align = c("llccccrlc"), escape = FALSE,
    col.names = c("        Study", "Liquid", "N", "> 6", "6→2", "2", "N (%)", " ", "CHO vs. Comparator")
  ) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Thirst" = 2, "OR (95% CI)"), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4, 6), width = "3em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(7, width = "5em") %>%
  column_spec(8, width = "5em") %>%
  column_spec(9, width = "11em") %>%
  row_spec(cho_row, color = "brown") %>%
  pack_top(., "Adult, Surgical", 1, 13) %>%
  pack_sub(., "RCT", 1, 10) %>%
  pack_sub(., "Nonrandomized Studies of Interventions", 11, 12) %>%
  pack_sub(., "Prospective Cohort", 13, 13) %>%
  pack_rows("> 6          6→2         ≤ 2", 14, 14, bold = TRUE, italic = FALSE, color = "black", label_row_css = "border-top: 1px solid; padding-left: 45.4%;", indent = FALSE) %>% 
  pack_top(., "Pedatric, Surgical", 14, 19) %>%  
  # pack_top(., "Pedatric, Surgical                                                                                      > 6      6→2       ≤ 2", 14, 19) %>%
  pack_sub(., "RCT", 14, 19) %>%
  footnote(
    general = "RCT: randomized controlled trial; OR: odds ratio; CHO: carbohydrate; Prot: protein.",
    alphabet = c(
      "Reported thirst.",
      "'Did you feel thirst during the fasting period?' (prior to endoscopy).",
      "Based on VAS scores.",
      "'None vs. a little or alot.'",
      "Yes vs. no.",
      "'Did you have a dry mouth before surgery?'",
      "Thirst present or absent.",
      "Compared similar carbohydrate liquids given 1 vs. 2 hours prior to surgery. Odds ratio is for 1 vs. 2 hour comparison.",
      "Liquid at 2 hours.",
      "Liquid at 1 hour."
      # "OR vs. combined CHO/Simp arms."
    ),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

<a id="choTab10"></a>

### Patient-rated (surgical) 

<br/>

<font size = 4> Table `r table_n`. Patient-rated preoperative thirst in adult surgical studies according to fasting, liquid and volume. </font>

```{r thirsSurgTableLikert, include = TRUE}
## (updated 2021/01/13 05:51) thirstLikert --------------------------------
likert_cho_thirst.dat <- likert_cho.dat %>%
  filter(refid %in% cho_refids) %>%
  filter(thirst_l == "thirst_l") %>%
  # filter_at(vars(thirst_m:thirst_pval), any_vars(!is.na(.))) %>% # identical (2021/04/06 11:36)
  # fill in any misssing timeoutcomes
  group_by(refid) %>%
  fill(likert_time_outcome) %>%
  ungroup() %>%
  mutate(
    pre_post_op = ifelse(likert_time_outcome > 1, "Postop", "Preop"),
    pre_post_op = ifelse(refid == 4952, "Preop", pre_post_op),
    pre_post_op = ifelse(surg_nosurg == "non-surgical", likert_time_outcome, pre_post_op)
  ) %>%
  # select(refid, study, surg_nosurg, age, design, year, arm_tx, likert_time_outcome, pre_post_op) %>%
  arrange(age, desc(surg_nosurg), design, desc(pre_post_op), year, study, arm_tx)

likert_cho_thirst_kbl.dat <- likert_cho_thirst.dat %>%
  rename(time_outcome = likert_time_outcome) %>%
  mutate(
    # surgical studies (note none have times 0 or negative)
    # hr_2 is ≤ 2; hr_26 is (2, 6] >2 to 6; hr_gt6 is >6
    hr_2 = 0, hr_26 = 0, hr_gt6 = 0,
    hr_2 = if_else(timeingest1 <= 2 & timeingest1 > 0, amtingest1, hr_2, missing = 0),
    hr_26 = if_else(timeingest1 > 2 & timeingest1 < 6, amtingest1, hr_26, missing = 0),
    hr_gt6 = if_else(timeingest1 >= 6, amtingest1, hr_gt6, missing = 0),
    hr_2 = if_else(hr_2 == 0 & timeingest2 <= 2 & timeingest2 > 0, amtingest2, hr_2, missing = 0),
    hr_26 = if_else(hr_26 == 0 & timeingest2 > 2 & timeingest2 < 6, amtingest2, hr_26, missing = 0),
    hr_gt6 = if_else(hr_gt6 == 0 & timeingest2 >= 6, amtingest2, hr_gt6, missing = 0),
    hr_gt6 = if_else(grepl("also received 300", type_ingest_1), 500, hr_gt6), # ) %>%  # Oyama PM
    # for nonsurgical
    hr_0 = 0, hr_minus2 = 0,
    hr_0 = if_else(surg_nosurg != "surgical" & timeingest1 == 0, amtingest1, hr_0, missing = 0),
    hr_minus2 = if_else(surg_nosurg != "surgical" & timeingest1 == -2, amtingest1, hr_minus2, missing = 0),
    hr_0 = if_else(surg_nosurg != "surgical" & timeingest2 == 0 & is.na(hr_0), amtingest2, hr_0, missing = 0),
    hr_minus2 = if_else(surg_nosurg != "surgical" & timeingest2 == -2 & is.na(hr_minus2), amtingest1, hr_minus2, missing = 0)
  ) %>%
  replace_with_na_at(.vars = c("hr_gt6", "hr_26", "hr_2"), condition = ~ .x == 0) %>%
  # filter(surg_nosurg == "surgical") %>%
  select(refid:age, arm_n, arm_tx, hr_gt6, hr_26, hr_2, hr_0, hr_minus2, pre_post_op, time_outcome, thirst_scale, thirst_m:thirst_iqru, out_l_notes) %>%
  rename(notes = out_l_notes) %>% 
  mutate(
    thirst_md = thirst_med, # save thirst_med value
    thirst_med = paste0(thirst_med, " (", round_0(thirst_iqrl), "-", round_0(thirst_iqru), ")"),
    thirst_med = ifelse(refid %in% c(2674, 3588), paste0(thirst_md, " (", round_1(thirst_iqrl), "-", round_1(thirst_iqru), ")"), thirst_med),
    thirst_med = ifelse(thirst_med == "NA (NA-NA)", NA, thirst_med),
    thirst_med = gsub(" \\(NA-NA\\)", "", thirst_med),
    # NOTE: footnote Melis, Melis 2006: "Within group change from baseline."
    thirst_med = ifelse(refid == 4952, paste0(thirst_md, " (", round_0(thirst_iqrl), ")^b^"), thirst_med),
    ranges = str_c("(", round_0(thirst_rl), "-", round_0(thirst_ru), ")"),
    thirst_sd = ifelse(is.na(thirst_sd) & !is.na(thirst95u), sd_confint(thirst95l, thirst95u), thirst_sd),
    mn_95_ci = str_c(round_1(thirst_m), " (", round_1(thirst95l), "-", round_1(thirst95u), ")"),
    mn_95_ci = ifelse(!is.na(thirst_m) & !is.na(thirst_sd), str_c(round_1(thirst_m), " (", round_1(thirst_m - (1.96 * thirst_sd)), "-", round_1(thirst_m + (1.96 * thirst_sd)), ")"), mn_95_ci),
    mn_95_ci = ifelse(mn_95_ci == "NA (NA-NA)", NA, mn_95_ci),
    mn_95_ci = str_replace(mn_95_ci, "\\(NA-NA\\)", ""),
    # mn_sd = NA,
    mn_sd = ifelse(!is.na(thirst_sd) & !is.na(thirst_m), paste0(round_1(thirst_m), " (", round_1(thirst_sd), ")"), round_2(thirst_m)),
    mn_sd = ifelse(refid == 262, paste0(mn_sd, "^c^"), mn_sd),
    mn_sd = na_if(mn_sd, " NA"), 
    thirst_med = str_replace(thirst_med, "\\(NA-NA\\)", ""),
    ranges = str_replace(ranges, "\\(NA-NA\\)", ""),
    # thirst_scale = ifelse(grepl("VAS..0.*100", thirst_scale), "0→100", thirst_scale),
    thirst_scale = ifelse(thirst_scale == "VAS: 0 to 100", "0→100", thirst_scale),
    thirst_scale = ifelse(thirst_scale == "VAS, 0-100", "0→100", thirst_scale),
    thirst_scale = ifelse(thirst_scale == "VAS, 0 to 100", "0→100", thirst_scale),
    thirst_scale = ifelse(thirst_scale == "VAS, 0 to 10", "0→10", thirst_scale),
    thirst_scale = ifelse(thirst_scale == "VAS, 1 to 10", "1→10", thirst_scale),
    thirst_scale = ifelse(thirst_scale == "VAS, 0-10", "0→10", thirst_scale),
    thirst_scale = ifelse(thirst_scale == "VAS (0-10)", "0→10", thirst_scale),
    thirst_scale = ifelse(thirst_scale == "VAS 10 pt", "0→10", thirst_scale),
    thirst_scale = ifelse(thirst_scale == "NRS, 0 to 10", "0→10^NRS^", thirst_scale),
    thirst_scale = ifelse(thirst_scale == "NRS, 0 to 2", "0→2^NRS^", thirst_scale),
    thirst_scale = ifelse(thirst_scale == "NRS, 0 to 3", "0→3^NRS^", thirst_scale),
    thirst_scale = ifelse(thirst_scale == "Likert, 0 to 3", "0→3^NRS^", thirst_scale),
    thirst_scale = ifelse(refid == 3588, "1→5^NRS^", thirst_scale),
    thirst_med = ifelse(grepl("(AM)", study) & arm_tx == "Fasting", str_c(thirst_med, "^d^"), thirst_med),
    thirst_med = ifelse(grepl("(PM)", study) & arm_tx == "Fasting", str_c(thirst_med, "^d^"), thirst_med),
    # mn_sd = ifelse(refid == 5803 & arm_tx == "CHO/Simp", paste0(mn_sd, "^b^"), mn_sd),
    # mn_sd = ifelse(study == "Zelic 2013", paste0(mn_sd, "^e^"), mn_sd), post-op
    # thirst_med = ifelse(study == "De Jonghe 2016" & arm_tx != "Fasting", paste0(thirst_med, "^e^"), thirst_med)
  ) %>%
  arrange(age, desc(surg_nosurg), design, desc(pre_post_op), year, study) %>%
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    thirst_scale = ifelse(row_number() == 1, thirst_scale, NA),
  ) %>%
  ungroup() 

```

```{r thirstAdultSurgKable, echo = FALSE}
## (updated 2020/12/13 13:48) thirstAdultSurgKable ------------------------
cho_row <- likert_cho_thirst_kbl.dat %>%
  filter(surg_nosurg == "surgical", pre_post_op == "Preop") %>%
  mutate(line = row_number()) %>%
  filter(grepl("CHO", arm_tx)) %>%
  pull(line)

likert_cho_thirst_kbl.dat %>%
  filter(surg_nosurg == "surgical", pre_post_op == "Preop") %>% 
  # verified w/notes field 2021/05/08 08:07
  select(study, arm_tx, arm_n, hr_gt6, hr_26, hr_2, thirst_scale, mn_sd, thirst_med, ranges) %>%
  add_row() %>%
   kbl(
    booktabs = T, align = c("llcccclll"), escape = FALSE,
    col.names = c(
      "       Study", "Liquid", "N", "> 6", "6→2", "2", "Scale^a^", "M (SD)", "Med (IQR)", "Range"
    )
  ) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Thirst Rating" = 4), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  # NOTE: footnote a: includes at 2.5 hours
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4,6), width = "3em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(7, width = "4em") %>%
  column_spec(8, width = "6em") %>%
  column_spec(9, width = "7em") %>%
  column_spec(10, width = "4em") %>%
  row_spec(cho_row, color = "brown") %>%
  pack_top(., "Adult, Surgical", 1, 50) %>%
  pack_sub(., "RCT", 1, 44) %>%
  pack_sub(., "Nonrandomized Studies of Interventions", 45, 50) %>%
    result_pack("No detected differences", 49, padding = 70) %>%
  result_pack("Difference  p < .0001", 51, padding = 70) %>%
  footnote(
    general = "RCT: randomized controlled trial; M: mean; SD: standard deviation; SD: standard deviation; Med: median; IQR: interquartile range; NRS: numeric rating scale; MD: mean difference.",
    alphabet = c(
      "Arrow (→) indicates best to worst thirst (visual analogue if not noted NRS).",
      # "Detected a difference vs. water, p < .05.",
      "Within group change from baseline; reported IQR as a single value.",
      "Difference from before beverage consumption to 1 hr post-consumption.",
      "IQR bound outside range of scale used."
    ),
    general_title = "",  
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()

```

<br/>

<a id="choTab11"></a>

### Patient-rated (nonsurgical) 

<br/>

<font size = 4> Table `r table_n`. Patient-rated thirst 2 hours following liquids in nonsurgical studies according to fasting, liquid and volume. </font>

```{r thirstAdultNonsurgKable, echo = FALSE}
## (updated 2020/12/13 13:48) thirstAdultSurgKable ------------------------
cho_row <- likert_cho_thirst_kbl.dat %>%
  filter(surg_nosurg != "surgical") %>%
  mutate(line = row_number()) %>%
  filter(grepl("CHO", arm_tx)) %>%
  pull(line)

likert_cho_thirst_kbl.dat %>%
  mutate(
  study = ifelse(study == "Jian 2017", cell_spec(study, color = "black"), study),
  thirst_med = ifelse(thirst_med == "30.23", "30.2", thirst_med)
  ) %>%
  filter(surg_nosurg != "surgical") %>% 
  # mutate(
    # for non-surgical use hr_26 as amount
    # hr_26 = ifelse(surg_nosurg == "non-surgical", hr_0, hr_26),
    # study = ifelse(study == "Jian 2017", cell_spec(study, color = "black"), study)) %>%
  select(study, arm_tx, arm_n, hr_0, thirst_scale, mn_sd, thirst_med, ranges) %>%
  add_row() %>%
  kbl(
    booktabs = T, align = c("llccclll"), escape = FALSE,
    col.names = c(
      "        Study", "Liquid", "N", "2 hr", "Scale^a^", "M (SD)", "Med (IQR)", "Range"
    )
  ) %>%
  add_header_above(c(" " = 3, "Volume (mL)" = 1, "Thirst Rating" = 4), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  # NOTE: footnote a: includes at 2.5 hours
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(4, width = "7em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(6, width = "6em") %>%
  column_spec(7, width = "7em") %>%
  column_spec(8, width = "4em") %>%
  row_spec(cho_row, color = "brown") %>%
  # pack_rows("Volume (mL) at Specified Time", 72, 72, label_row_css = "padding-left:37%; border-top: 1px solid;", color = "black", background = "white", underline = FALSE, bold = TRUE, italic = FALSE) %>%
  pack_top(., "Adult, Non-surgical", 1, 2) %>%
  pack_sub(., "Crossover", 1, 2) %>%
  result_pack("No difference detected", 3, padding = 72) %>% 
  pack_top(., "Pediatric, Non-surgical", 3, 4) %>%
  pack_sub(., "Crossover", 3, 4) %>%
  result_pack("No difference detected", 5, padding = 72) %>% 
  footnote(
    general = "hr: hours; M: mean; SD: standard deviation; Med: median; IQR: interquartile range.",
    alphabet = c(
      "Arrow (→) indicates best to worst thirst (visual analogue scale)."
    ),
    general_title = "",  
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

<a id="choFig4"></a>

### Pooled (adult RCTs, rates)   

<br/>

<font size = 4> Figure `r figure_n`. Pooled rates of preoperative thirst in adult surgical patients --- randomized trials comparing carbohydrate drinks with fasting. </font>

```{r thirstMetaDichot, include = TRUE,  fig.width = 10, fig.height = 3.2, fig.align = "center"}
## (updated 2021/01/13 09:48)  --------------------------------------------
thirst_meta.dat <- or_join(dichot_thirst_or, "thirst")
# add age, design, year
thirst_meta.dat <- left_join(thirst_meta.dat, study_char.dat %>% select(refid, year, design, age), by = "refid") %>%
  filter(c_tx == "Fasting", age == "Adult", design == "rct") 

thirst_meta <- metabin(event_e, n_e, event_c, n_c,
  data = thirst_meta.dat,
  studlab = study,
  sm = "OR",
  method = "MH",
  method.tau = "PM",
  hakn = FALSE,
  prediction = TRUE,
  digits = 2)

forest(thirst_meta,
  comb.fixed = FALSE,
  lab.e = "CHO     ",
  lab.c = "Fasting    ",
  digits = 2,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = FALSE,
  fs.xlab = 11,
  xlim = c(.001, 10),
  at = c(0.001, 0.01, 0.1, .4,  1, 2, 2),
  pooled.events = TRUE,
  rightcols = c("effect", "ci"),
  rightlabs = c("OR", "95% CI     "),
  xlab = "Favors CHO           Favors Fasting")
  
figure_n <- fig_inc()
```

```{r, include = FALSE, echo = FALSE, eval = FALSE, fig.width = 10, fig.height = 3.5, fig.align = "center"}
# Bayesian model with weakly informative prio for tau; note HAKN exceedingly wide
library(MetaStan)
temp <- thirst_meta.dat %>% 
  rename(r2 = event_e, r1 = event_c, n2 = n_e, n1 = n_c) %>% 
  mutate(arms = 2) %>% 
  select(refid, study, r1, r2, n1, n2, arms)

dat_MetaStan <- create_MBMA_dat(
  dat = temp,
  armVars = c(responders = "r", sampleSize = "n"),
  nArmsVar = "arms"
)

ma.stan <- meta_stan(
  ntrt = n2,
  nctrl = n1,
  rtrt = r2,
  rctrl = r1,
  data = temp,
  model = "BNHM1",
  # likelihood = "binomial",
  mu_prior = c(0, 10),
  theta_prior = c(0, 100),
  tau_prior = 0.5,
  tau_prior_dist = "half-normal"
)
print(ma.stan)

# > exp(c(-2.37, -3.63, -1.21))
# [1] 0.09348073 0.02651618 0.29819728
# > print(ma.stan)
# Meta-analysis using MetaStan
# Mean treatment effect
#  mean  2.5%   50% 97.5% 
# -2.37 -3.63 -2.36 -1.21 
# Heterogeneity stdev
#  mean  2.5%   50% 97.5% 
#  0.99  0.51  0.96  1.57 

metabias(thirst_meta, plotit = TRUE, k.min = 5)
funnel(thirst_meta)
```

Too few studies to examine small-study effects.

<br>

<a id="choFig5"></a>

### Pooled (adult RCTs, patient-rated)   

<br/>

<font size = 4> Figure `r figure_n`. Pooled preoperative thirst ratings (standardized mean differences in VAS or NRS) from randomized trials comparing carbohydrate drinks with fasting in adult surgical patients. </font>

```{r thirstAdultLikertMeta, echo = FALSE, fig.width = 10, fig.height = 5.0, fig.align = "center"}
## (updated 2021/04/13 07:39) thirstAdultLikertMeta -----------------------
thirst_lik_meta.dat <- likert_cho_thirst_kbl.dat %>%
  filter(age == "Adult", design == "rct") %>%
  mutate(
    # Zelic 2982 not detect difference, no exact p, assume 0.1 analyses, sens metansue (note also postop thirst)
    thirst_sd = ifelse(refid == 2982, 2.634, thirst_sd),
    # Savluk 1274 combine 3 cho/comp arms
    thirst_m = ifelse(refid == 1274 & arm == 2, 1.8186, thirst_m),
    thirst_sd = ifelse(refid == 1274 & arm == 2, 1.7244, thirst_sd)
  ) %>%
  # exclude Mellis 4952 did not report sufficient data
  filter(!refid %in% c(4952)) %>%
  # exclude Savluk 1274 arms combined
  filter(!(refid == 1274 & arm %in% c(3,4))) %>% 
  select(refid, study, pre_post_op, contains("arm_"), thirst_m, thirst_sd, thirst_md, contains("iqr"), contains("t_r")) %>% 
         #thirst_iqrl, thirst_iqru, thirst_rl, thirst_ru) %>%
  group_by(refid) %>%
  fill(study, pre_post_op) %>%
  ungroup()

# fasting
fast_meta.dat <- thirst_lik_meta.dat %>%
  filter(grepl("Fasting|CHO", arm_tx)) %>%
  # delete Henriksen 5479, comparison with water only; Yagmurdur outlier ? valid 
  filter(!refid %in% c(5479, 3553, 431)) %>% 
  mutate(
    # combine Wendling 262 cho simp and complex arms (keep above for possible nma)
    thirst_m = ifelse(refid == 262 & arm_n == 20, -16.433, thirst_m),
    thirst_sd = ifelse(refid == 262 & arm_n == 20, 6.6219, thirst_sd),
    thirst_sd = ifelse(refid == 602, thirst_sd * sqrt(arm_n), thirst_sd),
    arm = ifelse(arm_tx == "Fasting", "Fasting", "CHO"),
  ) %>% 
  filter(!(refid == 262 & arm_tx == "CHO/Comp")) %>%
  # delete Wendling arm 3
  group_by(refid) %>%
  filter(n() > 1) %>%
  filter(row_number() < 3) %>%
  ungroup() %>%
  select(-c(refid, arm_tx)) %>%
  pivot_wider(names_from = "arm", values_from = arm_n:thirst_ru) %>% 
  rename_all( ~ str_replace(., "thirst_", "")) %>% 
  rename_all(tolower) %>% 
  filter(pre_post_op == "Preop")

temp <- metacont(
  n.e = arm_n_cho,
  mean.e = m_cho,
  sd.e = sd_cho,
  median.e = md_cho,
  q1.e = iqrl_cho,
  q3.e = iqru_cho,
  min.e = rl_cho,
  max.e = ru_cho,
  n.c = arm_n_fasting,
  mean.c = m_fasting,
  sd.c = sd_fasting,
  median.c = md_fasting,
  q1.c = iqrl_fasting,
  q3.c = iqru_fasting,
  min.c = rl_fasting,
  max.c = ru_fasting,
  sm = "SMD",
  hakn = TRUE,
  method.tau = "REML",
  studlab = study,
  comb.fixed = TRUE,
  data = fast_meta.dat
)

# dmetar::find.outliers(temp)
 
forest(temp,
  comb.fixed = FALSE,
  lab.e = "CHO     ",
  lab.c = "Fasting     ",
  digits = 2,
  digits.sd = 1,
  digits.mean = 1,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  print.byvar = TRUE,
  # bylab = c("Preop", "Postop", "Unclear"),
  # overall = FALSE,
  fs.xlab = 11,
  # sortvar = -TE,
  xlim = c(-3, 1),
  rightcols = c("effect", "ci"),
  rightlabs = c("SMD", "95% CI     "),
  xlab = "Favors CHO              Favors Fasting"
)

# metabias(temp, method.bias = "Pustejovsky")
# funnel(temp)

figure_n <- fig_inc()
```

When unreported, means and standard deviations were calculated from medians, interquartile ranges, ranges, or P-values. In studies with more than 1 carbohydrate arm, the arms were combined for analysis. 
Standard deviations from Wang 2019 were assumed to be standard errors for these analyses (SMD -4.0). Rizvanovic 2019 was judged an outlier (SMD -5.5, reported confidence intervals in the publication appeared to be in error). Yagmurdur 2011 appeared to be an outlier with implausible SMD (-18.8), having only the range to impute the standard deviation. Removal of outliers would not alter any conclusions. 
There was an indication of potential small-study effects (P = .06, Pustejovsky test of funnel plot asymmetry), but 3 studies pooled had large effects with uncertainty due to estimates of means and standard deviations. 

<a id="choFig6"></a> 

<br/><br/>

<font size = 4> Figure `r figure_n`. Pooled preoperative thirst ratings (standardized mean differences in VAS or NRS) from randomized trials comparing carbohydrate drinks with water or placebo in adult surgical patients. </font>

```{r thirstAdultLikertMetaWater, echo = FALSE, fig.width = 10, fig.height = 3.5, fig.align = "center"}
## (updated 2021/04/13 07:39) thirstAdultLikertMeta -----------------------
# water, placebo, CHO
wat_plac_meta.dat <- thirst_lik_meta.dat %>%
  filter(grepl("Water|Placebo|CHO", arm_tx)) %>%
  filter(pre_post_op == "Preop") %>% 
  filter(!refid %in% c(262)) %>% 
  mutate(
    arm = ifelse(grepl("CHO", arm_tx), "CHO", "Water/Placebo"),
    thirst_m = ifelse(refid == 5479 & arm_n == 15, 2.316, thirst_m),
    thirst_sd = ifelse(refid == 5479 & arm_n == 15, 2.300, thirst_sd),
  ) %>% 
  group_by(refid) %>%
  filter(n() > 1) %>%
  filter(row_number() < 3) %>%
  ungroup() %>%
  select(-c(refid, arm_tx)) %>%
  pivot_wider(names_from = "arm", values_from = arm_n:thirst_ru) %>% 
  rename_all( ~ str_replace(., "Water/Placebo", "comp")) %>% 
  rename_all( ~ str_replace(., "thirst_", "")) %>% 
  rename_all(tolower) 

temp <- metacont(
  n.e = arm_n_cho,
  mean.e = m_cho,
  sd.e = sd_cho,
  median.e = md_cho,
  q1.e = iqrl_cho,
  q3.e = iqru_cho,
  min.e = rl_cho,
  max.e = ru_cho,
  n.c = arm_n_comp,
  mean.c = m_comp,
  sd.c = sd_comp,
  median.c = md_comp,
  q1.c = iqrl_comp,
  q3.c = iqru_comp,
  min.c = rl_comp,
  max.c = ru_comp,
  sm = "SMD",
  method.tau = "REML",
  hakn = FALSE,
  studlab = study,
  comb.fixed = TRUE,
  data = wat_plac_meta.dat 
)

# dmetar::find.outliers(temp)
 
forest(temp,
  comb.fixed = FALSE,
  lab.e = "CHO     ",
  lab.c = "Water/Placebo",
  digits = 2,
  digits.sd = 1,
  digits.mean = 1,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  print.byvar = TRUE,
  # bylab = c("Preop", "Postop", "Unclear"),
  # overall = FALSE,
  fs.xlab = 11,
  # sortvar = -TE,
  xlim = c(-4, 1),
  rightcols = c("effect", "ci"),
  rightlabs = c("SMD", "95% CI     "),
  xlab = "Favors CHO              Favors Water/Placebo"
)

# metabias(temp, k.min = 6, method.bias = "Pustejovsky")
# funnel(temp)

figure_n <- fig_inc()

```
Carbohydrate arms in Henriksen 2003 combined for analysis. 
Too few studies to examine small-study effects.

<br/>

## *Preoperative Nausea* 

<a id="choTab12"></a>

### Rates (surgical) 

<br/>

<font size = 4> Table `r table_n`. Rates of nausea according to fasting, liquid and volume. </font>

```{r nauseaTableOr, include = TRUE}
## (updated 2021/01/13 08:52) nauseaTable ---------------------------------
dichot_format <- function(x) (x/100)
dichot_nausea_or <- dichot_cho.dat %>% 
  filter(!is.na(nausea_np)) %>%
  select(refid, study, arm_tx, arm_n, nausea_n) %>% 
  group_by(refid) %>% 
  filter(n() > 1)

or_nausea <- with(or_join(dichot_nausea_or, "nausea"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2))

```

```{r nauseaTable, include = TRUE}
## (updated 2021/01/12 18:04) nauseaTable ---------------------------------
dichot_nausea <- dichot_cho.dat %>%
  filter(!is.na(nausea_np)) %>%
  mutate(
    pre_post_op = ifelse(time_outcome > 0, "Postop", "Preop"),
    pre_post_op = ifelse(surg_nosurg == "non-surgical", NA, pre_post_op),
    # Itou 2012 nausea was post-op 
    pre_post_op = ifelse(study == "Itou 2012", "Postop", pre_post_op) 
    # Yildiz 2013, distiller contains p
  ) %>%
  select(refid:time_outcome, pre_post_op, nausea_np, nausea_per, nausea_n, out_dichot_notes) %>%
  rename(notes = out_dichot_notes) %>% 
  arrange(age, desc(surg_nosurg), design, desc(pre_post_op), year, study)

dichot_nausea <- left_join(dichot_nausea, or_nausea, by = "refid") %>%
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    or_ci = ifelse(row_number() == 1, or_ci, NA)
  ) %>%
  ungroup() %>%
  mutate(nausea_per = round(nausea_per, 0)) %>%
  select(refid, arm, design, age, surg_nosurg, study, arm_n, arm_tx, starts_with("hr"), time_outcome, pre_post_op, nausea_np, nausea_per, or_ci, nausea_n, notes)

# correct Hausel 2005 odds ratios ####
# CHO vs fasting, placebo
temp <- dichot_nausea_or %>% filter(refid == 5091)
a <- with(or_join(temp[c(1,3),], "nausea"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2)) %>% pull(or_ci)
b <- with(or_join(temp[c(2,3),], "nausea"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2)) %>% pull(or_ci)
# correct Askura 2015 odds ratios
temp <- dichot_nausea_or %>% filter(refid == 2234)
# CHO/Simp vs fasting, CHO/Simp/Prot
c <- with(or_join(temp[c(1,3),], "nausea"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2)) %>% pull(or_ci)
d <- with(or_join(temp[c(2,3),], "nausea"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2)) %>% pull(or_ci)
# correct Singh 2015 odds ratios
temp <- dichot_nausea_or %>% filter(refid == 2172)
# CHO vs fasting, placebo
e <- with(or_join(temp[c(1,3),], "nausea"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2)) %>% pull(or_ci)
f <- with(or_join(temp[c(2,3),], "nausea"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2)) %>% pull(or_ci)

dichot_nausea <- dichot_nausea %>%
  mutate(
    or_ci = ifelse(refid == 5091 & arm == 1, a, or_ci),
    or_ci = ifelse(refid == 5091 & arm == 3, b, or_ci), # arm 3 is Placebo
    or_ci = ifelse(refid == 2234 & arm == 1, c, or_ci),
    or_ci = ifelse(refid == 2234 & arm == 3, d, or_ci), # arm 3 is CHO/Simp/Prot
    or_ci = ifelse(refid == 2172 & arm == 1, e, or_ci),
    or_ci = ifelse(refid == 2172 & arm == 3, f, or_ci),
    # remove Panebianco 2020 274
    or_ci = ifelse(refid == 274 & arm == 1, "", or_ci),
    or_ci = ifelse(or_ci == "NA (NA-NA)", "", or_ci)
  )
rm(a, b, c, d, e, f)

# formatting ####
dichot_nausea$nausea_bar <- NA
dichot_nausea$nausea_bar <- ifelse(grepl("CHO", dichot_nausea$arm_tx),
  color_bar("darksalmon", fun = dichot_format)(dichot_nausea$nausea_per),
  color_bar("lightgray", fun = dichot_format)(dichot_nausea$nausea_per))

dichot_nausea <- dichot_nausea %>% 
  add_foot(study, "Koeppe 2013", "a") %>% #           'Did you feel nausea during the fasting period?
  add_foot(study, "Yildiz 2013", "b") %>% #           'Based on VAS scores.'
  add_foot(study, "Panebianco 2020", "c") %>% #       'None vs. a little or alot.'
  # add_foot(study, "Feguri 2012", "d") %>% #           'Reported nausea'.
  add_foot(study, "TDrobjewski 2018", "d") %>% #      'Present or absent.'
mutate(nausea_bar = str_replace(nausea_bar, ">[0-9]{1,2}", ">&nbsp;"),
  nausea_bar = ifelse(nausea_n == 0, NA, nausea_bar),
  study = ifelse(study == "Song 2016", cell_spec(study, color = "black"), study),
  or_ci = ifelse(refid == 2234 & arm_n == 46, cell_spec(or_ci, color = "black"), or_ci))

dichot_nausea_preop <- dichot_nausea %>% 
  filter(pre_post_op == "Preop")
  
## (updated 2021/02/13 08:44) nauseaKable ---------------------------------
cho_row <- dichot_nausea_preop %>%
  mutate(line = row_number()) %>%
  filter(grepl("CHO", arm_tx)) %>%
  pull(line)

# check 2 hours 2021/06/23 10:48 verified
# two_hours(dichot_nausea_preop$refid)

dichot_nausea_preop %>% 
  select(study, arm_tx, arm_n, hr_gt6:hr_2, nausea_np, nausea_bar, or_ci) %>%
  kbl(
    booktabs = T, align = c("llccccrlc"), escape = FALSE,
    col.names = c("        Study", "Liquid", "N", "> 6", "6→2", "2", "N (%)", " ", "CHO vs. Comparator")
  ) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Nausea" = 2, "OR (95% CI)"), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4, 6), width = "3em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(7, width = "5em") %>%
  column_spec(8, width = "5em") %>%
  column_spec(9, width = "11em") %>%
  row_spec(cho_row, color = "brown") %>% 
  pack_top(., "Adult, Surgical", 1, 12) %>% 
  pack_sub(., "RCT", 1, 12) %>%
  pack_top(., "Pedatric, Surgical", 13, 14) %>% 
  pack_sub(., "RCT", 13, 14) %>%
  # pack_sub(., "Prospective Cohort", 58, 58) %>%
  footnote(general = "RCT: randomized controlled trial; OR: odds ratio; CHO: carbohydrate; Simp: simple; Comp: complex; Prot: protein.",
           alphabet = c("Did you feel nausea during the fasting period?",
                        "Based on VAS scores.",
                        "None vs. a little or alot.",
                        "Present or absent."),
           general_title = "",  
           footnote_as_chunk = FALSE)

table_n <- tab_inc()
```

<br/>

<a id="choTab13"></a>

### Rates (nonsurgical) 

<br/>

<font size = 4> Table `r table_n`. Rates of nausea in crossover studies of adult healthy volunteers. </font>

```{r nauseaNonsurgTableOr, include = TRUE}
## (updated 2021/05/06 10:35) nauseaNonsurgTable --------------------------
dichot_format <- function(x) (x/100)
dichot_nonsurg_nausea <- dichot_nonsurg_cho.dat %>%
  filter(!is.na(nausea_np)) %>%
  select(refid, study, arm_tx, arm_n, nausea_n, nausea_per, nausea_np, amtingest1) %>%
  group_by(refid) %>%
  filter(n() > 1) %>%
  ungroup() %>%
  # add times
  mutate(
    time_outcome = case_when(
      refid == 4092 ~ "When ingested",
      refid == 6280 ~ "Few hours"
    ),
    study = ifelse(study == "Lobo 2009", cell_spec(study, color = "black"), study),
    time_outcome = cell_spec(time_outcome, color = "black")
  ) %>%
  group_by(refid) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    time_outcome = ifelse(row_number() == 1, time_outcome, NA)
  ) %>%
  ungroup()


dichot_nonsurg_nausea$nausea_bar <- NA
dichot_nonsurg_nausea$nausea_bar <- ifelse(grepl("CHO", dichot_nonsurg_nausea$arm_tx),
  color_bar("darksalmon", fun = dichot_format)(dichot_nonsurg_nausea$nausea_per),
  color_bar("lightgray", fun = dichot_format)(dichot_nonsurg_nausea$nausea_per))
dichot_nonsurg_nausea <- dichot_nonsurg_nausea %>%
  mutate(nausea_bar = str_replace(nausea_bar, ">.*<", "> <"),
         nausea_bar = ifelse(nausea_n == 0, NA, nausea_bar))

## (updated 2021/05/06 10:36) nauseaNonsurgKable --------------------------
cho_row <- dichot_nonsurg_nausea %>% 
  mutate(line = row_number()) %>% 
  filter(grepl("CHO", arm_tx)) %>% 
  pull(line)

dichot_nonsurg_nausea %>% 
  select(study, arm_tx, arm_n, amtingest1, time_outcome, nausea_np, nausea_bar) %>% 
    kbl(
    booktabs = T, align = c("llcclll"), escape = FALSE,
    col.names = c("        Study", "Liquid", "N", "Amount (mL)", "Time Assessed", "N (%)",  " ")) %>%
   add_header_above(c(" " = 5, "Nausea" = 2), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(4, width = "7em") %>%
  column_spec(5, width = "8em") %>%
  column_spec(6, width = "4em") %>% 
  column_spec(7, width = "5em") %>% 
  row_spec(cho_row, color = "brown") %>% 
  pack_top(., "Adult, Nonsurgical", 1, 5) %>% 
  pack_sub(., "Crossover", 1, 5) %>% 
    footnote(
    general = "CHO: carbohydrate; Comp: complex; Prot: protein",
    general_title = "",
    footnote_as_chunk = FALSE)

table_n <- tab_inc()
```

<br/>

<a id="choTab14"></a>

### Patient-rated (surgical)  

<br/>

<font size = 4> Table `r table_n`. Patient-rated preoperative nausea according to fasting, reporting time, liquid and volume. (Results were not pooled due to limitations in reported data). </font>

```{r nauseaLikert, include = FALSE, echo = FALSE}
## (updated 2021/04/17 14:37) likert_cho_nausea.dat ----------------------
likert_cho_nausea.dat <- likert_cho.dat %>%
  filter(refid %in% cho_refids) %>%
  filter(nausea_l == "nausea_l") %>%
  # filter_at(vars(nausea_m:nausea_pval), any_vars(!is.na(.))) %>% # identical n = 77 (2021/04/06 11:36)
  # fill in any misssing timeoutcomes
  group_by(refid) %>%
  fill(likert_time_outcome) %>%
  ungroup() %>%
  mutate(
    pre_post_op = ifelse(likert_time_outcome > 1, "Postop", "Preop"),
    pre_post_op = ifelse(surg_nosurg == "non-surgical", NA, pre_post_op)
  ) %>%
  select(refid:age, arm_n, arm_tx, likert_time_outcome, pre_post_op, matches("ingest"), starts_with("nausea"), summary_l_result, out_l_notes) %>%
  rename(notes = out_l_notes) %>% 
  arrange(age, desc(surg_nosurg), design, desc(pre_post_op), year, study, arm_tx)

## (updated 2021/04/17 14:37) likert_cho_nausea_kbl.dat -------------------
likert_cho_nausea_kbl.dat <- likert_cho_nausea.dat %>%
  rename(time_outcome = likert_time_outcome) %>%
  mutate(
    # surgical studies (note none have times 0 or negative)
    # hr_2 is ≤ 2; hr_26 is (2, 6] >2 to 6; hr_gt6 is >6
    hr_2 = 0, hr_26 = 0, hr_gt6 = 0,
    hr_2 = if_else(timeingest1 <= 2 & timeingest1 > 0, amtingest1, hr_2, missing = 0),
    hr_26 = if_else(timeingest1 > 2 & timeingest1 < 6, amtingest1, hr_26, missing = 0),
    hr_gt6 = if_else(timeingest1 >= 6, amtingest1, hr_gt6, missing = 0),
    hr_2 = if_else(hr_2 == 0 & timeingest2 <= 2 & timeingest2 > 0, amtingest2, hr_2, missing = 0),
    hr_26 = if_else(hr_26 == 0 & timeingest2 > 2 & timeingest2 < 6, amtingest2, hr_26, missing = 0),
    hr_gt6 = if_else(hr_gt6 == 0 & timeingest2 >= 6, amtingest2, hr_gt6, missing = 0),
    hr_gt6 = if_else(grepl("also received 300", type_ingest_1), 500, hr_gt6), # ) %>%  # Oyama PM
    # for nonsurgical
    hr_0 = 0, hr_minus2 = 0,
    hr_0 = if_else(surg_nosurg != "surgical" & timeingest1 == 0, amtingest1, hr_0, missing = 0),
    hr_minus2 = if_else(surg_nosurg != "surgical" & timeingest1 == -2, amtingest1, hr_minus2, missing = 0),
    hr_0 = if_else(surg_nosurg != "surgical" & timeingest2 == 0, amtingest1, hr_0, missing = 0),
    hr_minus2 = if_else(surg_nosurg != "surgical" & timeingest2 == -2, amtingest1, hr_minus2, missing = 0)
  ) %>%
  replace_with_na_at(.vars = c("hr_gt6", "hr_26", "hr_2"), condition = ~ .x == 0) %>%
  select(refid:arm_tx, hr_gt6, hr_26, hr_2, time_outcome, pre_post_op, notes, nausea_scale, nausea_m:nausea_iqru) %>%
  mutate(
    # fix Naguib Savluk Rizvanovic assume SEM
    # nausea_sd = ifelse(refid %in% c(1274, 602, 431), nausea_sd * sqrt(arm_n), nausea_sd),
    nausea_md = nausea_med,
    nausea_med = paste0(nausea_med, " (", round_0(nausea_iqrl), "-", round_0(nausea_iqru), ")"),
    # nausea_med = ifelse(refid %in% c(2674, 3588), paste0(nausea_md, " (", round_1(nausea_iqrl), "-", round_1(nausea_iqru), ")"), nausea_med),
    nausea_med = ifelse(nausea_med == "NA (NA-NA)", NA, nausea_med),
    nausea_med = gsub(" \\(NA-NA\\)", "", nausea_med),
    # NOTE: Melis use only median because is change score with IQR as just lower
    # NOTE: footnote "Within group change from baseline."
    ranges = str_c("(", round_0(nausea_rl), "-", round_0(nausea_ru), ")"),
    nausea_sd = ifelse(is.na(nausea_sd) & !is.na(nausea95u), sd_confint(nausea95l, nausea95u), nausea_sd),
    mn_95_ci = str_c(round_1(nausea_m), " (", round_1(nausea95l), "-", round_1(nausea95u), ")"),
    mn_95_ci = ifelse(!is.na(nausea_m) & !is.na(nausea_sd), str_c(round_1(nausea_m), " (", round_1(nausea_m - (1.96 * nausea_sd)), "-", round_1(nausea_m + (1.96 * nausea_sd)), ")"), mn_95_ci),
    mn_95_ci = ifelse(mn_95_ci == "NA (NA-NA)", NA, mn_95_ci),
    mn_95_ci = str_replace(mn_95_ci, "\\(NA-NA\\)", ""),
    # mn_sd = NA,
    mn_sd = ifelse(!is.na(nausea_sd) & !is.na(nausea_m), paste0(round_1(nausea_m), " (", round_1(nausea_sd), ")"), round_1(nausea_m)),
    # mn_sd = ifelse(refid == 262, paste0(mn_sd, "^c^"), mn_sd),
    mn_sd = na_if(mn_sd, "NA"),
    nausea_med = str_replace(nausea_med, "\\(NA-NA\\)", ""),
    ranges = str_replace(ranges, "\\(NA-NA\\)", ""),
    # NOTE: footnote e: Hunger Satiety Scale
    nausea_scale = ifelse(nausea_scale == "VAS: 0 to 100", "0→100", nausea_scale),
    nausea_scale = ifelse(nausea_scale == "VAS, 0-100", "0→100", nausea_scale),
    nausea_scale = ifelse(nausea_scale == "VAS, 0 to 100", "0→100", nausea_scale),
    nausea_scale = ifelse(nausea_scale == "VAS, 0 to 10", "0→10", nausea_scale),
    nausea_scale = ifelse(nausea_scale == "VAS, 1 to 10", "0→10", nausea_scale),
    nausea_scale = ifelse(nausea_scale == "VAS, 0-10", "0→10", nausea_scale),
    nausea_scale = ifelse(nausea_scale == "VAS 10 pt", "0→10", nausea_scale),
    nausea_scale = ifelse(nausea_scale == "NRS, 0 to 10", "0→10^NRS^", nausea_scale),
    nausea_scale = ifelse(nausea_scale == "NRS, 0 to 2", "0→2^NRS^", nausea_scale),
    nausea_scale = ifelse(nausea_scale == "NRS, 0 to 3", "0→3^NRS^", nausea_scale),
    nausea_scale = ifelse(nausea_scale == "Likert, 0 to 3", "0→3^NRS^", nausea_scale),
    # fix Mellis 4952 change reported w/iqr as single value
    nausea_med = str_replace(nausea_med, "-NA", ""),
    # NOTE: footnote b: Mellis "Within group change from baseline."
    nausea_med = ifelse(refid == 4952, paste0(nausea_md, " (", round_0(nausea_iqrl), ")^b^"), nausea_med),
  ) %>%
  # remove second line study identifier
  arrange(age, desc(surg_nosurg), design, desc(pre_post_op), year, study) %>%
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    nausea_scale = ifelse(row_number() == 1, nausea_scale, NA),
  ) %>%
  ungroup()

likert_cho_nausea_preop_kbl.dat <- likert_cho_nausea_kbl.dat %>% 
  filter(pre_post_op == "Preop")
  # 2021/05/08 11:05 verified all preop
  
```

```{r nauseaAdultSurgKable, echo = FALSE}
## (updated 2020/12/13 13:48) nauseaAdultSurgKable ------------------------
cho_row <- likert_cho_nausea_preop_kbl.dat %>%
  mutate(line = row_number()) %>%
  filter(grepl("CHO", arm_tx)) %>%
  pull(line)

# no < 2 hours verified 2021/06/23 11:03
# two_hours(likert_cho_nausea_preop_kbl.dat$refid)

likert_cho_nausea_preop_kbl.dat %>%
  select(study, arm_tx, arm_n, hr_gt6, hr_26, hr_2, nausea_scale, mn_sd, nausea_med, ranges) %>%
  add_row() %>%
  kbl(
    booktabs = T, align = c("llcccclll"), escape = FALSE,
    col.names = c(
      "       Study", "Liquid", "N", "> 6", "6→2", "2", "Scale^a^", "M (SD)", "Med (IQR)", "Range"
    )
  ) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Nausea Rating" = 4), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  # NOTE: footnote a: includes at 2.5 hours
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4, 6), width = "3em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(7, width = "4em") %>%
  column_spec(8, width = "6em") %>%
  column_spec(9, width = "7em") %>%
  column_spec(10, width = "7em") %>%
  row_spec(cho_row, color = "brown") %>%
  pack_top(., "Adult, Surgical", 1, 28) %>%
  pack_sub(., "RCT", 1, 28) %>%
  result_pack("Between-group differences not detected", 4, padding = 65) %>%
  result_pack("Difference across groups not detected", 7, padding = 65) %>%
  result_pack("Afternoon prior to surgery change undetected", 10, padding = 65) %>%
  result_pack("Difference across groups not detected, P = .96", 13, padding = 65) %>%
  result_pack("Between-group differences not detected", 15, padding = 65) %>%
  result_pack("Between-group differences not detected, P = .28", 17, padding = 65) %>%
  result_pack("Between-group differences not detected", 19, padding = 65) %>%
  result_pack("Between-group differences not detected, P = .08", 21, padding = 65) %>%
  result_pack("Between-group differences not detected, P = .84", 23, padding = 65) %>%
  result_pack("Between-group differences not detected, P = .19", 25, padding = 65) %>%
  result_pack("Between-group differences not detected, P = .48", 27, padding = 65) %>%
  result_pack("Between-group differences not detected", 29, padding = 65) %>%
  footnote(
    general = "RCT: randomized controlled trial; M: mean; SD: standard deviation; Med: median; IQR: interquartile range; NRS: numeric rating scale.",
    alphabet = c(
      "Arrow (→) indicates best to worst nausea (visual analogue if not noted NRS).",
      "Within group change from baseline; reported IQR as a single value."
    ),
    general_title = "",
    footnote_as_chunk = FALSE
  )

  table_n <- tab_inc()
```

<br/>

<a id="choFig7"></a>

### Pooled (adult RCTs, rates)   

<br/>

<font size = 4> Figure `r figure_n`. Pooled rates of preoperative nausea in adult patients — randomized trials comparing carbohydrate drinks with fasting. </font>

```{r nauseaMetaDichot, include = TRUE,  fig.width = 10, fig.height = 2.7, fig.align = "center"}
## (updated 2021/01/13 09:48) --------------------------------------------
# cho vs fasting, add pre_post_op
nausea_meta.dat <- or_join(dichot_nausea_or, "nausea") %>% 
  filter(c_tx == "Fasting") %>% 
  filter(tx != "Placebo") %>% 
  mutate(tx = "CHO (any)") %>% 
  # select only preop trials, exclude TDrobjewski 2018 940 peds
  filter(refid %in% unique(dichot_nausea_preop$refid), refid != 940)
  
## (updated 2021/05/05 09:56) meta ----------------------------------------
nausea_meta <- metabin(event_e, n_e, event_c, n_c,
  data = nausea_meta.dat,
  studlab = study,
  sm = "OR",
  method = "MH",
  method.tau = "PM",
  hakn = FALSE,
  digits = 2)

forest(nausea_meta,
  comb.random = FALSE,
  lab.e = "CHO     ",
  lab.c = "Fasting    ",
  digits = 2,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  overall = TRUE,
  print.I2.ci = TRUE,
  prediction = FALSE,
  fs.xlab = 11,
  rightcols = c("effect", "ci"),
  rightlabs = c("OR", "95% CI     "),
  xlim = c(.2, 10),
  allstudies = FALSE,
  # at = c(0.01, 0.1, .4,  1, 2, 2),
  pooled.events = TRUE,
  xlab = "Favors CHO           Favors Fasting")
  
figure_n <- fig_inc()

# funnel(nausea_meta)
# metabias(nausea_meta, k.min = 9)
```

<br/>

## *Preoperative Pain/Discomfort* 

<a id="choTab15"></a>

### Rates  

<br/>

<font size = 4> Table `r table_n`. Rates of preoperative discomfort, or irritability in children, in randomized trials according to fasting, liquid and volume. </font>

```{r comfortTableOr, include = TRUE}
##(updated 2021/01/13 08:52) comfortTableOr --------------------------------
dichot_format <- function(x) (x/100)
dichot_comfort_or <- dichot_cho.dat %>% 
  filter(!is.na(comfort_np)) %>%
  select(refid, study, arm_tx, arm_n, comfort_n) %>% 
  group_by(refid) %>% 
  filter(n() > 1)

or_comfort <- with(or_join(dichot_comfort_or, "comfort"), odds_ratio(event_c, n_c, event_e, n_e, refid = refid, digits = 2))

dichot_comfort <- dichot_cho.dat %>%
  filter(!is.na(comfort_np)) %>%
  mutate(
    pre_post_op = ifelse(time_outcome > 0, "Postop", "Preop"),
    pre_post_op = ifelse(surg_nosurg == "non-surgical", NA, pre_post_op)
  ) %>%
  arrange(age, desc(surg_nosurg), design, year, study) %>%
  select(refid:time_outcome, pre_post_op, comfort_np, comfort_per, comfort_n)

dichot_comfort <- left_join(dichot_comfort, or_comfort, by = "refid") %>% 
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    or_ci = ifelse(row_number() == 1, or_ci, NA),
  ) %>%
  ungroup() %>% 
  mutate(comfort_per = round(comfort_per, 0)) %>% 
  select(refid, arm, design, age, study, arm_n, arm_tx, starts_with("hr"), comfort_np, comfort_per, or_ci)

## (updated 2021/04/19 14:29) kable ---------------------------------------
cho_row <- dichot_comfort %>%
  mutate(line = row_number()) %>%
  filter(grepl("CHO", arm_tx)) %>%
  pull(line)

dichot_comfort$comfort_bar <- NA
dichot_comfort$comfort_bar <- ifelse(grepl("CHO", dichot_comfort$arm_tx),
  color_bar("darksalmon", fun = dichot_format)(100 - dichot_comfort$comfort_per),
  color_bar("lightgray", fun = dichot_format)(100 - dichot_comfort$comfort_per))

# delete number (%) from bars
dichot_comfort <- dichot_comfort %>%
  mutate(comfort_bar = str_replace(comfort_bar, ">[0-9]{1,2}", ">&nbsp;"))

# two_hours(dichot_comfort$refid); none <2 hours 2021/06/23 11:11
  
dichot_comfort %>%
  select(study, arm_tx, arm_n, hr_gt6:hr_2, comfort_np, comfort_bar, or_ci) %>%
  mutate(hr_26 = ifelse(arm_tx == "CHO/Simp", "10-15 mL/kg", hr_26)) %>%
  kbl(
    booktabs = T, align = c("llccccrlc"), escape = FALSE,
    col.names = c("        Study", "Liquid", "N", "> 6", "6→2", "2", "N (%)", " ", "CHO vs. Comparator")
  ) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Discomfort" = 2, "OR (95% CI)"), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4, 6), width = "3em") %>%
  column_spec(5, width = "6em") %>%
  column_spec(7, width = "5em") %>%
  column_spec(8, width = "5em") %>%
  column_spec(9, width = "11em") %>%
  row_spec(cho_row, color = "brown") %>%
  pack_top(., "Adult, Surgical (endoscopy)", 1, 2) %>%
  pack_sub(., "RCT", 1, 2) %>%
  pack_top(., "Pediatric, Surgical", 3, 4) %>%
  result_pack("Irritable vs. Normal Behavior", 3, 70, bold = TRUE, italic = FALSE, color = "black") %>%
  pack_sub(., "RCT", 3, 4) %>%
  footnote(
    general = "RCT: randomized controlled trial; OR: odds ratio; CHO: carbohydrate; Comp: complex; Simp: simple; Prot: protein.",
    # alphabet = c(""),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

<a id="choTab16"></a>

### Patient-rated  

<br/>

<font size = 4> Table `r table_n`. Preoperative pain/discomfort ratings according to fasting, liquid and volume. </font>

```{r comfortData, include = TRUE}
## (updated 2020/12/14` 14:32) comfortData ---------------------------------
# pain/comfort studies
likert_cho_comfort.dat <- likert_cho.dat %>%
  filter(refid %in% cho_refids, !is.na(comfort_l) | !is.na(pain_l)) %>%
  mutate(
    pre_post_op = ifelse(likert_time_outcome > 0, "Postop", "Preop"),
    pre_post_op = ifelse(surg_nosurg == "non-surgical", NA, pre_post_op)
  ) %>%
  # filter_at(vars(thirst_m:thirst_pval), any_vars(!is.na(.))) # same
  select(refid:age, arm_n, arm_tx, pre_post_op, likert_time_outcome, contains("ingest"), starts_with(c("comfort", "pain")), out_l_notes) %>%
  mutate(
    # surgical studies (note none have times 0 or negative)
    # hr_2 is ≤ 2; hr_26 is (2, 6] >2 to 6; hr_gt6 is >6
    hr_2 = 0, hr_26 = 0, hr_gt6 = 0,
    hr_2 = if_else(timeingest1 <= 2 & timeingest1 > 0, amtingest1, hr_2, missing = 0),
    # FOR Du Rct add new header in table after RCT
    # hr_2 =   if_else(timeingest1 == 0, amtingest1, hr_2, missing = 0),
    hr_26 = if_else(timeingest1 > 2 & timeingest1 < 6, amtingest1, hr_26, missing = 0),
    hr_gt6 = if_else(timeingest1 >= 6, amtingest1, hr_gt6, missing = 0),
    hr_2 = if_else(hr_2 == 0 & timeingest2 <= 2 & timeingest2 > 0, amtingest2, hr_2, missing = 0),
    hr_26 = if_else(hr_26 == 0 & timeingest2 > 2 & timeingest2 < 6, amtingest2, hr_26, missing = 0),
    hr_gt6 = if_else(hr_gt6 == 0 & timeingest2 >= 6, amtingest2, hr_gt6, missing = 0),
    hr_gt6 = if_else(grepl("also received 300", type_ingest_1), 500, hr_gt6), # Oyama PM
    arm_tx = droplevels(arm_tx)
  ) %>%
  replace_with_na_at(.vars = c("hr_gt6", "hr_26", "hr_2"), condition = ~ .x == 0) %>%
  mutate( # columns for table
    comfort95l = ifelse(is.na(comfort95l), conf_tl(comfort_m, comfort_sd, arm_n), comfort95l),
    comfort95u = ifelse(is.na(comfort95u), conf_tu(comfort_m, comfort_sd, arm_n), comfort95u),
    m_ci = ifelse(comfort_m >= 1,
      str_c(round_1(comfort_m), " (", round_1(comfort95l), "-", round_1(comfort95u), ")"),
      str_c(round_2(comfort_m), " (", round_2(comfort95l), "-", round_2(comfort95u), ")")
    ),
    m_ci = gsub(" \\(NA-NA\\)", "", m_ci),
    med_iqr = str_c(comfort_med, " (", comfort_iqrl, "-", comfort_iqru, ")"),
    med_iqr = ifelse(is.na(med_iqr) & !is.na(comfort_med), comfort_med, med_iqr),
    med_range = str_c("(", comfort_rl, "-", comfort_ru, ")"),
    m_ci = ifelse(m_ci == "0.00 (0.00-0.00)", "0.0 (0-0)", m_ci)
  ) %>%
  arrange(age, desc(surg_nosurg), design, desc(pre_post_op), desc(comfort_pain), year, study, arm_tx) %>% 
  filter(pre_post_op == "Preop")

# write_csv(likert_cho_comfort.dat, "/Users/mgrant/Desktop/likert_comfort.csv", na = "")
```

```{r comfortKable, echo = FALSE, include = TRUE}
## (updated 2020/12/14 14:31) comfortKable --------------------------------
likert_cho_comfort_kbl.dat <- likert_cho_comfort.dat %>%
  # change Bisgaard 2004 5309 pain to preop
  mutate(pre_post_op = ifelse(refid == 5309, "Preop", pre_post_op)) %>% 
  # pain only 
  filter(comfort_pain == "pain") %>% 
  rename(scale_com = comfort_pain_scale) %>% 
  select(study, arm_tx, arm_n, hr_gt6, hr_26, hr_2, pre_post_op, scale_com, m_ci, med_iqr, med_range) %>%
  # add_row() %>%
  mutate(
    scale_com = ifelse(grepl("QoR-40 (pain)", scale_com), "QoR-40 pain^c^", scale_com),
    # scale_com = ifelse(grepl("comfort", scale_com), "QoR-40^c^  12→60 ", scale_com),
    # scale_com = ifelse(grepl("unspecified", scale_com), "VAS^d^  ?→? ", scale_com),
    # scale_com = ifelse(grepl("abdominal", scale_com), "VAS^e^ 0→100 ", scale_com),
    scale_com = ifelse(grepl("0 to 100 \\(pain\\)", scale_com), "0→100", scale_com),
    scale_com = ifelse(grepl("Pain VAS, 0 to 10", scale_com), "VAS 0→10", scale_com),
    scale_com = ifelse(grepl("0 to 100", scale_com), "0→100", scale_com),
    scale_com = ifelse(grepl("0-100", scale_com), "0→100", scale_com),
    scale_com = ifelse(grepl("range", scale_com), "VAS unspec", scale_com),
    scale_com = ifelse(grepl("QoR-40", scale_com), "QoR40 0→60", scale_com),
    scale_com = ifelse(scale_com == "VAS, 0-100", "0→100", scale_com),
    scale_com = ifelse(scale_com == "VAS, 0 to 100", "0→100", scale_com),
    scale_com = ifelse(scale_com == "VAS, 0 to 10", "0→10", scale_com),
    scale_com = ifelse(scale_com == "VAS, 1 to 10", "0→10", scale_com),
    scale_com = ifelse(scale_com == "VAS, 0-10", "0→10", scale_com),
    scale_com = ifelse(scale_com == "VAS 10 pt", "0→10", scale_com),
    scale_com = ifelse(scale_com == "0-10", "0→10", scale_com),
    scale_com = ifelse(scale_com == "NRS, 0 to 10", "0→10^NRS^", scale_com),
    scale_com = ifelse(scale_com == "NRS, 0 to 2", "0→2^NRS^", scale_com),
    scale_com = ifelse(scale_com == "NRS, 0 to 3", "0→3^NRS^", scale_com),
    scale_com = ifelse(scale_com == "Likert, 0 to 3", "0→3^NRS^", scale_com),
    # change Lawick to post-op becuase appears in Distiller as preop b/c hunger thirst
    pre_post_op = ifelse(study == "Lawick 2009", "Postop", pre_post_op)
    ) %>%
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    pre_post_op = ifelse(row_number() == 1, pre_post_op, NA),
    # comfort_pain = ifelse(row_number() == 1, comfort_pain, NA),
    scale_com = ifelse(row_number() == 1, scale_com, NA)) %>%
  ungroup() %>%
  mutate(scale_com = ifelse(arm_tx == "CHO" & arm_n == 43, "35→5", scale_com))

# two_hours(likert_cho_comfort.dat$refid); verified only 2 hour

# fix Drobjewski divide by age
temp <- tribble(
  ~study, ~arm_tx, ~arm_n, ~hr_gt6, ~hr_26, ~hr_2, ~pre_post_op, ~scale_com, ~m_ci, ~med_iqr, ~med_range,
  "TDrobjewski 2018", "Fasting" ,    49,   NA,  NA,    NA, "Preop",  "0→10",      "1.0", NA, "(0-9)",    
  "     >4 yr"      , "CHO/Comp",    55,   "5 mL/kg",    NA, "5 mL/kg", NA,  NA,  "1.0", NA, "(0-6)", 
  "TDrobjewski 2018", "Fasting" ,    11,   NA,    NA,    NA, "Preop",  "0→10^b^", "1.0", NA, "(0-7)",    
  "     ≤4 yr"      , "CHO/Comp",    5,    "5 mL/kg",    NA, "5 mL/kg", NA, NA,   "2.0", NA, "(0-6)" 
)

likert_cho_comfort_kbl.dat <- likert_cho_comfort_kbl.dat %>% 
  slice(n = 1:12) %>% 
  mutate(hr_2 = as.character(hr_2),
         hr_gt6 = as.character(hr_gt6)) %>% 
  bind_rows(temp) %>% 
  add_row()

rm(temp)

cho_row <- likert_cho_comfort_kbl.dat %>% 
  mutate(line = row_number()) %>% 
  filter(grepl("CHO", arm_tx)) %>% 
  pull(line)

likert_cho_comfort_kbl.dat %>% 
  select(-pre_post_op) %>% 
  kbl(booktabs = T, align = c("llccccllll"), escape = FALSE,
    col.names = c(
      "       Study", "Liquid", "N",  "> 6", "6→2", "2", "Scale^a^", "M (95% CI)",
      "Med (IQR)", "Range")) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Pain/Discomfort\n (Between-group Comparison)" = 4), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4,6), width = "5em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(7, width = "5em") %>%
  column_spec(8, width = "8em") %>%
  column_spec(9, width = "7em") %>%
  column_spec(10, width = "5em") %>%
  row_spec(cho_row, color = "brown") %>%
  pack_top(., "Adult, Surgical", 1, 12) %>%
  pack_sub(., "RCT", 1, 12) %>%
  pack_top(., "Pediatric", 13, 16) %>% 
  pack_sub(., "RCT", 13, 16) %>% 
  # pack_rows("Between-group difference not detected, P = .49", 4, 4, label_row_css = "padding-left:60%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>% 
  # pack_rows("MD 0.08 (95% CI, -0.70 to 0.86)", 6, 6, label_row_css = "padding-left:60%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>% 
  # pack_rows("Between-group difference not detected, P = .16", 9, 9, label_row_css = "padding-left:60%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>% 
  # pack_rows("MD 0.03 (-0.10 to 0.17)", 11, 11, label_row_css = "padding-left:60%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>% 
  # pack_rows("MD -1.92 (95% CI, -2.15 to -1.69)", 13, 13, label_row_css = "padding-left:60%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>% 
  #pack_rows("Comfort", 1, 3, label_row_css = "padding-left:76.5%", bold = TRUE) %>%
  #pack_rows("Pain", 4, 12, label_row_css = "padding-left:77.5%", bold = TRUE) %>%
  result_pack("Difference not detected", 17, padding = 70) %>% 
  result_pack("Difference not detected", 15, padding = 70) %>% 
  footnote(
    general = "RCT: randomized controlled trial; M: mean; SD: standard deviation; Med: median; IQR: interquartile range.",
    alphabet = c("Visual analogue scales; Arrow (→) indicates least/best to worst/most.",
                 "Observational pain scale with 0 to 2 points for crying, facial expression, position of torso, position of legs, and motor restlessness."),
    general_title = "",
    footnote_as_chunk = FALSE)

table_n <- tab_inc()
```

<br/>

<a id="choTab8"></a>

### Pooled (adult RCTs, patient-rated)   

<br/>

<font size = 4> Figure `r figure_n`. Pooled preoperative pain ratings (standardized mean differences in VAS) from randomized trials comparing carbohydrate drinks with fasting in adult surgical patients. </font>

```{r comfortAdultLikertMeta, echo = FALSE,  fig.width = 10, fig.height = 3.0, fig.align = "center"}
## (updated 2021/04/13 07:39) comfortAdultLikertMeta -----------------------
comfort_lik_meta.dat <- likert_cho_comfort.dat %>%
  filter(age == "Adult", design == "rct") %>%
  select(refid, study, pre_post_op, contains("arm_"), comfort_m, comfort_sd, comfort_med, contains("t_iqr"), contains("t_r")) %>% 
         #comfort_iqrl, comfort_iqru, comfort_rl, comfort_ru) %>%
  group_by(refid) %>%
  fill(study, pre_post_op) %>%
  ungroup()

# fasting
fast_meta.dat <- comfort_lik_meta.dat %>%
  filter(grepl("Fasting|CHO", arm_tx)) %>%
  # delete Rizvanovic 2019 both arms 0; Zhang 743 all zero
  filter(!refid %in% c(431, 743)) %>%
  # impute Zelic 2013 sd ns b/w group
  mutate(
    comfort_sd = ifelse(refid == 2982, 1.244, comfort_sd),
    arm = ifelse(grepl("CHO", arm_tx), "CHO", as.character(arm_tx))
  ) %>% 
group_by(refid) %>%
  filter(n() > 1) %>%
  filter(row_number() < 3) %>%
  ungroup() %>%
  select(-c(refid, arm_tx)) %>%
  pivot_wider(names_from = "arm", values_from = arm_n:comfort_ru) %>%
  rename_all(~ str_replace(., "comfort_", "")) %>%
  rename_all(tolower)
  # filter(pre_post_op == "Preop")

temp <- metacont(
  n.e = arm_n_cho,
  mean.e = m_cho,
  sd.e = sd_cho,
  median.e = med_cho,
  q1.e = iqrl_cho,
  q3.e = iqru_cho,
  min.e = rl_cho,
  max.e = ru_cho,
  n.c = arm_n_fasting,
  mean.c = m_fasting,
  sd.c = sd_fasting,
  median.c = med_fasting,
  q1.c = iqrl_fasting,
  q3.c = iqru_fasting,
  min.c = rl_fasting,
  max.c = ru_fasting,
  sm = "SMD",
  method.tau = "REML",
  studlab = study,
  comb.fixed = TRUE,
  data = fast_meta.dat
)

# dmetar::find.outliers(temp)
 
forest(temp,
  comb.fixed = FALSE,
  lab.e = "CHO     ",
  lab.c = "Fasting     ",
  digits = 2,
  digits.sd = 1,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  print.byvar = FALSE,
  overall = TRUE,
  fs.xlab = 11,
  xlim = c(-2, 2),
  rightcols = c("effect", "ci"),
  rightlabs = c("SMD", "95% CI     "),
  xlab = "Favors CHO              Favors Fasting"
)

# metabias(temp, method.bias = "Pustejovsky", k.min = 8)
# funnel(temp)

figure_n <- fig_inc()
```
Zhang 2019 and Rizvanovic 2019 (preoperative pain) were excluded from the pooled result as both reported no pain/discomfort in either arm.  

Too few studies to examine small study effects.

<br/>

<a id="choTab17"></a>

## *Patient Satisfaction*   

<br/>

<font size = 4> Table `r table_n`. Patient satisfaction ratings according to fasting, liquid and volume. </font>

```{r satisLikert, include = TRUE}
## (updated 2021/01/29 08:30) satisLikert ---------------------------------
# no subgroup data
likert_satis.dat <- likert_cho.dat %>%
  filter(refid %in% cho_refids) %>%
  # delete Asakura 2234 and Lee 2018 as abstracted QoR emotional
  filter(pt_satis_l == "pt_satis_l", !refid %in% c(2234, 926)) %>%
  # filter_at(vars(satis_m:satis_pval), any_vars(!is.na(.))) # same
  select(refid:age, arm_n, arm_tx, likert_time_outcome, contains("ingest"), contains("satis")) %>%
  mutate(arm_tx = droplevels(arm_tx)) %>%
  arrange(age, desc(surg_nosurg), design, year, study, arm_tx)

likert_satis_kbl.dat <- likert_satis.dat %>%
  rename(time_outcome = likert_time_outcome) %>%
  mutate(
    # surgical studies (note none have times 0 or negative)
    # hr_2 is ≤ 2; hr_26 is (2, 6] >2 to 6; hr_gt6 is >6
    hr_2 = 0, hr_26 = 0, hr_gt6 = 0,
    hr_2 =   if_else(timeingest1 <= 2 & timeingest1 > 0, amtingest1, hr_2, missing = 0),
    hr_26 =  if_else(timeingest1 > 2 & timeingest1 < 6, amtingest1, hr_26, missing = 0),
    hr_gt6 = if_else(timeingest1 >= 6, amtingest1, hr_gt6, missing = 0),
    hr_2 =   if_else(hr_2 == 0 & timeingest2 <= 2 & timeingest2 > 0, amtingest2, hr_2, missing = 0),
    hr_26 =  if_else(hr_26 == 0 & timeingest2 > 2 & timeingest2 < 6, amtingest2, hr_26, missing = 0),
    hr_gt6 = if_else(hr_gt6 == 0 & timeingest2 >= 6, amtingest2, hr_gt6, missing = 0),
    hr_gt6 = if_else(grepl("also received 300", type_ingest_1), 500, hr_gt6),  # Oyama PM
    arm_tx = as.character(arm_tx),
    arm_tx = ifelse(study == "Du 2017" & arm_tx == "Clear", "Juice^e^", arm_tx),
    arm_tx = ifelse(study == "Marquini 2020c" & arm_tx == "Clear", "Water^c^", arm_tx)) %>%
  replace_with_na_at(.vars = c("hr_gt6", "hr_26", "hr_2"), condition = ~ .x == 0) %>%
  # Footnote: distilled water, 4 drops red dye, 2 drops sucrose
  select(refid:arm_tx, hr_gt6, hr_26, hr_2, time_outcome, satisfaction_scale, satis_m:satis_iqru) %>%
  mutate(
    satis_med = paste0(satis_med, " (", satis_iqrl, "-", satis_iqru, ")"),
    satis_med = ifelse(satis_med == "NA (NA-NA)", NA, satis_med),
    satis_med = gsub(" \\(NA-NA\\)", "", satis_med),
    ranges = str_c("(", satis_rl, "-", satis_ru, ")"),
    mn_95_ci = str_c(round_1(satis_m), " (", round_1(satis95l), "-", round_1(satis95u), ")"),
    mn_95_ci = ifelse(mn_95_ci == "NA (NA-NA)", NA, mn_95_ci),
    mn_95_ci = str_replace(mn_95_ci, "\\(NA-NA\\)", ""), 
    satisfaction_scale = ifelse(study == "Ajuzieogu 2016", "NRS^b^", satisfaction_scale),
    # NOTE: footnote e: satis Satiety Scale
    satisfaction_scale = ifelse(satisfaction_scale == "VAS, 0 to 10", "0→10", satisfaction_scale),
    satisfaction_scale = ifelse(satisfaction_scale == "0-10 scale", "10→0", satisfaction_scale),
    ) %>% 
  # remove second line study identifier
  arrange(age, desc(surg_nosurg), design, year, study) %>%
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    study = ifelse(study == "Song 2016", "Song 2016^c^", study),
    satisfaction_scale = ifelse(row_number() == 1, satisfaction_scale, NA),
    time_outcome = ifelse(row_number() == 1, time_outcome, NA)) %>%
  ungroup()
```

```{r satisAdultSurgKable, echo = FALSE}
## (updated 2021/01/29 08:30) satisAdultSurgKable -------------------------
cho_row <- likert_satis_kbl.dat %>%
  mutate(line = row_number()) %>%
  filter(grepl("CHO", arm_tx))  %>%
  pull(line)

# two_hours(likert_satis.dat$refid)

likert_satis_kbl.dat %>%
  mutate(study = ifelse(study == "Song 2016^c^", cell_spec(study, color = "black"), study)) %>% 
  select(study, arm_tx, arm_n, hr_gt6, hr_26, hr_2, satisfaction_scale, mn_95_ci, satis_med, ranges) %>%
  add_row() %>% 
  kbl(booktabs = T, align = c("llcccclccc"), escape = FALSE,
      col.names = c(
        "        Study", "Liquid", "N",  "> 6", "6→2", "2",  "Scale^a^", "M (95% CI)", "Med", "Range")) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Satisfaction Rating\n *(Between-group Comparison)*" = 4), line = TRUE) %>%
  # NOTE: footnote a: includes at 2.5 hours
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(4, width = "3em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(6, width = "4em") %>%
  column_spec(7, width = "6em") %>%
  column_spec(8, width = "6em") %>%
  column_spec(9, width = "7em") %>%
  column_spec(10, width = "6em") %>%
  row_spec(cho_row, color = "brown") %>%
  pack_top(., "Adult", 1, 7) %>%
  pack_sub(., "RCT", 1, 7) %>%
  result_pack("P = .03; higher in CHO arm", 4, padding = 70) %>% 
  result_pack("No difference detected", 6, padding = 70) %>% 
  result_pack("P = .01; MD^d^\\ 1.76 (95% CI, 1.59 to 1.93)", 8, padding = 70) %>% 

  pack_top(., "Pediatric", 8, 8) %>% 
  pack_sub(., "Prospective Cohort", 8, 8) %>% 
  footnote(
    general = "RCT: randomized controlled trial; M: mean; Med: median; MD: mean difference.",
    alphabet = c(
      "Visual analogue scale with arrow (→) indicating low to high patient satisfaction.",
      "Range unspecified.",
      "Parental satisfaction (lower is better).",
      "Calculated from means and confidence intervals."),
    general_title = "",
    footnote_as_chunk = FALSE)

table_n <- tab_inc()
```

<br/>

<hr style="height:2px;border-width:0;color:gray;background-color:gray">

# **Clinical Outcomes** 

<br/>   

## *Aspiration*

<a id="choTab18"></a> 

### Adults 

<br/>

<font size = 4> Table `r table_n`. Studies reporting no occurrence of aspiration in adults — number of participants according to liquid received. </font>

```{r aspirateTableReport, include = TRUE}
## (updated 2021/01/12 18:04) aspirateTableReport -------------------------
# overall totals
totals <- dichot_cho.dat %>%
  filter(!is.na(aspirate_np)) %>%
  filter(surg_nosurg == "surgical") %>%
  arrange(age, desc(surg_nosurg), design, year, study) %>%
  select(refid, design, age, study, arm_n, arm_tx) %>%
  pivot_wider(
    id_cols = c(refid, study, age, design),
    names_from = arm_tx,
    values_from = arm_n,
    values_fn = sum
  ) %>%
  # exclude duplicate Marquini publications
  filter(!refid %in% c(6446, 247)) %>%
  mutate(study = ifelse(refid == 165, "Marquini 2020", study)) %>%
  filter(age == "Adult") %>% 
  select(study, Fasting, Water, Placebo, "CHO/Comp", "CHO/Simp", "CHO/Comp/Prot", "CHO/Simp/Prot", "Prot") %>%
  adorn_totals(c("col", "row"), fill = "-", na.rm = TRUE) %>% 
  slice_tail(n = 1)

dichot_cho.dat %>%
  filter(!is.na(aspirate_np)) %>%
  filter(surg_nosurg == "surgical") %>%
  arrange(age, desc(surg_nosurg), design, year, study) %>%
  select(refid, design, age, study, arm_n, arm_tx) %>%
  # select(refid, design, age, study, arm_n, arm_tx, year, surg_nosurg) %>%
  pivot_wider(
    id_cols = c(refid, study, age, design),
    # id_cols = c(refid, study, age, design, year, surg_nosurg),
    names_from = arm_tx,
    values_from = arm_n,
    values_fn = sum
  ) %>%
  # exclude duplicate Marquini publications
  filter(!refid %in% c(6446, 247)) %>%
  mutate(study = ifelse(refid == 165, "Marquini 2020", study)) %>%
  filter(age == "Adult") %>% 
  select(study, design, Fasting, Water, Placebo, "CHO/Comp", "CHO/Simp", "CHO/Comp/Prot", "CHO/Simp/Prot", "Prot") %>%
  # get fasting totals
  # filter(!is.na(Fasting)) %>% 
  # filter(!is.na("CHO/Comp") | !is.na("CHO/Simp") | !is.na("CHO/Comp/Prot") | !is.na("CHO/Simp/Prot")) %>% 
  group_by(design) %>% 
  group_map(~ .x %>%  adorn_totals(c("col", "row"), fill = "-", na.rm = TRUE)) %>% 
  bind_rows() %>% 
  ungroup() %>% 
  bind_rows(., totals) %>% 
  mutate(study = ifelse(row_number() == n(), "Overall", study),
         study = ifelse(study == "Total", "    Total", study),
         across(Fasting:Total, ~ifelse(.x == 0, NA, .x))) %>% 
  kbl(
    booktabs = T, align = c("lccccccccr"), escape = FALSE,
    col.names = c("       Study", "Fasting", "Water", "Placebo", "CHO/Comp", "CHO/Simp", "Prot", "Prot", "Prot", "Total")
  ) %>%
  add_header_above(c(" " = 6, "CHO/Comp", "CHO/Simp", " " = 2), line = FALSE, bold = TRUE) %>% 
  add_header_above(c(" " = 1, "Liquid and Participants Receiving" = 8, " " = 1), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "15em") %>%
  column_spec(2:9, width = "5em") %>%
  column_spec(10, width = "5em") %>%
  # row_spec(c(38, 44, 46, 48, 49), bold = TRUE) %>%
  row_spec(49, bold = TRUE) %>%
  column_spec(10, bold = TRUE) %>%
  pack_top(., "Adult", 1, 48) %>%
  pack_sub(., "RCT", 1, 38) %>%
  pack_sub(., "Nonrandomized Studies of Interventions", 39, 44) %>%
  pack_sub(., "Prospective Cohort", 45, 46) %>%
  pack_sub(., "Case-Control", 47, 48) %>%
  footnote(
    general = "RCT: randomized controlled trial; CHO: carbohydrate; Simp: simple; Comp: complex; Prot: protein.",
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/> 

<a id="choTab19"></a>

### Pediatric 

<br/>

<font size = 4> Table `r table_n`. Studies reporting any occurrence of aspiration in children — number of participants according to liquid received. </font>

```{r aspirateTableReportPeds, include = TRUE}
## (updated 2021/01/12 18:04) aspirateTableReport -------------------------
# overall totals
totals <- dichot_cho.dat %>%
  filter(!is.na(aspirate_np)) %>%
  filter(surg_nosurg == "surgical") %>%
  filter(age == "Pediatric") %>% 
  filter(study != "Huang 2020") %>% 
  arrange(age, desc(surg_nosurg), design, year, study) %>%
  select(refid, design, age, study, arm_n, arm_tx) %>%
  pivot_wider(
    id_cols = c(refid, study, age, design),
    names_from = arm_tx,
    values_from = arm_n,
    values_fn = sum
  ) %>%
  select(study, design, Fasting, "CHO/Comp", "CHO/Simp") %>%
  adorn_totals(c("col", "row"), fill = "-", na.rm = TRUE) %>% 
  slice_tail(n = 1)

dichot_cho.dat %>%
  filter(!is.na(aspirate_np)) %>%
  filter(surg_nosurg == "surgical") %>%
  filter(age == "Pediatric") %>% 
  filter(study != "Huang 2020") %>% 
  arrange(age, desc(surg_nosurg), design, year, study) %>%
  # mutate(asp_report = paste0(aspirate_n, "/", arm_n, " (", aspirate_per, ")")) %>% 
  select(refid, design, age, study, arm_n, arm_tx) %>%
  pivot_wider(
    id_cols = c(refid, study, age, design),
    names_from = arm_tx,
    values_from = c(arm_n),
    values_fn = sum
  ) %>%
  select(study, design, Fasting, "CHO/Comp", "CHO/Simp") %>%
  group_by(design) %>% 
  group_map(~ .x %>%  adorn_totals(c("col", "row"), fill = "-", na.rm = TRUE)) %>% 
  bind_rows() %>% 
  ungroup() %>% 
  bind_rows(., totals) %>% 
  mutate(study = ifelse(row_number() == n(), "Overall", study),
         study = ifelse(study == "Total", "    Total", study),
         across(Fasting:Total, ~ifelse(.x == 0, NA, .x))) %>% 
  select(-design) %>% 
  add_row(study = "Huang 2020 2hr^a^", "CHO/Simp" = 174,) %>%
  add_row(study = "                         1hr", "CHO/Simp" = 170, Total = 334) %>% 
  add_row() %>% 
  kbl(
    booktabs = T, align = c("lcccr"), escape = FALSE,
    col.names = c("       Study", "Fasting", "CHO/Comp", "CHO/Simp", "Total")
  ) %>%
  add_header_above(c(" " = 1, "Liquid and Participants Receiving" = 3, " " = 1), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "15em") %>%
  column_spec(2:4, width = "5em") %>%
  column_spec(5, width = "5em") %>%
  row_spec(7, bold = TRUE) %>%
  column_spec(5, bold = TRUE) %>%
  pack_top(., "No Aspiration", 1, 6) %>%
  pack_sub(., "RCT", 1, 4) %>%
  pack_sub(., "Retrospective Cohort", 5, 6) %>%
  pack_top(., "Aspiration", 8, 10) %>%  
  result_pack("3 patients aspirated in each arm", row = 10, padding = 40) %>% 
  footnote(
    general = "RCT: randomized controlled trial; CHO: carbohydrate; Simp: simple; Comp: complex.",
    general_title = "",
    alphabet = c("Study of infants undergoing surgery for cyanotic congenital heart disease (Chinese study)."),
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

<a id="choTab20"></a>

### Adults Unreported 

<br>

<font size = 4> Table `r table_n`. Studies in adults silent on whether or not aspiration occurred. </font>

```{r aspirateTableNoReport, include = TRUE}
## (updated 2021/01/12 18:04) aspirateTableReport -------------------------
## (updated 2021/01/12 18:04) aspirateTableReport -------------------------
# overall totals
totals <- dichot_cho.dat %>%
  filter(is.na(aspirate_np)) %>%
  filter(surg_nosurg == "surgical") %>%
  arrange(age, desc(surg_nosurg), design, year, study) %>%
  select(refid, design, age, study, arm_n, arm_tx) %>%
  pivot_wider(
    id_cols = c(refid, study, age, design),
    names_from = arm_tx,
    values_from = arm_n,
    values_fn = sum
  ) %>%
  # exclude duplicate Marquini publications
  filter(!refid %in% c(6446, 247)) %>%
  mutate(study = ifelse(refid == 165, "Marquini 2020", study)) %>%
  filter(age == "Adult") %>%
  select(study, Fasting, Water, Placebo, Clear, "CHO/Comp", "CHO/Simp", "CHO/Comp/Prot") %>%
  janitor::adorn_totals(c("col", "row"), fill = "-", na.rm = TRUE) %>% 
  slice_tail(n = 1)

dichot_cho.dat %>%
  filter(is.na(aspirate_np)) %>%
  filter(surg_nosurg == "surgical") %>%
  arrange(age, desc(surg_nosurg), design, year, study) %>%
  select(refid, design, age, study, arm_n, arm_tx) %>%
  pivot_wider(
    id_cols = c(refid, study, age, design),
    names_from = arm_tx,
    values_from = arm_n,
    values_fn = sum
  ) %>%
  # exclude duplicate Marquini publications
  filter(!refid %in% c(6446, 247)) %>%
  mutate(study = ifelse(refid == 165, "Marquini 2020", study)) %>%
  filter(age == "Adult") %>%
  select(study, design, Fasting, Water, Placebo, Clear, "CHO/Comp", "CHO/Simp", "CHO/Comp/Prot") %>%
  group_by(design) %>% 
  group_map(~ .x %>%  adorn_totals(c("col", "row"), fill = "-", na.rm = TRUE)) %>% 
  bind_rows() %>% 
  ungroup() %>% 
  bind_rows(., totals) %>% 
  mutate(study = ifelse(row_number() == n(), "Overall", study),
         study = ifelse(study == "Total", "    Total", study),
         across(Fasting:Total, ~ifelse(.x == 0, NA, .x))) %>% 
  kbl(
    booktabs = T, align = c("lcccccccr"), escape = FALSE,
    col.names = c("       Study", "Fasting", "Water", "Placebo", "Clear", "CHO/Comp", "CHO/Simp", "Prot", "Total")
  ) %>%
  add_header_above(c(" " = 7 , "CHO/Comp", " " = 1), line = FALSE, bold = TRUE) %>% 
  add_header_above(c(" " = 1, "Liquid and Participants Receiving" = 7, " " = 1), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "15em") %>%
  column_spec(2:7, width = "5em") %>%
  column_spec(8, width = "5em") %>%
  row_spec(33, bold = TRUE) %>%
  column_spec(9, bold = TRUE) %>%
  pack_top(., "Adult", 1, 32) %>%
  pack_sub(., "RCT", 1, 22) %>%
  pack_sub(., "Nonrandomized Studies of Interventions", 23, 25) %>%
  pack_sub(., "Prospective Cohort", 26, 27) %>%
  pack_sub(., "Retrospective Cohort", 28, 30) %>%
  pack_sub(., "Before-After", 31, 32) %>%
  footnote(
    general = "RCT: randomized controlled trial; CHO: carbohydrate; Simp: simple; Comp: complex; Prot: protein.",
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()

```

<br/>

<a id="choTab21"></a>

### Pediatric Unreported 

<br>

<font size = 4> Table `r table_n`. Studies in children silent on whether or not aspiration occurred. </font>

```{r aspiratePedsTableNoReport, include = TRUE}
## (updated 2021/01/12 18:04) aspirateTableReport -------------------------
dichot_cho.dat %>%
  filter(is.na(aspirate_np)) %>%
  filter(surg_nosurg == "surgical") %>%
  arrange(age, desc(surg_nosurg), design, year, study) %>%
  select(refid, design, age, study, arm_n, arm_tx) %>%
  pivot_wider(
    id_cols = c(refid, study, age, design),
    names_from = arm_tx,
    values_from = arm_n,
    values_fn = sum
  ) %>%
  filter(age == "Pediatric") %>%
  select(study, Fasting, "CHO/Comp", "CHO/Simp") %>%
  janitor::adorn_totals(c("col", "row"), fill = "-", na.rm = TRUE) %>%
  kbl(
    booktabs = T, align = c("lcccr"), escape = FALSE,
    col.names = c("       Study", "Fasting", "CHO/Comp", "CHO/Simp", "Total")
  ) %>%
  add_header_above(c(" " = 1, "Liquid and Participants Receiving" = 3, " " = 1), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "15em") %>%
  column_spec(2:4, width = "5em") %>%
  column_spec(5, width = "5em") %>%
  row_spec(4, bold = TRUE) %>%
  column_spec(5, bold = TRUE) %>%
  pack_top(., "Pediatric", 1, 3) %>%
  pack_sub(., "RCT", 1, 3) %>%
  footnote(
    general = "RCT: randomized controlled trial; CHO: carbohydrate; Simp: simple; Comp: complex.",
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()

```

<br/>

## *Preoperative Regurgitation* 

<a id="choTab22"></a>

### Adults (surgical) 

<br/>

<font size = 4> Table `r table_n`. Rates of regurgitation (preoperative) in adults according to fasting, liquid and volume. </font>

```{r regurgTable, include = TRUE}
## (2021/05/07 09:14) regurgTableOr ---------------------------------------
dichot_format <- function(x) (x/100)

dichot_regurg_or <- dichot_cho.dat %>% 
  filter(!is.na(regurg_np)) %>%
  select(refid, study, arm_tx, arm_n, regurg_n) %>% 
  group_by(refid) %>% 
  filter(n() > 1)

or_regurg <- with(or_join(dichot_regurg_or, "regurg"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2))

## (updated 2021/01/12 18:04) regurgTable ---------------------------------
# note all studies are preoperative assessments
dichot_regurg <- dichot_cho.dat %>% 
  filter(!is.na(regurg_np)) %>%
  arrange(age, desc(surg_nosurg), design, year, study) %>% 
  select(refid:time_outcome, regurg_np, regurg_per, regurg_n)

dichot_regurg <- left_join(dichot_regurg, or_regurg, by = "refid") %>% 
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    or_ci = ifelse(row_number() == 1, or_ci, NA),
    or_ci = ifelse(or_ci == "NA (NA-NA)", "", or_ci),
    or_ci = ifelse(study == "De Jonghe 2016", NA, or_ci)) %>%
  ungroup() %>% 
  mutate(regurg_per = round(regurg_per, 0)) %>% 
  select(refid, arm, design, age, study, arm_n, arm_tx, starts_with("hr"), regurg_np, regurg_per, or_ci)

cho_row <- dichot_regurg %>%
  mutate(line = row_number()) %>%
  filter(grepl("CHO", arm_tx)) %>%
  pull(line)

dichot_regurg$regurg_bar <- 0
dichot_regurg$regurg_bar <- ifelse(grepl("CHO", dichot_regurg$arm_tx),
  color_bar("darksalmon", fun = dichot_format)(dichot_regurg$regurg_per),
  color_bar("lightgray", fun = dichot_format)(dichot_regurg$regurg_per))

tot_n <- sum(dichot_regurg$arm_n)

dichot_regurg  <- dichot_regurg %>% 
  add_foot(study, "Koeppe 2013", "a") %>% 
  mutate(regurg_bar = str_replace(regurg_bar, ">\\d+", ">&nbsp;"),
       regurg_bar = ifelse(regurg_per == 0, "", regurg_bar),
       # DeJohnge fix for rounding
       regurg_np = ifelse(arm_n == 199, "1 (0.5)", regurg_np))
  # add totals
  # add_row(regurg_np = paste0(23, " (", round_1(23/tot_n * 100), ")"), arm_n = tot_n, study = "Total")

# two_hours(dichot_regurg$refid)

dichot_regurg %>% 
  select(!c(refid, arm, design, age, regurg_per)) %>% 
  select(study, arm_tx, arm_n, hr_gt6:hr_2, regurg_np, regurg_bar, or_ci) %>% 
  kbl(booktabs = T, align =  c("llccccrlc"), escape = FALSE,
    col.names = c("        Study", "Liquid", "N",  "> 6", "6→2", "2", "N (%)", " ", "CHO vs. Fasting")) %>% 
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Regurgitation" = 2, "OR (95% CI)"), line = TRUE, bold = TRUE) %>% 
  row_spec(0, bold = TRUE) %>% 
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4, 6), width = "3em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(7, width = "4em") %>%
  column_spec(8, width = "5em") %>%
  column_spec(9, width = "9em") %>%
  row_spec(cho_row, color = "brown") %>% 
  # row_spec(21, bold = TRUE) %>% 
  row_spec(cho_row, color = "brown") %>% 
  pack_top(., "Adult, Surgical", 1, 15) %>% 
  pack_sub(., "RCT", 1, 13) %>%
  pack_sub(., "Nonrandomized Studies of Interventions", 14, 15) %>%
  footnote(general = "RCT: randomized controlled trial; OR: odds ratio; CHO: carbohydrate; Prot: protein.",
           alphabet = c("Regurgitation at upper endoscopic intubation."),
           general_title = "",  
           footnote_as_chunk = FALSE)

table_n <- tab_inc()
```

<br/>

## *Preoperative Vomiting* 

```{r vomitTablesData, include = TRUE}
## (2021/05/07 14:20) vomitTable ----------------------------------
dichot_format <- function(x) (x/100)
dichot_vomit_or <- dichot_cho.dat %>% 
  filter(!is.na(vomit_np)) %>%
  select(refid, study, arm_tx, arm_n, vomit_n) %>% 
  group_by(refid) %>% 
  filter(n() > 1)

or_vomit <- with(or_join(dichot_vomit_or, "vomit"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2))

## (2021/05/07 14:21) vomitTable ------------------------------------------
dichot_vomit <- dichot_cho.dat %>% 
  filter(!is.na(vomit_np)) %>%
  arrange(age, desc(surg_nosurg), design, year, study) %>% 
  mutate(notes = out_dichot_notes) %>% 
  select(refid:time_outcome, vomit_np, vomit_per, vomit_n, notes) 

dichot_vomit <- left_join(dichot_vomit, or_vomit, by = "refid") %>% 
  mutate(vomit_per = round(vomit_per, 0)) %>% 
  mutate(pre_post_op = ifelse(time_outcome > 0, "postop", "preop"),
         pre_post_op = ifelse(grepl("postop vomiting", notes), "postop", pre_post_op)) %>% 
  select(refid, arm, design, age, study, arm_n, arm_tx, starts_with("hr"), pre_post_op, time_outcome, vomit_np, vomit_per, or_ci, notes)

## (updated 2021/05/08 14:34) correct 5091, 1228, 2172 odds ratios --------
# correct Hausel 2005 odds ratios
# CHO vs fasting, placebo
temp <- dichot_vomit_or %>% filter(refid == 5091)
a <- with(or_join(temp[c(1,3),], "vomit"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2)) %>% pull(or_ci)
b <- with(or_join(temp[c(2,3),], "vomit"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2)) %>% pull(or_ci)
# correct Jiang 2018 odds ratios
temp <- dichot_vomit_or %>% filter(refid == 1228)
# CHO vs fasting, placebo
c <- with(or_join(temp[c(1,3),], "vomit"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2)) %>% pull(or_ci)
d <- with(or_join(temp[c(2,3),], "vomit"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2)) %>% pull(or_ci)
# correct Singh 2015 odds ratios
temp <- dichot_vomit_or %>% filter(refid == 2172)
# CHO vs fasting, placebo
e <- with(or_join(temp[c(1,3),], "vomit"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2)) %>% pull(or_ci)
f <- with(or_join(temp[c(2,3),], "vomit"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2)) %>% pull(or_ci)

dichot_vomit <- dichot_vomit %>% 
  mutate(or_ci = ifelse(refid == 5091 & arm == 1, a, or_ci),
         or_ci = ifelse(refid == 5091 & arm == 2, b, or_ci),
         or_ci = ifelse(refid == 1228 & arm == 1, c, or_ci),
         or_ci = ifelse(refid == 1228 & arm == 2, d, or_ci),
         or_ci = ifelse(refid == 2172 & arm == 1, e, or_ci),
         or_ci = ifelse(refid == 2172 & arm == 2, f, or_ci),
         # remove Ravannni 2015 2256
         or_ci = ifelse(refid == 2256 & arm == 2, "", or_ci),
         or_ci = ifelse(or_ci == "NA (NA-NA)", "", or_ci))

rm(a, b, c, d, e, f)

## (updated 2021/05/08 14:34) formating -----------------------------------
dichot_vomit$vomit_bar <- NA
dichot_vomit$vomit_bar <- ifelse(grepl("CHO", dichot_vomit$arm_tx),
  color_bar("darksalmon", fun = dichot_format)(dichot_vomit$vomit_per),
  color_bar("lightgray", fun = dichot_format)(dichot_vomit$vomit_per))

dichot_vomit  <- dichot_vomit %>% 
mutate(vomit_bar = str_replace(vomit_bar, ">\\d+", ">&nbsp;"),
       vomit_bar = ifelse(vomit_per == 0, "", vomit_bar),
       study = ifelse(study == "Taniguchi 2011", cell_spec(study, color = "black"), study),
       study = ifelse(study == "Song 2016", cell_spec(study, color = "black"), study))

## (updated 2021/05/07 14:30) subgroups -----------------------------------
dichot_vomit_adult_preop <- dichot_vomit %>%
  filter(age == "Adult", pre_post_op == "preop") %>%
  group_by(study) %>%
  mutate(
    vomit_np = ifelse(study == "Gianotti 2018" & arm_tx == "CHO/Comp", "1 (0.3)", vomit_np),
    study = ifelse(row_number() == 1, study, NA),
    or_ci = ifelse(row_number() == 1, or_ci, NA),
    time_outcome = ifelse(row_number() == 1, time_outcome, NA)
  ) %>%
  ungroup()

dichot_vomit_adult_postop <- dichot_vomit %>%
  filter(age == "Adult", pre_post_op == "postop") %>%
  # arrange(design, study) %>%
  group_by(study) %>%
  mutate(
    or_ci = ifelse(vomit_np == "0 (0)", NA, or_ci),
    study = ifelse(row_number() == 1, study, NA),
    or_ci = ifelse(row_number() != n(), or_ci, NA),
    time_outcome = ifelse(row_number() == 1, time_outcome, NA)
  ) %>%
  ungroup()

dichot_vomit_peds <- dichot_vomit %>%
  filter(age == "Pediatric") %>% 
  mutate(year = str_extract(study, "\\d{4}")) %>% 
  arrange(desc(pre_post_op), design, year, study) %>% 
  mutate(
    study = ifelse(study == "Huang 2020", cell_spec(study, color = "black"), study),
    hr_2 = ifelse(study == "Gawecka 2014" & arm_tx == "CHO/Comp", "10 mL/kg", hr_2),
    hr_26 = ifelse(study == "Moghaddam 2014" & arm_tx == "CHO/Simp", "ad lib", hr_26),
    hr_2 = ifelse(study == "Jiang 2018" & arm == 2, "5 mL/kg", hr_2),
    hr_2 = ifelse(study == "Jiang 2018" & arm == 3, "10 mL/kg", hr_2),
    hr_2 = ifelse(study == "Jiang 2018" & arm == 4, "15 mL/kg", hr_2)
  ) %>% 
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    or_ci = ifelse(row_number() == 1, or_ci, NA),
    time_outcome = ifelse(row_number() == 1, time_outcome, NA)
  ) %>%
  ungroup()

```

<a id="choTab23"></a>

### Rates, Adults 

<br/>

<font size = 4> Table `r table_n`. Rates of preoperative vomiting among adults according to fasting, liquid and volume. </font>

```{r vomitPreopAdults, include = TRUE}
## (updated 2021/05/07 14:49) tables --------------------------------------
cho_row <- dichot_vomit_adult_preop %>%
  mutate(line = row_number()) %>%
  filter(grepl("CHO", arm_tx)) %>%
  pull(line)

# two_hours(dichot_vomit_adult_preop$refid)

dichot_vomit_adult_preop %>%
  select(study, arm_tx, arm_n, hr_gt6:hr_2, vomit_np, vomit_bar, or_ci) %>%
  kbl(
    booktabs = T, align = c("llccccrlc"), escape = FALSE,
    col.names = c("        Study", "Liquid", "N", "> 6", "6→2", "2", "N (%)", " ", "CHO vs. Comparator")
  ) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Vomiting" = 2, "OR (95% CI)"), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4, 6), width = "3em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(7, width = "5em") %>%
  column_spec(8, width = "5em") %>%
  column_spec(9, width = "10em") %>%
  row_spec(cho_row, color = "brown") %>% 
  pack_top(., "Adult, Surgical", 1, 13) %>%
  pack_sub(., "RCT", 1, 12) %>%
  pack_sub(., "Prospective Cohort", 13, 13) %>%
  # pack_sub(., "Retrospective Cohort", 42, 43) %>%
  # pack_sub(., "Case-Control", 44, 45) %>%
  # pack_sub(., "Nonrandomized Studies of Interventions", 9, 10) %>%
  # pack_top(., "Pedatric, Surgical", 46, 57) %>%
  # pack_sub(., "RCT", 46, 56) %>%
  # pack_sub(., "Prospective Cohort", 57, 57) %>%
  footnote(general = "RCT: randomized controlled trial; OR: odds ratio; CHO: carbohydrate; Comp: complex; Simp: simple; Prot: protein.",
           # alphabet = c(" "),
           general_title = "",
           footnote_as_chunk = FALSE)

table_n <- tab_inc()
```

<br/>

<a id="choTab24"></a>

### Rates, Pediatric 

<br/>

<font size = 4> Table `r table_n`. Rates of preoperative vomiting among pediatric patients according to fasting, liquid and volume. </font>

```{r vomitPeds, include = TRUE}
## (updated 2021/05/07 14:49) tables --------------------------------------
cho_row <- dichot_vomit_peds %>%  
  filter(pre_post_op == "preop") %>% 
  mutate(line = row_number()) %>%
  filter(grepl("CHO", arm_tx)) %>%
  pull(line)

# two_hours(dichot_vomit_peds$refid)

dichot_vomit_peds %>%
  filter(pre_post_op == "preop") %>% 
  select(study, arm_tx, arm_n, hr_gt6:hr_2, vomit_np) %>%
  kbl(
    booktabs = T, align = c("llccccc"), escape = FALSE,
    col.names = c("        Study", "Liquid", "N", "> 6", "6→2", "≤ 2", "N (%)")
  ) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Vomiting" = 1), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(4, width = "3em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(6, width = "5em") %>%
  column_spec(7, width = "5em") %>%
  row_spec(cho_row, color = "brown") %>% 
  pack_top(., "RCT", 1, 4) %>%
  footnote(general = "RCT: randomized controlled trial; CHO: carbohydrate; Comp: complex.",
           # alphabet = c(" "),
           general_title = "",
           footnote_as_chunk = FALSE)

table_n <- tab_inc()
```

<br/>

## *Residual Gastric Volume* 

<a id="choTab25"></a>

### Adults (surgical)  

<br/>

<font size = 4> Table `r table_n`. Residual gastric volumes measured by aspiration at induction in studies of adult surgical patients according to fasting, liquid and volume. </font>

```{r choRgv, include = FALSE}
## (updated 2021/01/19 19:20) choRgv --------------------------------------
rgv.dat <- contin_cho.dat %>%
  filter(refid %in% cho_refids) %>%
  select(refid:age, arm_n, arm_tx, hr_gt6, hr_26, hr_2, type_ingest_1, starts_with("rgv"), notes_continuous) %>%
  # select(refid:age, arm_n, arm_tx, timeingest1, amtingest1, timeingest2, amtingest2, type_ingest_1, starts_with("rgv"), notes_continuous) %>%
  rename(notes = notes_continuous) %>% 
  filter(surg_nosurg == "surgical") %>%
  filter(!is.na(rgv_us) | !is.na(rgv_imag) | !is.na(rgv_asp)) %>%
  # filter_at(vars(rgv_time_1:rgv_pval_2), any_vars(!is.na(.))) %>% # same
  # mutate(
  #   # surgical studies (note none have times 0 or negative)
  #   # hr_2 is ≤ 2; hr_26 is (2, 6] >2 to 6; hr_gt6 is >6
  #   hr_2 = 0, hr_26 = 0, hr_gt6 = 0,
  #   hr_2 = if_else(timeingest1 <= 2 & timeingest1 > 0, amtingest1, hr_2, missing = 0),
  #   hr_26 = if_else(timeingest1 > 2 & timeingest1 < 6, amtingest1, hr_26, missing = 0),
  #   hr_gt6 = if_else(timeingest1 >= 6, amtingest1, hr_gt6, missing = 0),
  #   hr_2 = if_else(hr_2 == 0 & timeingest2 <= 2 & timeingest2 > 0, amtingest2, hr_2, missing = 0),
  #   hr_26 = if_else(hr_26 == 0 & timeingest2 > 2 & timeingest2 < 6, amtingest2, hr_26, missing = 0),
  #   hr_gt6 = if_else(hr_gt6 == 0 & timeingest2 >= 6, amtingest2, hr_gt6, missing = 0),
  #   hr_gt6 = if_else(grepl("also received 300", type_ingest_1), 500, hr_gt6)
  # ) %>%
  # # Oyama PM
  # replace_with_na_at(.vars = c("hr_gt6", "hr_26", "hr_2"), condition = ~ .x == 0) %>%
  mutate(
    study = ifelse(study == "Oyama 2011" & grepl("AM", notes), "Oyama 2011 (AM)^a^", study),
    study = ifelse(study == "Oyama 2011" & grepl("PM", notes), "Oyama 2011 (PM)^a^", study),
    rgv_type_meas = case_when(
      rgv_type_meas == "aspiration" ~ "Asp",
      rgv_type_meas == "ultrasound" ~ "US",
      rgv_type_meas == "imaging" ~ "MRI"),
    rgv_iqr_low_1 = ifelse(rgv_iqr_low_1 >= 10, round_0(rgv_iqr_low_1), round_1(rgv_iqr_low_1)),
    rgv_iqr_up_1 = ifelse(rgv_iqr_up_1 >= 10, round_0(rgv_iqr_up_1), round_1(rgv_iqr_up_1)),
    rgv_iqr = str_c("(", rgv_iqr_low_1, "-", rgv_iqr_up_1, ")"),
    rgv_range = str_c("(", round_0(rgv_range_low_1), "-", round_0(rgv_range_up_1), ")"),
    rgv_range = na_if(rgv_range, "(NA-NA)"),
    rgv_mean = ifelse(!is.na(rgv_sd_1) & !is.na(rgv_mean_1), str_c(round_1d(rgv_mean_1), " (", round_1d(rgv_sd_1), ")"), round_1d(rgv_mean_1)),
    # Oyama, Ajuzieogu to no digits
    rgv_mean = ifelse(refid %in% c(3588, 1768), str_c(round_0d(rgv_mean_1), " (", round_0d(rgv_sd_1), ")"), rgv_mean),
    rgv_mean = na_if(rgv_mean, "  NA"),
    rgv_mean = str_replace(rgv_mean, "\\(NA\\)", ""),
    rgv_mean = str_replace(rgv_mean, "^\\s", ""),
    rgv_mean = str_replace(rgv_mean, "\\( ", "\\("),
    rgv_med = str_c(round(rgv_median_1, 0), rgv_iqr, sep = " "),
    rgv_bar = ifelse(!is.na(rgv_mean_1), rgv_mean_1, rgv_median_1)
  ) %>%
  arrange(age, desc(surg_nosurg), design, year, study, arm_tx) %>%
  group_by(study) %>%
  mutate(
    id = row_number(),
    study = ifelse(id > 1, NA, study),
    rgv_type_meas = ifelse(id > 1, NA, rgv_type_meas)
  ) %>%
  ungroup() %>%
  select(refid, age, design, surg_nosurg, study, arm_tx, arm_n, hr_gt6, hr_26, hr_2, rgv_type_meas, rgv_time_1, rgv_med, rgv_mean, rgv_bar, notes)

# standardize to 0 to 30
cts30_format <- function(x) (x/75)
cts1_format <- function(x) (x)

rgv_surg <- rgv.dat %>%
  mutate(rgv_bar = case_when(
    grepl("CHO", arm_tx) & age == "Adult" ~ color_bar("darksalmon", fun = cts30_format)(formattable::percent(rgv_bar)),
    !grepl("CHO", arm_tx) & age == "Adult" ~ color_bar("lightgray", fun = cts30_format)(formattable::percent(rgv_bar)),
    grepl("CHO", arm_tx) & age == "Pediatric" ~ color_bar("darksalmon", fun = cts1_format)(formattable::percent(rgv_bar)),
    !grepl("CHO", arm_tx) & age == "Pediatric" ~ color_bar("lightgray", fun = cts1_format)(formattable::percent(rgv_bar))
  )) %>%
  select(refid, study, arm_tx, arm_n, hr_gt6, hr_26, hr_2, rgv_time_1, rgv_mean, rgv_med, rgv_bar, age) %>%
  mutate(
    rgv_bar = str_replace(rgv_bar, ">.*<", ">&nbsp;<"),
    rgv_time_1 = ifelse(rgv_time_1 == 0.0, round_0d(rgv_time_1), rgv_time_1),
    hr_26 = round(hr_26, digits = 0),
    study = ifelse(study %in% c("Huang 2020", "Braga 2012", "Karimian 2020"), cell_spec(study, color = "black"), study),
    study = ifelse(study == "Jarvela 2008", "Järvelä 2008^a^", study)
  ) 

```

```{r rgvKable, echo = FALSE}
## (updated 2020/12/15 08:32) rgvKable ------------------------------------
cho_row <- rgv.dat %>%
  filter(age == "Adult") %>% 
  mutate(line = row_number()) %>%
  filter(grepl("CHO", arm_tx)) %>%
  pull(line)

rgv_surg %>%
  filter(age == "Adult") %>% 
  mutate(
    arm_tx = as.character(arm_tx),
    # arm_tx = ifelse(refid == 5803 & rgv_mean == "27.1", "CHO (Honey)", arm_tx),
    arm_tx = ifelse(refid == 5803 & arm_tx == "Clear", "Apple Juice", arm_tx)
  ) %>%
  select(!c(refid, rgv_time_1, age)) %>%
    kbl(
    booktabs = T, align = c("llcccclll"), escape = FALSE,
    col.names = c(
      "       Study", "Liquid", "N", "> 6", "6→2", "2", "M (SD)", "Med (IQR)", "M or Med"
    )
  ) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "RGV (mL)" = 3), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  # NOTE: footnote a: includes at 2.5 hours
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4,6), width = "3em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(7, width = "6em") %>%
  column_spec(8, width = "6em") %>%
  column_spec(9, width = "11em") %>%
  row_spec(cho_row, color = "brown") %>%
  pack_top(., "Adult, Surgical", 1, 38) %>%
  pack_sub(., "RCT", 1, 34) %>%
  pack_sub(., "Nonrandomized Studies of Interventions", 35, 38) %>%
  footnote(
    general = "RGV: residual gastric volumne; M: mean; SD: standard deviation; Med: median; IQR: interquartile range; CHO: carbohydrate; Simp: simple; Comp: complex; Prot: protein; RCT: randomized controlled trial.",
    alphabet = c("RGV measured at induction in all but Järvelä 2008 where obtained at 2 to 2.5 hours intraoperatively."),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

<a id="choTab26"></a>

### Pediatric (surgical)  

<br/>

<font size = 4> Table `r table_n`. Residual gastric volumes measured by aspiration at induction in studies of  pediatric surgical patients according to fasting, liquid and volume. </font>

```{r rgvPedsKable, echo = FALSE}
## (updated 2020/12/15 08:32) rgvKable ------------------------------------
cho_row <- rgv.dat %>%
  filter(age == "Pediatric") %>% 
  mutate(line = row_number()) %>%
  filter(grepl("CHO", arm_tx)) %>%
  pull(line)

# two_hours(rgv_surg$refid)

rgv_surg %>%
  filter(age == "Pediatric") %>% 
  select(!c(refid, rgv_time_1, age, rgv_med)) %>%
    kbl(
    booktabs = T, align = c("llccccll"), escape = FALSE,
    col.names = c(
      "       Study", "Liquid", "N", "> 6", "6→2", "≤ 2", "M (SD)", " "
    )
  ) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "RGV (mL/kg)" = 2), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  # NOTE: footnote a: includes at 2.5 hours
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4,6), width = "3em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(7, width = "6em") %>%
  column_spec(8, width = "11em") %>%
  row_spec(cho_row, color = "brown") %>%
  pack_top(., "Pediatric, Surgical", 1, 6) %>%
  pack_sub(., "RCT", 1, 6) %>%
  footnote(
    general = "RGV: residual gastric volumne; M: mean; SD: standard deviation; Med: median; IQR: interquartile range; CHO: carbohydrate; RCT: randomized controlled trial",
    # alphabet = c("RGV measured at induction in all but Järvelä 2008 where obtained at 2 to 2.5 hours intraoperatively."),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

<a id="choRgv27"></a>

### Nonsurgical Studies  

<br/>

<font size = 4> Table `r table_n`. Residual gastric volumes in randomized controlled trials of nonsurgical healthy volunteers according to fasting, liquid and volume. </font>
```{r rgvNonsurgTable, echo = FALSE}
## (updated 2020/12/15 10:23) rgvNonsurgTable -----------------------------
rgv_nonsurg.dat <- contin_cho.dat %>%
  filter(refid %in% cho_refids) %>%
  select(refid:age, arm_n, arm_tx, timeingest1, amtingest1, timeingest2, amtingest2, type_ingest_1, starts_with("rgv"), notes_continuous) %>%
  filter(!is.na(rgv_us) | !is.na(rgv_imag) | !is.na(rgv_asp)) %>%
  filter(surg_nosurg == "non-surgical") %>% 
  mutate(
    hr_2 = 0, hr_0 = 0, 
    hr_2 = if_else(abs(timeingest1) == 2, amtingest1, hr_2, missing = 0), # crossover abs
    hr_0 = if_else(timeingest1 == 0, amtingest1, hr_0, missing = 0), # crossover
    hr_2 = if_else(hr_2 == 0 & abs(timeingest2) == 2, amtingest2, hr_2, missing = 0), # crossover abs
    hr_0 = if_else(hr_0 == 0 & timeingest2 == 0, amtingest2, hr_0, missing = 0), # crossover
    arm_tx = droplevels(arm_tx)) %>%
  replace_with_na_at(.vars = c("hr_2", "hr_0"), condition = ~ .x == 0) %>%
  mutate(rgv_type_meas = case_when(
      rgv_type_meas == "aspiration" ~ "Asp",
      rgv_type_meas == "ultrasound" ~ "US",
      rgv_type_meas == "imaging" ~ "MRI"))

## (updated 2020/12/15 10:24) rgv_no_table --------------------------------
rgv_no_table <- rgv_nonsurg.dat %>%
  select(
    refid, arm, study, year, age, arm_n, arm_tx, design, surg_nosurg, arm_tx, timeingest1, amtingest1,
    timeingest2, amtingest2, everything()) %>%
  arrange(age, desc(surg_nosurg), design, year, study, arm_tx) %>% 
  select(!type_ingest_1) %>%
  rename(time_1_rgv = rgv_time_1, time_2_rgv = rgv_time_2) %>%
  pivot_wider(names_from = time_1_rgv, values_from = rgv_mean_1:rgv_iqr_up_1) %>%
  pivot_wider(names_from = time_2_rgv, values_from = rgv_mean_2:rgv_iqr_up_2) %>%
  select(!ends_with("NA")) %>%
  rename_with(~ gsub("_95_", "_ci_", .x, fixed = TRUE)) %>%
  rename_with(~ gsub("rgv_", "", .x, fixed = TRUE)) %>%
  # reorder to facilitate select final digit is hour of measurement variable_1/2_hr
  select(refid:surg_nosurg, type_meas, hr_2, hr_0, ends_with("_1"), ends_with("_2"), ends_with("_3")) %>%
  # remove_empty("cols") %>% 
  # select(!median_1_2) %>%
  mutate(
    mean_1_2 = coalesce(mean_1_2, mean_2_2),
    sd_1_2 = coalesce(sd_1_2, sd_2_2),
    ci_low_1_2 = coalesce(ci_low_1_2, ci_low_2_2),
    ci_up_1_2 = coalesce(ci_up_1_2, ci_up_2_2),
    iqr_low_1_2 = coalesce(iqr_low_1_2, iqr_low_2_2),
    iqr_up_1_2 = coalesce(iqr_up_1_2, iqr_up_2_2),
    range_low_1_2 = coalesce(range_low_1_2, range_low_2_2),
    range_up_1_2 = coalesce(range_up_1_2, range_up_2_2),
    median_1_2 = coalesce(median_1_2, median_2_2)) %>%
  # rename(median_1_2 = median_2_2) %>% # no median_1_2 values
  # removed coalesced columns
  select(!ends_with("_2_2")) %>% 
  # select(!ends_with("_2_3")) %>% 
  # select(!(mean_2_2:ci_up_2_2)) %>%
  # select(!(range_low_2_2:iqr_up_2_2)) %>%
  janitor::remove_empty(which = "cols") %>%
  # rename to remove data point 1, 2, 3
  rename_with(~ gsub("_1_", "_", .x, fixed = TRUE)) %>%
  rename_with(~ gsub("_2_", "_", .x, fixed = TRUE)) %>%
  # rename_with(~ gsub("_3_", "_", .x, fixed = TRUE)) %>%
  rename_with(~ gsub("mean_", "m_", .x, fixed = TRUE)) %>%
  rename_with(~ gsub("median_", "med_", .x, fixed = TRUE)) %>%
  # calculate sd if missing and ci reported
  mutate(
    sd_1 = ifelse(is.na(sd_1) & !is.na(ci_low_1), sd_confint(ci_low_1, ci_up_1), sd_1),
    sd_2 = ifelse(is.na(sd_2) & !is.na(ci_low_2), sd_confint(ci_low_2, ci_up_2), sd_2)) %>%
  # keep range and iqr but display only iqr
  select(refid, arm, study, year, age, design, arm_tx, arm_n, type_meas, hr_2, hr_0, m_1, sd_1, m_2, sd_2, m_3, sd_3, med_1, iqr_low_1, iqr_up_1, range_low_1, range_up_1, med_2, iqr_low_2, iqr_up_2, range_low_2, range_up_2, ci_low_1, ci_low_2, ci_up_1, ci_up_2)
```

```{r rgvNonsurgKable, echo = FALSE, include = TRUE, eval = TRUE}
## (updated 2020/12/15 10:24) rgvNonsurgKable -----------------------------
rgv_no_table_kbl <- rgv_no_table %>%
  mutate(
    arm_tx = as.character(arm_tx),
    arm_tx = ifelse(refid == 1315 & arm_tx == "Clear", "Apple juice", arm_tx),
    msd1 = str_c(round_1(m_1), " (", round_1(sd_1), ")"),
    msd2 = str_c(round_1(m_2), " (", round_1(sd_2), ")"),
    # digits Du2017
    msd1 = ifelse(refid == 1315, str_c(round_2(m_1), " (", round_2(sd_1), ")"), msd1),
    msd2 = ifelse(refid == 1315, str_c(round_2(m_2), " (", round_2(sd_2), ")"), msd2),
    msd3 = str_c(round_1(m_3), " (", round_1(sd_3), ")"),
    med1 = str_c(round(med_1, 0), " (", round(iqr_low_1, 0), "-", round(iqr_up_1, 0), ")"),
    # med2 = str_c(round(med_2, 0), " (", round(iqr_low_2, 0), "-", round(iqr_up_2, 0), ")"),
    # Nakamura med and add range for hr 2
    msd1 = ifelse(refid %in% c(2703), paste0(round_0(med_1), " (", round_0(iqr_low_1), ", ", round_0(iqr_up_1), ")"), msd1),
    msd1 = ifelse(refid %in% c(499), paste0(round_1(med_1), " (", round_1(iqr_low_1), ", ", round_1(iqr_up_1), ")"), msd1),
    msd2 = ifelse(refid == 2703, paste0(round_0(med_2), " [", range_low_2, ", ", range_up_2, "]"), msd2),
    msd2 = ifelse(refid %in% c(6280, 7600), paste0(round_0(med_2), " (", round_0(iqr_low_2), ", ", round_0(iqr_up_2), ")"), msd2),
    msd2 = ifelse(refid %in% c(499), paste0(round_1(med_2), " (", round_1(iqr_low_2), ", ", round_1(iqr_up_2), ")"), msd2),
    msd1 = na_if(msd1, "NA (NA)"),
    msd2 = na_if(msd2, "NA (NA)"),
    msd1 = na_if(msd1, "NA"),
    msd2 = ifelse(is.na(msd2), "", msd2),
    msd3 = na_if(msd3, "NA (NA)"),
    # Zhang2020 convert log to ml and footnote 95% CI
    msd1 = ifelse(refid == 81, paste0(round_1(exp(m_1)), " [", round_1(exp(ci_low_1)), ", ", round_1(exp(ci_up_1)), "]"), msd1),
    msd2 = ifelse(refid == 81, paste0(round_1(exp(m_2)), " [", round_1(exp(ci_low_2)), ", ", round_1(exp(ci_up_2)), "]"), msd2),
  ) %>%
  mutate(
    add_foot(., study, "Du 2017", "b"),
    msd1 = replace_na(msd1, ""),
    msd1 = cell_spec(msd1, underline = (ifelse(refid %in% c(499, 2703), TRUE, FALSE))),
    msd2 = cell_spec(msd2, underline = (ifelse(refid %in% c(499, 2703), TRUE, FALSE)))
  ) %>%
  group_by(study) %>%
  mutate(
    study = cell_spec(study, color = "black"),
    study = ifelse(row_number() == 1, study, NA),
    msd1 = ifelse(grepl("Nascimento 2019", study), paste0(msd1, "^a^"), msd1),
    msd2 = ifelse(grepl("Nascimento 2019", study), paste0(msd2, "^a^"), msd2),
    type_meas = cell_spec(type_meas, color = "black"),
    type_meas = ifelse(row_number() == 1, type_meas, NA),
    arm_tx = ifelse(arm_tx == "Milk", "Coffee/Milk", arm_tx),
    msd1 = ifelse(grepl("Jian", study), paste0(msd1, "^c^"), msd1),
    msd2 = ifelse(grepl("Jian", study), paste0(msd2, "^c^"), msd2),
    arm_tx = ifelse(grepl("82.3 \\(5", msd1), "CHO/Simp obese", arm_tx),
    arm_tx = ifelse(grepl("67.1 \\(42", msd1), "CHO/Simp nonobese", arm_tx),
  ) %>%
  ungroup() %>%
  select(study, arm_tx, arm_n, hr_2, hr_0, type_meas, msd1:msd3) %>%
  add_row()

## (updated 2021/06/01 15:09) rgv_no_table_kbl ----------------------------
cho_row <- rgv_no_table_kbl %>% 
  mutate(line = row_number()) %>% 
  filter(grepl("CHO", arm_tx)) %>% 
  pull(line)

rgv_no_table_kbl %>%
  kbl(
    booktabs = T, align = c("llrccclll"), escape = FALSE,
    col.names = c("        Study", "Liquid", "N", "2 hr", "0 hr", "Measure", "       1 hr", "       2 hr", "       3 hr")
  ) %>%
  add_header_above(c(" " = 3, "Liquid Volume (mL)" = 2, "RGV" = 1, "Mean RGV mL (SD) [95% CI] unless noted" = 3), line = TRUE) %>%
  add_header_above(c(" " = 6, "Median RGV (IQR) [Range] (mL)" = 3), underline = TRUE, line = TRUE) %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4:5), width = "5em") %>%
  column_spec(6, width = "6em") %>%
  column_spec(7, width = "8em") %>%
  column_spec(8, width = "8em") %>%
  column_spec(9, width = "10em") %>%
  pack_top(., "Adult, Nonsurgical", 1, 26) %>%
  pack_sub(., "RCT", 1, 5) %>%
  result_pack("CHO/Comp cleared more rapidly than simple or milk", 4, padding = 65) %>% 
  result_pack("No detected difference at 1 or 2 hours", 6, padding = 65) %>% 
  pack_sub(., "Crossover", 6, 24) %>%
  result_pack("Lower without protein at 2 hours", 9, padding = 65) %>% 
  result_pack("No detected difference at 2 or 3 hours", 11, padding = 65) %>% 
  result_pack("Higher RGV with CHO/Simp/Prot at 1 and 2 hours", 13, padding = 65) %>% 
  result_pack("No detected difference at 2 hours", 16, padding = 65) %>% 
  result_pack("No detected difference at 2 or 3 hours", 18, padding = 65) %>% 
  result_pack("No detected difference at 1 or 2 hours", 20, padding = 65) %>% 
  result_pack("Lower RGV with smaller liquid volume at 1 hour", 23, padding = 65) %>% 
  result_pack("Higher RGV with CHO/Comp/Prot at 2 hours", 25, padding = 65) %>% 
  pack_sub(., "Nonrandomized Studies of Interventions", 25, 26) %>%
  result_pack("No detected difference at 1 or 2 hours", 27, padding = 65) %>% 
  pack_top(., "Pediatric, Nonsurgical", 27, 32) %>%
  pack_sub(., "RCT", 27, 29) %>%
  result_pack("Proportion of Baseline Gastric Antral CSA", 27, padding = 63, color = "black", italic = FALSE) %>% 
  result_pack("No detected difference at 2 hours", 32, padding = 65) %>% 
  result_pack("No detected difference return to baseline at 2 hours", 30, padding = 65) %>% 
  pack_sub(., "Crossover", 30, 32) %>%
  row_spec(cho_row, color = "brown") %>%

  # pack_rows("2-hr MD 39.1 (95% CI, -5.8 to 84.0)", 3, 3, label_row_css = "padding-left:64%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>%
  # pack_rows("Proportion of Baseline Gastric Antral CSA", 14, 16, label_row_css = "padding-left:63%", bold = FALSE) %>%
  # pack_rows("Prot/CHO vs Juice, MD 0.07 (95% CI, 0.04 to 0.11)", 17, 17, label_row_css = "padding-left:64%; border-bottom: 0px solid;", underline = FALSE, bold = FALSE, color = "gray", italic = TRUE) %>%
  footnote(
    general = "RGV: residual gastric volumne; IQR: interquartile range; M: mean; SD: standard deviation; CHO: carbohydrate; Comp: complex; Simp: simple; Prot: protein; MRI: magnetic resonance imaging; US: ultrasound; CSA: cross-sectional area.",
    general_title = "",
    alphabet = c(
      "mL/kg",
      "Authors reported similar clearances of all 3 liquids in terminal emptying phase (eg, 120 to 180 minutes).",
      "Gastric cross-sectional area in mm^2^."
    ),
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

<a id="choFig9"></a>

### Pooled (adult RCTs)  

<br/>

<font size = 4> Figure `r figure_n`. Pooled residual gastric volume from randomized trials comparing carbohydrate drinks (excludes protein containing) with fasting in adult surgical patients. </font>

```{r rgvChoMeta, include = TRUE, fig.width = 10, fig.height = 5.2, fig.align = "center"}
## (updated 2021/01/22 15:19) rgvChoMeta ------------------- ---------------
rgv_meta.dat <- contin_cho.dat %>%
  arrange(design, year, study) %>%
  filter(refid %in% cho_refids, surg_nosurg == "surgical") %>%
  filter(arm_tx == "Fasting" | grepl("CHO", arm_tx)) %>%
  filter(!is.na(rgv_us) | !is.na(rgv_imag) | !is.na(rgv_asp)) %>%
  filter(design == "rct", age == "Adult") %>%
  filter(refid != 69) %>%
  # exclude Karimian
  select(refid, study, year, design, arm_n, arm_tx, rgv_mean_1, rgv_sd_1, rgv_median_1:rgv_iqr_up_1) %>%
  # Yilmaz 2013 estimate sd smd.bwgrpS(21.85, 19.15, 20, 20, .77),
  # Yildiz 2013 3154 smd.bwgrpS(18.1, 9.3, 30, 30, .05)
  # Wang 2019 smd.bwgrpS(24.86, 29.63, 37, 36, .238)
  mutate(
    rgv_sd_1 = ifelse(refid == 2985, 29.0, rgv_sd_1),
    rgv_sd_1 = ifelse(refid == 3154, 17.0, rgv_sd_1)
  ) %>%
  arrange(refid, arm_tx) %>%
  filter(!grepl("Prot", arm_tx), !study %in% c("Gianotti 2018", "deANascimento 2014", "Braga 2012"))

rgv_meta.dat <- calc_mn_sd(
  "arm_n",
  "rgv_mean_1",
  "rgv_sd_1",
  "rgv_median_1",
  "rgv_iqr_low_1",
  "rgv_iqr_up_1",
  "rgv_range_low_1",
  "rgv_range_up_1",
  "study",
  "arm_tx",
  refid = "refid",
  log_trans = TRUE,
  data = rgv_meta.dat
)

rgv_meta.dat <- rgv_meta.dat %>%
  mutate(arm_tx = ifelse(grepl("CHO", arm_tx), "CHO", "Fasting")) %>%
  pivot_wider(
    id_cols = c("study"),
    names_from = c("arm_tx"),
    values_from = c("n", "mean", "sd", "mean_log", "sd_log")
  )

rgv_meta <- metacont(
  n.e = n_CHO,
  mean.e = mean_CHO,
  sd.e = sd_CHO,
  n.c = n_Fasting,
  mean.c = mean_Fasting,
  sd.c = sd_Fasting,
  method.tau = "REML", 
  hakn = TRUE,
  prediction = TRUE,
  data = rgv_meta.dat,
  studlab = study
)

forest(rgv_meta,
  comb.fixed = FALSE,
  lab.e = "CHO     ",
  lab.c = "Fasting     ",
  digits = 1,
  digits.sd = 1,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  print.byvar = FALSE,
  overall = TRUE,
  fs.xlab = 11,
  rightcols = c("effect", "ci"),
  rightlabs = c("MD", "95% CI    "),
  xlab = "RGV (mL)\n Favors CHO           Favors Fasting"
)

figure_n <- fig_inc()

## (updated 2021/05/10 11:01) log scale -----------------------------------
temp <- metacont(
  n.e = n_CHO,
  mean.e = mean_log_CHO,
  sd.e = sd_log_CHO,
  n.c = n_Fasting,
  mean.c = mean_log_Fasting,
  sd.c = sd_log_Fasting,
  method.tau = "REML", 
  hakn = TRUE,
  prediction = TRUE,
  data = rgv_meta.dat,
  studlab = study
)

# transform to raw using mean and se
# mean_log_raw <- function(log_mean, log_sd){
#   (exp(log_mean + log_sd^2/2))
# }
# sd_log_raw<- function(log_mean, log_sd){
#   sqrt((exp(log_sd^2) - 1) * exp(2 * log_mean + log_sd^2))
# }
# mean_raw <- with(temp, mean_log_raw(TE.random, seTE.random))
# sd_raw <- with(temp, sd_log_raw(TE.random, seTE.random))
# approx 95% ci using 1.96
# mean_raw + c(-1.96, 1.96) * sd_raw

```

Mean differences estimated from means, standard deviations, medians, interquartile and overall ranges.
Owing to skewed distributions of RGV, conducted sensitivity analysis on a log scale with consistent results. 

<a id="choRgvFig10"></a>

<br/><br/>

<font size = 4> Figure `r figure_n`. Pooled residual gastric volume from randomized trials comparing carbohydrate drinks (excludes protein-containing drinks) with water or clear liquids in adult surgical patients. </font>

```{r rgvChoMetaClear, include = TRUE, eval = TRUE, fig.width = 10, fig.height = 3.5, fig.align = "center"}
## (updated 2021/01/22 15:19) rgvChoMeta ----------------------------------
rgv_meta.dat <- contin_cho.dat %>%
  arrange(design, year, study) %>%
  filter(refid %in% cho_refids, surg_nosurg == "surgical") %>%
  filter(arm_tx %in% c("Water", "Clear") | grepl("CHO", arm_tx)) %>%
  filter(!is.na(rgv_us) | !is.na(rgv_imag) | !is.na(rgv_asp)) %>%
  filter(design == "rct", age == "Adult") %>%
  group_by(refid) %>%
  filter(n() > 1) %>%
  # filter(row_number() < 3) %>%
  ungroup() %>%
  select(refid, study, year, design, arm_n, arm_tx, rgv_mean_1, rgv_sd_1, rgv_median_1:rgv_iqr_up_1) %>%
  # exclude Braga, Karimian, DNascimento 2012a lacking water/clear comparator
  filter(!refid %in% c(3481, 69, 3282)) %>% # 5803, 3823, 
  arrange(refid, year) %>%
  select(-design)

## (updated 2021/05/10 11:28) data set for meta ---------------------------
rgv_meta.dat <- calc_mn_sd(
  "arm_n",
  "rgv_mean_1",
  "rgv_sd_1",
  "rgv_median_1",
  "rgv_iqr_low_1",
  "rgv_iqr_up_1",
  "rgv_range_low_1",
  "rgv_range_up_1",
  "study",
  "arm_tx",
  refid = "refid",
  log_trans = TRUE,
  data = rgv_meta.dat
)

# combine DNascimento 2011 CHO arms, plain and log; not when excluding protein arms
nascimento <- c(combine_contin(12, 14, 12.6, 4.9, 19.57038, 4.576153),
            combine_contin(12, 14, 1.906072, 1.275682, 1.1203792, 0.7919006)[2:3])
rgv_meta.dat[6, c(3:7)] <- nascimento
rgv_meta.dat <- as_tibble(rgv_meta.dat[-c(7),])

rgv_meta.dat <- rgv_meta.dat %>%
  mutate(arm_tx = ifelse(grepl("CHO", arm_tx), "CHO", "water_clear")) %>%
  pivot_wider(
    id_cols = c("study"),
    names_from = c("arm_tx"),
    values_from = c("n", "mean", "sd", "mean_log", "sd_log")
)

rgv_meta <- metacont(
  n.e = n_CHO,
  mean.e = mean_CHO,
  sd.e = sd_CHO,
  n.c = n_water_clear,
  mean.c = mean_water_clear,
  sd.c = sd_water_clear,
  method.tau = "REML", 
  hakn = FALSE,
  prediction = FALSE,
  data = rgv_meta.dat,
  studlab = study
)

forest(rgv_meta,
  comb.fixed = FALSE,
  lab.e = "CHO     ",
  lab.c = "Water/Clear  ",
  digits = 1,
  digits.sd = 1,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  print.byvar = FALSE,
  overall = TRUE,
  fs.xlab = 11,
  rightcols = c("effect", "ci"),
  rightlabs = c("MD", "95% CI   "),
  xlab = "RGV (mL)\n Favors CHO            Favors Water/Clear"
)

figure_n <- fig_inc()

## (updated 2021/05/10 11:01) log scale -----------------------------------
temp <- metacont(
  n.e = n_CHO,
  mean.e = mean_log_CHO,
  sd.e = sd_log_CHO,
  n.c = n_water_clear,
  mean.c = mean_log_water_clear,
  sd.c = sd_log_water_clear,
  method.tau = "REML", 
  hakn = TRUE,
  prediction = TRUE,
  data = rgv_meta.dat,
  studlab = study
)

# forest(temp)
# forest(rgv_meta)

```

Mean differences estimated from means, standard deviations, medians, interquartile and overall ranges.
Combined similar arms for Dock-Nascimento 2011.
Owing to skewed distributions of RGV, conducted sensitivity analysis on a log scale with consistent results. 

<br/>

<a id="choTab28"></a>

## *Gastric pH* 

<br/>

<font size = 4> Table `r table_n`. Gastric pH in randomized trials according to fasting, liquid and volume. </font>

```{r pHcho, include = TRUE}
## (updated 2021/05/10 18:33) ph data -------------------------------------
ph.dat <- contin_cho.dat %>%
  filter(refid %in% cho_refids) %>%
  select(refid:age, arm_n, arm_tx, hr_gt6, hr_26, hr_2, starts_with("ph"), notes_continuous) %>%
  rename(notes = notes_continuous) %>% 
  # filter(surg_nosurg == "surgical") %>%
  filter_at(vars(starts_with("ph")), any_vars(!is.na(.))) %>% 
  # delete Yilmaz, pH values outside range
  filter(study != "Yilmaz 2013") %>% 
  mutate(
    ph_mean = paste0(round_2(ph_mean_1), " (", round_2(ph_sd_1), ")"),
    ph_mean = str_replace(ph_mean, "\\( NA\\)", ""),
    ph_med = paste0(round_2(ph_median_1), " (", round_2(ph_iqr_low_1), "-", round_2(ph_iqr_up_1), ")"),
    ph_med = str_replace(ph_med, "\\( NA.*|NA.*", ""),
    arm_n = ifelse(study == "Spahn 2009" & arm_n == 20, 5, arm_n),
    arm_n = ifelse(study == "Spahn 2009" & arm_n == 27, 7, arm_n),
  ) %>% 
  arrange(age, design, year, study, arm_tx) %>% 
  # add_foot(study, "Yilmaz 2013", "a") %>% 
  add_foot(study, "Joshi 2020", "a") %>% 
  add_foot(study, "Spahn 2009", "b") 

cho_row <- ph.dat %>%
  # filter(age == "Adult") %>% 
  mutate(line = row_number()) %>%
  filter(grepl("CHO", arm_tx)) %>%
  pull(line)

# two_hours(ph.dat$refid)
  
ph.dat %>%
  # filter(age == "Adult") %>%
  group_by(study) %>%
  mutate(
    id = row_number(),
    study = ifelse(id > 1, NA, study)
  ) %>%
  ungroup() %>%
  add_row() %>%
  select(study, arm_tx, arm_n, hr_gt6:hr_2, ph_mean, ph_med, -id) %>%
  mutate(
    arm_tx = as.character(arm_tx),
  ) %>%
  kbl(
    booktabs = T, align = c("llcccclc"), escape = FALSE,
    col.names = c(
      "        Study", "Liquid", "N", "> 6", "6→2", "2", "     M (SD)", "     Med (IQR)"
    )
  ) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "pH" = 2), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4, 6), width = "3em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(7, width = "8em") %>%
  column_spec(8, width = "8em") %>%
  row_spec(cho_row, color = "brown") %>%
  pack_top(., "Adult, Surgical", 1, 13) %>%
  pack_sub(., "RCT", 1, 11) %>%
  pack_sub(., "Nonrandomized Studies of Interventions", 12, 13) %>%
  pack_top(., "Pediatric, Surgical", 14, 17) %>%
  pack_sub(., "RCT", 14, 17) %>%
  result_pack("Pooled fixed-effects MD for 2 studies, 0.48 (95% CI, 0.31-0.64), *I^2^* = 98% ", 18, padding = 24) %>%
  footnote(
    general = "RGV: residual gastric volumne; M: mean; SD: standard deviation; Med: median; IQR: interquartile range; CHO: carbohydrate; Simp: simple; RCT: randomized controlled trial.",
    alphabet = c( # "Used urine pH test scripts.",  from Yilmaz
      "During the intraoperative period",
      "Reported pH for 5 of 20 in the CHO/Simp arm and 7 of 27 receiving water."
    ),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

<a id="choFig11"></a>

### Pooled (adult RCTs) 

<br/>

<font size = 4> Figure `r figure_n`. Pooled gastric pH from randomized trials comparing carbohydrate drinks with fasting in adult surgical patients. </font>

```{r metaPh, include = TRUE, fig.width = 10, fig.height = 3.2, fig.align = "center"}
ph_meta.dat <- ph.dat %>% 
  filter(age == "Adult") %>% 
  arrange(design, year, study) %>%
  filter(arm_tx == "Fasting" | grepl("CHO", arm_tx)) %>%
  mutate(arm_tx = ifelse(grepl("CHO", arm_tx), "cho", "fasting")) %>% 
  group_by(refid) %>% 
  filter(n() > 1, refid != 2985, refid != 7990) %>% # Joshi 2020 ph over intraop period
  ungroup() %>% 
  select(study, arm_tx, arm_n, ph_mean_1, ph_sd_1, ph_median_1, ph_iqr_low_1, ph_iqr_up_1) %>% 
  rename_with(~str_replace(., "_1", "")) %>% 
  rename_with(~str_replace(., "ph_", "")) %>% 
  pivot_wider(id_cols = "study", names_from = "arm_tx", values_from = c("arm_n", "mean", "sd", "median", "iqr_low", "iqr_up"))

ph_meta <- metacont(
  data = ph_meta.dat,
  n.e = arm_n_cho,
  n.c = arm_n_fasting,
  mean.e = mean_cho,
  mean.c = mean_fasting,
  sd.e = sd_cho,
  sd.c = sd_fasting,
  median.e = median_cho,
  median.c = median_fasting,
  q1.e = iqr_low_cho,
  q1.c = iqr_low_fasting,
  q3.e = iqr_up_cho,
  q3.c = iqr_up_fasting,
  method.tau = "REML",
  hakn = TRUE,
  studlab = study
)
  
forest(ph_meta,
  comb.fixed = FALSE,
  lab.e = "CHO     ",
  lab.c = "Fasting     ",
  digits = 2,
  digits.sd = 1,
  digits.mean = 1,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  print.byvar = FALSE,
  overall = TRUE,
  fs.xlab = 11,
  rightcols = c("effect", "ci"),
  rightlabs = c("MD", "95% CI   "),
  xlab = "pH\n Favors Fasting           Favors CHO"
)

figure_n <- fig_inc()

```

<br/>

## *Complications* 

<a id="choTab29"></a>

### Adults  

<br/>

<font size = 4> Table `r table_n`. Reported complications according to procedure type, fasting, liquid and volume in adults (unreported in pediatric studies). </font>

```{r complicateTableOr, include = TRUE}
## (updated 2021/01/13 08:52) complicateTableOr --------------------------------
dichot_format <- function(x) (x/100)
dichot_complicate_or <- dichot_cho.dat %>% 
  filter(!is.na(complicate_np)) %>%
  select(refid, study, arm_tx, arm_n, complicate_n) %>% 
  group_by(refid) %>% 
  filter(n() > 1)

or_complicate <- with(or_join(dichot_complicate_or, "complicate"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2))

```

```{r surgCategories}
## (updated 2021/05/11 08:57) surgery categories --------------------------
surg_cat <- study_char_cho.dat %>%
  select(refid, study, year, age, surg_nosurg, design, surg_type) %>%
  arrange(age, desc(surg_nosurg), design, year, study) %>%
  mutate(surg = case_when(
      str_detect(surg_type, "[Gg]yn|[Hh]ysterectomy") ~ "Gyn",
      str_detect(surg_type, "craniotomy") ~ "Neurosurgical",
      str_detect(surg_type, "maxillofacial") ~ "Maxillofacial",
      str_detect(surg_type, "[Hh]ernia|herniorrhaphy") ~ "Herniorrhaphy",
      str_detect(surg_type, "prostatectomy") ~ "Prostatectomy",
      str_detect(surg_type, "ariety") ~ "Various",
      str_detect(surg_type, "various|Hirschsprung's") ~ "Various",
      str_detect(surg_type, "CABG|[Cc]oronary artery bypass surgery") ~ "CABG",
      str_detect(surg_type, "[Cc]olorectal|[Bb]owel|colon resection") ~ "Colorectal",
      str_detect(surg_type, "[Tt]hyroid|hip joint") ~ "Thyroid",
      str_detect(surg_type, "[Oo]rthopedic|discectomy") ~ "Orthopedic",
      str_detect(surg_type, "total hip or total knee replacement|[Tt]otal hip|[Tt]otal knee|Hip joint|hip replacement") ~ "TKA/THA",
      str_detect(surg_type, "cholecystectomy") ~ "Cholecystectomy",
      str_detect(surg_type, "pancreaticoduodenectomy") ~ "Whipple",
      str_detect(surg_type, "[Gg]ast|Bowel") ~ "Other GI",
      str_detect(surg_type, "not appli") ~ "None (healthy)",
      str_detect(surg_type, "oral") ~ "Oral",
      str_detect(surg_type, "minor") ~ "Misc minor",
      str_detect(surg_type, "None") ~ "None (healthy)",
      str_detect(surg_type, "abdomin") ~ "Other GI",
      str_detect(surg_type, "[Cc]esarean|labor") ~ "Cesarean/vaginal birth",
      str_detect(surg_type, "thoracotomy") ~ "Thoracic",
      str_detect(surg_type, "healthy") ~ "None (healthy)",
      str_detect(surg_type, "Elective") ~ "Elective",
      str_detect(surg_type, "adenotonsillectomy") ~ "Adenotonsillectomy",
      str_detect(surg_type, "[Bb]reast") ~ "Breast",
      str_detect(surg_type, "Endso|endoscopic|colonoscopy") ~ "Endoscopic")) %>% 
  select(refid, surg)

```

```{r complicateTable, include = TRUE}
## (updated 2021/01/12 18:04) complicateTable ---------------------------------
dichot_complicate <- dichot_cho.dat %>% 
  filter(!is.na(complicate_np), age == "Adult") %>%
  arrange(design, year, study) %>% 
  select(refid:time_outcome, complicate_np, complicate_per, complicate_n) %>% 
  filter(!study %in% c("Marquini 2020b", "Marquini 2020c")) %>% # all the same study
  mutate(study = ifelse(study == "Marquini 2020a", "Marquini 2020", study),
  # fix Breuer arms NOTE: not ideal but so doesn't break other code
  arm = ifelse(refid == 4766 & arm_n == 44, 1, arm),
  arm = ifelse(refid == 4766 & arm_n == 60, 2, arm),
  arm = ifelse(refid == 4766 & arm_n == 56, 3, arm))

dichot_complicate <- left_join(dichot_complicate, surg_cat, by = "refid") %>% 
  arrange(age, design, surg, year, study)

dichot_complicate <- left_join(dichot_complicate, or_complicate, by = "refid") %>% 
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    or_ci = ifelse(row_number() == 1, or_ci, NA),
    surg_cat = ifelse(row_number() == 1, surg_cat, NA),
    time_outcome = ifelse(row_number() == 1, time_outcome, NA)) %>%
  ungroup() %>% 
  mutate(complicate_per = round(complicate_per, 0)) %>% 
  select(refid, arm, surg, design, age, study, arm_n, arm_tx, starts_with("hr"), time_outcome, complicate_np, complicate_per, or_ci)

# correct odds ratios for multiarm studies
# Breuer 2006
temp <- dichot_complicate_or %>% filter(refid == 4766)
a <- with(or_join(temp[c(1,3),], "complicate"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2)) %>% pull(or_ci)
b <- with(or_join(temp[c(2,3),], "complicate"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2)) %>% pull(or_ci)
# DNascimento 2012a 3282
# CHO vs fasting, placebo
temp <- dichot_complicate_or %>% filter(refid == 3282)
c <- with(or_join(temp[c(1,3),], "complicate"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2)) %>% pull(or_ci)
d <- with(or_join(temp[c(2,3),], "complicate"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2)) %>% pull(or_ci)
# Ljunggren 2012 3371
# CHO vs fasting, placebo
temp <- dichot_complicate_or %>% filter(refid == 3371)
e <- with(or_join(temp[c(1,3),], "complicate"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2)) %>% pull(or_ci)
f <- with(or_join(temp[c(2,3),], "complicate"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2)) %>% pull(or_ci)
# Talutis 2020 147
temp <- dichot_complicate_or %>% filter(refid == 147)
g <- with(or_join(temp[c(1,3),], "complicate"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2)) %>% pull(or_ci)
h <- with(or_join(temp[c(2,3),], "complicate"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2)) %>% pull(or_ci)

dichot_complicate <- dichot_complicate %>%
  mutate(
    or_ci = ifelse(refid == 4766 & arm == 1, a, or_ci),
    or_ci = ifelse(refid == 4766 & arm == 2, b, or_ci),
    or_ci = ifelse(refid == 3282 & arm == 1, c, or_ci),
    or_ci = ifelse(refid == 3282 & arm == 2, d, or_ci),
    or_ci = ifelse(refid == 3371 & arm == 1, e, or_ci),
    or_ci = ifelse(refid == 3371 & arm == 2, f, or_ci),
    or_ci = ifelse(refid == 147 & arm == 1, g, or_ci),
    or_ci = ifelse(refid == 147 & arm == 2, h, or_ci),
    or_ci = ifelse(or_ci == "NA (NA-NA)", "", or_ci),
    or_ci = ifelse(grepl("NA", or_ci), "", or_ci)
  )

rm(a, b, c, d, e, f, g, h)

cho_row <- dichot_complicate %>%
  mutate(line = row_number()) %>%
  filter(grepl("CHO", arm_tx)) %>%
  pull(line)

dichot_complicate$complicate_bar <- NA
dichot_complicate$complicate_bar <- ifelse(grepl("CHO", dichot_complicate$arm_tx),
  color_bar("darksalmon", fun = dichot_format)(dichot_complicate$complicate_per),
  color_bar("lightgray", fun = dichot_format)(dichot_complicate$complicate_per))

dichot_complicate <- dichot_complicate %>% 
mutate(
  complicate_bar = str_replace(complicate_bar, ">0", ">"),
  complicate_bar = str_replace(complicate_bar, ">[0-9]{1,}", ">&nbsp;"),
  study = ifelse(study == "Alimena 2020", cell_spec(study, color = "black"), study),
  study = ifelse(study %in% c("Song 2016", "Karimian 2020"), cell_spec(study, color = "black"), study),
  or_ci = ifelse(refid == 147 & arm_n == 80,  cell_spec(or_ci, color = "black"), or_ci),
  or_ci = ifelse(or_ci == "0.55 (0.10-2.89)",  cell_spec(or_ci, color = "black"), or_ci))

# two_hours(dichot_complicate$refid)
  
dichot_complicate %>% 
  select(!c(refid, arm, design, age, complicate_per)) %>% 
  select(study, arm_tx, arm_n, hr_gt6:hr_2, complicate_np, complicate_bar, or_ci) %>% 
  kbl(booktabs = T, align =  c("llccccrlc"), escape = FALSE,
    col.names = c("        Study", "Liquid", "N", "> 6", "6 → 2", "2", "N (%)", " ", "CHO vs. Comparator")) %>% 
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Complications" = 2, "OR (95% CI)"), line = TRUE, bold = TRUE) %>% 
  row_spec(0, bold = TRUE) %>% 
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4, 6), width = "3em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(7, width = "5em") %>%
  column_spec(8, width = "5em") %>%
  column_spec(9, width = "8em") %>%
  row_spec(cho_row, color = "brown") %>%
  pack_top(., "Retrospective Cohort", 70, 72) %>%
  pack_top(., "Prospective Cohort", 69, 69) %>%
  pack_top(., "Nonrandomized Studies of Interventions", 65, 68) %>%
  pack_top(., "Case-Control", 73, 74) %>%
  pack_top(., "RCT, Adult", 1, 64) %>% 
  result_pack(., "CABG", 1, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Cholecystectomy", 10, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Colorectal", 25, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Gyn", 36, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Herniorrhaphy", 40, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Maxillofacial", 42, padding = 2, bold = TRUE, color = "black") %>% 
  result_pack(., "Neurosurgical", 46, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Other GI", 48, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "TKA/THA", 60, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Colorectal", 65, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Other GI", 67, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Gyn", 69, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Other GI", 70, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Various Procedures", 73, padding = 2, bold = TRUE, color = "black") %>%
  # pack_top(., "Adult, RCT", 1, 64) %>% 
  # pack_sub(., "CABG", 1, 9) %>% 
  # pack_sub(., "Cholecystectomy", 10, 24) %>% 
  # pack_sub(., "Colorectal", 25, 35) %>% 
  # pack_sub(., "Gyn", 36, 39) %>% 
  # pack_sub(., "Herniorrhaphy", 40, 41) %>% 
  # pack_sub(., "Maxillofacial", 42, 45) %>% 
  # pack_sub(., "Neurosurgical", 46, 47) %>% 
  # pack_sub(., "Other GI", 48, 59) %>%
  # pack_sub(., "TKA/THA", 60, 64) %>% 
  # pack_top(., "Nonrandomized Studies of Interventions", 65, 68) %>%
  # pack_sub(., "Colorectal", 65, 66) %>% 
  # pack_sub(., "Other GI", 67, 68) %>% 
  # pack_top(., "Prospective Cohort", 69, 69) %>%
  # pack_sub(., "Gyn", 69, 69) %>% 
  # pack_top(., "Retrospective Cohort", 70, 72) %>%
  # pack_sub(., "Other GI", 70, 72) %>% 
  # pack_top(., "Case-Control", 73, 74) %>%
  # pack_sub(., "Various Procedures", 73, 74) %>% 
  footnote(general = "RCT: randomized controlled trial; OR: odds ratio; CHO: carbohydrate; Prot: protein.",
           alphabet = c("When outcome assessed relative to surgery where 0 is prior to induction."),
           general_title = "",  
           footnote_as_chunk = FALSE)

table_n <- tab_inc()
```

<br/>       

<a id="choTab30"></a>

### &ensp; Complication Types 

<br/>

<font size = 4> Table `r table_n`. Types of complications ascertained according to study (categorized according to Anderson [@Anderson2013] ). </font>

```{r complicateTypes, include = TRUE}
## (updated 2021/02/16 11:19) ccomplicateTypes ----------------------------
complicate_data <- readxl::read_xlsx("data/CHOComplicationList_012521.xlsx", range = "A5:P35") %>% 
  clean_names() %>% 
  mutate(across(c(ssi:pulm, rena:anastomotic_leak, bleed:oth_infect), ~ recode(., X = "\U00D7")))

compl_names <- c("SSI", "GU", "CV", "GI", "Pulm", "Anes", "Renal", "Meds", "Leak", "Op", "Bleed", "TE", "CVD", "Infect")
cats <-  c("Surgical Site Infection", "Genitourinary", "Cardiovascular", "Gastrointestinal", "Respiratory", "Anesthesia", "Fluid/electrolyte/renal", "Medication", "Anastomotic leak", "Intraoperative", "Bleeding", "Thromboembolic", "Cerebrovascular", "Other infection")
compl_foot <- paste0(compl_names, ": ", tolower(cats), collapse = "; ")
compl_foot <- paste0(compl_foot, ".")

complicate_data %>% 
  select(-design) %>% 
   kbl(booktabs = T, align =  c("l", rep("c", 14)), escape = FALSE,
    col.names = c("Study", rep(" ", 14))) %>% 
  #add_header_above(c(" " = 1, "Surgical Site Infection" = 1, "Genitourinary" = 1, "Cardiovascular" = 1, "Gastrointestinal" = 1, "Respiratory" = 1, "Anesthesia" = 1, "Fluid/electrolyte/renal" = 1, "Medication" = 1, "Anastomotic leak" = 1, "Intraoperative" = 1, "Bleeding" =1, "Thromboembolic" = 1, "Cerebrovascular" = 1, 	"Other infection" = 1), line = FALSE, angle = -90, align = "initial", line_sep = 20) %>% 
  add_header_above(c(" " = 1, compl_names), line = FALSE, angle = -45, align = "c", line_sep = 1) %>% 
  kable_classic(full_width = TRUE, html_font = opt_font, position = "right", "hover") %>% 
  kable_styling(bootstrap_options = opt_boot) %>% 
  column_spec(1, width = "9em") %>%  
  column_spec(2:15, width = "2em") %>% 
  pack_top(., "Adult, Surgical", 1, 30) %>% 
  pack_sub(., "RCT", 1, 26) %>%
  pack_sub(., "Nonrandomized Studies of Interventions", 27, 28) %>%
  pack_sub(., "Prospective Cohort", 29, 29) %>%
  pack_sub(., "Case-Control", 30, 30) %>%
  footnote(general = compl_foot,
           # alphabet = c(""),
           general_title = "",  
           footnote_as_chunk = FALSE)
table_n <- tab_inc()
```

<br/>

<a id="choFig12"></a>

### Pooled (CHO vs. fasting)  

<br/>

<font size = 4> Figure `r figure_n`. Pooled complications rates by type of surgery --- randomized trials comparing carbohydrate drinks with fasting in adult surgical patients. </font>

```{r complicateMetaDichotDat, include = TRUE}
## (updated 2021/01/13 09:48)  --------------------------------------------
complicate_meta.dat <- dichot_cho.dat %>%
  filter(!is.na(complicate_np)) %>%
  # Marquini b,c; nrsi Vigano 2012, Adamova 2017; cc Weledji 2017, coh Talutis 2020, Huang 2020
  filter(!refid %in% c(6446, 247, 3367, 6529, 6530, 147, 7747)) %>%
  select(refid, study, arm_tx, arm_n, complicate_n) %>%
  # , hr_gt6:hr_2) %>%
  # mutate(h2 = ifelse(!is.na(hr_2), "≤2 hr", hr_2),
  #  h26 = ifelse(!is.na(hr_26) & is.na(hr_2), ">2 to 6 hr", NA)) %>%
  #  h6 = ifelse(!is.na(hr_gt6) & is.na(hr_2) & is.na(hr_26), ">6 hrs", NA)) %>%
  group_by(refid) %>%
  filter(n() > 1) %>%
  ungroup() %>%
  # cho, clear/water, fasting
  mutate(
    arm_tx = tolower(as.character(arm_tx)),
    prot = ifelse(grepl("prot", arm_tx), "prot", "no_prot"),
    arm_tx = ifelse(grepl("cho", arm_tx), "cho", arm_tx),
    arm_tx = ifelse(arm_tx %in% c("water", "placebo"), "water_plac", arm_tx)
  )

comp_prot_refids <- complicate_meta.dat %>% 
  filter(prot == "prot") %>% 
  select(refid) %>% 
  unique() %>% 
  pull(refid)

```

```{r complicateMetaFast, include = TRUE, fig.width = 10, fig.height = 6.5, fig.align = "center"}
## (updated 2021/05/11 10:14) cho vs fasting ------------------------------
cho_fast_refids <- complicate_meta.dat %>% 
  filter(arm_tx == "fasting") %>% 
  select(refid) %>% 
  unique() %>% 
  pull(refid)

comp_meta_fast <- complicate_meta.dat %>%
  filter(refid %in% cho_fast_refids, arm_tx != "water_plac") %>%
  pivot_wider(
    id_cols = c("refid", "study"),
    names_from = "arm_tx",
    values_from = c("arm_n", "complicate_n"),
    values_fn = sum
  ) %>%
  left_join(., surg_cat, by = "refid") %>%
  rename_all(~ str_replace(., "complicate", "comp")) %>%
  mutate(year = str_extract(study, "\\d{4}")) %>%
  arrange(surg, year)

temp <- metabin(
  event.e = comp_n_cho,
  n.e = arm_n_cho,
  event.c = comp_n_fasting,
  n.c = arm_n_fasting,
  hakn = TRUE,
  sm = "OR",
  method.tau = "PM",
  method = "MH",
  byvar = surg,
  print.byvar = TRUE,
  studlab = study,
  allstudies = FALSE,
  data = comp_meta_fast
)

forest(temp,
  comb.fixed = TRUE,
  comb.random = FALSE,
  lab.e = "CHO     ",
  lab.c = "Fasting    ",
  digits = 2,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = FALSE,
  fs.xlab = 11,
  print.subgroup.labels = TRUE,
  print.byvar = FALSE,
  test.subgroup = FALSE,
  subgroup = TRUE,
  addrow.subgroups = FALSE,
  resid.hetstat = FALSE,
  hetstat = FALSE,
  pooled.events = TRUE,
  rightcols = c("effect", "ci"),
  rightlabs = c("OR", "95% CI     "),
  print.Q.subgroup = FALSE,
  fs.fixed.labels = 10,
  allstudies = FALSE,
  xlab = "Favors CHO          Favors Fasting")
  
figure_n <- fig_inc()

```

<br/>

<a id="choFig13"></a> 

### Pooled (CHO vs. water/placebo) 

<br/>

<font size = 4> Figure `r figure_n`. Pooled complications rates by type of surgery --- randomized trials comparing carbohydrate drinks with water or placebo in adult surgical patients. </font>

```{r complicateMetaWaterPlac, include = TRUE, fig.width = 10, fig.height = 5.8, fig.align = "center"}
## (updated 2021/05/11 10:16) cho vs water/plac ---------------------------
cho_water_plac_refids <- complicate_meta.dat %>% 
  filter(arm_tx == "water_plac") %>% 
  select(refid) %>% 
  unique() %>% 
  pull(refid)

comp_meta_water <- complicate_meta.dat %>%
  filter(refid %in% cho_water_plac_refids, arm_tx != "fasting") %>%
  pivot_wider(
    id_cols = c("refid", "study"),
    names_from = "arm_tx",
    values_from = c("arm_n", "complicate_n"),
    values_fn = sum
  ) %>%
  left_join(., surg_cat, by = "refid") %>%
  rename_all(~ str_replace(., "complicate", "comp")) %>%
  mutate(year = str_extract(study, "\\d{4}")) %>%
  arrange(surg, year)

temp <- metabin(
  event.e = comp_n_cho,
  n.e = arm_n_cho,
  event.c = comp_n_water_plac,
  n.c = arm_n_water_plac,
  hakn = TRUE,
  sm = "OR",
  method.tau = "PM",
  method = "MH",
  byvar = surg,
  print.byvar = TRUE,
  studlab = study,
  allstudies = FALSE,
  data = comp_meta_water
)

forest(temp,
  comb.fixed = TRUE,
  comb.random = FALSE,
  lab.e = "CHO     ",
  lab.c = "Water/Placebo",
  digits = 2,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = FALSE,
  fs.xlab = 11,
  addrow.subgroups = FALSE,
  print.subgroup.labels = TRUE,
  print.byvar = FALSE,
  test.subgroup = FALSE,
  subgroup = TRUE,
  resid.hetstat = FALSE,
  hetstat = FALSE,
  pooled.events = TRUE,
  print.Q.subgroup = FALSE,
  fs.fixed.labels = 10,
  rightcols = c("effect", "ci"),
  rightlabs = c("OR", "95% CI     "),
  allstudies = FALSE,
  xlab = "Favors CHO          Favors Water/Placebo")
  
figure_n <- fig_inc()

```

<a id="choFig14"></a>

### Pooled (protein) 

<br/>

<font size = 4> Figure `r figure_n`. Pooled complications rates from randomized trials comparing carbohydrate drinks with protein with fasting in adult surgical patients. </font>

```{r complicateMetaFastProt, include = TRUE, fig.width = 10, fig.height = 2, fig.align = "center"}
## (updated 2021/05/11 10:14) cho vs fasting ------------------------------
temp <- metabin(
  event.e = comp_n_cho,
  n.e = arm_n_cho,
  event.c = comp_n_fasting,
  n.c = arm_n_fasting,
  hakn = TRUE,
  sm = "OR",
  method.tau = "PM",
  method = "MH",
  # byvar = surg,
  # print.byvar = TRUE,
  studlab = study,
  allstudies = FALSE,
  subset = refid %in% comp_prot_refids,
  data = comp_meta_fast
)

forest(temp,
  sortvar = year,
  comb.fixed = TRUE,
  comb.random = FALSE,
  lab.e = "CHO/Prot ",
  lab.c = "Fasting ",
  digits = 2,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = FALSE,
  fs.xlab = 11,
  test.subgroup = FALSE,
  subgroup = TRUE,
  resid.hetstat = FALSE,
  hetstat = FALSE,
  pooled.events = TRUE,
  print.Q.subgroup = FALSE,
  rightcols = c("effect", "ci"),
  rightlabs = c("OR", "95% CI     "),
  fs.fixed.labels = 10,
  allstudies = FALSE,
  xlab = "Favors CHO          Favors Fasting")
  
figure_n <- fig_inc()

```
Pexe-Machado 2013 CABG, Yi 2020 gastrointestinal procedures.

<br/>


## *Length of Stay* 

<a id="choTab31"></a>

### Adults 

<br/>

<font size = 4> Table `r table_n`. Reported length of stay in adult patients by surgical category according to liquid or fasting. </font>

<br/>

```{r losKbl, include = TRUE}
## (2021/05/11 15:27) losKbl ----------------------------------------------
los.dat <- contin_cho.dat %>% 
  select(refid:age, arm_n, arm_tx, starts_with("los")) %>% 
  filter_at(vars(los:los_pval), any_vars(!is.na(.))) %>% 
  left_join(., surg_cat, by = "refid") %>% 
  mutate(surg = ifelse(surg == "Orthopedic", "TK Orthopedic", surg)) %>% 
  arrange(age, desc(surg_nosurg), design, surg, year, study, arm_tx) %>% 
  mutate(
    los_bar = ifelse(!is.na(los_median_1), los_median_1, los_mean_1),
    los_iqr = str_c("(", los_iqr_low_1, "-", round(los_iqr_up_1, 1), ")"),
    los_range = str_c("(", los_range_low_1, "-", los_range_up_1, ")"),
    #los_mean_1 = round(los_mean_1, 1),
    los_mean = ifelse(!is.na(los_sd_1) & !is.na(los_mean_1), str_c(round_1(los_mean_1), " (", round_1(los_sd_1), ")"), round_1(los_mean_1)),
    los_med = str_c(los_median_1, str_replace_na(los_iqr, "NA"), sep = " "),
    los_mean = na_if(los_mean, "NA"),
    los_med = gsub(" NA", "", los_med)) %>% 
  select(surg, refid, study, age, design, arm_tx, arm_n, los_mean, los_med, los_range, los_bar) 

cts_format <- function(x) (x/20)

los.dat <- los.dat %>%
  mutate(los_bar = case_when(
    grepl("CHO", arm_tx)~ color_bar("darksalmon", fun = cts_format)(formattable::percent(los_bar)),
    !grepl("CHO", arm_tx) ~ color_bar("lightgray", fun = cts_format)(formattable::percent(los_bar))),
    los_bar = str_replace(los_bar, ">.*<", ">&nbsp;<")
    )

## (updated 2021/05/12 06:07) kable los -----------------------------------
cho_row <- los.dat %>% 
  filter(age == "Adult") %>% 
  mutate(line = row_number()) %>% 
  filter(grepl("CHO", arm_tx)) %>% 
  pull(line)

los.dat %>%
  filter(age == "Adult") %>%
  select(study, arm_tx, arm_n, los_mean, los_med, los_range, los_bar) %>%
  group_by(study) %>%
  mutate(
    study = cell_spec(study, color = "black"),
    study = ifelse(row_number() == 1, study, NA)
  ) %>%
  ungroup() %>%
  kbl(
    booktabs = T, align = c("llccccl"), escape = FALSE,
    col.names = c(
      "       Study", "Liquid", "N", "Mean (SD)", "Median (IQR)", "Range", "Median or Mean"
    )
  ) %>%
  add_header_above(c(" " = 3, "LOS (days)" = 4), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4:6), width = "7em") %>%
  column_spec(7, width = "8em") %>%
  row_spec(cho_row, color = "brown") %>%
  pack_top(., "RCT", 1, 81) %>%
  pack_top(., "Nonrandomized Studies of Interventions", 82, 87) %>%
  pack_top(., "Prospective Cohort", 88, 88) %>%
  pack_top(., "Retrospective Cohort", 89, 93) %>%
  pack_top(., "Case Control", 94, 95) %>%
  pack_top(., "Retrospective Cohort", 96, 97) %>%
  result_pack(., "CABG", 1, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Cholecystectomy", 16, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Colorectal", 25, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Endoscopic Submucosal Dissection", 46, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Gyn", 48, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Herniorrhaphy", 50, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Neurosurgical", 52, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Other GI", 54, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Orthopedic", 64, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "TKA/THA", 66, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Various", 77, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Whipple", 80, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Colorectal", 82, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Gyn", 84, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Other GI", 86, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Gyn", 88, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Other GI", 89, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "TKA/THA", 92, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Various", 94, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Thoracic", 96, padding = 2, bold = TRUE, color = "black") %>%
  footnote(
    general = "RCT: randomized controlled trial.",
    # alphabet = c(""),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()

```

<br/>

<a id="choTab32"></a>

### Pediatric 

<br/>

<font size = 4> Table `r table_n`. Reported length of stay in pediatric patients  according to liquid or fasting. </font>

```{r losPeds, include = TRUE}
## (updated 2021/05/12 06:07) kable los -----------------------------------
cho_row <- los.dat %>% 
  filter(age == "Pediatric") %>% 
  mutate(line = row_number()) %>% 
  filter(grepl("CHO", arm_tx)) %>% 
  pull(line)

los.dat %>%
  filter(age == "Pediatric") %>%
  select(study, arm_tx, arm_n, los_mean, los_med, los_range, los_bar) %>%
  group_by(study) %>%
  mutate(
    study = cell_spec(study, color = "black"),
    study = ifelse(row_number() == 1, study, NA)
  ) %>%
  ungroup() %>%
  kbl(
    booktabs = T, align = c("llccccl"), escape = FALSE,
    col.names = c(
      "       Study", "Liquid", "N", "Mean (SD)", "Median (IQR)", "Range", "Median or Mean"
    )
  ) %>%
  add_header_above(c(" " = 3, "LOS (days)" = 4), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4:6), width = "7em") %>%
  column_spec(7, width = "8em") %>%
  row_spec(cho_row, color = "brown") %>%
  pack_top(., "RCT", 1, 4) %>%
  result_pack(., "Various Procedures", 1, padding = 2, bold = TRUE, color = "black") %>%
  footnote(
    general = "RCT: randomized controlled trial.",
    # alphabet = c(""),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()

```

<br/>

<hr style="height:2px;border-width:0;color:gray;background-color:gray">

<br/>

# **Study/Participant Detail** 

<br/>

### *Study Characteristics* 

<br>

<font size = 4> Table `r table_n`. Characteristics of studies examining carbohydrate drinks. </font>

```{r createStudyCharTable, include = FALSE} 
## (updated 2021/01/12 09:30) createStudyCharTable ------------------------
study_char_table <- study_char_cho.dat %>%
  mutate(
    dates = str_c(date_start, "-", date_end),
    country = countrycode::countryname(country, destination = "iso3c"),
    low_r = noquote(if_else(non_vh_hdi == "yes", "\U2022", "", "")),
    n = n_enrolled,
    n_anal = n_analyze,
    pilot = noquote(if_else(pilot == "yes", "\U2022", "", "")),
    study = ifelse(grepl("Marquini", study), str_c(study, "^a^"), study),
    setting = case_when(
      !is.na(hospital) ~ "Hosp",
      !is.na(ambulatory) ~ "Amb",
      !is.na(oth_setting) ~"Other"),
    gen = noquote(if_else(!is.na(general), "\U2022", "", "")),
    reg = noquote(if_else(!is.na(regional), "\U2022", "", "")),
    sed = noquote(if_else(!is.na(sedation), "\U2022", "", "")),
    registered = noquote(if_else(registered == "yes", "\U2022", "", "")),
    surg = case_when(
      str_detect(surg_type, "[Gg]yn|[Hh]ysterectomy") ~ "Gyn",
      str_detect(surg_type, "craniotomy") ~ "Neurosurgical",
      str_detect(surg_type, "maxillofacial") ~ "Maxillofacial",
      str_detect(surg_type, "[Hh]ernia|herniorrhaphy") ~ "Herniorrhaphy",
      str_detect(surg_type, "prostatectomy") ~ "prostatectomy",
      str_detect(surg_type, "ariety") ~ "Various",
      str_detect(surg_type, "various|Hirschsprung's") ~ "Various",
      str_detect(surg_type, "CABG|[Cc]oronary artery bypass surgery") ~ "CABG",
      str_detect(surg_type, "[Cc]olorectal|[Bb]owel|colon resection") ~ "Colorectal",
      str_detect(surg_type, "[Tt]hyroid|hip joint") ~ "Thyroid",
      str_detect(surg_type, "[Oo]rthopedic|discectomy") ~ "Orthopedic",
      str_detect(surg_type, "pancreaticoduodenectomy") ~ "Whipple",
      str_detect(surg_type, "total hip or total knee replacement|[Tt]otal hip|[Tt]otal knee|Hip joint|hip replacement") ~ "TKA/THA",
      str_detect(surg_type, "cholecystectomy") ~ "Cholecystectomy",
      str_detect(surg_type, "[Gg]ast|Bowel") ~ "Other GI",
      str_detect(surg_type, "not appli") ~ "None (healthy)",
      str_detect(surg_type, "oral") ~ "Oral",
      str_detect(surg_type, "minor") ~ "Misc minor",
      str_detect(surg_type, "None") ~ "None (healthy)",
      str_detect(surg_type, "abdomin") ~ "Other GI",
      str_detect(surg_type, "[Cc]esarean|labor") ~ "Cesarean/vaginal birth",
      str_detect(surg_type, "thoracotomy") ~ "Thoracic",
      str_detect(surg_type, "healthy") ~ "None (healthy)",
      str_detect(surg_type, "Elective") ~ "Elective",
      str_detect(surg_type, "adenotonsillectomy") ~ "Adenotonsillectomy",
      str_detect(surg_type, "[Bb]reast") ~ "Breast",
      str_detect(surg_type, "Endso|endoscopic|colonoscopy") ~ "Endoscopic")) %>%
  # filter(!study %in% c("Marquini 2020b", "Marquini 2020c")) %>% 
  arrange(age, desc(surg_nosurg), design, year, study) %>%
  select(refid, age, surg_nosurg, design, study, dates, country, n, pilot, setting, gen, reg, sed, surg, registered)

```

```{r studyCharKable, echo = FALSE} 
## (updated 2021/01/12 19:27) ---------------------------------------------
study_char_table %>%
  select(!c(refid, age, surg_nosurg, design)) %>% 
  kbl(booktabs = T, align = c("lcccccccclc"), 
      # format = "latex",
      col.names = c("\\ \\ \\ \\ \\ \\ \\ Study", "Dates", "Country", " (N\\) ", "Pilot", 
                    "Setting", "Gen", "Reg", "Sed", "Type of Surgery", "Registered")) %>%
  add_header_above(c(" " = 3, "Enrolled" = 1, " " = 2, "Anesthetic" = 3, " " = 2), bold = TRUE) %>% 
  row_spec(0, bold = TRUE) %>% 
  kable_classic(full_width = TRUE, html_font = opt_font, position = "left", "hover") %>% 
  kable_styling(bootstrap_options = opt_boot) %>% 
  column_spec(1, width = "15em") %>% 
  # column_spec(2, width = "2em") %>% 
  pack_top(., "Adult, Surgical", 1, 99) %>% 
  pack_sub(., "RCT", 1, 84) %>% 
  pack_sub(., "Nonrandomized Studies of Interventions", 85, 92) %>% 
  pack_sub(., "Prospective Cohort", 93, 95) %>%
  pack_sub(., "Retrospective Cohort", 96, 97) %>% 
  pack_sub(., "Case-control", 98, 98) %>% 
  pack_sub(., "Before-after", 99, 99) %>% 
  pack_top(., "Adult, Non-surgical", 100, 111) %>% 
  pack_sub(., "RCT", 100, 100) %>%
  pack_sub(., "Crossover", 101, 109) %>%
  pack_sub(., "Nonrandomized Studies of Interventions", 110, 111) %>% 
  pack_top(., "Pediatric, Surgical", 112, 120) %>% 
  pack_sub(., "RCT", 112, 119) %>% 
  # pack_sub(., "Nonrandomized Studies of Interventions", 119, 119) %>% 
  pack_sub(., "Prospective Cohort", 120, 120) %>% 
  pack_top(., "Pediatric, Non-surgical", 121, 123) %>% 
  pack_sub(., "RCT", 121, 121) %>%
  pack_sub(., "Crossover", 122, 122) %>%
  pack_sub(., "Prospective Cohort", 123, 123) %>% 
  footnote(general_title = "",
    general = "Gen: general; Reg: regional; Sed: sedation; Hosp: hospital; Amb: ambulatory; TKA: total knee arthroplasty; THA: total hip arthroplasty.",
    alphabet = c("Multiple publications from the same study."),
    footnote_as_chunk = FALSE) # %>% 

table_n <- tab_inc()
```

<br/>

### *Sample Characteristics* 

<br>    

<font size = 4> Table `r table_n`. Characteristics of patients in included studies. </font>

```{r createPtCharTable, include = FALSE}
## (updated 2021/01/12 09:29) createPtCharTable ---------------------------
pt_char_table <- study_arm_cho.dat %>%
  # filter(refid == 6490) %>% 
  group_by(refid) %>%
  summarize(
    N = sum(arm_n),
    wgt = arm_n / N,
    asai_all = round(sum(asai * wgt, na.rm = FALSE)),
    asaii_all = round(sum(asaii * wgt, na.rm = FALSE)),
    asaiii_all = round(sum(asaiii * wgt, na.rm = FALSE)),
    asai_ii_all = round(sum(asai_ii * wgt, na.rm = FALSE)),
    age_mn_all = round(sum(age_mean * wgt, na.rm = FALSE)),
    age_md_all = round(sum(age_med * wgt, na.rm = FALSE)),
    sex_all = round(sum(female * wgt, na.rm = FALSE)),
    white_all = round(sum(white * wgt, na.rm = FALSE)),
    black_all = round(sum(black * wgt, na.rm = FALSE)),
    asian_all = round(sum(asian * wgt, na.rm = FALSE)),
    bmi_mn_all = round(sum(bmi_mean * wgt, na.rm = FALSE)),
    bmi_md_all = round(sum(bmi_med * wgt, na.rm = FALSE)),
    dm_mn_all = round(sum(dm * wgt, na.rm = FALSE)),
    neuro_all = round(sum(neuro * wgt, na.rm = FALSE))) %>%
  filter(row_number() == 1) %>%
  ungroup() 

# add study age, surg_nosurg, design
temp <- left_join(study_names, study_char.dat[, c("refid", "age", "surg_nosurg", "design")], by = "refid")
  
pt_char_table <- left_join(pt_char_table, temp, by = "refid") %>% 
  arrange(age, desc(surg_nosurg), design, year, study) %>% 
  mutate(study = ifelse(grepl("Marquini", study), str_c(study, "^a^"), study)) %>% 
  select(age, design, study, year, everything())

rm(temp)

pt_char_table <- pt_char_table %>% 
  # filter(!study %in% c("Marquini 2020b", "Marquini 2020c")) %>% 
  select(study, N, asai_all, asaii_all, asai_ii_all, asaiii_all, sex_all, age_mn_all, 
  age_md_all, white_all, black_all, asian_all, bmi_mn_all, bmi_md_all, dm_mn_all)

```

```{r ptCharKable, echo = FALSE}
## (updated 2021/01/12 09:29) ptCharKable ---------------------------------
pt_char_table %>% 
  mutate_at(vars(asai_all:dm_mn_all), na_if, 0) %>% 
  kbl(
    booktabs = T, align = c("lrrrrcccccccccc"),
    col.names = c("\\ \\ \\ \\ \\ \\ \\ Study", "Analyzed", "I", "II", "I-II", "III", "(%)",
      "Mean", "Med", "White", "Black", "Asian", "Mean", "Med", "DM (%)")) %>%
  add_header_above(c(" " = 1, "N" = 1, "\\ \\ \\ ASA Classs (%)" = 4, "Female" = 1, "Age" = 2,
    "Race (%)" = 3, "BMI (kg/m^2^)" = 2, " " = 1), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>% 
  kable_classic(full_width = TRUE, html_font = opt_font, position = "left", "hover") %>% 
  kable_styling(bootstrap_options = opt_boot) %>% 
  column_spec(1, width = "15em") %>%
  # column_spec(2, width = "4em") %>%
  pack_top(., "Adult, Surgical", 1, 99) %>% 
  pack_sub(., "RCT", 1, 84) %>% 
  pack_sub(., "Nonrandomized Studies of Interventions", 85, 92) %>% 
  pack_sub(., "Prospective Cohort", 93, 95) %>%
  pack_sub(., "Retrospective Cohort", 96, 97) %>% 
  pack_sub(., "Case-control", 98, 98) %>% 
  pack_sub(., "Before-after", 99, 99) %>% 
  pack_top(., "Adult, Non-surgical", 100, 111) %>% 
  pack_sub(., "RCT", 100, 100) %>%
  pack_sub(., "Crossover", 101, 109) %>%
  pack_sub(., "Nonrandomized Studies of Interventions", 110, 111) %>% 
  pack_top(., "Pediatric, Surgical", 112, 120) %>% 
  pack_sub(., "RCT", 112, 119) %>% 
  # pack_sub(., "Nonrandomized Studies of Interventions", 119, 119) %>% 
  pack_sub(., "Prospective Cohort", 120, 120) %>% 
  pack_top(., "Pediatric, Non-surgical", 121, 123) %>% 
  pack_sub(., "RCT", 121, 121) %>%
  pack_sub(., "Crossover", 122, 122) %>%
  pack_sub(., "Prospective Cohort", 123, 123) %>% 
  footnote(alphabet = c("Multiple publications from the same study."),
    general = "Med: median",
    general_title = "",
    footnote_as_chunk = T)

table_n <- tab_inc()
```

<br/>

### *Fasting, Liquid Timing and Amounts* 

<br/>

<font size = 4> Table `r table_n`. Liquid consumption prior to surgery or outcome measurement and amounts according to study arm. </font>

```{r createFastingTable, include = FALSE, echo = FALSE}
## (updated 2021/01/12 09:29) createFastingTable --------------------------
fasting_table <- study_arm_cho.dat %>%
  filter(refid %in% cho_refids) %>%
  mutate(
    arm = ifelse(refid == 3588 & arm_n == 35, 3, arm),
    arm = ifelse(refid == 3588 & arm_n == 27, 2, arm),
    fastsolid = ifelse(fastsolid == 99, 12, fastsolid),
    timeingest1 = ifelse(timeingest1 == 99, 12, timeingest1),
    fastliquid = round_0(fastliquid),
    fastliquid = na_if(fastliquid, "NA"),
    amtingest1 = round(amtingest1, 0),
    amtingest1 = na_if(amtingest1, 0),
    amtingest2 = round(amtingest2, 0),
    amtingest2 = na_if(amtingest2, 0),
    timeingest1 = round(timeingest1, 0),
    timeingest2 = round(timeingest2, 0)) %>%
  select(refid, age, surg_nosurg, design, study, year, arm_tx, arm_n, fastsolid, fastliquid, type_of_liquid, timeingest1, amtingest1, timeingest2, amtingest2) %>%
  arrange(age, desc(surg_nosurg), design, year, study, arm_tx) %>%
  # mutate(year = ifelse(row_number() == 1, as.numeric(year), "")) %>% 
  mutate(study = ifelse(study == "Marquini 2020a", "Marquini 2020abc", study)) %>% 
  filter(!study %in% c("Marquini 2020b", "Marquini 2020c")) %>% 
  group_by(study) %>%
  mutate(study = if_else(row_number() == 1, study, ""),
         study = if_else(refid == 5815 & arm_tx == "Fasting", "Moyao-Garcia 2001", study),
         temp = row_number()) %>% 
  ungroup() %>% 
  select(study, arm_tx, arm_n, fastsolid, fastliquid, contains("ingest"))

```

```{r fastingKable, echo = FALSE}
## (updated 2021/01/12 09:27) fastingKable --------------------------------
fasting_table %>%
  kbl(booktabs = T, align = c("llccccccc"),
      col.names = c("        Author", "   Liquid", "N", "Solids", "Liquids",  "Time^a^ (hr)", "Amount (mL)", 
      "Time^a^ (hr)", "Amount (mL)")) %>%
  add_header_above(c(" " = 3, "Prescribed Fasting  (hr)" = 2, "Treat Liquid 1" = 2, "Treat Liquid 2" = 2), line = TRUE, bold = TRUE) %>% 
  row_spec(0, bold = TRUE) %>% 
  kable_classic(full_width = TRUE, html_font = opt_font, position = "left", "hover") %>% 
  kable_styling(bootstrap_options = opt_boot) %>% 
  column_spec(1, width = "15em") %>% 
  # column_spec(2, width = "5em") %>% 
  # column_spec(3, width = "9em") %>%
  pack_top(., "Adult, Surgical", 1, 227) %>% 
  pack_sub(., "RCT", 1, 195) %>% 
  pack_sub(., "Nonrandomized Studies of Interventions", 196, 215) %>%
  pack_sub(., "Prospective Cohort", 216, 218) %>%
  pack_sub(., "Retrospective Cohort", 219, 223) %>% 
  pack_sub(., "Case-control", 224, 225) %>% 
  pack_sub(., "Before-after", 226, 227) %>% 
  pack_top(., "Adult, Non-surgical", 228, 255) %>% 
  pack_sub(., "RCT", 228, 229) %>%
  pack_sub(., "Crossover", 230, 250) %>%
  pack_sub(., "Nonrandomized Studies of Interventions", 251, 255) %>% 
  pack_top(., "Pediatric, Surgical", 256, 274) %>% 
  pack_sub(., "RCT", 256, 273) %>% 
  pack_sub(., "Prospective Cohort", 274, 274) %>% 
  pack_top(., "Pediatric, Non-surgical", 275, 280) %>% 
  pack_sub(., "RCT", 275, 277) %>%
  pack_sub(., "Crossover", 278, 279) %>%
  pack_sub(., "Prospective Cohort", 280, 280) %>% 
  footnote(general = "hr: hours; ch: cholecystectomy; cr: colorectal; gen: general; epi: epidural",
          alphabet = c("In surgical studies hours prior to surgery. In non-surgical studies time 0 reference for any measurements and negative numbers prior ingestion."),
          alphabet_title = " ",
          general_title = "",
          footnote_as_chunk = T)

table_n <- tab_inc()
```

<br/>

### *Carbohydrate Drink Amounts*

<br/>

<font size = 4> Table `r table_n`. Composition of carbohydrate liquids and brands. </font>

```{r createChoDrinkTable, include = FALSE}
## (updated 2021/01/12 09:27) createChoDrinkTable -------------------------
# calculate total cho/protein
cho_drink_table <- study_arm_cho.dat %>%
  filter(grepl("CHO", arm_tx)) %>%
  mutate(
    amtingest2 = replace_na(amtingest2, 0),
    tot_vol = amtingest2 + amtingest1,
    prot_conc = round(prot_conc, 1),
    prot_gm_all = round(prot_conc * tot_vol / 100, 1),
    cho_gm_all = round(cho_conc * tot_vol / 100, 1),
    cho_gm_all = round(ifelse(is.na(cho_gm_all), cho_gm, cho_gm_all), 0),
    prot_gm_all = ifelse(is.na(prot_gm_all), protein_gm, prot_gm_all)) %>% 
  select(refid, age, surg_nosurg, design, study, year, arm_tx, arm, cho_gm, cho_conc, protein_gm, prot_gm_all, prot_conc, brand, tx_detail, cho_gm_all, prot_gm_all, prot_conc)

cho_drink_table <- cho_drink_table %>% 
  mutate(cho_conc = ifelse(refid == 1228 & arm == 2, "0.5 gm/kg", cho_conc),
         cho_conc = ifelse(refid == 1228 & arm == 3, "1.0 gm/kg", cho_conc),
         cho_conc = ifelse(refid == 1228 & arm == 4, "1.5 gm/kg", cho_conc)) %>% 
  group_by(study) %>% 
  arrange(age, desc(surg_nosurg), design, year, study) %>% 
  mutate(study = ifelse(row_number() >= 2, " ", study),
         study = ifelse(study == "Marquini 2020a", "Marquini 2020 (all)", study),
         study = ifelse(refid == 5815, "Moyao-Garcia 2001", study)) %>% 
  ungroup() %>% 
  filter(!study %in% c("Marquini 2020b", "Marquini 2020c")) %>% 
  select(study, cho_conc, prot_conc, cho_gm_all, prot_gm_all, brand, tx_detail)

```

```{r choDrinksKable, echo = FALSE}
## (updated 2021/01/12 09:28) choDrinksKable ------------------------------
cho_drink_table <- cho_drink_table %>% 
  mutate(cho_gm_all = replace_na(cho_gm_all, ""),
         prot_gm_all = replace_na(prot_gm_all, ""))

prot_gm_scale <- function(x) (x/200)
cho_gm_scale <- function(x) (x/200)
cho_drink_table$cho_gm_all <- color_bar("lightgreen", fun = cho_gm_scale)(cho_drink_table$cho_gm_all)
cho_drink_table$prot_gm_all <- color_bar("lightgreen", fun = prot_gm_scale)(cho_drink_table$prot_gm_all)

cho_drink_table$prot_gm_all <- str_replace(cho_drink_table$prot_gm_all, "direction: rtl; ", "")
cho_drink_table$cho_gm_all <- str_replace(cho_drink_table$cho_gm_all, "direction: rtl; ", "")

#cho_drink_table$cho_gm_all <- normalize_bar(color = "lightgreen", na.rm = TRUE)(cho_drink_table$cho_gm_all)
#cho_drink_table$prot_gm_all <- normalize_bar("lightgreen", na.rm = TRUE)(cho_drink_table$prot_gm_all)

cho_drink_table %>% 
  select(-tx_detail) %>% 
  kbl(booktabs = T, align = c("llllll"),
      col.names = linebreak(c("        Study", "CHO, g", "Protein, g", "CHO, g", "Protein, g", "Brand")), escape = FALSE) %>%
  add_header_above(c(" " = 1, "Per 100 mL" = 2, "Total" = 2, " " = 1), line = TRUE, bold = TRUE) %>%  
  row_spec(0, bold = TRUE) %>% 
  kable_classic(full_width = TRUE, html_font = opt_font, position = "left", "hover") %>% 
  kable_styling(bootstrap_options = opt_boot) %>% 
  column_spec(1, width = "10em") %>% 
  column_spec(c(2,3), width = "3em") %>% 
  column_spec(c(4,5), width = "5em") %>% 
  column_spec(6, width = "9em") %>%
  pack_top(., "Adult, Surgical", 1, 119) %>% 
  pack_sub(., "RCT", 1, 99) %>%
  pack_sub(., "Nonrandomized Studies of Interventions", 100, 111) %>% 
  pack_sub(., "Prospective Cohort", 112, 114) %>%
  pack_sub(., "Retrospective Cohort", 115, 117) %>% 
  pack_sub(., "Case-control", 118, 118) %>% 
  pack_sub(., "Before-after", 119, 119) %>% 
  pack_top(., "Adult, Non-surgical", 120, 144) %>% 
  pack_sub(., "RCT", 120, 121) %>%
  pack_sub(., "Crossover", 122, 139) %>%
  pack_sub(., "Nonrandomized Studies of Interventions", 140, 144) %>% 
  pack_top(., "Pediatric, Surgical", 145, 156) %>% 
  pack_sub(., "RCT", 145, 155) %>% 
  pack_sub(., "Prospective Cohort", 156, 156) %>% 
  pack_top(., "Pediatric, Non-surgical", 157, 160) %>% 
  pack_sub(., "RCT", 157, 158) %>%
  pack_sub(., "Crossover", 159, 159) %>%
  pack_sub(., "Prospective Cohort", 160, 160) %>% 
  footnote(general = "CHO: carbohydrate; g: grams; Osm: osomolality; Glut: glutamine; Arg: arginine; NS: not specified",
          #alphabet = c("per 100/mL if not otherwise specified"),
          # alphabet_title = " ",
          general_title = "",
          footnote_as_chunk = T)  

table_n <- tab_inc()
```

<br>

### *Funding* 

<br>

<font size = 4> Table `r table_n`. Reported funding sources. </font>

```{r createFundingTable, include = FALSE}
## (updated 2021/01/12 09:28) createFundingTable --------------------------
study_fund_table <- study_char_cho.dat %>%
  mutate(
    # sponsor_desc = str_to_title(sponsor_desc),
    registered = noquote(if_else(registered == "yes", "\U2022", "", "")),
    public = noquote(if_else(funding == "public" | funding == "pub_indus", "\U2022", "", "")),
    industry = noquote(if_else(funding == "pub_indus", "\U2022", "", "")),
    none = noquote(if_else(funding == "none", "\U2022", "", "")),
    not_reported = noquote(if_else(funding == "NR", "\U2022", "", "")),
    study = ifelse(study == "Marquini 2020a", "Marquini 2020 (all)", study)) %>%
  filter(!study %in% c("Marquini 2020b", "Marquini 2020c")) %>% 
  arrange(age, desc(surg_nosurg), design, year, study) %>%
  select(study, design, registered, public, industry, none, not_reported, sponsor_desc)

temp <- cho_drink_table %>% 
  select(study, brand) %>% 
  distinct()

study_fund_table <- left_join(study_fund_table, temp, by = "study") 

```

```{r fundingKable, echo = FALSE}
## (updated 2021/01/12 09:28) fundingKable --------------------------------
study_fund_table %>% 
  select(-design, -registered) %>% 
  kbl(booktabs = T, align = c("lcccclll"),
      col.names = c("        Study", "Public", "Industry", "None", 
                    "Not Reported", "Funding description", "Brand")) %>%
  add_header_above(c(" " = 1, "Reported Funding Source(s)" = 4, " " = 2), line = TRUE, bold = TRUE) %>% 
  row_spec(0, bold = TRUE) %>% 
  kable_classic(full_width = TRUE, html_font = opt_font, position = "left", "hover") %>% 
  kable_styling(bootstrap_options = opt_boot) %>% 
  column_spec(1, width = "16em") %>% 
  column_spec(c(2,3,4,5), width = "4em") %>% 
  column_spec(6, width = "23em") %>%
  pack_top(., "Adult, Surgical", 1, 98-1) %>% 
  pack_sub(., "RCT", 1, 83-1) %>%
  pack_sub(., "Nonrandomized Studies of Interventions", 84-1, 91-1) %>% 
  pack_sub(., "Prospective Cohort", 92-1, 94-1) %>%
  pack_sub(., "Retrospective Cohort", 95-1, 96-1) %>% 
  pack_sub(., "Case-control", 97-1, 97-1) %>% 
  pack_sub(., "Before-after", 98-1, 98-1) %>% 
  pack_top(., "Adult, Non-surgical", 99-1, 110-1) %>% 
  pack_sub(., "RCT", 99-1, 99-1) %>%
  pack_sub(., "Crossover", 100-1, 108-1) %>%
  pack_sub(., "Nonrandomized Studies of Interventions", 109-1, 110-1) %>% 
  pack_top(., "Pediatric, Surgical", 111-1, 119-1) %>% 
  pack_sub(., "RCT", 111-1, 118-1) %>% 
  # pack_sub(., "Nonrandomized Studies of Interventions", 118-1, 118-1) %>% 
  pack_sub(., "Prospective Cohort", 119-1, 119-1) %>% 
  pack_top(., "Pediatric, Non-surgical", 120-1, 122-1) %>% 
  pack_sub(., "RCT", 120-1, 120-1) %>%
  pack_sub(., "Crossover", 121-1, 121-1) %>%
  pack_sub(., "Prospective Cohort", 122-1, 122-1)
  #footnote(general = "g: grams; Osm: osmolality",
          # alphabet = c("Hours prior to surgery"),
          # alphabet_title = " ",
          # general_title = "",
          # footnote_as_chunk = T)

table_n <- tab_inc()
```

<br>

<hr style="height:2px;border-width:0;color:gray;background-color:gray">

<br>

# **Risk of Bias** 

### *Patient Reported Outcomes*

<br>

<font size = 4> Figure `r figure_n`. Summary risk of bias appraisal for randomized controlled trials including patient reported outcomes --- nausea, hunger, thirst, and pain. </font>

<img src="assets/cho_pro_rob_summary.svg" style="width:600px;" align="left"/>

<br clear="all" />

```{r}
figure_n <- fig_inc()
```

<font size = 4> Figure `r figure_n`. Individual study risk of bias appraisal for randomized controlled trials including patient reported outcomes --- nausea, hunger, thirst, and pain. </font>

<img src="assets/cho_pro_rob_traffic.svg" style="width:600px;" align="left"/>

<br clear="all" />

```{r}
figure_n <- fig_inc()
```

<br>

### *Clinical Outcomes*

<br>

<font size = 4> Figure `r figure_n`. Summary risk of bias appraisal for randomized controlled trials including clinical outcomes. </font>

<img src="assets/cho_clin_rob_summary.svg" style="width:600px;" align="left"/>

<br clear="all" />

```{r}
figure_n <- fig_inc()
```

<font size = 4> Figure `r figure_n`. Individual study risk of bias appraisal for randomized controlled trials for clinical outcomes. </font>

<img src="assets/cho_clin_rob_traffic.svg" style="width:600px;" align="left"/>

```{r}
figure_n <- fig_inc()
```
<br clear="all" />

<hr style="height:2px;border-width:0;color:gray;background-color:gray">

<br>

# References {#references} 

<br/>



