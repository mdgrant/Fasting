---
title: "Protein/Carbohydrate Containing Drinks"
date: "`r format(Sys.time(), '%d %B, %Y (%H:%M)')`"
output:
  html_document:
    font: Source Sans Pro
    theme: cosmo
    anchor_sections: TRUE
    toc_float: 
      collapsed: true
      smooth_scroll: TRUE
    toc_depth: 4
    linkcolor: blue
  latex_engine: xelatex
  pdf_document:
    toc: yes
    toc_depth: '3'
bibliography: protein.bib
csl: jama.csl
link-citations: yes
workflowr:
  suppress_report: false
nocite: '@*'
---

#### 

```{=html}
<style type="text/css">
  body{
  font-size: 9.5pt;
  font-family: Source Sans Pro;
}

.list-group-item.active, .list-group-item.active:hover, .list-group-item.active:focus {
  color: #090909;
  background-color: #0909093d;
}

.lightable-classic.lightable-hover tbody tr:hover {
    background-color: #c5d4e4;
}
.btn-xs, .btn-group-xs>.btn { 
display: none; 
}

.btn-default {
display: none !important; 
}
</style>
```

```{r setupData, include = FALSE}
## * (updated 2021/01/06 11:34) preliminaries -------------------------------
# functions
now <- function() {str_replace_all(format(Sys.time(), "%m %d %y_%H-%M"), " ", "_")}
m_table <- function(data, x){
  group_by(data, arm_tx) %>%
    summarise(tx_count = n())
}
# replace_mg <- function(a, b) {if_else(is.na(a) & !is.na(b), b, a)}
tab_inc <- function() {
  table_n <- table_n + 1
  table_n}
fig_inc <- function() {
  figure_n <- figure_n + 1
  figure_n}
table_n <- 1
figure_n <- 1

## * get current files; select cho refids; directory must have unique ####
source("code/readFiles_120220_wfr.R")

# study char cho refs 
study_char_prot.dat <- study_char.dat %>% 
  filter(refid %in% protein_refids)

# study arm protein refs 
study_arm_prot.dat <- study_arm.dat %>%
  filter(refid %in% protein_refids) %>%
  # remove Awad other, no "other" category
  filter(arm_tx != "other") %>%
  # remove duplicate arms tewari 2019 (refid 716)
  filter(!(refid == 716 & arm_n == 8)) %>%
  mutate(
    study = ifelse(refid == 2564 & grepl("colorectal", notes_arm), paste(study, "(CR)"), study),
    study = ifelse(refid == 2564 & grepl("cholecystectomy", notes_arm), paste(study, "(CH)"), study),
    study = ifelse(refid == 1926 & grepl("general", notes_arm), paste(study, "(gen)"), study),
    study = ifelse(refid == 1926 & grepl("epidural", notes_arm), paste(study, "(epi)"), study)
  ) %>%
  mutate(tx = factor(arm_tx,
    levels = c(
      "fasting",
      "water",
      "placebo",
      "other_clear",
      "milk",
      "prot",
      "prot_simp",
      "prot_comp",
      "cho_simp",
      "cho_comp"
    )
  )) %>%
  mutate(
    tx = fct_recode(tx,
      Fasting = "fasting",
      Water = "water",
      Placebo = "placebo",
      Clear = "other_clear",
      Milk = "milk",
      "Prot" = "prot",
      "CHO/Comp/Prot" = "prot_comp",
      "CHO/Simp/Prot" = "prot_simp",
      "CHO/Simp" = "cho_simp",
      "CHO/Comp" = "cho_comp",
    ),
    arm_tx = tx
  ) %>%
  select(-tx) 

# tewari 2019
study_arm_prot_tewari.dat <- study_arm.dat %>% 
  filter(refid == 716)

## * dichot factor treatment arm outcome type for ordering (updated 2020/12/12 12:04) ####
# save dichot.dat 
dichot_prot.dat <- dichot.dat %>%
  filter(refid %in% protein_refids) %>%
  # remove Awad other, no "other" category
  filter(arm_tx != "other") %>%
  # factor arm_tx levels for cho studies
  mutate(tx = factor(arm_tx,
    levels = c(
      "fasting",
      "water",
      "placebo",
      "other_clear",
      "milk",
      "prot",
      "prot_simp",
      "prot_comp",
      "cho_simp",
      "cho_comp"
    )
  )) %>%
  mutate(
    tx = fct_recode(tx,
      Fasting = "fasting",
      Water = "water",
      Placebo = "placebo",
      Clear = "other_clear",
      Milk = "milk",
      "Prot" = "prot",
      "CHO/Comp/Prot" = "prot_comp",
      "CHO/Simp/Prot" = "prot_simp",
      "CHO/Simp" = "cho_simp",
      "CHO/Comp" = "cho_comp",
    ),
    arm_tx = tx
  ) %>%
  select(-tx)

dichot_prot.dat %>% tabyl(arm_tx)

## * contin factor treatment arm outcome type for ordering (updated 2020/12/12 12:04) ####
contin_prot.dat <- contin.dat %>% 
  filter(refid %in% protein_refids) %>% 
  # remove Awad other, no "other" category
  filter(arm_tx != "other") %>%
  # factor arm_tx levels for cho studies
  mutate(tx = factor(arm_tx,
  levels = c(
    "fasting",
    "water",
    "placebo",
    "other_clear",
    "milk",
    "prot",
    "prot_simp",
    "prot_comp",
    "cho_simp",
    "cho_comp"))) %>%
  mutate(tx = fct_recode(tx,
    Fasting = "fasting",
    Water = "water",
    Placebo = "placebo",
    Clear = "other_clear",
    Milk = "milk",
    "Prot" = "prot",
    "CHO/Simp/Prot" = "prot_simp",
    "CHO/Comp/Prot" = "prot_comp",
    "CHO/Simp" = "cho_simp",
    "CHO/Comp" = "cho_comp",
    ),
    arm_tx = tx,
    arm_tx = fct_relevel(arm_tx, c("CHO/Simp/Prot", "CHO/Comp/Prot"), after = 8)) %>%
  select(-tx)

contin_prot.dat %>% tabyl(arm_tx)

## * likert factor treatment arm outcome type for ordering (updated 2020/12/12 12:04) ####
likert_prot.dat <- likert.dat %>% 
  filter(refid %in% protein_refids) %>% 
  # remove Awad other, no "other" category
  filter(arm_tx != "other") %>%
  # factor arm_tx levels for cho studies
  mutate(tx = factor(arm_tx,
  levels = c(
    "fasting",
    "water",
    "placebo",
    "other_clear",
    "milk",
    "prot",
    "prot_simp",
    "prot_comp",
    "cho_simp",
    "cho_comp"))) %>%
  mutate(tx = fct_recode(tx,
    Fasting = "fasting",
    Water = "water",
    Placebo = "placebo",
    Clear = "other_clear",
    Milk = "milk",
    "Prot" = "prot",
    "CHO/Simp/Prot" = "prot_simp",
    "CHO/Comp/Prot" = "prot_comp",
    "CHO/Simp" = "cho_simp",
    "CHO/Comp" = "cho_comp",),
    arm_tx = tx) %>%
  select(-tx)

likert_prot.dat %>% tabyl(arm_tx)

## * divide Sada 2014 and Celiksular 2016 into 2 studies ------------------
likert_prot.dat <- likert_prot.dat %>%
  mutate(
    study = ifelse(study == "Sada 2014" & grepl("cholecystectomy", out_l_notes), "Sada 2014 (CH)", study),
    study = ifelse(study == "Sada 2014" & !grepl("cholecystectomy", out_l_notes), "Sada 2014 (CR)", study),
    study = ifelse(study == "Celiksular 2016" & grepl("general", out_l_notes), "Celiksular 2016 (G)", study),
    study = ifelse(study == "Celiksular 2016" & grepl("epidural", out_l_notes), "Celiksular 2016 (E)", study)
  )

contin_prot.dat <- contin_prot.dat %>%
  mutate(
    study = ifelse(study == "Sada 2014" & grepl("cholecystectomy", notes_continuous), "Sada 2014 (CH)", study),
    study = ifelse(study == "Sada 2014" & !grepl("cholecystectomy", notes_continuous), "Sada 2014 (CR)", study),
    study = ifelse(study == "Celiksular 2016" & grepl("general", notes_continuous), "Celiksular 2016 (G)", study),
    study = ifelse(study == "Celiksular 2016" & grepl("epidural", notes_continuous), "Celiksular 2016 (E)", study)
  )

dichot_prot.dat <- dichot_prot.dat %>%
  mutate(
    study = ifelse(study == "Sada 2014" & grepl("cholecystectomy", out_dichot_notes), "Sada 2014 (CH)", study),
    study = ifelse(study == "Sada 2014" & !grepl("cholecystectomy", out_dichot_notes), "Sada 2014 (CR)", study),
    study = ifelse(study == "Celiksular 2016" & grepl("general", out_dichot_notes), "Celiksular 2016 (G)", study),
    study = ifelse(study == "Celiksular 2016" & grepl("epidural", out_dichot_notes), "Celiksular 2016 (E)", study)
  )


```

# **Included Studies** 

<br/>

<font size = 4> Table `r table_n`. Number of included studies according to age, surgery, and design. </font>

```{r tablesIncluded, include = TRUE, echo = FALSE} 
## (updated 2021/04/21 08:25) Included Studies ----------------------------
# list of studies, age, surgical/non surgical, design 
study_char_prot.dat %>%
  group_by(age, surg_nosurg, design, .groups = "drop") %>%
  summarise(total = n()) %>%
  ungroup() %>%
  arrange(age, desc(surg_nosurg), design) %>%
  group_by(age, surg_nosurg, .groups = "drop") %>%
  mutate(row = row_number()) %>%
  ungroup() %>%
  janitor::adorn_totals("row") %>%
  mutate(
    age = ifelse(row != 1, NA, age),
    surg_nosurg = ifelse(row != 1, NA, surg_nosurg),
    surg_nosurg = firstup(surg_nosurg),
    design = case_when(
      design == "rct" ~ "RCT",
      design == "crossover" ~ "Crossover",
      design == "cluster" ~ "Cluster",
      design == "nrsi" ~ "Nonrandomized",
      design == "prospect_coh" ~ "Prospective Cohort",
      design == "retrospect_coh" ~ "Retrospective Cohort",
      design == "casecontrol" ~ "Case-Control",
      design == "other" ~ "Before-After"),
      age = ifelse(row_number() == n(), "Total", age)
  ) %>%
  select(age, surg_nosurg, design, total) %>%
  kbl(
    booktabs = T, align = c("lllr"),
    col.names = c("Age", "Patients", "Design", "N")
  ) %>%
  row_spec(c(0, 7), bold = TRUE) %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "8em") %>%
  column_spec(2, width = "8em") %>%
  column_spec(3, width = "10em") %>%
  column_spec(4, width = "3em")

table_n <- tab_inc()
```

<br/>

<br/>

## Adult Surgical

<br/>

<font size = 4> Table `r table_n`. Studies of adults undergoing surgery (see [References](#references) for citations). </font>

```{r studiesIncludedList, echo = FALSE, include = TRUE}
## * (updated 2021/04/21 08:24) included_studies ----------------------------
included_studies <- study_char_prot.dat %>%
  select(refid, study, year, age, surg_nosurg, design, n_analyze, country, centers, non_vh_hdi, surg_type) %>%
  mutate(
    surg = case_when(
      str_detect(surg_type, "[Gg]yn|[Hh]ysterectomy") ~ "Gyn",
      str_detect(surg_type, "craniotomy") ~ "Neurosurgical",
      str_detect(surg_type, "maxillofacial") ~ "Maxillofacial",
      str_detect(surg_type, "[Hh]ernia|herniorrhaphy") ~ "Herniorrhaphy",
      str_detect(surg_type, "prostatectomy") ~ "Prostatectomy",
      str_detect(surg_type, "ariety") ~ "Various",
      str_detect(surg_type, "various|Hirschsprung's") ~ "Various",
      str_detect(surg_type, "CABG|[Cc]oronary artery bypass surgery") ~ "CABG",
      str_detect(surg_type, "Cardiac surgery") ~ "Cardiac",
      str_detect(surg_type, "[Cc]olorectal|[Bb]owel|colon resection") ~ "Colorectal",
      str_detect(surg_type, "[Tt]hyroid|hip joint") ~ "Thyroid",
      str_detect(surg_type, "[Oo]rthopedic|discectomy") ~ "Orthopedic",
      str_detect(surg_type, "total hip or total knee replacement|[Tt]otal hip|[Tt]otal knee|Hip joint|hip replacement") ~ "TKA/THA",
      str_detect(surg_type, "cholecystectomy") ~ "Cholecystectomy",
      str_detect(surg_type, "pancreaticoduodenectomy") ~ "Whipple",
      str_detect(surg_type, "[Gg]ast|Bowel") ~ "Other GI",
      str_detect(surg_type, "not appli") ~ "None (healthy)",
      str_detect(surg_type, "oral") ~ "Oral",
      str_detect(surg_type, "minor") ~ "Misc minor",
      str_detect(surg_type, "None") ~ "None (healthy)",
      str_detect(surg_type, "abdomin") ~ "Other GI",
      str_detect(surg_type, "[Cc]esarean") ~ "Cesarean delivery",
      str_detect(surg_type, "[Cc]aesarian") ~ "Cesarean delivery",
      str_detect(surg_type, "[Ll]abor") ~ "Labor",
      str_detect(surg_type, "thoracotomy") ~ "Thoracic",
      str_detect(surg_type, "healthy") ~ "None (healthy)",
      str_detect(surg_type, "Elective") ~ "Elective",
      str_detect(surg_type, "adenotonsillectomy") ~ "Adenotonsillectomy",
      str_detect(surg_type, "[Bb]reast") ~ "Breast",
      str_detect(surg_type, "Endso|endoscopic|colonoscopy") ~ "Endoscopic"
    ),
    surg_nosurg = ifelse(surg_nosurg == "non-surgical", "None", surg_nosurg),
    study = ifelse(grepl("Marquini", study), str_c(study, "^b^"), study),
    country = ifelse(grepl("USA", country), "USA", country),
    country = ifelse(grepl("UK", country), "UK", country),
    country = ifelse(!is.na(non_vh_hdi), str_c(country, "^a^"), country),
    n_analyze = ifelse(refid == 2009, 9, n_analyze)
  ) 

## (updated 2021/04/21 08:25) adult surgical ------------------------------
included_studies %>% 
  arrange(age, design, surg, country, year, study) %>%
  filter(age == "Adult", surg_nosurg == "surgical") %>% 
  select(refid, study, n_analyze, centers, country, surg) %>%
  kbl(
    booktabs = T, align = c("llccll"), # format = "latex",
    col.names = c("\\ \\ \\ \\ \\ \\ \\ \\ ID", "Study", "Analyzed (N)", "Centers", "Country^a^", "Surgery")
  ) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "6em") %>%
  column_spec(2, width = "10em") %>%
  column_spec(3, width = "6em") %>%
  column_spec(4, width = "6em") %>%
  column_spec(5, width = "10em") %>%
  column_spec(6, width = "12em") %>%
  pack_top(., "Adult, Surgical", 1, 22) %>%
  pack_sub(., "RCT", 1, 20) %>%
  pack_sub(., "Nonrandomized Studies of Interventions", 21, 21) %>%
  pack_sub(., "Retrospective Cohort", 22, 22) %>%
  footnote(
    alphabet = c(
      "Non very high [Human Development Index](https://en.wikipedia.org/wiki/List_of_countries_by_Human_Development_Index) country."
    ,
    "Multiple publications of the same study."),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

## Adult Nonsurgical

<br/>

<font size = 4> Table `r table_n`. Studies of healthy adults not undergoing surgery (see [References](#references) for citations). </font>

```{r studiesAdultNonsurg, echo = FALSE, include = TRUE}
## (updated 2021/04/21 08:25) adult nonsurgical ---------------------------
included_studies %>% 
  arrange(age, design, country, year, study) %>%
  filter(age == "Adult", surg_nosurg == "None") %>% 
  select(refid, study, n_analyze, centers, country, surg) %>%
  kbl(
    booktabs = T, align = c("llccll"), 
    col.names = c("\\ \\ \\ \\ \\ \\ \\ \\ ID", "Study", "Analyzed (N)", "Centers", "Country^a^", "Surgery")
  ) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "6em") %>%
  column_spec(2, width = "10em") %>%
  column_spec(3, width = "6em") %>%
  column_spec(4, width = "6em") %>%
  column_spec(5, width = "10em") %>%
  column_spec(6, width = "12em") %>%
  pack_top(., "RCT", 1, 1) %>%
  pack_top(., "Crossover", 2, 7) %>%
  footnote(
    alphabet = c(
      "Non very high [Human Development Index](https://en.wikipedia.org/wiki/List_of_countries_by_Human_Development_Index) country."
    ),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

## Pediatric Surgical

<br>

<font size = 4> No studies identified. </font>

<br>

## Pediatric Nonsurgical

<br/>

<font size = 4> Table `r table_n`. Stud of healthy pediatric individuals not undergoing surgery (see [References](#references) for citations). </font>

```{r studiesPedsNonsurg, echo = FALSE, include = TRUE}
## (updated 2021/04/21 08:25) pediatric surgical --------------------------
included_studies %>% 
  filter(age == "Pediatric", surg_nosurg == "None") %>% 
  select(refid, study, n_analyze, centers, country, surg) %>%
  kbl(
    booktabs = T, align = c("llccll"), # format = "latex",
    col.names = c("\\ \\ \\ \\ \\ \\ \\ \\ ID", "Study", "Analyzed (N)", "Centers", "Country", "Surgery")
  ) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "6em") %>%
  column_spec(2, width = "10em") %>%
  column_spec(3, width = "6em") %>%
  column_spec(4, width = "6em") %>%
  column_spec(5, width = "10em") %>%
  column_spec(6, width = "12em") %>%
  pack_top(., "RCT", 1, 1)

table_n <- tab_inc()
```

<br/>

<hr style="height:2px;border-width:0;color:gray;background-color:gray">

# **Patient Reported Outcomes** 

```{r dichotChoDataSurgical, include = FALSE}
## * (updated 2021/01/12 09:26; in temp_to_run) dichotProtDataNonSurgical ----------------------
dichot_nonsurg_prot.dat <- dichot_prot.dat %>%
  # only Jian 2017, non-surgical, reported any pro (hunger thirst) and was not included
  filter(surg_nosurg == "non-surgical") %>%
  mutate(
    hunger_np = n_percent(hunger_n, hunger_per),
    thirst_np = n_percent(thirst_n, thirst_per),
    nausea_np = n_percent(nausea_n, nausea_per),
    vomit_np = n_percent(vomit_n, vomit_per),
    comfort_np = n_percent(arm_n - comfort_n, 100 - comfort_per),
    satisfac_np = n_percent(satisfac_n, satisfac_per),
    complicate_np = n_percent(complicate_n, complicate_per),
    hypotension_np = n_percent(hypotension_n, hypotension_per),
    regurg_np = n_percent(regurg_n, regurg_per),
    rgv_gt25_np = n_percent(rgv_gt25_n, rgv_gt25_per),
    ph_lt25_np = n_percent(ph_lt25_n, ph_lt25_per),
    aspirate_np = n_percent(aspirate_n, aspirate_per),
    vomit_np = ifelse(refid == 6446 & arm_n == 40, "4 (10)", vomit_np)) %>%
  arrange(age, desc(surg_nosurg), design, year, study, arm_tx, arm) %>%
  select(refid, study, year, age, design, surg_nosurg, arm, arm_n, arm_tx, hr_gt6, hr_26, hr_2, time_outcome, hunger_np:aspirate_np, compl_descript, out_dichot_notes, ends_with("_n"), timeingest1, amtingest1, timeingest2, amtingest2, ends_with("per")) %>%
  filter_at(vars(hunger_np:aspirate_np), any_vars(!is.na(.)))

## * (updated 2021/01/12 09:26; in temp_to_run) dichotProtDataSurgical ----------------------
dichot_prot.dat <- dichot_prot.dat %>%
  filter(surg_nosurg == "surgical") %>%
  mutate(
    hunger_np = n_percent(hunger_n, hunger_per),
    thirst_np = n_percent(thirst_n, thirst_per),
    nausea_np = n_percent(nausea_n, nausea_per),
    vomit_np = n_percent(vomit_n, vomit_per),
    comfort_np = n_percent(arm_n - comfort_n, 100 - comfort_per),
    satisfac_np = n_percent(satisfac_n, satisfac_per),
    complicate_np = n_percent(complicate_n, complicate_per),
    hypotension_np = n_percent(hypotension_n, hypotension_per),
    regurg_np = n_percent(regurg_n, regurg_per),
    rgv_gt25_np = n_percent(rgv_gt25_n, rgv_gt25_per),
    ph_lt25_np = n_percent(ph_lt25_n, ph_lt25_per),
    aspirate_np = n_percent(aspirate_n, aspirate_per),
    vomit_np = ifelse(refid == 6446 & arm_n == 40, "4 (10)", vomit_np)) %>%
  arrange(age, desc(surg_nosurg), design, year, study, arm_tx, arm) %>%
  select(refid, study, year, age, design, surg_nosurg, arm, arm_n, arm_tx, hr_gt6, hr_26, hr_2, time_outcome, hunger_np:aspirate_np, compl_descript, out_dichot_notes, ends_with("_n"), timeingest1, amtingest1, timeingest2, amtingest2, ends_with("per")) %>%
  filter_at(vars(hunger_np:aspirate_np), any_vars(!is.na(.)))

## * (updated 2021/03/10 13:29; in temp_to_run) cho_amts adult rct ----------------------------
cho_amts <- study_arm_prot.dat %>%
  filter(design == "rct", age == "Adult", surg_nosurg == "surgical") %>%
  filter(arm_tx %in% c("CHO/Comp/Prot", "CHO/Simp/Prot", "CHO/Comp", "CHO/Simp")) %>%
  filter(refid %in% protein_refids) %>%
  mutate(
    amtingest2 = replace_na(amtingest2, 0),
    amtingest1 = replace_na(amtingest1, 0),
    tot_vol = amtingest2 + amtingest1,
    prot_gm_all = prot_conc * tot_vol / 100,
    cho_gm_all = cho_conc * tot_vol / 100,
    cho_gm_1 = cho_conc * amtingest1 / 100,
    cho_gm_2 = cho_conc * amtingest2 / 100,
    cho_gm_all = ifelse(is.na(cho_gm_all), cho_gm, cho_gm_all),
    prot_gm_all = ifelse(is.na(prot_gm_all), protein_gm, prot_gm_all)) %>%
  select(refid, study, arm_tx, arm, cho_gm, protein_gm, prot_gm_all, cho_gm_all, cho_gm_1, cho_gm_2, amtingest1, amtingest2, prot_conc, cho_conc)

```

<br/>

## *Hunger* 

### Rates <a id="protHungRate5"></a>

<br/>

<font size = 4> Table `r table_n`. Rates of preoperative hunger according to fasting, liquid and volume. </font>

```{r hungerTableOr, include = TRUE}
## (updated 2021/01/12 09:42) hungerTableOr -------------------------------
dichot_format <- function(x) (x/100)

# odds ratios
# exclude single arm studies
# select refid, study, arm_tx, arm_n, outcome_n
dichot_hunger_or <- dichot_prot.dat %>% 
  filter(!is.na(hunger_np)) %>%
  select(refid, study, arm_tx, arm_n, hunger_n) %>% 
  group_by(refid) %>% 
  filter(n() > 1)

or_hunger <- with(or_join(dichot_hunger_or, "hunger"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2))

```

```{r hungerTableDichot, include = TRUE}
## (updated 2021/01/12 18:04) hungerRatesTable ---------------------------------
dichot_hunger <- dichot_prot.dat %>% 
  filter(!is.na(hunger_np)) %>%
  arrange(age, desc(surg_nosurg), design, year, study) %>% 
  select(refid:time_outcome, hunger_np, hunger_per, hunger_n)

dichot_hunger <- left_join(dichot_hunger, or_hunger, by = "refid") %>%
  mutate(pre_post_op = ifelse(time_outcome > 0, "Postop", "Preop")) %>%
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    or_ci = ifelse(row_number() == 1, or_ci, NA),
    time_outcome = ifelse(row_number() == 1, time_outcome, NA),
    # pre_post_op = ifelse(row_number() == 1, pre_post_op, NA)
  ) %>%
  ungroup() %>%
  mutate(hunger_per = round(hunger_per, 0)) %>%
  select(refid, arm, design, age, study, arm_n, arm_tx, starts_with("hr"), pre_post_op, time_outcome, hunger_np, hunger_per, or_ci)

prot_row <- dichot_hunger %>%
  mutate(line = row_number()) %>%
  filter(grepl("Prot", arm_tx)) %>%
  pull(line)

dichot_hunger$hunger_bar <- 0
dichot_hunger$hunger_bar <- ifelse(grepl("CHO", dichot_hunger$arm_tx),
  color_bar("darksalmon", fun = dichot_format)(dichot_hunger$hunger_per),
  color_bar("lightgray", fun = dichot_format)(dichot_hunger$hunger_per))

dichot_hunger  <- dichot_hunger %>% 
  add_foot(study, "Koeppe 2013", "a") %>% 
  mutate(hunger_bar = str_replace(hunger_bar, ">[0-9][0-9]", ">&nbsp;"))
  
## (updated 2021/04/21 09:07) hungerRateskable ---------------------------------------
dichot_hunger %>%
  filter(pre_post_op != "Postop") %>%
  mutate(
    arm_tx = as.character(arm_tx)
  ) %>%
  select(!c(refid, arm, design, age, hunger_per, time_outcome, pre_post_op)) %>%
  select(study, arm_tx, arm_n:hunger_np, hunger_bar, or_ci) %>%
  kbl(
    booktabs = T, align = c("llccccrlc"), escape = FALSE,
    col.names = c("\\ \\ \\ \\ \\ \\ \\ Study", "Liquid", "N", "> 6", "6→2", "≤ 2", "N (%)", " ", "CHO vs. Comparator")
  ) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Hunger" = 2, "OR (95% CI)"), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4, 6), width = "3em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(7, width = "5em") %>%
  column_spec(8, width = "5em") %>%
  column_spec(9, width = "11em") %>%
  row_spec(prot_row, color = "brown") %>%
  pack_top(., "Adult, Surgical", 1, 2) %>%
  pack_sub(., "RCT", 1, 2) %>%
  footnote(
    general = "RCT: randomized controlled trial; OR: odds ratio; CHO: carbohydrate; Comp: complex; Prot: protein.",
    alphabet = c(
      "'Did you feel hunger during the fasting period?'"
    ),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

### Patient-rated  <a id="protHungRating6"></a>

<br/>

<font size = 4> Table `r table_n`. Patient-rated hunger (preoperative in surgical studies and after 2 hours in nonsurgical study) according to fasting, liquid and volume. </font>

```{r hungerTableLikert, include = TRUE}
## (updated 2021/01/13 05:51) hungerLikert --------------------------------
likert_prot_hung.dat <- likert_prot.dat %>%
  filter(refid %in% protein_refids) %>%
  filter(hunger_l == "hunger_l") %>%
  # filter_at(vars(hunger_m:hunger_pval), any_vars(!is.na(.))) # 1290 not incpuded as RR in notes field
  select(refid:age, arm_n, arm_tx, starts_with("hr_"), likert_time_outcome, contains("ingest"), starts_with("hunger"), out_l_notes) %>%
  mutate(arm_tx = droplevels(arm_tx)) %>%
  # fill in any misssing timeoutcomes
  group_by(refid) %>%
  fill(likert_time_outcome) %>%
  ungroup() %>%
  mutate(
    pre_post_op = ifelse(likert_time_outcome > 1, "Postop", "Preop"),
    pre_post_op = ifelse(refid == 4952, "Preop", pre_post_op),
    pre_post_op = ifelse(surg_nosurg == "non-surgical", likert_time_outcome, pre_post_op)
  ) %>%
  arrange(age, desc(surg_nosurg), design, desc(pre_post_op), year, study, arm_tx)

likert_prot_hung_kbl.dat <- likert_prot_hung.dat %>%
  rename(time_outcome = likert_time_outcome) %>%
  # filter(surg_nosurg == "surgical") %>%
  select(refid:arm_tx, starts_with("hr_"), time_outcome, pre_post_op, hunger_scale, hunger_m:hunger_iqru) %>%
  mutate(
    # save hunger_med value
    hung_md = hunger_med,
    hunger_med = paste0(hunger_med, " (", round_0(hunger_iqrl), "-", round_0(hunger_iqru), ")"),
    hunger_med = ifelse(refid %in% c(3588), paste0(hung_md, " (", round_1(hunger_iqrl), "-", round_1(hunger_iqru), ")"), hunger_med),
    hunger_med = ifelse(hunger_med == "NA (NA-NA)", NA, hunger_med),
    hunger_med = gsub(" \\(NA-NA\\)", "", hunger_med),
    ranges = str_c("(", round_0(hunger_rl), "-", round_0(hunger_ru), ")"),
    hunger_sd = ifelse(is.na(hunger_sd) & !is.na(hunger95u), sd_confint(hunger95l, hunger95u), hunger_sd),
    mn_95_ci = str_c(round_1(hunger_m), " (", round_1(hunger95l), "-", round_1(hunger95u), ")"),
    mn_95_ci = ifelse(!is.na(hunger_m) & !is.na(hunger_sd), str_c(round_1(hunger_m), " (", round_1(hunger_m - (1.96 * hunger_sd)), "-", round_1(hunger_m + (1.96 * hunger_sd)), ")"), mn_95_ci),
    mn_95_ci = ifelse(mn_95_ci == "NA (NA-NA)", NA, mn_95_ci),
    mn_95_ci = str_replace(mn_95_ci, "\\(NA-NA\\)", ""),
    # mn_sd = NA,
    mn_sd = ifelse(!is.na(hunger_sd) & !is.na(hunger_m), paste0(round_1(hunger_m), " (", round_1(hunger_sd), ")"), round_2(hunger_m)),
    mn_sd = na_if(mn_sd, " NA"), 
    hunger_med = str_replace(hunger_med, "\\(NA-NA\\)", ""),
    ranges = str_replace(ranges, "\\(NA-NA\\)", ""),
    # NOTE: footnote e: Hunger Satiety Scale
    hunger_scale = ifelse(hunger_scale == "VAS: 0 to 100", "0→100", hunger_scale),
    hunger_scale = ifelse(hunger_scale == "VAS, 0-100", "0→100", hunger_scale),
    hunger_scale = ifelse(hunger_scale == "VAS, 0 to 100", "0→100", hunger_scale),
    hunger_scale = ifelse(hunger_scale == "VAS, 0 to 10", "0→10", hunger_scale),
    hunger_scale = ifelse(hunger_scale == "VAS, 1 to 10", "0→10", hunger_scale),
    hunger_scale = ifelse(hunger_scale == "VAS, 0-10", "0→10", hunger_scale),
    hunger_scale = ifelse(hunger_scale == "NRS, 0 to 10", "0→10^NRS^", hunger_scale),
    hunger_scale = ifelse(hunger_scale == "NRS, 0 to 2", "0→2^NRS^", hunger_scale),
    hunger_scale = ifelse(hunger_scale == "NRS, 0 to 3", "0→3^NRS^", hunger_scale),
    hunger_scale = ifelse(hunger_scale == "Likert, 0 to 3", "0→3^NRS^", hunger_scale),
    hunger_scale = ifelse(refid == 3588, "1→5^NRS^", hunger_scale),
    hunger_scale = ifelse(refid == 1315, "5→1^HSS^", hunger_scale),
    hunger_med = ifelse(grepl("(AM)", study) & arm_tx == "Fasting", str_c(hunger_med, "^d^"), hunger_med),
    hunger_med = ifelse(grepl("(PM)", study) & arm_tx == "Fasting", str_c(hunger_med, "^d^"), hunger_med),
  ) %>%
  arrange(age, desc(surg_nosurg), design, desc(pre_post_op), year, study) %>%
  filter(pre_post_op %in% c("Preop", "2")) %>% 
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    hunger_scale = ifelse(row_number() == 1, hunger_scale, NA),
    # time_outcome = ifelse(row_number() == 1, time_outcome, NA),
    # pre_post_op = ifelse(row_number() == 1, pre_post_op, NA),
    # for non-surgical use hr_26 as amount
	  hr_26 = ifelse(surg_nosurg == "non-surgical", hr_0, hr_26),
  ) %>%
  ungroup() %>% 
  select(-c(hr_minus2, hr_0))

```

```{r hungerLikertSurgKable, echo = FALSE}
## (updated 2020/12/13 13:48) hungerLikertSurgKable ------------------------
# fix footnotes
likert_prot_hung_kbl.dat <- likert_prot_hung_kbl.dat %>% 
  mutate(hunger_med = str_replace(hunger_med, "\\^d\\^", "\\^c\\^"))

prot_row <- likert_prot_hung_kbl.dat %>%
  mutate(line = row_number()) %>%
  filter(grepl("Prot", arm_tx)) %>%
  pull(line)

likert_prot_hung_kbl.dat %>%
  select(study, arm_tx, arm_n, hr_gt6, hr_26, hr_2, hunger_scale, mn_sd, hunger_med, ranges) %>%
  add_row() %>%
kbl(
    booktabs = T, align = c("llcccclll"), escape = FALSE,
    col.names = c(
      "\\ \\ \\ \\ \\ \\ \\ Study", "Liquid", "N", "> 6", "6→2", "≤ 2", "Scale^a^", "M (SD)",
      "Med (IQR)", "Range"
    )
  ) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Hunger Rating" = 4), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  # NOTE: footnote a: includes at 2.5 hours
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4,6), width = "3em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(7, width = "4em") %>%
  column_spec(8, width = "6em") %>%
  column_spec(9, width = "7em") %>%
  column_spec(10, width = "7em") %>%
  row_spec(prot_row, color = "brown") %>%
  pack_top(., "Adult, Surgical", 1, 8) %>%
  pack_sub(., "RCT", 1, 4) %>%
  result_pack("P = .001, MD^b^  ≈ -31.1 (95% CI, -36.9 to -25.3)", 3, padding = 68) %>% 
  result_pack("P = NS, MD^b^  ≈ -11.2", 5, padding = 68) %>% 
  pack_sub(., "Nonrandomized Studies of Interventions", 5, 8) %>%
  result_pack("P = NS, MD^b^  ≈ 0.5 (95% CI, -1.1 to 2.1)", 7, padding = 68) %>% 
  result_pack("P = NS, MD^b^  ≈ 1.0 (95% CI, -0.4 to 2.4)", 9, padding = 68) %>% 
  pack_top(., "Pediatric, Nonsurgical (age 8-14 years)", 9, 11) %>%
  result_pack("2 hr after liquids", 9, padding = 62, italic = FALSE, color = "black", bold = TRUE) %>% 
  result_pack("CHO/Simp/Prot vs. CHO/Simp or milk, p = 0.78", 12, padding = 65) %>% 
  footnote(
    general = "RCT: randomized controlled trial; M: mean; SD: standard deviaion; Med: median; IQR: interquartile range; NRS: numeric rating scale; MD: mean difference; HSS: hunger satiety scale.",
    alphabet = c(
      "Arrow (→) indicates best to worst hunger (visual analogue if not noted NRS).",
      "Estimated using reported medians, IQRs, and ranges.",
      "IQR bound outside range of scale used."
    ),
    general_title = "",
    footnote_as_chunk = FALSE
  )

  table_n <- tab_inc()
```

<br/>

## *Thirst* 

### Rates <a id="protThirstRate7"></a> 

<br/>

<font size = 4> Table `r table_n`. Rates of preoperative thirst according to fasting, liquid and volume. </font>

```{r thirstTableOr, include = TRUE}
## (updated 2021/01/13 08:52) thirstTableOr -------------------------------
dichot_format <- function(x) (x/100)

# odds ratios
# exclude single arm studies
# select refid, study, arm_tx, arm_n, outcome_n
dichot_thirst_or <- dichot_prot.dat %>% 
  filter(!is.na(thirst_np)) %>%
  select(refid, study, arm_tx, arm_n, thirst_n) %>% 
  group_by(refid) %>% 
  filter(n() > 1)

or_thirst <- with(or_join(dichot_thirst_or, "thirst"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2))

```

```{r thirstTable, include = TRUE}
## (updated 2021/01/12 18:04) thirstTable ---------------------------------
dichot_thirst <- dichot_prot.dat %>% 
  filter(!is.na(thirst_np)) %>%
  select(refid:time_outcome, thirst_np, thirst_per, thirst_n)

dichot_thirst <- left_join(dichot_thirst, or_thirst, by = "refid") %>%
  mutate(pre_post_op = ifelse(time_outcome > 0, "Postop", "Preop")) %>%
  arrange(age, desc(surg_nosurg), design, desc(pre_post_op), year, study) %>% 
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    or_ci = ifelse(row_number() == 1, or_ci, NA),
    time_outcome = ifelse(row_number() == 1, time_outcome, NA),
    pre_post_op = ifelse(row_number() == 1, pre_post_op, NA)
  ) %>%
  ungroup() %>%
  mutate(thirst_per = round(thirst_per, 0)) %>%
  select(refid, arm, design, age, study, arm_n, arm_tx, starts_with("hr"), pre_post_op, time_outcome, thirst_np, thirst_per, or_ci)

prot_row <- dichot_thirst %>%
  mutate(line = row_number()) %>%
  filter(grepl("Prot", arm_tx)) %>%
  pull(line)

dichot_thirst$thirst_bar <- NA
dichot_thirst$thirst_bar <- ifelse(grepl("CHO", dichot_thirst$arm_tx),
  color_bar("darksalmon", fun = dichot_format)(dichot_thirst$thirst_per),
  color_bar("lightgray", fun = dichot_format)(dichot_thirst$thirst_per))

dichot_thirst$thirst_bar <- str_replace(dichot_thirst$thirst_bar, ">6<", ">&nbsp;<")

dichot_thirst <- dichot_thirst %>%
  # add_foot(study, "Koeppe 2013", "c") %>% # 'Did you feel thirst during the fasting period?
  mutate(
    thirst_bar = str_replace(thirst_bar, ">[0-9]{1,2}", ">&nbsp;"),
  )

dichot_thirst %>% 
  mutate(arm_tx = as.character(arm_tx)) %>% 
    select(!c(refid, arm, design, age, thirst_per, time_outcome, pre_post_op)) %>%
  select(study, arm_tx, arm_n:thirst_np, thirst_bar, or_ci) %>%
  kbl(
    booktabs = T, align = c("llccccrlc"), escape = FALSE,
    col.names = c("\\ \\ \\ \\ \\ \\ \\ Study", "Liquid", "N", "> 6", "6→2", "≤ 2", "N (%)", " ", "CHO vs. Comparator")
  ) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Endoscopy (hr)" = 3, "Thirst" = 2, "OR (95% CI)"), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4, 6), width = "3em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(7, width = "5em") %>%
  column_spec(8, width = "5em") %>%
  column_spec(9, width = "11em") %>%
  row_spec(prot_row, color = "brown") %>% 
  pack_top(., "Adult, Endoscopy", 1, 2) %>% 
  pack_sub(., "RCT", 1, 2) %>%
  footnote(general = "RCT: randomized controlled trial; OR: odds ratio; CHO: carbohydrate; Comp: complex; Prot: protein.",
           alphabet = c("Outcome assessed relative to surgery or endosocopy (Koeppe 2013).", 
                        "'Did you feel thirst during the fasting period?' (prior to endoscopy)."),
           general_title = "",  
           footnote_as_chunk = FALSE)

table_n <- tab_inc()
```

<br/>

### Patient-rated <a id="protThirstRating8"></a>

<br/>

<font size = 4> Table `r table_n`. Patient-rated preoperative thirst in adult surgical studies according to fasting, liquid and volume. </font>

```{r thirstTableLikert, include = TRUE}
## (updated 2021/01/13 05:51) thirstLikert --------------------------------
likert_prot_thirst.dat <- likert_prot.dat %>% 
  filter(refid %in% protein_refids) %>% 
  filter(thirst_l == "thirst_l") %>% 
  # filter_at(vars(thirst_m:thirst_pval), any_vars(!is.na(.))) %>% # identical n = 77 (2021/04/06 11:36)
  # fill in any misssing timeoutcomes
  group_by(refid) %>% 
  fill(likert_time_outcome) %>% 
  ungroup() %>% 
  mutate(pre_post_op = ifelse(likert_time_outcome > 1, "Postop", "Preop"),
         pre_post_op = ifelse(surg_nosurg == "non-surgical", likert_time_outcome, pre_post_op)) %>% 
  # select(refid, study, surg_nosurg, age, design, year, arm_tx, likert_time_outcome, pre_post_op) %>% 
  arrange(age, desc(surg_nosurg), design, desc(pre_post_op), year, study, arm_tx)

likert_prot_thirst_kbl.dat <- likert_prot_thirst.dat %>%
  rename(time_outcome = likert_time_outcome) %>%
  mutate(
    # surgical studies (note none have times 0 or negative)
    # hr_2 is ≤ 2; hr_26 is (2, 6] >2 to 6; hr_gt6 is >6
    hr_2 = 0, hr_26 = 0, hr_gt6 = 0,
    hr_2 = if_else(timeingest1 <= 2 & timeingest1 > 0, amtingest1, hr_2, missing = 0),
    hr_26 = if_else(timeingest1 > 2 & timeingest1 < 6, amtingest1, hr_26, missing = 0),
    hr_gt6 = if_else(timeingest1 >= 6, amtingest1, hr_gt6, missing = 0),
    hr_2 = if_else(hr_2 == 0 & timeingest2 <= 2 & timeingest2 > 0, amtingest2, hr_2, missing = 0),
    hr_26 = if_else(hr_26 == 0 & timeingest2 > 2 & timeingest2 < 6, amtingest2, hr_26, missing = 0),
    hr_gt6 = if_else(hr_gt6 == 0 & timeingest2 >= 6, amtingest2, hr_gt6, missing = 0),
    hr_gt6 = if_else(grepl("also received 300", type_ingest_1), 500, hr_gt6), # ) %>%  # Oyama PM
    # for nonsurgical
    hr_0 = 0, hr_minus2 = 0,
    hr_0 = if_else(surg_nosurg != "surgical" & timeingest1 == 0, amtingest1, hr_0, missing = 0),
    hr_minus2 = if_else(surg_nosurg != "surgical" & timeingest1 == -2, amtingest1, hr_minus2, missing = 0),
    hr_0 = if_else(surg_nosurg != "surgical" & timeingest2 == 0 & is.na(hr_0), amtingest2, hr_0, missing = 0),
    hr_minus2 = if_else(surg_nosurg != "surgical" & timeingest2 == -2 & is.na(hr_minus2), amtingest1, hr_minus2, missing = 0)
  ) %>%
  replace_with_na_at(.vars = c("hr_gt6", "hr_26", "hr_2"), condition = ~ .x == 0) %>%
  # filter(surg_nosurg == "surgical") %>%
  select(refid:age, arm_n, arm_tx, hr_gt6, hr_26, hr_2, hr_0, hr_minus2, pre_post_op, time_outcome, thirst_scale, thirst_m:thirst_iqru, out_l_notes) %>%
  mutate(
    thirst_md = thirst_med, # save thirst_med value
    thirst_med = paste0(thirst_med, " (", round_0(thirst_iqrl), "-", round_0(thirst_iqru), ")"),
    thirst_med = ifelse(refid %in% c(3588), paste0(thirst_md, " (", round_1(thirst_iqrl), "-", round_1(thirst_iqru), ")"), thirst_med),
    thirst_med = ifelse(thirst_med == "NA (NA-NA)", NA, thirst_med),
    thirst_med = gsub(" \\(NA-NA\\)", "", thirst_med),
    ranges = str_c("(", round_0(thirst_rl), "-", round_0(thirst_ru), ")"),
    thirst_sd = ifelse(is.na(thirst_sd) & !is.na(thirst95u), sd_confint(thirst95l, thirst95u), thirst_sd),
    mn_95_ci = str_c(round_1(thirst_m), " (", round_1(thirst95l), "-", round_1(thirst95u), ")"),
    mn_95_ci = ifelse(!is.na(thirst_m) & !is.na(thirst_sd), str_c(round_1(thirst_m), " (", round_1(thirst_m - (1.96 * thirst_sd)), "-", round_1(thirst_m + (1.96 * thirst_sd)), ")"), mn_95_ci),
    mn_95_ci = ifelse(mn_95_ci == "NA (NA-NA)", NA, mn_95_ci),
    mn_95_ci = str_replace(mn_95_ci, "\\(NA-NA\\)", ""),
    # mn_sd = NA,
    mn_sd = ifelse(!is.na(thirst_sd) & !is.na(thirst_m), paste0(round_1(thirst_m), " (", round_1(thirst_sd), ")"), round_2(thirst_m)),
    mn_sd = na_if(mn_sd, " NA"), 
    thirst_med = str_replace(thirst_med, "\\(NA-NA\\)", ""),
    ranges = str_replace(ranges, "\\(NA-NA\\)", ""),
    # thirst_scale = ifelse(grepl("VAS..0.*100", thirst_scale), "0→100", thirst_scale),
    thirst_scale = ifelse(thirst_scale == "VAS: 0 to 100", "0→100", thirst_scale),
    thirst_scale = ifelse(thirst_scale == "VAS, 0-100", "0→100", thirst_scale),
    thirst_scale = ifelse(thirst_scale == "VAS, 0 to 100", "0→100", thirst_scale),
    thirst_scale = ifelse(thirst_scale == "VAS, 0 to 10", "0→10", thirst_scale),
    thirst_scale = ifelse(thirst_scale == "VAS, 1 to 10", "1→10", thirst_scale),
    thirst_scale = ifelse(thirst_scale == "VAS, 0-10", "0→10", thirst_scale),
    thirst_scale = ifelse(thirst_scale == "VAS (0-10)", "0→10", thirst_scale),
    thirst_scale = ifelse(thirst_scale == "VAS 10 pt", "0→10", thirst_scale),
    thirst_scale = ifelse(thirst_scale == "NRS, 0 to 10", "0→10^NRS^", thirst_scale),
    thirst_scale = ifelse(thirst_scale == "NRS, 0 to 2", "0→2^NRS^", thirst_scale),
    thirst_scale = ifelse(thirst_scale == "NRS, 0 to 3", "0→3^NRS^", thirst_scale),
    thirst_scale = ifelse(thirst_scale == "Likert, 0 to 3", "0→3^NRS^", thirst_scale),
    thirst_scale = ifelse(refid == 3588, "1→5^NRS^", thirst_scale),
    thirst_med = ifelse(grepl("(AM)", study) & arm_tx == "Fasting", str_c(thirst_med, "^b^"), thirst_med),
    thirst_med = ifelse(grepl("(PM)", study) & arm_tx == "CHO/Simp/Prot", str_c(thirst_med, "^b^"), thirst_med),
  ) %>%
  arrange(age, desc(surg_nosurg), design, desc(pre_post_op), year, study) %>%
  # only preop
  filter(pre_post_op == "Preop") %>% 
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    thirst_scale = ifelse(row_number() == 1, thirst_scale, NA)
  ) %>%
  ungroup() 

```

```{r thirstAdultSurgKable, echo = FALSE}
## (updated 2020/12/13 13:48) thirstAdultSurgKable ------------------------
prot_row <- likert_prot_thirst_kbl.dat %>%
  mutate(line = row_number()) %>%
    filter(grepl("Prot", arm_tx)) %>%
    pull(line)

likert_prot_thirst_kbl.dat %>%
  mutate(
    # for non-surgical use hr_26 as amount
    hr_26 = ifelse(surg_nosurg == "non-surgical", hr_0, hr_26)
  ) %>%
  select(study, arm_tx, arm_n, hr_gt6, hr_26, hr_2, thirst_scale, mn_sd, thirst_med, ranges) %>%
  add_row() %>%
   kbl(
    booktabs = T, align = c("llcccclll"), escape = FALSE,
    col.names = c(
      "       Study", "Liquid", "N", "> 6", "6→2", "≤ 2", "Scale^a^", "M (SD)", "Med (IQR)", "Range"
    )
  ) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Thirst Rating" = 4), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  # NOTE: footnote a: includes at 2.5 hours
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4,6), width = "3em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(7, width = "4em") %>%
  column_spec(8, width = "6em") %>%
  column_spec(9, width = "7em") %>%
  column_spec(10, width = "6em") %>%
  row_spec(prot_row, color = "brown") %>%
  pack_top(., "Adult, Surgical", 1, 11) %>%
  pack_sub(., "RCT", 1, 7) %>%
  result_pack("Differences between groups not detected", 4, padding = 69) %>%
  result_pack("Lower ratings  with CHO, P = .01", 6, padding = 69) %>%
  # result_pack("P = .01, MD^c^ ≈  -13.3 (95% CI, -16.4 to -10.2)", 6, padding = 69) %>%
  result_pack("Difference between groups not detected", 8, padding = 69) %>%
  # result_pack("p = NS, MD^e^≈\ -10.6 (95% CI, -24.6 to 3.4)", 8, padding = 69) %>%
  pack_sub(., "Nonrandomized Studies of Interventions", 8, 11) %>%
  # result_pack("p = NS, MD^c^≈\ -0.5 (95% CI, -2.1 to 1.1)", 10, padding = 69) %>%
  # result_pack("p = NS, MD^c^≈\ -1.0 (95% CI, -2.2 to 0.2)", 12, padding = 69) %>%
  result_pack("Difference between groups not detected", 10, padding = 69) %>%
  result_pack("Difference between groups not detected", 12, padding = 69) %>%
  footnote(
    general = "RCT: randomized controlled trial; M: mean; SD: standard deviation;  Med: median; IQR: interquartile range; NRS: numeric rating scale; MD: mean difference; CHO: ",
    alphabet = c(
      "Arrow (→) indicates best to worst thirst (visual analogue if not noted NRS).",
      "IQR bound outside range of scale used.",
      "Estimated using reported medians, IQRs, and ranges."
    ),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()

```

<br/>

## *Nausea* 

### Rates <a id="protNauseaRate9"></a> 

<br/>

<font size = 4> Table `r table_n`. Rates of preoperative nausea according to fasting, liquid and volume. </font>

```{r nauseaTableOr, include = TRUE}
## (updated 2021/01/13 08:52) nauseaTable ---------------------------------
dichot_format <- function(x) (x/100)

# odds ratios
# exclude single arm studies
# select refid, study, arm_tx, arm_n, outcome_n
dichot_nausea_or <- dichot_prot.dat %>% 
  filter(!is.na(nausea_np)) %>%
  select(refid, study, arm_tx, arm_n, nausea_n) %>% 
  group_by(refid) %>% 
  filter(n() > 1)

or_nausea <- with(or_join(dichot_nausea_or, "nausea"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2))

```

```{r nauseaTable, include = TRUE}
## (updated 2021/01/12 18:04) nauseaTable ---------------------------------
dichot_nausea <- dichot_prot.dat %>%
  filter(!is.na(nausea_np)) %>%
  mutate(
    pre_post_op = ifelse(time_outcome > 1, "Postop", "Preop"),
    pre_post_op = ifelse(surg_nosurg == "non-surgical", NA, pre_post_op)
  ) %>%
  select(refid:time_outcome, pre_post_op, nausea_np, nausea_per, nausea_n) %>%
  arrange(age, desc(surg_nosurg), design, desc(pre_post_op), year, study)

dichot_nausea <- left_join(dichot_nausea, or_nausea, by = "refid") %>%
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    or_ci = ifelse(row_number() == 1, or_ci, NA)
  ) %>%
  ungroup() %>%
  mutate(nausea_per = round(nausea_per, 0)) %>%
  select(refid, arm, design, age, surg_nosurg, study, arm_n, arm_tx, starts_with("hr"), time_outcome, pre_post_op, nausea_np, nausea_per, or_ci, nausea_n)

# correct Askura 2015 odds ratios
temp <- dichot_nausea_or %>% filter(refid == 2234)
# CHO/Simp vs fasting, CHO/Simp/Prot
c <- with(or_join(temp[c(1,3),], "nausea"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2)) %>% pull(or_ci)
d <- with(or_join(temp[c(2,3),], "nausea"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2)) %>% pull(or_ci)

dichot_nausea <- dichot_nausea %>%
  mutate(
    or_ci = ifelse(refid == 2234 & arm == 1, c, or_ci),
    or_ci = ifelse(refid == 2234 & arm == 3, d, or_ci), # arm 3 is CHO/Simp/Prot
    or_ci = ifelse(or_ci == "NA (NA-NA)", "", or_ci)
  )
rm(c, d)

## (updated 2021/05/01 10:13) formatting ----------------------------------
dichot_nausea$nausea_bar <- NA
dichot_nausea$nausea_bar <- ifelse(grepl("CHO", dichot_nausea$arm_tx),
  color_bar("darksalmon", fun = dichot_format)(dichot_nausea$nausea_per),
  color_bar("lightgray", fun = dichot_format)(dichot_nausea$nausea_per))

dichot_nausea <- dichot_nausea %>%
  add_foot(study, "Koeppe 2013", "a") %>% #           'Did you feel nausea during the fasting period?
  mutate(
    nausea_bar = str_replace(nausea_bar, ">[0-9]{1,2}", ">&nbsp;"),
    nausea_bar = ifelse(nausea_n == 0, NA, nausea_bar),
    or_ci = ifelse(refid == 2234 & arm_n == 46, cell_spec(or_ci, color = "black"), or_ci)
  )

dichot_nausea_preop <- dichot_nausea %>% 
  filter(pre_post_op == "Preop")
  
## (updated 2021/02/13 08:44) nauseaKable ---------------------------------
prot_row <- dichot_nausea_preop %>%
  mutate(line = row_number()) %>%
  filter(grepl("Prot", arm_tx)) %>%
  pull(line)

dichot_nausea_preop %>%
  select(study, arm_tx, arm_n, hr_gt6:hr_2, nausea_np, nausea_bar, or_ci) %>%
  kbl(
    booktabs = T, align = c("llccccrlc"), escape = FALSE,
    col.names = c("        Study", "Liquid", "N", "> 6", "6→2", "≤ 2", "N (%)", " ", "CHO vs. Comparator")
  ) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Nausea" = 2, "OR (95% CI)"), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4, 6), width = "3em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(7, width = "5em") %>%
  column_spec(8, width = "5em") %>%
  column_spec(9, width = "11em") %>%
  row_spec(prot_row, color = "brown") %>%
  pack_top(., "Adult, Surgical", 1, 4) %>%
  pack_sub(., "RCT", 1, 4) %>%
  # pack_sub(., "Retrospective Cohort", 16, 17) %>%
  footnote(
    general = "RCT: randomized controlled trial; OR: odds ratio; CHO: carbohydrate; Simp: simple; Comp: complex; Prot: protein.",
    alphabet = c("Did you feel nausea during the fasting period?"),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

### Rates, nonsurgical studies <a id="protNauseaNonRate10"></a>

<br/>

<font size = 4> Table `r table_n`. Rates of nausea in crossover studies of adult healthy volunteers. </font>

```{r nauseaNonsurgTableOr, include = TRUE}
## (updated 2021/05/06 10:35) nauseaNonsurgTable --------------------------
dichot_format <- function(x) (x/100)
dichot_nonsurg_nausea <- dichot_nonsurg_prot.dat %>%
  filter(!is.na(nausea_np)) %>%
  select(refid, study, arm_tx, arm_n, nausea_n, nausea_per, nausea_np, amtingest1) %>%
  group_by(refid) %>%
  filter(n() > 1) %>%
  ungroup() %>%
  # add times
  mutate(
    time_outcome = case_when(
      refid == 4092 ~ "When ingested",
      refid == 6280 ~ "Few hours"
    ),
    study = ifelse(study == "Lobo 2009", cell_spec(study, color = "black"), study)
  ) %>%
  group_by(refid) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    time_outcome = ifelse(row_number() == 1, time_outcome, NA)
  ) %>%
  ungroup()


dichot_nonsurg_nausea$nausea_bar <- NA
dichot_nonsurg_nausea$nausea_bar <- ifelse(grepl("CHO", dichot_nonsurg_nausea$arm_tx),
  color_bar("darksalmon", fun = dichot_format)(dichot_nonsurg_nausea$nausea_per),
  color_bar("lightgray", fun = dichot_format)(dichot_nonsurg_nausea$nausea_per))
dichot_nonsurg_nausea <- dichot_nonsurg_nausea %>%
  mutate(nausea_bar = str_replace(nausea_bar, ">.*<", "> <"),
         nausea_bar = ifelse(nausea_n == 0, NA, nausea_bar))

## (updated 2021/05/06 10:36) nauseaNonsurgKable --------------------------
prot_row <- dichot_nonsurg_nausea %>% 
  mutate(line = row_number()) %>% 
  filter(grepl("Prot", arm_tx)) %>% 
  pull(line)

dichot_nonsurg_nausea %>% 
  select(study, arm_tx, arm_n, amtingest1, time_outcome, nausea_np, nausea_bar) %>% 
    kbl(
    booktabs = T, align = c("llcclll"), escape = FALSE,
    col.names = c("        Study", "Liquid", "N", "Amount (mL)", "Time Assessed", "N (%)",  " ")) %>%
   add_header_above(c(" " = 5, "Nausea" = 2), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(4, width = "7em") %>%
  column_spec(5, width = "8em") %>%
  column_spec(6, width = "4em") %>% 
  column_spec(7, width = "5em") %>% 
  row_spec(prot_row, color = "brown") %>% 
  pack_top(., "Adult, Nonsurgical", 1, 5) %>% 
  pack_sub(., "Crossover", 1, 5) %>% 
    footnote(
    general = "CHO: carbohydrate; Comp: complex; Prot: protein",
    general_title = "",
    footnote_as_chunk = FALSE)

table_n <- tab_inc()
```

<br/>

### Patient-rated <a id="protNauseaRating11"></a>

<br/>

<font size = 4> Table `r table_n`. Patient-rated preoperative nausea according to fasting, reporting time, liquid and volume. </font>

```{r nauseaLikert, include = FALSE, echo = FALSE}
## (updated 2021/04/17 14:37) likert_cho_nausea.dat ----------------------
likert_prot_nausea.dat <- likert_prot.dat %>%
  filter(refid %in% cho_refids) %>%
  filter(nausea_l == "nausea_l") %>%
  # filter_at(vars(nausea_m:nausea_pval), any_vars(!is.na(.))) %>% # identical n = 77 (2021/04/06 11:36)
  # fill in any misssing timeoutcomes
  group_by(refid) %>%
  fill(likert_time_outcome) %>%
  ungroup() %>%
  mutate(
    pre_post_op = ifelse(likert_time_outcome > 1, "Postop", "Preop"),
    pre_post_op = ifelse(surg_nosurg == "non-surgical", NA, pre_post_op)
  ) %>%
  select(refid:age, arm_n, arm_tx, likert_time_outcome, pre_post_op, matches("ingest"), starts_with("nausea"), summary_l_result, out_l_notes) %>%
  arrange(age, desc(surg_nosurg), design, desc(pre_post_op), year, study, arm_tx)

## (updated 2021/04/17 14:37) likert_cho_nausea_kbl.dat -------------------
likert_prot_nausea_kbl.dat <- likert_prot_nausea.dat %>%
  rename(time_outcome = likert_time_outcome) %>%
  mutate(
    # surgical studies (note none have times 0 or negative)
    # hr_2 is ≤ 2; hr_26 is (2, 6] >2 to 6; hr_gt6 is >6
    hr_2 = 0, hr_26 = 0, hr_gt6 = 0,
    hr_2 = if_else(timeingest1 <= 2 & timeingest1 > 0, amtingest1, hr_2, missing = 0),
    hr_26 = if_else(timeingest1 > 2 & timeingest1 < 6, amtingest1, hr_26, missing = 0),
    hr_gt6 = if_else(timeingest1 >= 6, amtingest1, hr_gt6, missing = 0),
    hr_2 = if_else(hr_2 == 0 & timeingest2 <= 2 & timeingest2 > 0, amtingest2, hr_2, missing = 0),
    hr_26 = if_else(hr_26 == 0 & timeingest2 > 2 & timeingest2 < 6, amtingest2, hr_26, missing = 0),
    hr_gt6 = if_else(hr_gt6 == 0 & timeingest2 >= 6, amtingest2, hr_gt6, missing = 0),
    hr_gt6 = if_else(grepl("also received 300", type_ingest_1), 500, hr_gt6), # ) %>%  # Oyama PM
    # for nonsurgical
    hr_0 = 0, hr_minus2 = 0,
    hr_0 = if_else(surg_nosurg != "surgical" & timeingest1 == 0, amtingest1, hr_0, missing = 0),
    hr_minus2 = if_else(surg_nosurg != "surgical" & timeingest1 == -2, amtingest1, hr_minus2, missing = 0),
    hr_0 = if_else(surg_nosurg != "surgical" & timeingest2 == 0, amtingest1, hr_0, missing = 0),
    hr_minus2 = if_else(surg_nosurg != "surgical" & timeingest2 == -2, amtingest1, hr_minus2, missing = 0)
  ) %>%
  replace_with_na_at(.vars = c("hr_gt6", "hr_26", "hr_2"), condition = ~ .x == 0) %>%
  # filter(surg_nosurg == "surgical") %>%
  select(refid:arm_tx, hr_gt6, hr_26, hr_2, time_outcome, pre_post_op, nausea_scale, nausea_m:nausea_iqru) %>%
  mutate(
    nausea_md = nausea_med,
    nausea_med = paste0(nausea_med, " (", round_0(nausea_iqrl), "-", round_0(nausea_iqru), ")"),
    nausea_med = ifelse(nausea_med == "NA (NA-NA)", NA, nausea_med),
    nausea_med = gsub(" \\(NA-NA\\)", "", nausea_med),
    ranges = str_c("(", round_0(nausea_rl), "-", round_0(nausea_ru), ")"),
    nausea_sd = ifelse(is.na(nausea_sd) & !is.na(nausea95u), sd_confint(nausea95l, nausea95u), nausea_sd),
    mn_95_ci = str_c(round_1(nausea_m), " (", round_1(nausea95l), "-", round_1(nausea95u), ")"),
    mn_95_ci = ifelse(!is.na(nausea_m) & !is.na(nausea_sd), str_c(round_1(nausea_m), " (", round_1(nausea_m - (1.96 * nausea_sd)), "-", round_1(nausea_m + (1.96 * nausea_sd)), ")"), mn_95_ci),
    mn_95_ci = ifelse(mn_95_ci == "NA (NA-NA)", NA, mn_95_ci),
    mn_95_ci = str_replace(mn_95_ci, "\\(NA-NA\\)", ""),
    # mn_sd = NA,
    mn_sd = ifelse(!is.na(nausea_sd) & !is.na(nausea_m), paste0(round_1(nausea_m), " (", round_1(nausea_sd), ")"), round_1(nausea_m)),
    mn_sd = na_if(mn_sd, "NA"),
    nausea_med = str_replace(nausea_med, "\\(NA-NA\\)", ""),
    ranges = str_replace(ranges, "\\(NA-NA\\)", ""),
    # NOTE: footnote e: Hunger Satiety Scale
    nausea_scale = ifelse(nausea_scale == "VAS: 0 to 100", "0→100", nausea_scale),
    nausea_scale = ifelse(nausea_scale == "VAS, 0-100", "0→100", nausea_scale),
    nausea_scale = ifelse(nausea_scale == "VAS, 0 to 100", "0→100", nausea_scale),
    nausea_scale = ifelse(nausea_scale == "VAS, 0 to 10", "0→10", nausea_scale),
    nausea_scale = ifelse(nausea_scale == "VAS, 1 to 10", "0→10", nausea_scale),
    nausea_scale = ifelse(nausea_scale == "VAS, 0-10", "0→10", nausea_scale),
    nausea_scale = ifelse(nausea_scale == "VAS 10 pt", "0→10", nausea_scale),
    nausea_scale = ifelse(nausea_scale == "NRS, 0 to 10", "0→10^NRS^", nausea_scale),
    nausea_scale = ifelse(nausea_scale == "NRS, 0 to 2", "0→2^NRS^", nausea_scale),
    nausea_scale = ifelse(nausea_scale == "NRS, 0 to 3", "0→3^NRS^", nausea_scale),
    nausea_scale = ifelse(nausea_scale == "Likert, 0 to 3", "0→3^NRS^", nausea_scale),
    nausea_med = str_replace(nausea_med, "-NA", ""),
  ) %>%
  arrange(age, desc(surg_nosurg), design, desc(pre_post_op), year, study) %>%
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    nausea_scale = ifelse(row_number() == 1, nausea_scale, NA),
  ) %>%
  ungroup()
```

```{r nauseaAdultSurgKable, echo = FALSE}
## (updated 2020/12/13 13:48) nauseaAdultSurgKable ------------------------
lik_prot_nausea_preop_kbl.dat <- likert_prot_nausea_kbl.dat %>% 
  filter(pre_post_op == "Preop")

prot_row <- lik_prot_nausea_preop_kbl.dat %>%
  mutate(line = row_number()) %>%
  filter(grepl("Prot", arm_tx)) %>%
  pull(line)

lik_prot_nausea_preop_kbl.dat %>%
   select(study, arm_tx, arm_n, hr_gt6, hr_26, hr_2, nausea_scale, mn_sd, nausea_med, ranges) %>%
  add_row() %>%
  kbl(
    booktabs = T, align = c("llcccclll"), escape = FALSE,
    col.names = c(
      "       Study", "Liquid", "N", "> 6", "6→2", "≤ 2", "Scale^a^", "M (SD)", "Med (IQR)", "Range"
    )
  ) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Nausea Rating" = 4), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  # NOTE: footnote a: includes at 2.5 hours
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4, 6), width = "3em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(7, width = "4em") %>%
  column_spec(8, width = "6em") %>%
  column_spec(9, width = "7em") %>%
  column_spec(10, width = "7em") %>%
  row_spec(prot_row, color = "brown") %>%
  pack_top(., "Adult, Surgical", 1, 5) %>%
  pack_sub(., "RCT", 1, 5) %>%
  result_pack("Between-group differences not detected, P = .84", 3, padding = 65) %>%
  result_pack("Between-group differences not detected, P = .48", 5, padding = 65) %>%
  # result_pack("Between-group differences not detected", 8, padding = 65) %>%
  # result_pack("Between-group differences not detected", 10, padding = 65) %>%
  footnote(
    general = "RCT: randomized controlled trial; M: mean; SD: standard deviation;  Med: median; IQR: interquartile range; CHO: carbohydrate; Comp: complex; Simp: simple.",
    alphabet = c(
      "Arrow (→) indicates best to worst nausea (visual analogue scale)."
    ),
    general_title = "",
    footnote_as_chunk = FALSE
  )

  table_n <- tab_inc()
```

<br/>

## *Pain/Discomfort* 

### Rates <a id="protPainRate12"></a>

<br/>

<font size = 4> Table `r table_n`. Rates of discomfort in randomized trials according to fasting, liquid and volume. </font>

```{r comfortTableOr, include = TRUE}
##  (updated 2021/01/13 08:52) comfortTableOr --------------------------------
dichot_format <- function(x) (x/100)
# odds ratios
# exclude single arm studies
# select refid, study, arm_tx, arm_n, outcome_n
dichot_comfort_or <- dichot_prot.dat %>% 
  filter(!is.na(comfort_np)) %>%
  select(refid, study, arm_tx, arm_n, comfort_n) %>% 
  group_by(refid) %>% 
  filter(n() > 1)

or_comfort <- with(or_join(dichot_comfort_or, "comfort"), odds_ratio(event_c, n_c, event_e, n_e, refid = refid, digits = 2))

dichot_comfort <- dichot_prot.dat %>%
  filter(!is.na(comfort_np)) %>%
  mutate(
    pre_post_op = ifelse(time_outcome > 1, "Postop", "Preop"),
    pre_post_op = ifelse(surg_nosurg == "non-surgical", NA, pre_post_op)
  ) %>%
  arrange(age, desc(surg_nosurg), design, year, study) %>%
  select(refid:time_outcome, pre_post_op, comfort_np, comfort_per, comfort_n)

dichot_comfort <- left_join(dichot_comfort, or_comfort, by = "refid") %>% 
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    or_ci = ifelse(row_number() == 1, or_ci, NA),
    time_outcome = ifelse(row_number() == 1, time_outcome, NA),
    pre_post_op = ifelse(row_number() == 1, pre_post_op, NA)
  ) %>%
  ungroup() %>% 
  mutate(comfort_per = round(comfort_per, 0)) %>% 
  select(refid, arm, design, age, study, arm_n, arm_tx, starts_with("hr"), pre_post_op, comfort_np, comfort_per, or_ci)

## (updated 2021/04/19 14:29) kable ---------------------------------------
prot_row <- dichot_comfort %>%
  mutate(line = row_number()) %>%
  filter(grepl("Prot", arm_tx)) %>%
  pull(line)

dichot_comfort$comfort_bar <- NA
dichot_comfort$comfort_bar <- ifelse(grepl("CHO", dichot_comfort$arm_tx),
  color_bar("darksalmon", fun = dichot_format)(100 - dichot_comfort$comfort_per),
  color_bar("lightgray", fun = dichot_format)(100 - dichot_comfort$comfort_per))

dichot_comfort  <- dichot_comfort %>% 
mutate(comfort_bar = str_replace(comfort_bar, ">0", ">"),
       comfort_bar = str_replace(comfort_bar, ">[0-9]{1,}", ">&nbsp;"))
  
dichot_comfort %>% 
  select(!c(refid, arm, design, age, comfort_per)) %>% 
  select(study, arm_tx, arm_n, hr_gt6:comfort_np, comfort_bar, or_ci) %>% 
  kbl(booktabs = T, align =  c("llcccccrlc"), escape = FALSE,
    col.names = c("        Study", "Liquid", "N", "> 6", "6 → 2", "≤ 2", "", "N (%)", " ", "CHO vs. Comparator")) %>% 
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Time" = 1, "Discomfort" = 2, "OR (95% CI)"), line = TRUE, bold = TRUE) %>% 
  row_spec(0, bold = TRUE) %>% 
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4,6), width = "3em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(7, width = "3em") %>%
  column_spec(8, width = "5em") %>%
  column_spec(9, width = "6em") %>%
  column_spec(10, width = "10em") %>%
  row_spec(prot_row, color = "brown") %>% 
  pack_top(., "Adult, Surgical", 1, 2) %>% 
  pack_sub(., "RCT", 1, 2) %>%
  footnote(general = "RCT: randomized controlled trial; OR: odds ratio; CHO: carbohydrate; Prot: protein.",
           # alphabet = c(""),
           general_title = "",  
           footnote_as_chunk = FALSE)

table_n <- tab_inc()
```

<br/>

### Patient-rated <a id="protPainRating13"></a>

<br/>

<font size = 4> Table `r table_n`. Preoperative pain ratings according to fasting, liquid and volume. </font>

<font size = 4> Will be single study w/preop Helminen. </font>

```{r}
table_n <- tab_inc()
```

<br/>

## *Patient Satisfaction* <a id="protSatisRating14"></a>

<br/>

<font size = 4> Table `r table_n`. Patient satisfaction ratings according to fasting, liquid and volume. </font>

```{r satisLikert, include = TRUE}
## (updated 2021/01/29 08:30) satisLikert ---------------------------------
# no subgroup data
likert_prot_satis.dat <- likert_prot.dat %>%
  filter(refid %in% protein_refids) %>%
  # delete Asakura as abstracted QoR emotional
  filter(pt_satis_l == "pt_satis_l", refid != 2234) %>%
  # filter_at(vars(satis_m:satis_pval), any_vars(!is.na(.))) # same
  select(refid:age, arm_n, arm_tx, likert_time_outcome, contains("ingest"), contains("satis")) %>%
  mutate(arm_tx = droplevels(arm_tx)) %>%
  arrange(age, desc(surg_nosurg), design, year, study, arm_tx)

likert_prot_satis_kbl.dat <- likert_prot_satis.dat %>%
  rename(time_outcome = likert_time_outcome) %>%
  mutate(
    # surgical studies (note none have times 0 or negative)
    # hr_2 is ≤ 2; hr_26 is (2, 6] >2 to 6; hr_gt6 is >6
    hr_2 = 0, hr_26 = 0, hr_gt6 = 0,
    hr_2 =   if_else(timeingest1 <= 2 & timeingest1 > 0, amtingest1, hr_2, missing = 0),
    hr_26 =  if_else(timeingest1 > 2 & timeingest1 < 6, amtingest1, hr_26, missing = 0),
    hr_gt6 = if_else(timeingest1 >= 6, amtingest1, hr_gt6, missing = 0),
    hr_2 =   if_else(hr_2 == 0 & timeingest2 <= 2 & timeingest2 > 0, amtingest2, hr_2, missing = 0),
    hr_26 =  if_else(hr_26 == 0 & timeingest2 > 2 & timeingest2 < 6, amtingest2, hr_26, missing = 0),
    hr_gt6 = if_else(hr_gt6 == 0 & timeingest2 >= 6, amtingest2, hr_gt6, missing = 0),
    hr_gt6 = if_else(grepl("also received 300", type_ingest_1), 500, hr_gt6),  # Oyama PM
    arm_tx = as.character(arm_tx),
    arm_tx = ifelse(study == "Du 2017" & arm_tx == "Clear", "Juice^e^", arm_tx),
    arm_tx = ifelse(study == "Marquini 2020c" & arm_tx == "Clear", "Water^c^", arm_tx)) %>%
  replace_with_na_at(.vars = c("hr_gt6", "hr_26", "hr_2"), condition = ~ .x == 0) %>%
  # Footnote: distilled water, 4 drops red dye, 2 drops sucrose
  select(refid:arm_tx, hr_gt6, hr_26, hr_2, time_outcome, satisfaction_scale, satis_m:satis_iqru) %>%
  mutate(
    satis_med = paste0(satis_med, " (", satis_iqrl, "-", satis_iqru, ")"),
    satis_med = ifelse(satis_med == "NA (NA-NA)", NA, satis_med),
    satis_med = gsub(" \\(NA-NA\\)", "", satis_med),
    ranges = str_c("(", satis_rl, "-", satis_ru, ")"),
    mn_95_ci = str_c(round_1(satis_m), " (", round_1(satis95l), "-", round_1(satis95u), ")"),
    mn_95_ci = ifelse(mn_95_ci == "NA (NA-NA)", NA, mn_95_ci),
    # NOTE: footnote e: satis Satiety Scale
    satisfaction_scale = ifelse(satisfaction_scale == "VAS, 0 to 10", "0→10", satisfaction_scale)) %>% 
  # remove second line study identifier
  arrange(age, desc(surg_nosurg), design, year, study) %>%
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    satisfaction_scale = ifelse(row_number() == 1, satisfaction_scale, NA),
    time_outcome = ifelse(row_number() == 1, time_outcome, NA)) %>%
  ungroup()
```

```{r satisAdultSurgKable, echo = FALSE}
## (updated 2021/01/29 08:30) satisAdultSurgKable -------------------------
prot_row <- likert_prot_satis_kbl.dat %>%
  mutate(line = row_number()) %>%
  filter(grepl("Prot", arm_tx))  %>%
  pull(line)

likert_prot_satis_kbl.dat %>%
  select(study, arm_tx, arm_n, hr_gt6, hr_26, hr_2, time_outcome, satisfaction_scale, mn_95_ci, satis_med, ranges) %>%
  add_row() %>% 
  kbl(booktabs = T, align = c("llcccccccc"), escape = FALSE,
      col.names = c(
        "        Study", "Liquid", "N",  "> 6", "6→2", "≤ 2", "Time (hr)^a^", "Scale^b^", "M (95% CI)", "Med", "Range")) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Satisfaction Rating\n *(Between-group Comparison)*" = 5), bold = TRUE, line = TRUE) %>%
  # NOTE: footnote a: includes at 2.5 hours
  row_spec(0, bold = TRUE) %>% 
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4,6), width = "3em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(7, width = "5em") %>%
  column_spec(8, width = "4em") %>%
  column_spec(9, width = "6em") %>%
  column_spec(10, width = "7em") %>%
  column_spec(11, width = "6em") %>%
  row_spec(prot_row, color = "brown") %>%
  pack_top(., "Adult, Surgical", 1, 2) %>%
  pack_sub(., "RCT", 1, 2) %>%
  result_pack("P = 0.01; MD^d^\\ 1.76 (95% CI, 1.59 to 1.93)", 3, padding = 62) %>% 
  footnote(
    general = "RCT: randomized controlled trial; M: mean; Med: median; MD: mean difference.",
    alphabet = c(
      "When outcome assessed relative to surgery where 0 is prior to induction.",
      "Visual analogue scale with arrow (→) indicating low to high patient satisfaction.",
      "Distilled water, 4 drops red dye, 2 drops sucrose.",
      "Calculated from means and confidence intervals."),
    general_title = "",
    footnote_as_chunk = FALSE)

table_n <- tab_inc()
```

<br/>

<hr style="height:2px;border-width:0;color:gray;background-color:gray">

# **Clinical Outcomes** 

<br/>

## *Aspiration* 

### None Reported (Adult) <a id="protAspAdult15"></a> 

<br/>

<font size = 4> Table `r table_n`. Studies reporting no occurrence of aspiration in adults — number of participants according to liquid received. </font>

```{r aspirateTableReport, include = TRUE}
## (updated 2021/01/12 18:04) aspirateTableReport -------------------------
dichot_prot.dat %>%
  filter(!is.na(aspirate_np)) %>%
  filter(surg_nosurg == "surgical") %>%
  arrange(age, desc(surg_nosurg), design, year, study) %>%
  select(refid, design, age, study, arm_n, arm_tx) %>%
  pivot_wider(
    id_cols = c(refid, study, age, design),
    names_from = arm_tx,
    values_from = arm_n,
    values_fn = sum
  ) %>%
  # exclude duplicate Marquini publications
  filter(!refid %in% c(6446, 247)) %>%
  mutate(study = ifelse(refid == 165, "Marquini 2020", study)) %>%
  filter(age == "Adult") %>% 
  select(study, Fasting, Water, Placebo, "CHO/Comp", "CHO/Simp", "CHO/Comp/Prot", "CHO/Simp/Prot", "Prot") %>%
  janitor::adorn_totals(c("col", "row"), fill = "-", na.rm = TRUE) %>%
  kbl(
    booktabs = T, align = c("lccccccccr"), escape = FALSE,
    col.names = c("       Study", "Fasting", "Water", "Placebo", "CHO/Comp", "CHO/Simp", "Prot", "Prot", "Prot", "Total")
  ) %>%
 add_header_above(c(" " = 6, "CHO/Comp", "CHO/Simp", " " = 2), line = FALSE, bold = TRUE) %>% 
  add_header_above(c(" " = 1, "Liquid and Participants Receiving" = 8, " " = 1), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "15em") %>%
  column_spec(2:9, width = "5em") %>%
  column_spec(10, width = "5em") %>%
  row_spec(13, bold = TRUE) %>%
  column_spec(10, bold = TRUE) %>%
  pack_top(., "Adult", 1, 13) %>%
  pack_sub(., "RCT", 1, 10) %>%
  pack_sub(., "Nonrandomized Studies of Interventions", 11, 12) %>%
  footnote(
    general = "RCT: randomized controlled trial; CHO: carbohydrate; Simp: simple; Comp: complex; Prot: protein.",
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/> 

### Unreported (Adult) <a id="protNoAspAdult16"></a>

<br>

<font size = 4> Table `r table_n`. Studies in adults silent on whether or not aspiration occurred. </font>

```{r aspirateTableNoReport, include = TRUE}
## (updated 2021/01/12 18:04) aspirateTableReport -------------------------
dichot_prot.dat %>%
  filter(is.na(aspirate_np)) %>%
  filter(surg_nosurg == "surgical") %>%
  arrange(age, desc(surg_nosurg), design, year, study) %>%
  select(refid, design, age, study, arm_n, arm_tx) %>%
  pivot_wider(
    id_cols = c(refid, study, age, design),
    names_from = arm_tx,
    values_from = arm_n,
    values_fn = sum
  ) %>%
  # exclude duplicate Marquini publications
  filter(!refid %in% c(6446, 247)) %>%
  mutate(study = ifelse(refid == 165, "Marquini 2020", study)) %>%
  filter(age == "Adult") %>%
  select(study, Fasting, Water, "CHO/Comp", "CHO/Comp/Prot") %>%
  janitor::adorn_totals(c("col", "row"), fill = "-", na.rm = TRUE) %>%
  kbl(
    booktabs = T, align = c("lccccr"), escape = FALSE,
    col.names = c("       Study", "Fasting", "Water", "CHO/Comp", "Prot", "Total")) %>%
  add_header_above(c(" " = 4, "CHO/Comp", " " = 1), line = FALSE, bold = TRUE) %>% 
  add_header_above(c(" " = 1, "Liquid and Participants Receiving" = 4, " " = 1), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "15em") %>%
  column_spec(2:5, width = "5em") %>%
  column_spec(6, width = "5em") %>%
  row_spec(5, bold = TRUE) %>%
  column_spec(6, bold = TRUE) %>%
  pack_top(., "Adult", 1, 4) %>%
  pack_sub(., "RCT", 1, 3) %>%
  pack_sub(., "Retrospective Cohort", 4, 4) %>%
  footnote(
    general = "RCT: randomized controlled trial; CHO: carbohydrate; Comp: complex; Prot: protein.",
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()

```

<br/>

## *Regurgitation* 

### Adults (surgical) <a id="protRegurgAdult17"></a>

<br/>

<font size = 4> Table `r table_n`. Rates of regurgitation (preoperative) in adults according to fasting, liquid and volume. </font>

```{r regurgTable, include = TRUE}
## (2021/05/07 09:14) regurgTableOr ---------------------------------------
dichot_format <- function(x) (x/100)

dichot_regurg_or <- dichot_prot.dat %>% 
  filter(!is.na(regurg_np)) %>%
  select(refid, study, arm_tx, arm_n, regurg_n) %>% 
  group_by(refid) %>% 
  filter(n() > 1)

or_regurg <- with(or_join(dichot_regurg_or, "regurg"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2))

## (updated 2021/01/12 18:04) regurgTable ---------------------------------
# note all studies are preoperative assessments
dichot_regurg <- dichot_prot.dat %>% 
  filter(!is.na(regurg_np)) %>%
  arrange(age, desc(surg_nosurg), design, year, study) %>% 
  select(refid:time_outcome, regurg_np, regurg_per, regurg_n)

dichot_regurg <- left_join(dichot_regurg, or_regurg, by = "refid") %>%
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    or_ci = ifelse(row_number() == 1, or_ci, NA),
    or_ci = ifelse(or_ci == "NA (NA-NA)", "", or_ci),
  ) %>%
  ungroup() %>%
  mutate(regurg_per = round(regurg_per, 0)) %>%
  select(refid, arm, design, age, study, arm_n, arm_tx, starts_with("hr"), regurg_np, regurg_per, or_ci)

prot_row <- dichot_regurg %>%
  mutate(line = row_number()) %>%
  filter(grepl("Prot", arm_tx)) %>%
  pull(line)

dichot_regurg$regurg_bar <- 0
dichot_regurg$regurg_bar <- ifelse(grepl("CHO", dichot_regurg$arm_tx),
  color_bar("darksalmon", fun = dichot_format)(dichot_regurg$regurg_per),
  color_bar("lightgray", fun = dichot_format)(dichot_regurg$regurg_per))

tot_n <- sum(dichot_regurg$arm_n)

dichot_regurg <- dichot_regurg %>%
  add_foot(study, "Koeppe 2013", "a") %>%
  mutate(
    regurg_bar = str_replace(regurg_bar, ">\\d+", ">&nbsp;"),
    regurg_bar = ifelse(regurg_per == 0, "", regurg_bar),
  )
  # add totals
  # add_row(regurg_np = paste0(23, " (", round_1(23 / tot_n * 100), ")"), arm_n = tot_n, study = "Total")

dichot_regurg %>% 
  select(!c(refid, arm, design, age, regurg_per)) %>% 
  select(study, arm_tx, arm_n, hr_gt6:hr_2, regurg_np, regurg_bar, or_ci) %>% 
  kbl(booktabs = T, align =  c("llccccrlc"), escape = FALSE,
    col.names = c("        Study", "Liquid", "N",  "> 6", "6→2", "≤ 2", "N (%)", " ", "CHO vs. Fasting")) %>% 
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Regurgitation" = 2, "OR (95% CI)"), line = TRUE, bold = TRUE) %>% 
  row_spec(0, bold = TRUE) %>% 
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4, 6), width = "3em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(7, width = "4em") %>%
  column_spec(8, width = "5em") %>%
  column_spec(9, width = "9em") %>%
  row_spec(prot_row, color = "brown") %>% 
  # row_spec(14, bold = TRUE) %>% 
  row_spec(prot_row, color = "brown") %>% 
  pack_top(., "Adult, Surgical", 1, 13) %>% 
  pack_sub(., "RCT", 1, 13) %>%
  footnote(general = "RCT: randomized controlled trial; OR: odds ratio; CHO: carbohydrate; Prot: protein.",
           alphabet = c("Regurgitation at upper endoscopic intubation."),
           general_title = "",  
           footnote_as_chunk = FALSE)

table_n <- tab_inc()
```

<br>

## *Vomiting* 


```{r vomitTablesData, include = TRUE}
## (2021/05/07 14:20) vomitTable ----------------------------------
dichot_format <- function(x) (x/100)
dichot_vomit_or <- dichot_prot.dat %>% 
  filter(!is.na(vomit_np)) %>%
  select(refid, study, arm_tx, arm_n, vomit_n) %>% 
  group_by(refid) %>% 
  filter(n() > 1)

or_vomit <- with(or_join(dichot_vomit_or, "vomit"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2))

## (2021/05/07 14:21) vomitTable ------------------------------------------
dichot_vomit <- dichot_prot.dat %>% 
  filter(!is.na(vomit_np)) %>%
  arrange(age, desc(surg_nosurg), design, year, study) %>% 
  mutate(notes = out_dichot_notes) %>% 
  select(refid:time_outcome, vomit_np, vomit_per, vomit_n, notes) 

dichot_vomit <- left_join(dichot_vomit, or_vomit, by = "refid") %>% 
  mutate(vomit_per = round(vomit_per, 0)) %>% 
  mutate(pre_post_op = ifelse(time_outcome > 0, "postop", "preop"),
         pre_post_op = ifelse(grepl("postop vomiting", notes), "postop", pre_post_op)) %>% 
  select(refid, arm, design, age, study, arm_n, arm_tx, starts_with("hr"), pre_post_op, time_outcome, vomit_np, vomit_per, or_ci, notes)

## (updated 2021/05/08 14:34) formating -----------------------------------
dichot_vomit$vomit_bar <- NA
dichot_vomit$vomit_bar <- ifelse(grepl("Prot", dichot_vomit$arm_tx),
  color_bar("darksalmon", fun = dichot_format)(dichot_vomit$vomit_per),
  color_bar("lightgray", fun = dichot_format)(dichot_vomit$vomit_per))

dichot_vomit  <- dichot_vomit %>% 
mutate(
  vomit_bar = str_replace(vomit_bar, ">\\d+", ">&nbsp;"),
  vomit_bar = ifelse(vomit_per == 0, "", vomit_bar),
  or_ci = ifelse(or_ci == "NA (NA-NA)", "", or_ci)
)

## (updated 2021/05/07 14:30) subgroups -----------------------------------
dichot_vomit_adult_preop <- dichot_vomit %>%
  filter(age == "Adult", pre_post_op == "preop") %>%
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    or_ci = ifelse(row_number() == 1, or_ci, NA),
    time_outcome = ifelse(row_number() == 1, time_outcome, NA)
  ) %>%
  ungroup()

dichot_vomit_adult_postop <- dichot_vomit %>%
  filter(age == "Adult", pre_post_op == "postop") %>%
  # arrange(design, study) %>%
  group_by(study) %>%
  mutate(
    or_ci = ifelse(vomit_np == "0 (0)", NA, or_ci),
    study = ifelse(row_number() == 1, study, NA),
    or_ci = ifelse(row_number() != n(), or_ci, NA),
    time_outcome = ifelse(row_number() == 1, time_outcome, NA)
  ) %>%
  ungroup()

```

### Rates, Adults (preop) <a id="protVomitAdult18"></a>

<br/>

<font size = 4> Table `r table_n`. Rates of pre-operative vomiting among adults according to fasting, liquid and volume. </font>

```{r vomitPreopAdults, include = TRUE}
## (updated 2021/05/07 14:49) tables --------------------------------------
prot_row <- dichot_vomit_adult_preop %>%
  mutate(line = row_number()) %>%
  filter(grepl("Prot", arm_tx)) %>%
  pull(line)

dichot_vomit_adult_preop %>%
  select(study, arm_tx, arm_n, hr_gt6:hr_2, vomit_np, vomit_bar, or_ci) %>%
  kbl(
    booktabs = T, align = c("llccccrlc"), escape = FALSE,
    col.names = c("        Study", "Liquid", "N", "> 6", "6→2", "≤ 2", "N (%)", " ", "CHO vs. Comparator")
  ) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Vomiting" = 2, "OR (95% CI)"), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4, 6), width = "3em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(7, width = "5em") %>%
  column_spec(8, width = "5em") %>%
  column_spec(9, width = "10em") %>%
  row_spec(prot_row, color = "brown") %>% 
  pack_top(., "Adult, Surgical", 1, 4) %>%
  pack_sub(., "RCT", 1, 4) %>%
  # pack_sub(., "Prospective Cohort", 13, 13) %>%
  # pack_sub(., "Retrospective Cohort", 42, 43) %>%
  # pack_sub(., "Case-Control", 44, 45) %>%
  # pack_sub(., "Nonrandomized Studies of Interventions", 9, 10) %>%
  # pack_top(., "Pedatric, Surgical", 46, 57) %>%
  # pack_sub(., "RCT", 46, 56) %>%
  # pack_sub(., "Prospective Cohort", 57, 57) %>%
  footnote(general = "RCT: randomized controlled trial; OR: odds ratio; CHO: carbohydrate; Comp: complex; Simp: simple; Prot: protein.",
           # alphabet = c(" "),
           general_title = "",
           footnote_as_chunk = FALSE)

table_n <- tab_inc()
```

<br/>

### Rates, Adults (postop) <a id="protVomitPostAdult19"></a>

<br/>

<font size = 4> Table `r table_n`. Rates of post-operative vomiting among adults according to fasting, liquid and volume. </font>

```{r vomitPostopAdults, include = TRUE}
## (updated 2021/05/07 14:49) tables --------------------------------------
prot_row <- dichot_vomit_adult_postop %>%
  mutate(line = row_number()) %>%
  filter(grepl("Prot", arm_tx)) %>%
  pull(line)

dichot_vomit_adult_postop %>%
  select(study, arm_tx, arm_n, hr_gt6:hr_2, vomit_np, vomit_bar, or_ci) %>%
  kbl(
    booktabs = T, align = c("llccccrlc"), escape = FALSE,
    col.names = c("        Study", "Liquid", "N", "> 6", "6→2", "≤ 2", "N (%)", " ", "CHO vs. Comparator")
  ) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Vomiting" = 2, "OR (95% CI)"), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4, 6), width = "3em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(7, width = "5em") %>%
  column_spec(8, width = "5em") %>%
  column_spec(9, width = "10em") %>%
  row_spec(prot_row, color = "brown") %>% 
  pack_top(., "Adult, Surgical", 1, 10) %>%
  # pack_rows(., "RCT", 1, 36, label_row_css = "border-top: 1px solid;", bold = FALSE, background = "white") %>% 
  pack_sub(., "RCT", 1, 8) %>%
  pack_sub(., "Retrospective Cohort", 9, 10) %>%
  footnote(general = "RCT: randomized controlled trial; OR: odds ratio; CHO: carbohydrate; Comp: complex; Simp: simple; Prot: protein.",
           # alphabet = c(" "),
           general_title = "",
           footnote_as_chunk = FALSE)

table_n <- tab_inc()
```

<br/>

## *Residual Gastric Volume* 

### Adults (surgical) <a id="protRgv20"></a>

<br/>

<font size = 4> Table `r table_n`. Residual gastric volumes measured by aspiration at induction in studies of  adult surgical patients according to fasting, liquid and volume. </font>

```{r choRgv, include = FALSE}
## (updated 2021/01/19 19:20) choRgv --------------------------------------
rgv.dat <- contin_prot.dat %>%
  filter(refid %in% protein_refids) %>%
  select(refid:age, arm_n, arm_tx, timeingest1, amtingest1, timeingest2, amtingest2, type_ingest_1, starts_with("rgv"), notes_continuous) %>%
  rename(notes = notes_continuous) %>% 
  filter(surg_nosurg == "surgical") %>%
  filter(!is.na(rgv_us) | !is.na(rgv_imag) | !is.na(rgv_asp)) %>%
  # filter_at(vars(rgv_time_1:rgv_pval_2), any_vars(!is.na(.))) %>% # same
  mutate(
    # surgical studies (note none have times 0 or negative)
    # hr_2 is ≤ 2; hr_26 is (2, 6] >2 to 6; hr_gt6 is >6
    hr_2 = 0, hr_26 = 0, hr_gt6 = 0,
    hr_2 = if_else(timeingest1 <= 2 & timeingest1 > 0, amtingest1, hr_2, missing = 0),
    hr_26 = if_else(timeingest1 > 2 & timeingest1 < 6, amtingest1, hr_26, missing = 0),
    hr_gt6 = if_else(timeingest1 >= 6, amtingest1, hr_gt6, missing = 0),
    hr_2 = if_else(hr_2 == 0 & timeingest2 <= 2 & timeingest2 > 0, amtingest2, hr_2, missing = 0),
    hr_26 = if_else(hr_26 == 0 & timeingest2 > 2 & timeingest2 < 6, amtingest2, hr_26, missing = 0),
    hr_gt6 = if_else(hr_gt6 == 0 & timeingest2 >= 6, amtingest2, hr_gt6, missing = 0),
    hr_gt6 = if_else(grepl("also received 300", type_ingest_1), 500, hr_gt6)
  ) %>%
  # Oyama PM
  replace_with_na_at(.vars = c("hr_gt6", "hr_26", "hr_2"), condition = ~ .x == 0) %>%
  mutate(
    study = ifelse(study == "Oyama 2011" & grepl("AM", notes), "Oyama 2011 (AM)^a^", study),
    study = ifelse(study == "Oyama 2011" & grepl("PM", notes), "Oyama 2011 (PM)^a^", study),
    rgv_type_meas = case_when(
      rgv_type_meas == "aspiration" ~ "Asp",
      rgv_type_meas == "ultrasound" ~ "US",
      rgv_type_meas == "imaging" ~ "MRI"),
    rgv_iqr_low_1 = ifelse(rgv_iqr_low_1 >= 10, round_0(rgv_iqr_low_1), round_1(rgv_iqr_low_1)),
    rgv_iqr_up_1 = ifelse(rgv_iqr_up_1 >= 10, round_0(rgv_iqr_up_1), round_1(rgv_iqr_up_1)),
    rgv_iqr = str_c("(", rgv_iqr_low_1, "-", rgv_iqr_up_1, ")"),
    rgv_range = str_c("(", round_0(rgv_range_low_1), "-", round_0(rgv_range_up_1), ")"),
    rgv_range = na_if(rgv_range, "(NA-NA)"),
    rgv_mean = ifelse(!is.na(rgv_sd_1) & !is.na(rgv_mean_1), str_c(round_1d(rgv_mean_1), " (", round_1d(rgv_sd_1), ")"), round_1d(rgv_mean_1)),
    # Oyama, Ajuzieogu to no digits
    rgv_mean = ifelse(refid %in% c(3588, 1768), str_c(round_0d(rgv_mean_1), " (", round_0d(rgv_sd_1), ")"), rgv_mean),
    rgv_mean = na_if(rgv_mean, "  NA"),
    rgv_mean = str_replace(rgv_mean, "\\(NA\\)", ""),
    rgv_mean = str_replace(rgv_mean, "^\\s", ""),
    rgv_mean = str_replace(rgv_mean, "\\( ", "\\("),
    rgv_med = str_c(round(rgv_median_1, 0), rgv_iqr, sep = " "),
    rgv_bar = ifelse(!is.na(rgv_mean_1), rgv_mean_1, rgv_median_1)
  ) %>%
  arrange(age, desc(surg_nosurg), design, year, study, arm_tx) %>%
  group_by(study) %>%
  mutate(
    id = row_number(),
    study = ifelse(id > 1, NA, study),
    rgv_type_meas = ifelse(id > 1, NA, rgv_type_meas)
  ) %>%
  ungroup() %>%
  select(refid, age, design, surg_nosurg, study, arm_tx, arm_n, hr_gt6, hr_26, hr_2, rgv_type_meas, rgv_time_1, rgv_med, rgv_mean, rgv_bar, notes)

# standardize to 0 to 30
cts30_format <- function(x) (x/75)

rgv_surg <- rgv.dat %>%
  mutate(rgv_bar = case_when(
    grepl("Prot", arm_tx) & age == "Adult" ~ color_bar("darksalmon", fun = cts30_format)(formattable::percent(rgv_bar)),
    !grepl("Prot", arm_tx) & age == "Adult" ~ color_bar("lightgray", fun = cts30_format)(formattable::percent(rgv_bar))
  )) %>%
  select(refid, study, arm_tx, arm_n, hr_gt6, hr_26, hr_2, rgv_time_1, rgv_mean, rgv_med, rgv_bar, age) %>%
  mutate(
    rgv_bar = str_replace(rgv_bar, ">.*<", ">&nbsp;<"),
    rgv_time_1 = ifelse(rgv_time_1 == 0.0, round_0d(rgv_time_1), rgv_time_1),
    hr_26 = round(hr_26, digits = 0),
    study = ifelse(study %in% c("Braga 2012"), cell_spec(study, color = "black"), study),
  )

```

```{r rgvKable, echo = FALSE}
## (updated 2020/12/15 08:32) rgvKable ------------------------------------
cho_row <- rgv.dat %>%
  filter(age == "Adult") %>% 
  mutate(line = row_number()) %>%
  filter(grepl("Prot", arm_tx)) %>%
  pull(line)

rgv_surg %>%
  filter(age == "Adult") %>% 
  mutate(
    arm_tx = as.character(arm_tx)
  ) %>%
  select(!c(refid, rgv_time_1, age)) %>%
    kbl(
    booktabs = T, align = c("llcccclll"), escape = FALSE,
    col.names = c(
      "       Study", "Liquid", "N", "> 6", "6→2", "≤ 2", "M (SD)", "Med (IQR)", "M or Med"
    )
  ) %>%
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "RGV (mL)" = 3), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  # NOTE: footnote a: includes at 2.5 hours
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4,6), width = "3em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(7, width = "6em") %>%
  column_spec(8, width = "6em") %>%
  column_spec(9, width = "11em") %>%
  row_spec(cho_row, color = "brown") %>%
  pack_top(., "Adult, Surgical", 1, 15) %>%
  pack_sub(., "RCT", 1, 11) %>%
  pack_sub(., "Nonrandomized Studies of Interventions", 12, 15) %>%
  footnote(
    general = "RGV: residual gastric volumne; M: mean; SD: standard deviation; Med: median; IQR: interquartile range; CHO: carbohydrate; Simp: simple; Comp: complex; Prot: protein; RCT: randomized controlled trial.",
    # alphabet = c(" "),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

### Nonsurgical Studies <a id="protNonRgv21"></a>

<br/>

<font size = 4> Table `r table_n`. Residual gastric volumes in randomized controlled trials of nonsurgical healthy volunteers according to fasting, liquid and volume. </font>
```{r rgvNonsurgTable, echo = FALSE}
## (updated 2020/12/15 10:23) rgvNonsurgTable -----------------------------
rgv_nonsurg.dat <- contin_prot.dat %>%
  filter(refid %in% protein_refids) %>%
  select(refid:age, arm_n, arm_tx, timeingest1, amtingest1, timeingest2, amtingest2, type_ingest_1, starts_with("rgv"), notes_continuous) %>%
  filter(!is.na(rgv_us) | !is.na(rgv_imag) | !is.na(rgv_asp)) %>%
  filter(surg_nosurg == "non-surgical") %>% 
  mutate(
    hr_2 = 0, hr_0 = 0, 
    hr_2 = if_else(abs(timeingest1) == 2, amtingest1, hr_2, missing = 0), # crossover abs
    hr_0 = if_else(timeingest1 == 0, amtingest1, hr_0, missing = 0), # crossover
    hr_2 = if_else(hr_2 == 0 & abs(timeingest2) == 2, amtingest2, hr_2, missing = 0), # crossover abs
    hr_0 = if_else(hr_0 == 0 & timeingest2 == 0, amtingest2, hr_0, missing = 0), # crossover
    arm_tx = droplevels(arm_tx)) %>%
  replace_with_na_at(.vars = c("hr_2", "hr_0"), condition = ~ .x == 0) %>%
  mutate(rgv_type_meas = case_when(
      rgv_type_meas == "aspiration" ~ "Asp",
      rgv_type_meas == "ultrasound" ~ "US",
      rgv_type_meas == "imaging" ~ "MRI"))

## (updated 2020/12/15 10:24) rgv_no_table --------------------------------
rgv_no_table <- rgv_nonsurg.dat %>%
  select(
    refid, arm, study, year, age, arm_n, arm_tx, design, surg_nosurg, arm_tx, timeingest1, amtingest1,
    timeingest2, amtingest2, everything()) %>%
  arrange(age, desc(surg_nosurg), design, year, study, arm_tx) %>% 
  select(!type_ingest_1) %>%
  rename(time_1_rgv = rgv_time_1, time_2_rgv = rgv_time_2) %>%
  pivot_wider(names_from = time_1_rgv, values_from = rgv_mean_1:rgv_iqr_up_1) %>%
  pivot_wider(names_from = time_2_rgv, values_from = rgv_mean_2:rgv_iqr_up_2) %>%
  select(!ends_with("NA")) %>%
  rename_with(~ gsub("_95_", "_ci_", .x, fixed = TRUE)) %>%
  rename_with(~ gsub("rgv_", "", .x, fixed = TRUE)) %>%
  # reorder to facilitate select final digit is hour of measurement variable_1/2_hr
  select(refid:surg_nosurg, type_meas, hr_2, hr_0, ends_with("_1"), ends_with("_2"), ends_with("_3")) %>%
  # select(!median_1_2) %>%
  mutate(
    mean_1_2 = coalesce(mean_1_2, mean_2_2),
    sd_1_2 = coalesce(sd_1_2, sd_2_2),
    ci_low_1_2 = coalesce(ci_low_1_2, ci_low_2_2),
    ci_up_1_2 = coalesce(ci_up_1_2, ci_up_2_2),
    iqr_low_1_2 = coalesce(iqr_low_1_2, iqr_low_2_2),
    iqr_up_1_2 = coalesce(iqr_up_1_2, iqr_up_2_2),
    range_low_1_2 = coalesce(range_low_1_2, range_low_2_2),
    range_up_1_2 = coalesce(range_up_1_2, range_up_2_2),
    median_1_2 = coalesce(median_1_2, median_2_2)) %>%
  # rename(median_1_2 = median_2_2) %>% # no median_1_2 values
  # removed coalesced columns
  select(!ends_with("_2_2")) %>% 
  # select(!ends_with("_2_3")) %>% 
  # select(!(mean_2_2:ci_up_2_2)) %>%
  # select(!(range_low_2_2:iqr_up_2_2)) %>%
  janitor::remove_empty(which = "cols") %>%
  # rename to remove data point 1, 2, 3
  rename_with(~ gsub("_1_", "_", .x, fixed = TRUE)) %>%
  rename_with(~ gsub("_2_", "_", .x, fixed = TRUE)) %>%
  # rename_with(~ gsub("_3_", "_", .x, fixed = TRUE)) %>%
  rename_with(~ gsub("mean_", "m_", .x, fixed = TRUE)) %>%
  rename_with(~ gsub("median_", "med_", .x, fixed = TRUE)) %>%
  # calculate sd if missing and ci reported
  mutate(
    sd_1 = ifelse(is.na(sd_1) & !is.na(ci_low_1), sd_confint(ci_low_1, ci_up_1), sd_1),
    sd_2 = ifelse(is.na(sd_2) & !is.na(ci_low_2), sd_confint(ci_low_2, ci_up_2), sd_2)) %>%
  # keep range and iqr but display only iqr
  select(refid, arm, study, year, age, design, arm_tx, arm_n, type_meas, hr_2, hr_0, m_1, sd_1, m_2, sd_2, m_3, sd_3, med_1, iqr_low_1, iqr_up_1, range_low_1, range_up_1, med_2, iqr_low_2, iqr_up_2, range_low_2, range_up_2)
```

```{r rgvNonsurgKable, echo = FALSE}
## (updated 2020/12/15 10:24) rgvNonsurgKable -----------------------------
protein_row <- rgv_no_table %>% 
  mutate(line = row_number()) %>% 
  filter(grepl("Prot", arm_tx)) %>% 
  pull(line)

rgv_no_table %>% 
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    type_meas = ifelse(row_number() == 1, type_meas, NA)) %>%
  ungroup() %>%
  mutate(
    arm_tx = as.character(arm_tx), 
    arm_tx = ifelse(refid == 1315 & arm_tx == "Clear", "Apple juice", arm_tx),
    msd1 = str_c(round_1(m_1), " (", round_1(sd_1), ")"),
    msd2 = str_c(round_1(m_2), " (", round_1(sd_2), ")"),
    msd1 = ifelse(refid == 1315, str_c(round_2(m_1), " (", round_2(sd_1), ")"), msd1),
    msd2 = ifelse(refid == 1315, str_c(round_2(m_2), " (", round_2(sd_2), ")"), msd2),
    msd3 = str_c(round_1(m_3), " (", round_1(sd_3), ")"),
    med1 = str_c(round(med_1, 0), " (", round(iqr_low_1, 0), "-", round(iqr_up_1, 0), ")"),
    # Nakamura med and add range for hr 2
    msd1 = ifelse(refid == 2703, paste0(round_0(med_1), " (", round_0(iqr_low_1), ", ", round_0(iqr_up_1), ")"), msd1),
    msd2 = ifelse(refid == 2703, paste0(round_0(med_2), " [", range_low_2, ", ", range_up_2, "]"), msd2),
    msd2 = ifelse(refid == 6280, paste0(round_0(med_2), " (", round_0(iqr_low_2), ", ", round_0(iqr_up_2), ")" ), msd2),
    msd1 = na_if(msd1, "NA (NA)"),
    msd2 = na_if(msd2, "NA (NA)"),
    msd3 = na_if(msd3, "NA (NA)")) %>%
  mutate(
    add_foot(., study, "Du 2017", "a"),
    msd1 = replace_na(msd1, ""),
    msd1 = cell_spec(msd1, underline = (ifelse(refid == 2703, TRUE, FALSE))),
    msd2 = cell_spec(msd2, underline = (ifelse(refid == 2703, TRUE, FALSE)))) %>%
  select(study, arm_tx, arm_n, hr_2, hr_0, type_meas, msd1:msd3, -age, -design) %>%
    add_row() %>% 
  kbl(
    booktabs = T, align = c("lllcccccc"), escape = FALSE,
    col.names = c("        Study", "Liquid", "N", "2 hr", "0 hr", "Measure", "1 hr", "2 hr", "3 hr")) %>%
  add_header_above(c(" " = 3, "Liquid Volume (mL)" = 2, "RGV" = 1, "Mean RGV (SD) (mL)" = 3), line = TRUE) %>%
  add_header_above(c(" " = 6, "Median RGV (IQR) [Range] (mL)" = 3), underline = TRUE, line = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4:5), width = "5em") %>%
  column_spec(6, width = "6em") %>%
  column_spec(7, width = "7em") %>%
  column_spec(8, width = "8em") %>%
  column_spec(9, width = "7em") %>%
  pack_top(., "Adult, Nonsurgical", 1, 13) %>%
  pack_sub(., "RCT", 1, 2) %>%
  result_pack("2-hr MD 39.1 (95% CI, -5.8 to 84.0)", 3, padding = 64) %>% 
  pack_sub(., "Crossover", 3, 13) %>%
  pack_top(., "Pedatric, Nonsurgical", 14, 16) %>%
  pack_rows("Proportion of Baseline Gastric Antral CSA", 14, 16, label_row_css = "padding-left:63%", bold = FALSE) %>%
  pack_sub(., "RCT", 14, 16) %>%
  result_pack("Prot/CHO vs Juice, MD 0.07 (95% CI, 0.04 to 0.11)", 17, padding = 64) %>% 
  row_spec(protein_row, color = "brown") %>%
  footnote(
    general = "RGV: residual gastric volumne; IQR: interquartile range; M: mean; SD: standard deviation; CHO: carbohydrate; MRI: magnetic resonance imaging; US: ultrasound; CSA: cross-sectional area.",
    general_title = "",
    alphabet = c("Authors reported similar clearances of all 3 liquids in terminal emptying phase (eg, 120 to 180 minutes)."),
    footnote_as_chunk = FALSE) 

 table_n <- tab_inc()
```

<br/>

### Pooled (adult surgical) <a id="protRgvFig1"></a>

<br/>

<font size = 4> Figure `r figure_n`. Pooled residual gastric volume from randomized trials comparing carbohydrate/protein drinks with fasting in adult surgical patients. </font>

```{r rgvChoMeta, include = TRUE, fig.width = 10, fig.height = 3.1, fig.align = "left"}
## (updated 2021/01/22 15:19) rgvChoMeta ------------------- ---------------
rgv_meta.dat <- contin_prot.dat %>%
  arrange(design, year, study) %>%
  filter(refid %in% cho_refids, surg_nosurg == "surgical") %>%
  filter(arm_tx == "Fasting" | grepl("Prot", arm_tx)) %>%
  filter(!is.na(rgv_us) | !is.na(rgv_imag) | !is.na(rgv_asp)) %>%
  filter(design == "rct", age == "Adult") %>%
  filter(refid != 3481) %>% # Braga
  select(refid, study, year, design, arm_n, arm_tx, rgv_mean_1, rgv_sd_1, rgv_median_1:rgv_iqr_up_1) %>%
  arrange(refid, arm_tx)

rgv_meta.dat <- calc_mn_sd(
  "arm_n",
  "rgv_mean_1",
  "rgv_sd_1",
  "rgv_median_1",
  "rgv_iqr_low_1",
  "rgv_iqr_up_1",
  "rgv_range_low_1",
  "rgv_range_up_1",
  "study",
  "arm_tx",
  refid = "refid",
  log_trans = TRUE,
  data = rgv_meta.dat
)

rgv_meta.dat <- rgv_meta.dat %>%
  mutate(arm_tx = ifelse(grepl("Prot", arm_tx), "CHO", "Fasting")) %>%
  pivot_wider(
    id_cols = c("study"),
    names_from = c("arm_tx"),
    values_from = c("n", "mean", "sd", "mean_log", "sd_log")
  )

rgv_meta <- metacont(
  n.e = n_CHO,
  mean.e = mean_CHO,
  sd.e = sd_CHO,
  n.c = n_Fasting,
  mean.c = mean_Fasting,
  sd.c = sd_Fasting,
  method.tau = "REML", 
  hakn = FALSE,
  prediction = FALSE,
  data = rgv_meta.dat,
  studlab = study
)
# rgv_meta

forest(rgv_meta,
  comb.random = TRUE,
  lab.e = "CHO     ",
  lab.c = "Fasting     ",
  digits = 1,
  digits.sd = 1,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  print.byvar = FALSE,
  overall = TRUE,
  fs.xlab = 11,
  rightcols = c("effect", "ci"),
  xlab = "RGV (mL)\n Favors CHO/Prot         Favors Fasting"
)

figure_n <- fig_inc()

## (updated 2021/05/10 11:01) log scale -----------------------------------
temp <- metacont(
  n.e = n_CHO,
  mean.e = mean_log_CHO,
  sd.e = sd_log_CHO,
  n.c = n_Fasting,
  mean.c = mean_log_Fasting,
  sd.c = sd_log_Fasting,
  method.tau = "REML", 
  hakn = TRUE,
  prediction = TRUE,
  data = rgv_meta.dat,
  studlab = study
)

# forest(temp)

```

Mean differences estimated from means, standard deviations, medians, interquartile and overall ranges.
Owing to skewed distributions of RGV, conducted sensitivity analysis on a log scale with consistent results. 

<br/>

### Pooled (adult nonsurgical) <a id="protNonRgvFig2"></a>

<br/>

<font size = 4> Figure `r figure_n`. Forest plot for pooled mean difference in residual gastric volume in crossover trials of adult nonsurgical patients at 2 hours --- protein and carbohydrate versus carbohydrate drinks. </font>
  
```{r metaNonsurg, echo = FALSE, fig.width = 10, fig.height = 3.1, fig.align = "left"} 
## (updated 2021/02/14 16:50) # 1 hour ----------------------------
# 1 hour
rgv_no_2hr <- rgv_no_table %>% 
  filter(age == "Adult", design == "crossover") %>% 
  filter(study != "Bisinotto 2019") %>% 
  filter(!(arm == 2 & study == "Lobo 2009")) %>% 
  select(refid, study, year, age, design, arm_tx, arm_n, m_2, sd_2, med_2, iqr_low_2, iqr_up_2, range_low_2, range_up_2) %>% 
  mutate(study = ifelse(study == "Nakamura 2014", "Nakamura 2014ᵇ", study),
         study = ifelse(study == "Lobo 2009", "Lobo 2009ª", study),
         arm_tx = str_replace(arm_tx, "/Simp", ""),
         arm_tx = str_replace(arm_tx, "/Comp", ""),
         arm_tx = str_replace(arm_tx, "/Prot", "Prot"),) %>% 
pivot_wider(id_cols = "study", names_from = "arm_tx", values_from = c(arm_n:range_up_2)) %>% 
  rename_with(~ gsub("_2", "", .x, fixed = TRUE)) %>%
  remove_empty("cols")

rgv_meta <- metacont(
  n.e = arm_n_CHOProt, 
  n.c = arm_n_CHO,
  median.e = med_CHOProt,
  mean.e = m_CHOProt,
  sd.e = sd_CHOProt,
  # q1.e = iqr_low_CHO/Prot,
  # q3.e = iqr_up_CHO/Prot,
  min.e = range_low_CHOProt,
  max.e = range_up_CHOProt,
  mean.c = m_CHO,
  sd.c = sd_CHO,
  median.c = med_CHO,
  min.c = range_low_CHO,
  max.c = range_up_CHO,
  data = rgv_no_2hr,
  # byvar = Hour,
  sm = "MD",
  method.tau = "REML",
  pooledvar = FALSE,
  studlab = study
)

temp.dat <- data.frame(rgv_meta[c("n.e", "mean.e", "sd.e", "n.c", "mean.c", "sd.c", "studlab")]) %>% 
  tibble() %>% 
  mutate(r_est = 0.5)

temp.dat <- metafor::escalc(
  m1i = mean.e,
  sd1i = sd.e,
  n1i = n.e,
  m2i = mean.c,
  sd2i = sd.c,
  n2i = n.c,
  ri = r_est,
  measure = "MD",
  slab = studlab,
  data = temp.dat) %>% 
  mutate(sd = sqrt(vi))

# rgv_meta$TE <- temp.dat$yi
# rgv_meta$seTE <- temp.dat$sd

rgv_metagen <- metagen(yi, sd,
  studlab = studlab,
  method.tau = "REML",
  data = temp.dat)

forest(rgv_metagen,
  comb.random = TRUE,
  comb.fixed = FALSE,
  lab.e = "Prot/CHO      ",
  lab.c = "Carbohydrate     ",
  digits = 1,
  digits.sd = 1,
  print.I2 = TRUE,
  print.tau2 = FALSE,
  digits.tau2 = 0,
  print.I2.ci = FALSE,
  print.pval.Q = FALSE,
  overall = TRUE,
  xlim = c(-100, 350),
  at = c(-100, 0, 100, 200, 300),
  print.byvar = FALSE,
  col.diamond.fixed = "red",
  fs.xlab = 11,
  rightcols = c("effect", "ci"),
  leftcols = c("studlab"),
  smlab = "Mean Difference (at 2 hours)",
  xlab = "RGV (mL)\n Favors Prot/CHO                  Favors Carbohydrate"
)

# Nakamura raw from digitized to check
# tibble(prot = c(107.71, 155.16, 168.99, 186.79, 224.36, 236.21, 254.00, 257.96, 354.81, 422.03),
#      cho = c(2.05, 2.05, 3.32, 3.32, 11.00, 12.28, 13.55, 16.11, 31.3, 35.29)) %>% 
# summarise(mn_p = mean(prot), mn_cho = mean(cho), sd_p = sd(prot), sd_cho = sd(cho))

#forest(rgv_meta, 
#       comb.random = TRUE,
#       comb.fixed = FALSE,
#       lab.e = "Prot/CHO      ",
#       lab.c = "Carbohydrate     ",
#       digits = 1,
#       digits.sd = 1,
#       print.I2 = TRUE,
#       print.tau2 = TRUE,
#       digits.tau2 = 0,
#       print.I2.ci = TRUE,
#       print.pval.Q = TRUE,
#       overall = TRUE,
#       xlim = c(-50, 350),
#       at = c(-50, 0, 100, 200, 300),
#       print.byvar = FALSE,
#       col.diamond.fixed = "red",
#       fs.xlab = 11,
#       xlab = "RGV (mL)\n Favors Protein          Favors Carbohydrate")

figure_n <- figure_n + 1
# TODO:  Compared with a carbohydrate drink, at 2 hours the residual gastric volume in non-surgical healthy adults appeared higher (MD 41.6, 95% CI: 36.7--46.5, I^2 = 99%, 4 crossover studies, 61 patients) but accompanied by large heterogeneity. 
```

^a^ Lobo 2009 included the protein comparison arm with the highest residual gastric volume. 

^b^ Nakamura 2014 did not report exact 2-hour volumes --- median, range were estimated from figures. Residual gastric volumes were exceedingly low following the carbohydrate only drink. Protein drink was Arginaid Water®.

<br/>

## *pH* 

<br/>

<font size = 4> No studies. </font>

## *Complications* 

### Adults <a id="protCompl22"></a>

<br/>

<font size = 4> Table `r table_n`. Reported complications according to procedure type, fasting, liquid and volume in adults. </font>

```{r complicateTableOr, include = TRUE}
## (updated 2021/01/13 08:52) complicateTableOr --------------------------------
dichot_format <- function(x) (x/100)
dichot_complicate_or <- dichot_prot.dat %>% 
  filter(!is.na(complicate_np)) %>%
  select(refid, study, arm_tx, arm_n, complicate_n) %>% 
  group_by(refid) %>% 
  filter(n() > 1)

or_complicate <- with(or_join(dichot_complicate_or, "complicate"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2))

```

```{r surgCategories}
## (updated 2021/05/11 08:57) surgery categories --------------------------
surg_cat <- study_char_prot.dat %>%
  select(refid, study, year, age, surg_nosurg, design, surg_type) %>%
  arrange(age, desc(surg_nosurg), design, year, study) %>%
  mutate(surg = case_when(
      str_detect(surg_type, "[Gg]yn|[Hh]ysterectomy") ~ "Gyn",
      str_detect(surg_type, "craniotomy") ~ "Neurosurgical",
      str_detect(surg_type, "maxillofacial") ~ "Maxillofacial",
      str_detect(surg_type, "[Hh]ernia|herniorrhaphy") ~ "Herniorrhaphy",
      str_detect(surg_type, "prostatectomy") ~ "prostatectomy",
      str_detect(surg_type, "ariety") ~ "Various",
      str_detect(surg_type, "various|Hirschsprung's") ~ "Various",
      str_detect(surg_type, "CABG|[Cc]oronary artery bypass surgery") ~ "CABG",
      str_detect(surg_type, "[Cc]olorectal|[Bb]owel|colon resection") ~ "Colorectal",
      str_detect(surg_type, "[Tt]hyroid|hip joint") ~ "Thyroid",
      str_detect(surg_type, "[Oo]rthopedic|discectomy") ~ "Orthopedic",
      str_detect(surg_type, "total hip or total knee replacement|[Tt]otal hip|[Tt]otal knee|Hip joint|hip replacement") ~ "TKA/THA",
      str_detect(surg_type, "cholecystectomy") ~ "Cholecystectomy",
      str_detect(surg_type, "pancreaticoduodenectomy") ~ "Whipple",
      str_detect(surg_type, "[Gg]ast|Bowel") ~ "Other GI",
      str_detect(surg_type, "not appli") ~ "None (healthy)",
      str_detect(surg_type, "oral") ~ "Oral",
      str_detect(surg_type, "minor") ~ "Misc minor",
      str_detect(surg_type, "None") ~ "None (healthy)",
      str_detect(surg_type, "abdomin") ~ "Other GI",
      str_detect(surg_type, "[Cc]esarean|labor") ~ "Cesarean/vaginal birth",
      str_detect(surg_type, "thoracotomy") ~ "Thoracic",
      str_detect(surg_type, "healthy") ~ "None (healthy)",
      str_detect(surg_type, "Elective") ~ "Elective",
      str_detect(surg_type, "adenotonsillectomy") ~ "Adenotonsillectomy",
      str_detect(surg_type, "[Bb]reast") ~ "Breast",
      str_detect(surg_type, "Endso|endoscopic|colonoscopy") ~ "Endoscopic")) %>% 
  select(refid, surg)

```

```{r complicateTable, include = TRUE}
## (updated 2021/01/12 18:04) complicateTable ---------------------------------
dichot_complicate <- dichot_prot.dat %>% 
  filter(!is.na(complicate_np), age == "Adult") %>%
  mutate(arm_tx = fct_relevel(arm_tx, c("CHO/Simp/Prot", "CHO/Comp/Prot"), after = 8)) %>%
  arrange(design, year, study) %>% 
  select(refid:time_outcome, complicate_np, complicate_per, complicate_n) %>% 
  filter(!study %in% c("Marquini 2020b", "Marquini 2020c")) %>% # all the same study
  mutate(study = ifelse(study == "Marquini 2020a", "Marquini 2020", study),
  # fix Breuer arms NOTE: not ideal but so doesn't break other code
  arm = ifelse(refid == 4766 & arm_n == 44, 1, arm),
  arm = ifelse(refid == 4766 & arm_n == 60, 2, arm),
  arm = ifelse(refid == 4766 & arm_n == 56, 3, arm))

dichot_complicate <- left_join(dichot_complicate, surg_cat, by = "refid") %>% 
  arrange(age, design, surg, year, study)

dichot_complicate <- left_join(dichot_complicate, or_complicate, by = "refid") %>% 
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    or_ci = ifelse(row_number() == 1, or_ci, NA),
    surg_cat = ifelse(row_number() == 1, surg_cat, NA),
    time_outcome = ifelse(row_number() == 1, time_outcome, NA)) %>%
  ungroup() %>% 
  mutate(complicate_per = round(complicate_per, 0)) %>% 
  select(refid, arm, surg, design, age, study, arm_n, arm_tx, starts_with("hr"), time_outcome, complicate_np, complicate_per, or_ci)

# correct odds ratios for multiarm studies
# DNascimento 2012a 3282
# CHO vs fasting, placebo
temp <- dichot_complicate_or %>% filter(refid == 3282)
c <- with(or_join(temp[c(1,3),], "complicate"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2)) %>% pull(or_ci)
d <- with(or_join(temp[c(2,3),], "complicate"), odds_ratio(event_e, n_e, event_c, n_c, refid = refid, digits = 2)) %>% pull(or_ci)

dichot_complicate <- dichot_complicate %>%
  mutate(
    or_ci = ifelse(refid == 3282 & arm == 1, c, or_ci),
    or_ci = ifelse(refid == 3282 & arm == 2, d, or_ci),
    or_ci = ifelse(or_ci == "NA (NA-NA)", "", or_ci),
    or_ci = ifelse(grepl("NA", or_ci), "", or_ci)
  )

rm(c, d)

prot_row <- dichot_complicate %>%
  mutate(line = row_number()) %>%
  filter(grepl("Prot", arm_tx)) %>%
  pull(line)

dichot_complicate$complicate_bar <- NA
dichot_complicate$complicate_bar <- ifelse(grepl("CHO", dichot_complicate$arm_tx),
  color_bar("darksalmon", fun = dichot_format)(dichot_complicate$complicate_per),
  color_bar("lightgray", fun = dichot_format)(dichot_complicate$complicate_per))

dichot_complicate <- dichot_complicate %>% 
mutate(
  complicate_bar = str_replace(complicate_bar, ">0", ">"),
  complicate_bar = str_replace(complicate_bar, ">[0-9]{1,}", ">&nbsp;"))
  
dichot_complicate %>% 
  select(!c(refid, arm, design, age, complicate_per)) %>% 
  select(study, arm_tx, arm_n, hr_gt6:hr_2, complicate_np, complicate_bar, or_ci) %>% 
  kbl(booktabs = T, align =  c("llccccrlc"), escape = FALSE,
    col.names = c("        Study", "Liquid", "N", "> 6", "6 → 2", "≤ 2", "N (%)", " ", "CHO vs. Comparator")) %>% 
  add_header_above(c(" " = 3, "Volume (mL) Before Induction (hr)" = 3, "Complications" = 2, "OR (95% CI)"), line = TRUE, bold = TRUE) %>% 
  row_spec(0, bold = TRUE) %>% 
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4, 6), width = "3em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(7, width = "5em") %>%
  column_spec(8, width = "5em") %>%
  column_spec(9, width = "8em") %>%
  row_spec(prot_row, color = "brown") %>%
  pack_top(., "RCT, Adult", 1, 23) %>% 
  result_pack(., "Cholecystectomy", 1, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Gyn", 10, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Herniorrhaphy", 14, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Maxillofacial", 16, padding = 2, bold = TRUE, color = "black") %>% 
  result_pack(., "Other GI", 20, padding = 2, bold = TRUE, color = "black") %>%
  footnote(general = "RCT: randomized controlled trial; OR: odds ratio; CHO: carbohydrate; Comp: complex; Prot: protein.",
           alphabet = c("When outcome assessed relative to surgery where 0 is prior to induction."),
           general_title = "",  
           footnote_as_chunk = FALSE)

table_n <- tab_inc()
```

<br/>

## *Length of Stay* 

### Adults <a id="protLos23"></a>

<br/>

<font size = 4> Table `r table_n`. Reported length of stay in adult patients by surgical category according to liquid or fasting. </font>

```{r losKbl, include = TRUE}
## (2021/05/11 15:27) losKbl ----------------------------------------------
los.dat <- contin_prot.dat %>% 
  select(refid:age, arm_n, arm_tx, starts_with("los")) %>% 
  filter_at(vars(los:los_pval), any_vars(!is.na(.))) %>% 
  left_join(., surg_cat, by = "refid") %>% 
  mutate(surg = ifelse(surg == "Orthopedic", "TK Orthopedic", surg)) %>% 
  arrange(age, desc(surg_nosurg), design, surg, year, study, arm_tx) %>% 
  mutate(
    los_bar = ifelse(!is.na(los_median_1), los_median_1, los_mean_1),
    los_iqr = str_c("(", los_iqr_low_1, "-", round(los_iqr_up_1, 1), ")"),
    los_range = str_c("(", los_range_low_1, "-", los_range_up_1, ")"),
    #los_mean_1 = round(los_mean_1, 1),
    los_mean = ifelse(!is.na(los_sd_1) & !is.na(los_mean_1), str_c(round_1(los_mean_1), " (", round_1(los_sd_1), ")"), round_1(los_mean_1)),
    los_med = str_c(los_median_1, str_replace_na(los_iqr, "NA"), sep = " "),
    los_mean = na_if(los_mean, "NA"),
    los_med = gsub(" NA", "", los_med)) %>% 
  select(surg, refid, study, age, design, arm_tx, arm_n, los_mean, los_med, los_range, los_bar) 

cts_format <- function(x) (x/20)

los.dat <- los.dat %>%
  mutate(los_bar = case_when(
    grepl("Prot", arm_tx)~ color_bar("darksalmon", fun = cts_format)(formattable::percent(los_bar)),
    !grepl("Prot", arm_tx) ~ color_bar("lightgray", fun = cts_format)(formattable::percent(los_bar))),
    los_bar = str_replace(los_bar, ">.*<", ">&nbsp;<")
    )

## (updated 2021/05/12 06:07) kable los -----------------------------------
prot_row <- los.dat %>% 
  filter(age == "Adult") %>% 
  mutate(line = row_number()) %>% 
  filter(grepl("Prot", arm_tx)) %>% 
  pull(line)

los.dat %>%
  filter(age == "Adult") %>%
  select(study, arm_tx, arm_n, los_mean, los_med, los_range, los_bar) %>%
  group_by(study) %>%
  mutate(
    study = cell_spec(study, color = "black"),
    study = ifelse(row_number() == 1, study, NA)
  ) %>%
  ungroup() %>%
  kbl(
    booktabs = T, align = c("llccccl"), escape = FALSE,
    col.names = c(
      "       Study", "Liquid", "N", "Mean (SD)", "Median (IQR)", "Range", "Median or Mean"
    )
  ) %>%
  add_header_above(c(" " = 3, "LOS (days)" = 4), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "14em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "3em") %>%
  column_spec(c(4:6), width = "7em") %>%
  column_spec(7, width = "8em") %>%
  row_spec(prot_row, color = "brown") %>%
  pack_top(., "RCT", 1, 11) %>%
  pack_top(., "Retrospective Cohort", 12, 13) %>%
  result_pack(., "Cholecystectomy", 1, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Herniorrhaphy", 3, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Other GI", 5, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Various", 7, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "Colorectal", 10, padding = 2, bold = TRUE, color = "black") %>%
  result_pack(., "TKA/THA", 12, padding = 2, bold = TRUE, color = "black") %>%
  footnote(
    general = "RCT: randomized controlled trial.",
    # alphabet = c(""),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()

```

<br/>

### Pediatric (no studies)

<br/>

<hr style="height:2px;border-width:0;color:gray;background-color:gray">


# **Study/Participant Detail** 

## *Study Characteristics* 

<font size = 4> Table `r table_n`. Characteristics of included studies examining protein-containing drinks. </font>

```{r createStudyCharTable, include = FALSE}
study_char_table <- study_char_prot.dat %>%
  mutate(
    dates = str_c(date_start, "-", date_end),
    country = countrycode::countryname(country, destination = "iso3c"),
    low_r = noquote(if_else(non_vh_hdi == "yes", "\U2022", "", "")),
    n = n_enrolled,
    n_anal = n_analyze,
    pilot = noquote(if_else(pilot == "yes", "\U2022", "", "")),
    study = ifelse(grepl("Marquini", study), str_c(study, "^a^"), study),
    setting = case_when(
      !is.na(hospital) ~ "Hosp",
      !is.na(ambulatory) ~ "Amb",
      !is.na(oth_setting) ~"Other"),
    gen = noquote(if_else(!is.na(general), "\U2022", "", "")),
    reg = noquote(if_else(!is.na(regional), "\U2022", "", "")),
    sed = noquote(if_else(!is.na(sedation), "\U2022", "", "")),
    registered = noquote(if_else(registered == "yes", "\U2022", "", "")),
    surg = case_when(
      str_detect(surg_type, "[Gg]yn") ~ "Gyn",
      str_detect(surg_type, "ariety") ~ "Various",
      str_detect(surg_type, "various") ~ "Various",
      str_detect(surg_type, "total hip or total knee replacement") ~ "TKA/THA",
      str_detect(surg_type, "cholecystectomy") ~ "Cholecystectomy",
      str_detect(surg_type, "[Gg]ast|Bowel") ~ "Other GI",
      str_detect(surg_type, "not appli") ~ "None (healthy)",
      str_detect(surg_type, "oral") ~ "Oral",
      str_detect(surg_type, "minor") ~ "Misc minor",
      str_detect(surg_type, "None") ~ "None (healthy)",
      str_detect(surg_type, "abdomin") ~ "Other GI",
      str_detect(surg_type, "Endso") ~ "Endoscopy")) %>%
  # filter(!study %in% c("Marquini 2020b", "Marquini 2020c")) %>% 
  arrange(age, desc(surg_nosurg), design, year, study) %>%
  select(study, dates, country, n, pilot, setting, gen, reg, sed, surg, registered)

```

```{r studyCharKable, echo = FALSE}
## (updated 2021/02/14 16:50) tudyCharKable ----------------------------
study_char_table %>%
  kbl(booktabs = T, align = c("lcccccccclc"), 
      # format = "latex",
      col.names = c("         Study", "Dates", "Country", " (N\\) ", "Pilot", 
                    "Setting", "Gen", "Reg", "Sed", "Type of Surgery", "Registered")) %>%
  add_header_above(c(" " = 3, "Enrolled" = 1, " " = 2, "Anesthetic" = 3, " " = 2)) %>% 
  kable_classic(full_width = TRUE, html_font = opt_font, position = "left", "hover") %>% 
  kable_styling(bootstrap_options = opt_boot) %>% 
  column_spec(1, width = "15em") %>% 
  # column_spec(2, width = "2em") %>% 
  column_spec(3, width = "7em") %>%
  pack_top(., "Adult, Surgical", 1, 22) %>% 
  pack_sub(., "RCT", 1, 20) %>% 
  pack_sub(., "Nonrandomized Studies of Interventions", 21, 21) %>% 
  pack_sub(., "Retrospective Cohort", 22, 22) %>% 
  pack_top(., "Adult, Nonsurgical", 23, 29) %>% 
  pack_sub(., "RCT", 23, 23) %>%
  pack_sub(., "Crossover", 24, 29) %>%
  pack_top(., "Pediatric, Nonsurgical", 30, 30) %>% 
  pack_sub(., "RCT", 30, 30) %>% 
  footnote(general_title = "",
    general = "Gen: general; Reg: regional; Sed: sedation; Hosp: hospital; Amb: ambulatory; TKA: total knee arthroplasty; THA: total hip arthroplasty.",
    alphabet = c("Multiple publications from the same study."),
    footnote_as_chunk = FALSE) # %>% 

table_n <- tab_inc()
```

<br><br>

## *Sample Characteristics* 

<font size = 4> Table `r table_n`. Characteristics of patients in included studies. </font>

```{r createPtCharTable, include = FALSE}
## (updated 2021/02/14 16:50) createPtCharTable ----------------------------
pt_char_table <- study_arm_prot.dat %>%
  group_by(refid) %>%
  summarize(
    N = sum(arm_n),
    wgt = arm_n / N,
    asai_all = round(sum(asai * wgt, na.rm = TRUE)),
    asaii_all = round(sum(asaii * wgt, na.rm = TRUE)),
    asaiii_all = round(sum(asaiii * wgt, na.rm = TRUE)),
    asai_ii_all = round(sum(asai_ii * wgt, na.rm = TRUE)),
    age_mn_all = round(sum(age_mean * wgt, na.rm = TRUE)),
    age_md_all = round(sum(age_med * wgt, na.rm = TRUE)),
    sex_all = round(sum(female * wgt, na.rm = TRUE)),
    white_all = round(sum(white * wgt, na.rm = TRUE)),
    black_all = round(sum(black * wgt, na.rm = TRUE)),
    asian_all = round(sum(asian * wgt, na.rm = TRUE)),
    bmi_mn_all = round(sum(bmi_mean * wgt, na.rm = TRUE)),
    bmi_md_all = round(sum(bmi_med * wgt, na.rm = TRUE)),
    dm_mn_all = round(sum(dm * wgt, na.rm = TRUE)),
    neuro_all = round(sum(neuro * wgt, na.rm = TRUE))) %>%
  filter(row_number() == 1) %>%
  ungroup()

# add study age, surg_nosurg, design
temp <- left_join(study_names, study_char.dat[, c("refid", "age", "surg_nosurg", "design")], by = "refid")
  
pt_char_table <- left_join(pt_char_table, temp, by = "refid") %>% 
  arrange(age, desc(surg_nosurg), design, year, study) %>% 
  mutate(study = ifelse(grepl("Marquini", study), str_c(study, "^a^"), study)) %>% 
  select(design, study, year, everything())

rm(temp)

pt_char_table <- pt_char_table %>% 
  # filter(!study %in% c("Marquini 2020b", "Marquini 2020c")) %>% 
  select(study, N, asai_all, asaii_all, asai_ii_all, asaiii_all, sex_all, age_mn_all, 
  age_md_all, white_all, black_all, asian_all, bmi_mn_all, bmi_md_all, dm_mn_all)

```

```{r ptCharKable, echo = FALSE}
## (updated 2021/02/14 16:50) ptCharKable ----------------------------
pt_char_table %>% 
  mutate_at(vars(asai_all:dm_mn_all), na_if, 0) %>% 
  kbl(
    booktabs = T, align = c("lrrrrcccccccccc"),
    col.names = c("         Study", "Analyzed", "I", "II", "I-II", "III", "(%)",
      "Mean", "Med", "White", "Black", "Asian", "Mean", "Med", "DM (%)")) %>%
  add_header_above(c(" " = 1, "N" = 1, "    ASA Classs (%)" = 4, "Female" = 1, "Age" = 2,
    "Race (%)" = 3, "BMI (kg/m^2^)" = 2, " " = 1), line = TRUE) %>%
  kable_classic(full_width = TRUE, html_font = opt_font, position = "left", "hover") %>% 
  kable_styling(bootstrap_options = opt_boot) %>% 
  column_spec(1, width = "15em") %>%
  # column_spec(2, width = "4em") %>%
  column_spec(3, width = "3em") %>%
  pack_top(., "Adult, Surgical", 1, 22) %>% 
  pack_sub(., "RCT", 1, 20) %>% 
  pack_sub(., "Nonrandomized Studies of Interventions", 21, 21) %>% 
  pack_sub(., "Retrospective Cohort", 22, 22) %>% 
  pack_top(., "Adult, Nonsurgical", 23, 29) %>% 
  pack_sub(., "RCT", 23, 23) %>%
  pack_sub(., "Crossover", 24, 29) %>%
  pack_top(., "Pediatric, Nonsurgical", 30, 30) %>% 
  pack_sub(., "RCT", 30, 30) %>% 
  footnote(alphabet = c("Multiple publications from he same study."),
    general = "Med: median",
    general_title = "",
    footnote_as_chunk = T
  )
table_n <- tab_inc()
```

<br><br>

## *Fasting, Liquid Timing and Amounts* 

<font size = 4> Table `r table_n`. Liquid consumption prior to surgery or outcome measurement and amounts according to study arm. </font>

```{r createFastingTable, include = FALSE}
## (updated 2021/02/14 16:51) createFastingTable ----------------------------
fasting_table <- study_arm.dat %>% 
  filter(refid %in% protein_refids) %>% 
  mutate(tx = factor(arm_tx,
  levels = c(
    "fasting",
    "water",
    "other_clear",
    "other",
    "cho",
    "milk",
    "protein"))) %>%
  mutate(tx = fct_recode(tx,
    Fasting = "fasting",
    Water = "water",
    Clear = "other_clear",
    Other = "other",
    CHO = "cho",
    Milk = "milk",
    "Prot/CHO" = "protein"),
    arm_tx = tx) %>%
  mutate(arm = ifelse(refid == 3588 & arm_n == 35, 3, arm),
         arm = ifelse(refid == 3588 & arm_n == 27, 2, arm)) %>% 
  select(refid, year, study, tx, arm_n, fastsolid, fastliquid, type_of_liquid, timeingest1, amtingest1, timeingest2, amtingest2, age, surg_nosurg, age, design, arm) %>% 
  arrange(age, desc(surg_nosurg), design, year, study, tx) %>% 
  select(study, tx, year, design, arm_n, fastsolid, fastliquid, timeingest1:amtingest2) 

fasting_table <- fasting_table %>%
  mutate(timeingest1 = ifelse(timeingest1 == 99, 12, timeingest1)) %>% 
  mutate(amtingest1  = na_if(amtingest1, 0)) %>% 
  mutate(timeingest1 = round(timeingest1, 0)) %>% 
  mutate(timeingest2 = round(timeingest2, 0)) %>% 
  group_by(study) %>% 
  # mutate(design = if_else(row_number() == 1, design, "")) %>% 
  mutate(year = ifelse(row_number() == 1, as.numeric(year), "" )) %>% 
  mutate(study = ifelse(study == "Marquini 2020a", "Marquini 2020a,b,c", study)) %>% 
  filter(!study %in% c("Marquini 2020b", "Marquini 2020c")) %>% 
  mutate(study = if_else(row_number() == 1, study, "")) %>% 
  ungroup()

# study arms
study_arm.dat %>% 
  filter(refid %in% protein_refids) %>% 
  group_by(refid) %>% 
  count(refid)

```

```{r fastingKable, echo = FALSE}
## (updated 2021/02/14 16:51) fastingKable ----------------------------
prot_row <- fasting_table %>%
  mutate(line = row_number()) %>%
  filter(grepl("Prot", tx)) %>%
  pull(line)

fasting_table %>%
  select(-year, -design) %>% 
  kbl(booktabs = T, align = c("llccccccc"),
      col.names = c("        Study", "   Liquid", "N", "Solids", "Liquids",  "Time^a^ (hr)", "Amount (mL)", 
      "Time^a^ (hr)", "Amount (mL)")) %>%
  add_header_above(c(" " = 3, "Prescribed Fasting  (hr)" = 2, "Treat Liquid 1" = 2, "Treat Liquid 2" = 2), line = TRUE) %>% 
  kable_classic(full_width = TRUE, html_font = opt_font, position = "left", "hover") %>% 
  kable_styling(bootstrap_options = opt_boot) %>% 
  row_spec(prot_row, color = "brown") %>%
  column_spec(1, width = "15em") %>% 
  # column_spec(2, width = "5em") %>% 
  # column_spec(3, width = "9em") %>%
  pack_top(., "Adult, Surgical", 1, 52) %>% 
  pack_sub(., "RCT", 1, 46) %>% 
  pack_sub(., "Nonrandomized Studies of Interventions", 47, 50) %>% 
  pack_sub(., "Retrospective Cohort", 51, 52) %>% 
  pack_top(., "Adult, Nonsurgical", 53, 68) %>% 
  pack_sub(., "RCT", 53, 54) %>%
  pack_sub(., "Crossover", 55, 68) %>%
  pack_top(., "Pediatric, Nonsurgical", 69, 71) %>% 
  pack_sub(., "RCT", 69, 71) %>%   
  footnote(general = "hr: hours",
          alphabet = c("Hours prior to surgery"),
          alphabet_title = " ",
          general_title = "",
          footnote_as_chunk = T)

table_n <- tab_inc()
```

<br><br>

## *Protein-containing Drinks* 

<font size = 4> Table `r table_n`. Composition of protein-containing liquids and brands. </font>

```{r createProteinDrinkTable, include = FALSE}
## (updated 2021/02/14 16:51) createProteinDrinkTable ----------------------------
# protein drinks used
prot_drink.dat <- readxl::read_xlsx("data/protein_detail_102320.xlsx", range = "A28:O59") %>% 
  janitor::clean_names()
  
# calculate total protein
volume <- study_arm.dat %>% 
  filter(grepl("prot", arm_tx)) %>% 
  mutate(amtingest2 = replace_na(amtingest2, 0),
    tot_vol = amtingest2 + amtingest1) %>% 
  select(refid, study, year, arm_tx, arm, tot_vol, amtingest1, amtingest2, age, surg_nosurg, design)

prot_drink.dat[, 5:10] <- map(prot_drink.dat[, 5:10], function(x) noquote(if_else(x == "X", "\U2022", "", "")))

prot_drink.dat <- left_join(volume[, c("refid", "tot_vol", "study", "age", "surg_nosurg", "design", "year")],
  prot_drink.dat,
  by = "refid") %>%
  mutate(prot_g_all = round(protein_g * tot_vol / 100, 0)) %>%
  group_by(study, brand) %>%
  slice(1)
         
prot_drink_table <- prot_drink.dat %>% 
  mutate(kcal = round(as.numeric(kcal), 0)) %>% 
  group_by(refid) %>% 
  arrange(age, desc(surg_nosurg), design, year, study) %>% 
  mutate(study = ifelse(row_number() == 2 & study == "Lobo 2009", " ", study),
         study = ifelse(study == "Marquini 2020a", "Marquini 2020 (all)", study)) %>% 
  ungroup() %>% 
  filter(!study %in% c("Marquini 2020b", "Marquini 2020c")) %>% 
  select(study, whey, glutamine, arginine, pea, soy, not_specified, protein_g, cho_g, kcal, osmolarity, prot_g_all, brand, tx_detail)
```

```{r proteinDrinksKable, echo = FALSE}
## (updated 2021/02/14 16:51) proteinDrinksKable ----------------------------
prot_drink_table %>% 
  select(-tx_detail) %>% 
  kbl(booktabs = T, align = c("lccccccccccc"),
      col.names = linebreak(c("        Study", "Whey", "Glut", "Arg", "Pea", "Soy", "NS", 
      "Protein, g", "CHO, g", "Kcal", "Osm", "Ingested, g", "Brand"))) %>%
  add_header_above(c(" " = 7, "Per 100 g" = 4, "Protein" = 1, " " = 1), line = TRUE) %>%  
  kable_classic(full_width = TRUE, html_font = opt_font, position = "left", "hover") %>% 
  kable_styling(bootstrap_options = opt_boot) %>% 
  column_spec(1, width = "15em") %>% 
  column_spec(c(2,3,4,5,6,7), width = "3em") %>% 
  # column_spec(3, width = "9em") %>%
  pack_top(., "Adult, Surgical", 1, 21) %>% 
  pack_sub(., "RCT", 1, 18) %>% 
  pack_sub(., "Nonrandomized Studies of Interventions", 19, 20) %>% 
  pack_sub(., "Retrospective Cohort", 21, 21) %>% 
  pack_top(., "Adult, Nonsurgical", 22, 29) %>% 
  pack_sub(., "RCT", 22, 22) %>%
  pack_sub(., "Crossover", 23, 29) %>%
  pack_top(., "Pediatric, Nonsurgical", 30, 30) %>% 
  pack_sub(., "RCT", 30, 30) %>%  
  footnote(general = "CHO: carbohydrate; g: grams; Osm: osomolality; Glut: glutamine; Arg: arginine; NS: not specified",
          #alphabet = c("per 100/mL if not otherwise specified"),
          # alphabet_title = " ",
          general_title = "",
          footnote_as_chunk = T)  

table_n <- tab_inc()
```

<br>

```{r proteinDrinksDetailKable, echo = FALSE, include = FALSE}
## (updated 2021/02/14 16:51) proteinDrinksDetailKable, ----------------------------
## Protein-containing Drinks (note) 
prot_drink_table %>% 
  select(study, tx_detail) %>% 
  filter(!is.na(tx_detail)) %>% 
   kbl(booktabs = T, align = c("ll"),
      col.names = c("\\ \\ \\ \\ \\ \\ \\ Author", "Detail")) %>%
  kable_classic(full_width = TRUE, html_font = "Cambria", position = "left", "striped") %>% 
  column_spec(1, width = "15em") %>% 
  # column_spec(2, width = "5em") %>% 
  # column_spec(3, width = "9em") %>%
  # add_header_above(c(" " = 3, "Prescribed Fasting  (hr)" = 2, "Treat Liquid 1" = 2, "Treat Liquid 2" = 2)) %>% 
  pack_rows("RCT", 1, 19) %>%
  pack_rows("Crossover", 20, 26) %>% 
  pack_rows("Non-randomized study (intervention)", 27, 28) %>% 
  pack_rows("Retrospective Cohort", 29, 29) %>% 
  footnote(general = "g: grams; Osm: osmolality",
          # alphabet = c("Hours prior to surgery"),
          # alphabet_title = " ",
          general_title = "",
          footnote_as_chunk = T)  
```

<br>

## *Comparator Detail* 

<font size = 4> Table `r table_n`. Comparator details.</font>

```{r createComparatorDetailTable, echo = FALSE}
## (updated 2021/02/14 16:52) createComparatorDetailTable ----------------------------
comparator_detail_table <- study_arm.dat %>%
  filter(refid %in% protein_refids) %>%
  mutate(tx = factor(arm_tx,
    levels = c(
      "fasting",
      "water",
      "placebo",
      "other_clear",
      "milk",
      "prot",
      "prot_simp",
      "prot_comp",
      "cho_simp",
      "cho_comp"
    )
  )) %>%
  mutate(
    tx = fct_recode(tx,
      Fasting = "fasting",
      Water = "water",
      Placebo = "placebo",
      Clear = "other_clear",
      Milk = "milk",
      "Prot" = "prot",
      "CHO/Simp/Prot" = "prot_simp",
      "CHO/Comp/Prot" = "prot_comp",
      "CHO/Simp" = "cho_simp",
      "CHO/Comp" = "cho_comp",
    ),
    arm_tx = tx
  ) %>%
  mutate(
    arm = ifelse(refid == 3588 & arm_n == 35, 3, arm),
    arm = ifelse(refid == 3588 & arm_n == 27, 2, arm)
  ) %>%
  select(refid, arm_n, tx, type_of_liquid, tx_detail, arm)

temp <- left_join(study_names, study_char.dat[, c("refid", "age", "surg_nosurg", "design")], by = "refid")
comparator_detail_table <- left_join(comparator_detail_table, temp, by = "refid") %>% 
  arrange(age, desc(surg_nosurg), design, year, study, arm)
rm(temp)

comparator_detail_table <- comparator_detail_table %>%
  arrange(age, desc(surg_nosurg), design, year, study, tx) %>%
  group_by(study) %>%
  # mutate(design = if_else(row_number() == 1, design, "")) %>%
  mutate(year = ifelse(row_number() == 1, as.numeric(year), "")) %>%
  filter(!study %in% c("Marquini 2020b", "Marquini 2020c")) %>%
  mutate(
    study = cell_spec(study, color = "black"),
    study = if_else(row_number() == 1, study, ""),
    study = ifelse(study == "Marquini 2020a", "Marquini 2020 (all)", study),
    tx_detail = firstup(tx_detail)
  ) %>%
  ungroup() %>%
  select(study, arm_n, tx, tx_detail)

```

```{r createComparatorDetailKable, echo = FALSE}
## (updated 2021/02/14 16:52) createComparatorDetailKable ----------------------------
prot_row <- comparator_detail_table %>%
  mutate(line = row_number()) %>%
  filter(grepl("Prot", tx)) %>%
  pull(line)

comparator_detail_table %>% 
   kbl(booktabs = T, align = c("ll"), escape = FALSE,
      col.names = c("        Study", "N", "Liquid", "Detail")) %>%
  kable_classic(full_width = TRUE, html_font = opt_font, position = "left", "hover") %>% 
  kable_styling(bootstrap_options = opt_boot) %>% 
    row_spec(prot_row, color = "brown") %>%
  column_spec(1, width = "15em") %>% 
  column_spec(2, width = "5em") %>% 
  column_spec(3, width = "8em") %>%
  # add_header_above(c(" " = 3, "Prescribed Fasting  (hr)" = 2, "Treat Liquid 1" = 2, "Treat Liquid 2" = 2)) %>% 
  pack_top(., "Adult, Surgical", 1, 52) %>% 
  pack_sub(., "RCT", 1, 46) %>% 
  pack_sub(., "Nonrandomized Studies of Interventions", 47, 50) %>% 
  pack_sub(., "Retrospective Cohort", 51, 52) %>% 
  pack_top(., "Adult, Nonsurgical", 53, 68) %>% 
  pack_sub(., "RCT", 53, 54) %>%
  pack_sub(., "Crossover", 55, 68) %>%
  pack_top(., "Pediatric, Nonsurgical", 69, 71) %>% 
  pack_sub(., "RCT", 69, 71) %>% 
  footnote(general = "CHO: carbohydrate; g: grams; Osm: osmolality",
          # alphabet = c("Hours prior to surgery"),
          # alphabet_title = " ",
          general_title = "",
          footnote_as_chunk = T)  

table_n <- tab_inc()
```

<br>

## *Funding* 

<font size = 4> Table `r table_n`. Reported funding sources. </font>

```{r createFundingTable, include = FALSE}
## (updated 2021/02/14 16:52) reateFundingTable ----------------------------
study_fund_table <- study_char_prot.dat %>%
  mutate(
    # sponsor_desc = str_to_title(sponsor_desc),
    registered = noquote(if_else(registered == "yes", "\U2022", "", "")),
    public = noquote(if_else(funding == "public" | funding == "pub_indus", "\U2022", "", "")),
    industry = noquote(if_else(funding == "pub_indus", "\U2022", "", "")),
    none = noquote(if_else(funding == "none", "\U2022", "", "")),
    not_reported = noquote(if_else(funding == "NR", "\U2022", "", "")),
    study = ifelse(study == "Marquini 2020a", "Marquini 2020 (all)", study)) %>%
  filter(!study %in% c("Marquini 2020b", "Marquini 2020c")) %>% 
  arrange(age, desc(surg_nosurg), design, year, study) %>%
  select(study, design, registered, public, industry, none, not_reported, sponsor_desc)

temp <- prot_drink_table %>% 
  mutate(brand = ifelse(str_detect(brand, "Arm"), NA, brand)) %>% 
  select(study, brand) %>% 
  distinct()

study_fund_table <- left_join(study_fund_table, temp, by = "study") 

```

```{r fundingKable, echo = FALSE}
## (updated 2021/02/14 16:52) fundingKable ----------------------------
study_fund_table %>% 
  select(-design, -registered) %>% 
  kbl(booktabs = T, align = c("lcccclll"),
      col.names = c("        Author", "Public", "Industry", "None", 
                    "Not Reported", "Funding description", "Brand")) %>%
  kable_classic(full_width = TRUE, html_font = opt_font, position = "left", "hover") %>% 
  kable_styling(bootstrap_options = opt_boot) %>% 
  column_spec(1, width = "16em") %>% 
  column_spec(c(2,3,4,5), width = "4em") %>% 
  column_spec(6, width = "23em") %>%
  row_spec(0, bold = TRUE) %>%
  add_header_above(c(" " = 1, "Reported Funding Source(s)" = 4, " " = 2), bold = TRUE, line = TRUE) %>% 
  # add_header_above(c(" " = 3, "Prescribed Fasting  (hr)" = 2, "Treat Liquid 1" = 2, "Treat Liquid 2" = 2)) %>% 
  # add_header_above(c(" " = 3, "Prescribed Fasting  (hr)" = 2, "Treat Liquid 1" = 2, "Treat Liquid 2" = 2)) %>% 
  pack_top(., "Adult, Surgical", 1, 20) %>% 
  pack_sub(., "RCT", 1, 18) %>% 
  pack_sub(., "Nonrandomized Studies of Interventions", 19, 19) %>% 
  pack_sub(., "Retrospective Cohort", 20, 20) %>% 
  pack_top(., "Adult, Nonsurgical", 21, 27) %>% 
  pack_sub(., "RCT", 21, 21) %>%
  pack_sub(., "Crossover", 22, 27) %>%
  pack_top(., "Pediatric, Nonsurgical", 28, 28) %>% 
  pack_sub(., "RCT", 28, 28)
  #footnote(general = "g: grams; Osm: osmolality",
          # alphabet = c("Hours prior to surgery"),
          # alphabet_title = " ",
          # general_title = "",
          # footnote_as_chunk = T)

table_n <- tab_inc()
```

<br>

<hr style="height:2px;border-width:0;color:gray;background-color:gray">

# **Risk of Bias** 

### Patient Reported Outcomes

<br>

<font size = 4> Figure `r figure_n`. Summary risk of bias appraisal for randomized controlled trials including patient reported outcomes --- nausea, hunger, thirst, and pain. </font>

<img src="assets/prot_pro_rob_summary.svg" style="width:600px;" align="left"/>

<br clear="all" />

```{r}
figure_n <- fig_inc()
```

<font size = 4> Figure `r figure_n`. Individual study risk of bias appraisal for randomized controlled trials including patient reported outcomes --- nausea, hunger, thirst, and pain. </font>

<img src="assets/prot_pro_rob_traffic.svg" style="width:600px;" align="left"/>

<br clear="all" />

```{r}
figure_n <- fig_inc()
```

<br>

### Clinical Outcomes

<br>

<font size = 4> Figure `r figure_n`. Summary risk of bias appraisal for randomized controlled trials including clinical outcomes. </font>

<img src="assets/prot_clin_rob_summary.svg" style="width:600px;" align="left"/>

<br clear="all" />

```{r}
figure_n <- fig_inc()
```

<font size = 4> Figure `r figure_n`. Individual study risk of bias appraisal for randomized controlled trials for clinical outcomes. </font>

<img src="assets/prot_clin_rob_traffic.svg" style="width:600px;" align="left"/>

```{r}
figure_n <- fig_inc()
```
<br clear="all" />

<hr style="height:2px;border-width:0;color:gray;background-color:gray">

<br>

# References {#references} 

